"use strict";(("undefined"!=typeof self?self:global).webpackChunkclient_web=("undefined"!=typeof self?self:global).webpackChunkclient_web||[]).push([[908],{87908:(e,t,n)=>{n.d(t,{ih:()=>E,cJ:()=>Ar,zq:()=>m,nA:()=>Pr,BE:()=>Zi});var r;n(89087),n(64574),n(92);!function(e){e.CAPPING_USER_IS_CAPPED="CAPPING_USER_IS_CAPPED",e.EME_API_NOT_SUPPORTED="EME_API_NOT_SUPPORTED",e.EME_MEDIA_KEYS_NOT_SUPPORTED="EME_MEDIA_KEYS_NOT_SUPPORTED",e.EME_MEDIA_KEY_SESSION_NOT_SUPPORTED="EME_MEDIA_KEY_SESSION_NOT_SUPPORTED",e.EME_NO_SUPPORTED_KEYSYSTEM="EME_NO_SUPPORTED_KEYSYSTEM",e.EME_PLAYER_MEDIA_KEYS_SETTING_FAILED="EME_PLAYER_MEDIA_KEYS_SETTING_FAILED",e.EME_ERROR_UNKNOWN="EME_ERROR_UNKNOWN",e.EME_LICENSE_REQUEST_EMPTY_RESPONSE="EME_LICENSE_REQUEST_EMPTY_RESPONSE",e.EME_LICENSE_REQUEST_FAILED_WITH_STATUS="EME_LICENSE_REQUEST_FAILED_WITH_STATUS",e.EME_LICENSE_REQUEST_WIDEVINE_ERROR="EME_LICENSE_REQUEST_WIDEVINE_ERROR",e.EME_LICENSE_UPDATE_FAILED="EME_LICENSE_UPDATE_FAILED",e.EME_HEADER_KEY_VALUE_MISMATCH="EME_HEADER_KEY_VALUE_MISMATCH",e.EME_HEADER_MISSING_CHALLENGE="EME_HEADER_MISSING_CHALLENGE",e.EME_INIT_DATA_MALFORMED="EME_INIT_DATA_MALFORMED",e.EME_CANNOT_SET_CERTIFICATE_FOR_PLATFORM="EME_CANNOT_SET_CERTIFICATE_FOR_PLATFORM",e.EME_MEDIA_KEY_SESSION_V0_1B_ERROR="EME_MEDIA_KEY_SESSION_V0_1B_ERROR",e.EME_MEDIA_KEY_SESSION_SAFARI_ERROR="EME_MEDIA_KEY_SESSION_SAFARI_ERROR",e.EME_NO_SUPPORTED_CONFIGURATION="EME_NO_SUPPORTED_CONFIGURATION",e.EME_NOT_SUPPORTED_ERROR="EME_NOT_SUPPORTED_ERROR",e.EME_INVALID_STATE_ERROR="EME_INVALID_STATE_ERROR",e.EME_UNKNOWN_ERROR="EME_UNKNOWN_ERROR",e.DISALLOW_PROTECTED_TRACK_ERROR="DISALLOW_PROTECTED_TRACK_ERROR",e.FILE_FORMAT_NOT_SUPPORTED="FILE_FORMAT_NOT_SUPPORTED",e.FILE_MALFORMED_SEEKTABLE="FILE_MALFORMED_SEEKTABLE",e.FILE_MALFORMED_PSSH="FILE_MALFORMED_PSSH",e.FILE_NOT_RESOLVED="FILE_NOT_RESOLVED",e.FRAGMENT_ONLINE_REQUEST_FAILED_WITH_ZERO="FRAGMENT_ONLINE_REQUEST_FAILED_WITH_ZERO",e.FRAGMENT_OFFLINE_REQUEST_FAILED_WITH_ZERO="FRAGMENT_OFFLINE_REQUEST_FAILED_WITH_ZERO",e.FRAGMENT_REQUEST_FAILED_WITH_ZERO="FRAGMENT_REQUEST_FAILED_WITH_ZERO",e.FRAGMENT_REQUEST_FAILED_WITH_STATUS="FRAGMENT_REQUEST_FAILED_WITH_STATUS",e.FRAGMENT_REQUEST_EMPTY_RESPONSE="FRAGMENT_REQUEST_EMPTY_RESPONSE",e.FRAGMENT_REQUEST_UNEXPECTED_LENGTH="FRAGMENT_REQUEST_UNEXPECTED_LENGTH",e.PLAYER_ATTEMPTED_VOLUME_OUT_OF_RANGE="PLAYER_ATTEMPTED_VOLUME_OUT_OF_RANGE",e.PLAYER_BUFFER_QUOTA_EXCEEDED="PLAYER_BUFFER_QUOTA_EXCEEDED",e.PLAYER_CANNOT_FIND_PLAYABLE_URI="PLAYER_CANNOT_FIND_PLAYABLE_URI",e.PLAYER_INVALID_INTERNAL_STATE="PLAYER_INVALID_INTERNAL_STATE",e.PLAYER_MEDIA_ERROR="PLAYER_MEDIA_ERROR",e.PLAYER_PLAYBACK_ERROR="PLAYER_PLAYBACK_ERROR",e.MEDIA_ABORTED="MEDIA_ABORTED",e.MEDIA_DECODING_ERROR="MEDIA_DECODING_ERROR",e.MEDIA_NETWORK_ERROR="MEDIA_NETWORK_ERROR",e.MEDIA_NOT_SUPPORTED="MEDIA_NOT_SUPPORTED",e.LICENSE_RESOLVE_INVALID_RESPONSE="LICENSE_RESOLVE_INVALID_RESPONSE",e.LICENSE_RESOLVER_CANT_RESOLVE_URL="LICENSE_RESOLVER_CANT_RESOLVE_URL",e.LICENSE_RESOLVER_DEPRECATED_VERSION="LICENSE_RESOLVER_DEPRECATED_VERSION",e.LIST_PLAYER_NO_TRACK_PLAYER="LIST_PLAYER_NO_TRACK_PLAYER",e.LIST_PLAYER_NO_LIST="LIST_PLAYER_NO_LIST",e.LIST_PLAYER_INVALID_ARGUMENT="LIST_PLAYER_INVALID_ARGUMENT",e.LIST_PLAYER_FORBIDDEN="LIST_PLAYER_FORBIDDEN",e.STORAGE_ERROR="STORAGE_ERROR",e.STORAGE_FAILED_WITH_STATUS="STORAGE_FAILED_WITH_STATUS",e.STORAGE_RETURNED_NO_TRACKS="STORAGE_RETURNED_NO_TRACKS",e.STORAGE_TRACK_MANIFEST_FAILED="STORAGE_TRACK_MANIFEST_FAILED",e.STORAGE_TRACK_MANIFEST_EMPTY="STORAGE_TRACK_MANIFEST_EMPTY",e.STORAGE_VIDEO_MANIFEST_FAILED="STORAGE_VIDEO_MANIFEST_FAILED",e.TRACK_DATA_ALREADY_FINALIZED="TRACK_DATA_ALREADY_FINALIZED",e.TSV_SENDING_FAILED="TSV_SENDING_FAILED",e.PLAYBACK_STATS_SENDING_FAILED="PLAYBACK_STATS_SENDING_FAILED",e.PLAYBACK_START_SENDING_FAILED="PLAYBACK_START_SENDING_FAILED",e.UNKNOWN="UNKNOWN"}(r||(r={}));var i,a=n(72226);!function(e){e.USER_INFO_REQUEST_EMPTY_RESPONSE="USER_INFO_REQUEST_EMPTY_RESPONSE",e.USER_INFO_REQUEST_FAILED_WITH_STATUS="USER_INFO_REQUEST_FAILED_WITH_STATUS",e.HARMONY_NO_TRACKS_LOADED="HARMONY_NO_TRACKS_LOADED",e.HARMONY_OPERATION_FORBIDDEN="HARMONY_OPERATION_FORBIDDEN",e.HARMONY_LOCAL_PLAYER_DISABLED="HARMONY_LOCAL_PLAYER_DISABLED",e.HARMONY_INVALID_DESCRIPTOR_ID="HARMONY_INVALID_DESCRIPTOR_ID",e.CONNECTAPI_CLIENT_INVALID_ARGUMENTS="CONNECTAPI_CLIENT_INVALID_ARGUMENTS",e.CONNECTAPI_CLIENT_MISSING_DEVICE_ID="CONNECTAPI_CLIENT_MISSING_DEVICE_ID",e.CONNECTAPI_CLIENT_NO_CONNECTION_ID="CONNECT_API_CLIENT_NO_CONNECTION_ID",e.CONNECTAPI_CLIENT_NO_DEVICE="CONNECTAPI_CLIENT_NO_DEVICE",e.CONNECTAPI_CLIENT_NO_SESSION_ID="CONNECTAPI_CLIENT_NO_SESSION_ID",e.CONNECTAPI_CLIENT_NO_STATE="CONNECTAPI_CLIENT_NO_STATE",e.CONNECTAPI_CLIENT_INVALID_POSITION="CONNECT_API_CLIENT_INVALID_POSITION",e.CONNECTAPI_CLIENT_INVALID_VOLUME="CONNECT_API_CLIENT_INVALID_VOLUME",e.CONNECTAPI_MAX_SUBSCRIPTIONS_REACHED="CONNECTAPI_MAX_SUBSCRIPTIONS_REACHED",e.CONNECTAPI_REGISTRATION_FAILED_WITH_STATUS="CONNECTAPI_REGISTRATION_FAILED_WITH_STATUS",e.CP_NO_DEVICE_DESCRIPTOR="CP_NO_DEVICE_DESCRIPTOR",e.CP_NO_CONNECTION_ID="CP_NO_CONNECTION_ID",e.CP_REGISTRATION_FAILED_WITH_STATUS="CP_REGISTRATION_FAILED_WITH_STATUS",e.CP_REGISTRATION_FAILED_NON_PREMIUM="CP_REGISTRATION_FAILED_NON_PREMIUM",e.CP_REQUEST_FAILED_WITH_STATUS="CP_REQUEST_FAILED_WITH_STATUS",e.CP_NO_DEVICE_ID="CP_NO_DEVICE_ID",e.CP_NO_RESPONSE_BODY="CP_NO_RESPONSE_BODY",e.CP_NO_TRACKING_DATA="CP_NO_TRACKING_DATA",e.CP_INVALID_STATE="CP_INVALID_STATE",e.QUEUE_MANAGER_NO_STATE="QUEUE_MANAGER_NO_STATE",e.QUEUE_OPERATION_STALE_REVISION="QUEUE_OPERATION_STALE_REVISION",e.TP_NO_RESPONSE_BODY="TP_NO_RESPONSE_BODY",e.TP_REGISTRATION_FAILED_NON_PREMIUM="TP_REGISTRATION_FAILED_NON_PREMIUM",e.TP_REGISTRATION_FAILED_WITH_STATUS="TP_REGISTRATION_FAILED_WITH_STATUS",e.TP_MAX_SUBSCRIPTIONS_REACHED="TP_MAX_SUBSCRIPTIONS_REACHED",e.TP_UPDATE_REQUEST_EMPTY_RESPONSE="TP_UPDATE_REQUEST_EMPTY_RESPONSE",e.TP_PARSE_STATE_UPDATE_FAILED_WITH_STATUS="TP_PARSE_STATE_UPDATE_FAILED_WITH_STATUS",e.TP_UNKNOWN_COMMAND="TP_UNKNOWN_COMMAND",e.TP_CANNOT_CREATE_STATE_REF="TP_CANNOT_CREATE_STATE_REF",e.TP_MISSING_INITIAL_STATE="TP_MISSING_INITIAL_STATE",e.TP_INVALID_STATE_REFERENCE="TP_INVALID_STATE_REFERENCE",e.TP_CONFLICT_REQUEST_FAILED_WITH_STATUS="TP_CONFLICT_REQUEST_FAILED_WITH_STATUS"}(i||(i={}));n(53309),n(69754),n(61207);var o=n(72755);n(11226),n(39018);var s,u=n(52398),l=n(24572),c=n(40936),_=n(49962),d=n(60790),f=n(65782),h=n(35165),v=n(29129),p=(n(34630),n(22190),n(53967),n(16897),n(4647),n(97639),n(30412),n(53016));!function(e){e.APPLOAD="appload",e.BACK_BUTTON="backbtn",e.CLICK_ROW="clickrow",e.CLICK_SIDE="clickside",e.END_PLAY="endplay",e.FORWARD_BUTTON="fwdbtn",e.LOGOUT="logout",e.PLAY_BUTTON="playbtn",e.POPUP="popup",e.REMOTE="remote",e.TRACK_DONE="trackdone",e.TRACK_ERROR="trackerror",e.UNKNOWN="unknown",e.URI_OPEN="uriopen",e.CAPPED="capped",e.SEEK="seek"}(s||(s={}));var E,y,m,g=n(60220),S="@local",R=65535;!function(e){e.AUTHENTICATED="authenticated",e.AUTHENTICATION_ERROR="authentication_error",e.AUTOPLAY_FAILED="autoplay_failed",e.BEFORE_DISCONNECT="before_disconnect",e.BEFORE_VOLUME_CHANGE="before_volume_change",e.BUFFER_STALLED="stalled",e.BUFFERING_END="buffering_end",e.BUFFERING_START="buffering_start",e.CONNECTED="connected",e.CONNECTION_ERROR="connection_error",e.DEVICES_CHANGED="devices_changed",e.DEVICE_DEACTIVATED="device_deactivated",e.DEVICE_DESCRIPTOR_CHANGED="descriptor_changed",e.DISCONNECTED="disconnected",e.DURATION_CHANGED="duration_changed",e.ERROR="error",e.LAST_ACTIVE_DEVICE_INFO_CHANGED="last_active_device_info_changed",e.LOCAL_CONTEXT_ENDED="local_context_ended",e.LOCAL_PLAYER_DISABLED="local_player_disabled",e.LOCAL_PLAYER_ENABLED="local_player_enabled",e.LOCAL_PLAYER_LOGGED_OUT="local_player_logged_out",e.LOGGED_OUT="logged_out",e.MAX_LIST_ERRORS_REACHED="max_list_errors_reached",e.MAX_SUBSCRIPTIONS_REACHED="max_subscriptions_reached",e.PLAYBACK_CAPPED="playback_capped",e.PLAYER_INITIALIZATION_DONE="player_initialization_done",e.PLAYER_INITIALIZATION_FAILED="player_initialization_failed",e.PRODUCT_STATE_CHANGED="product_state_changed",e.PROGRESS="progress",e.PLAYER_QUEUE_CHANGED="player_queue_changed",e.RECONNECTED="reconnected",e.RECONNECTING="reconnecting",e.REMOTE_OBSERVER_DISABLED="remote_observer_disabled",e.REMOTE_OBSERVER_ENABLED="remote_observer_enabled",e.SERVICE_REGISTRATION_ERROR="service_registration_error",e.STATE_CHANGED="state_changed",e.STOPPED_ON_BACKGROUND="stopped_on_background",e.TRACK_ENDED="track_ended",e.UNRECOVERABLE_FAILURE="unrecoverable_failure",e.VIDEO_ELEMENT_APPENDED="video_element_appended",e.VIDEO_ELEMENT_REMOVED="video_element_removed",e.VOLUME_CHANGED="volume_changed",e.DISPLAYED_CUES_CHANGED="displayed_cues_changed",e.SUBTITLE_LANGUAGES_LOADED="subtitle_languages_loaded",e.SPEED_CHANGED="speed_changed"}(E||(E={})),function(e){e.CLOUD_PLAYBACK="cloud-playback",e.CONNECT_API="connect-api",e.HARMONY="harmony",e.PLAYBACK="playback",e.TRACK_PLAYBACK="track-playback",e.TRANSPORT="transport"}(y||(y={})),function(e){e[e.OFF=0]="OFF",e[e.CONTEXT=1]="CONTEXT",e[e.TRACK=2]="TRACK"}(m||(m={}));var A=n(38369);function T(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var P=function(e){(0,f.Z)(n,e);var t=T(n);function n(e,r){var i;return(0,c.Z)(this,n),(i=t.call(this,r)).status=-1,i.unrecoverable=!1,i.debug={},i.code=e,i.name="HarmonyError",i}return(0,_.Z)(n,null,[{key:"fatal",value:function(e,t){var r=new n(e,t);return r.unrecoverable=!0,r}}]),n}((0,A.Z)(Error));n(63489);function L(e,t){return!e&&!t||!(!e||!t)&&(e.id===t.id&&e.is_active===t.is_active&&e.is_controllable===t.is_controllable&&e.is_observable===t.is_observable&&e.is_being_activated===t.is_being_activated&&e.local===t.local&&e.name===t.name&&e.type===t.type&&e.version===t.version&&e.volume===t.volume)}n(95346),n(60353),n(94186);var I=n(84691);n(76723),n(70532),n(26541),n(63452),n(27845),n(99463);function k(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var D=function(e){(0,f.Z)(n,e);var t=k(n);function n(e,r){var i;return(0,c.Z)(this,n),(i=t.call(this,r)).unrecoverable=!1,i.code=e,i.name="PlayerQueueError",i}return(0,_.Z)(n)}((0,A.Z)(Error));function C(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}function b(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return O(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return O(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function O(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var N=":::";function M(e){var t,n,r,i,a,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{ignoreMetaForTrack:!1},s=[],u=[],l=!1,c=!1;if(!(null==e?void 0:e.length))return{items:s,tracks:u,hasQueuedTracks:l};var _,d=b(e);try{for(d.s();!(_=d.n()).done;){var f=_.value,h="spotify:delimiter"===f.uri||/^spotify:meta:/.test(f.uri)?"meta":"track",v="".concat(f.uid).concat(N).concat(null!==(n=null===(t=f.metadata)||void 0===t?void 0:t.iteration)&&void 0!==n?n:""),p={type:h,uri:f.uri,uid:f.uid,qid:v,metadata:f.metadata||{},hidden:"true"===(null===(r=f.metadata)||void 0===r?void 0:r.hidden),queued:"true"===(null===(i=f.metadata)||void 0===i?void 0:i.is_queued),provider:f.provider,removed_reasons:f.removed,$blck_rs:f.blocked};p.queued&&(l=!0),s.push(p),"meta"===p.type?c=!0:!o.ignoreMetaForTrack&&c||"track"!==p.type||p.hidden||(null===(a=p.removed_reasons)||void 0===a?void 0:a.length)||u.push(p)}}catch(E){d.e(E)}finally{d.f()}return{items:s,tracks:u,hasQueuedTracks:l}}function w(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!Array.isArray(e))throw new TypeError("Items is not an array.");if(!e.length)return[];var n,r=[],i=b(e);try{for(i.s();!(n=i.n()).done;){var a=n.value;if(a){"string"==typeof a&&(a={type:"track",uri:a});var o={uri:a.uri,uid:a.uid,metadata:a.metadata||{},removed:a.removed_reasons,blocked:a.$blck_rs,provider:a.provider};(a.queued||t.queued)&&(o.metadata.is_queued="true",o.provider="queue"),(a.hidden||"meta"===a.type)&&(o.metadata.hidden="true"),r.push(o)}}}catch(s){i.e(s)}finally{i.f()}return r}function U(e){var t=e.split(N),n=(0,u.Z)(t,2),r=n[0],i=n[1],a={type:"track",uid:r};return i&&(a.metadata={iteration:i}),a}var F=function(e){(0,f.Z)(n,e);var t=C(n);function n(e){var r;return(0,c.Z)(this,n),(r=t.call(this))._hasInitialState=!1,r._reportInactiveQueues=!1,r._onlyLocalQueue=!1,r._currentPlayerState=null,r._currentInternalQueue=null,r._currentQueue=null,r._hasQueuedTracks=!1,r._connectClient=e.connectClient,r._runner=e.runner||function(e){return e()},r._parsePlayerState=r._parsePlayerState.bind((0,d.Z)(r)),r._onlyLocalQueue=!!e.onlyLocalQueue,r._reportInactiveQueues=!!e.reportInactiveQueues,r._connectClient.on("player_state_changed",r._onPlayerStateChanged.bind((0,d.Z)(r))),e.initialContextPlayerState&&r._parsePlayerState(e.initialContextPlayerState),r}return(0,_.Z)(n,[{key:"_onPlayerStateChanged",value:function(e){var t=e.data,n=t.playerState,r=t.orphaned,i=t.isLocal;this._parsePlayerState(n,r,i)}},{key:"_parsePlayerState",value:function(e,t,n){var r,i,a;if(this._hasInitialState=!0,this._onlyLocalQueue&&!n||!this._reportInactiveQueues&&t)this._currentPlayerState=null,this._currentInternalQueue=null,this._currentQueue=null;else if(this._currentPlayerState=null!=e?e:null,e){if(e.queue_revision===(null===(r=this._currentInternalQueue)||void 0===r?void 0:r.revision))return null;this._hasQueuedTracks=!1;var o={ignoreMetaForTrack:null===(i=e.options)||void 0===i?void 0:i.repeating_context},s=e.queue_revision,u=M([e.track]).items[0],l=M(e.next_tracks,o),c=M(e.prev_tracks,o);this._hasQueuedTracks=l.hasQueuedTracks;var _={uri:e.context_uri,metadata:null!==(a=e.context_metadata)&&void 0!==a?a:void 0};this._currentInternalQueue={revision:s,context:_,current_track:u,next_items:l.items,previous_items:c.items},this._currentQueue={revision:s,context:_,current_track:u,next_tracks:l.tracks,previous_tracks:c.tracks}}else this._hasQueuedTracks=!1,this._currentInternalQueue=null,this._currentQueue=null;return this.emit(E.PLAYER_QUEUE_CHANGED,{internalPlayerQueue:this._currentInternalQueue,playerQueue:this._currentQueue}),this._currentInternalQueue}},{key:"_setQueueNext",value:function(e,t){var n=this,r=this._currentPlayerState;if(!r)return Promise.reject(new D(i.QUEUE_MANAGER_NO_STATE,"Cannot perform operation; no current state."));var a={next_tracks:e,prev_tracks:r.prev_tracks,queue_revision:r.queue_revision};return this._runner((function(){return n._connectClient.setQueue(a,t)}),t)}},{key:"_appendQueued",value:function(e,t){var n,r,a=this._currentPlayerState;if(!a)return Promise.reject(new D(i.QUEUE_MANAGER_NO_STATE,"Cannot perform operation; no current state."));var o=Array.from(null!==(n=a.next_tracks)&&void 0!==n?n:[]);if(this._hasQueuedTracks){for(var s=!1,u=0,l=o.length;u<l;u++){var c=o[u];if("true"!==(null===(r=null==c?void 0:c.metadata)||void 0===r?void 0:r.is_queued)){o.splice.apply(o,[u,0].concat((0,I.Z)(e))),s=!0;break}}s||o.push.apply(o,(0,I.Z)(e))}else o.unshift.apply(o,(0,I.Z)(e));return this._setQueueNext(o,t)}},{key:"getInternalPlayerQueue",value:function(){var e=this;return this._hasInitialState?Promise.resolve(this._currentInternalQueue):new Promise((function(t){e.on(E.PLAYER_QUEUE_CHANGED,(function(e){t(e.data.internalPlayerQueue)}))}))}},{key:"getPlayerQueue",value:function(){var e=this;return this._hasInitialState?Promise.resolve(this._currentQueue):new Promise((function(t){e.on(E.PLAYER_QUEUE_CHANGED,(function(e){t(e.data.playerQueue)}))}))}},{key:"setInternalPlayerQueue",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{ignoreRevision:!1};if(!this._currentPlayerState)return Promise.reject(new D(i.QUEUE_MANAGER_NO_STATE,"Cannot perform operation; no current state."));if(e.revision!==this._currentPlayerState.queue_revision&&!r.ignoreRevision)return Promise.reject(new D(i.QUEUE_OPERATION_STALE_REVISION,"Cannot perform operation; revision is stale."));var a={next_tracks:w(e.next_items),prev_tracks:w(e.previous_items),queue_revision:r.ignoreRevision?void 0:this._currentPlayerState.queue_revision};return this._runner((function(){return n._connectClient.setQueue(a,t)}),t)}},{key:"addToQueue",value:function(e,t){var n=this;if(!Array.isArray(e))return Promise.reject(new TypeError("Argument `items` must be an array."));var r=w(e,{queued:!0});return r.length?1===r.length?this._runner((function(){return n._connectClient.addToQueue(r[0],t)}),t):this._appendQueued(r,t):Promise.resolve(!1)}},{key:"removeNext",value:function(e,t){var n,r,a,o,s=this._currentPlayerState;if(!s)return Promise.reject(new D(i.QUEUE_MANAGER_NO_STATE,"Cannot perform operation; no current state."));o="string"==typeof e?U(e):e;for(var u=Array.from(null!==(n=s.next_tracks)&&void 0!==n?n:[]),l=u.length,c=0;c<l;c++){var _=u[c];if((null==_?void 0:_.uid)===o.uid&&(null===(r=null==_?void 0:_.metadata)||void 0===r?void 0:r.iteration)===(null===(a=o.metadata)||void 0===a?void 0:a.iteration)){u.splice(c,1);break}}return u.length===l?Promise.resolve(!1):this._setQueueNext(u,t)}}],[{key:"create",value:function(e){return new n(e)}}]),n}(p.vp);function Y(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var B,x,Z=function(e){(0,f.Z)(n,e);var t=Y(n);function n(e){var r;return(0,c.Z)(this,n),(r=t.call(this))._hasFakeState=!1,r._localPlayerEnabled=!1,r._localPlayback=!1,r._lastDeviceList=[],r._deferredStreamer=(0,g.$)(),r._client=e.client,r._streamer=e.streamer,r._controller=e.controller,r._hidden=!!e.hidden,r._onlyLocalState=!!e.onlyLocalState,r._preferController=!r._onlyLocalState&&!!e.preferControllerState,r._claimInactivePlayerStates=!!e.claimInactivePlayerStates,r._enableControllerWithoutStreamer=!!e.enableControllerWithoutStreamer,r._autoActivateElement=!!e.autoActivateElement,r._deactivateOnStop=!!e.experimentalDeactivateOnStop,r._parseDeviceList=r._parseDeviceList.bind((0,d.Z)(r)),r._init(),r}return(0,_.Z)(n,[{key:"_init",value:function(){var e,t=this;this._createStreamerDeferred();var n=this._client;n.on("error",this._onError.bind(this)),this.proxyEmit(n,"authenticated",E.AUTHENTICATED),this.proxyEmit(n,"authentication_error",E.AUTHENTICATION_ERROR),this.proxyEmit(n,"before_disconnect",E.BEFORE_DISCONNECT),this.proxyEmit(n,"connected",E.CONNECTED),this.proxyEmit(n,"connection_error",E.CONNECTION_ERROR),this.proxyEmit(n,"descriptor_changed",E.DEVICE_DESCRIPTOR_CHANGED),this.proxyEmit(n,"product_state_changed",E.PRODUCT_STATE_CHANGED),this.proxyEmit(n,"reconnected",E.RECONNECTED),this.proxyEmit(n,"reconnecting",E.RECONNECTING),this.proxyEmit(n,"unrecoverable_failure",E.UNRECOVERABLE_FAILURE),this.proxyEmit(n,"logged_out",E.LOGGED_OUT);var r=this._controller;r.on("device_info_changed",(function(e){t._onDeviceStateChanged(e.data)})),r.on("devices_changed",this._onDevicesChanged.bind(this)),r.on("state_changed",this._onPlayerStateChanged.bind(this)),r.on("progress",this._onControllerProgress.bind(this)),this.proxyEmitAll(r,(e={},(0,l.Z)(e,"max_subscriptions_reached",E.MAX_SUBSCRIPTIONS_REACHED),(0,l.Z)(e,"device_deactivated",E.DEVICE_DEACTIVATED),e)),r.on("registered",this.emit.bind(this,E.REMOTE_OBSERVER_ENABLED,null)),r.on("deregistered",this.emit.bind(this,E.REMOTE_OBSERVER_DISABLED,null));var i=this._streamer;i?(i.on("deregistered",this._onStreamerDeregistered.bind(this)),i.on("registered",this._onStreamerRegistered.bind(this)),i.on("registration_aborted",this._onStreamerRegistrationAborted.bind(this)),i.on("state_changed",this._onStreamerStateChanged.bind(this)),i.on("stopped_on_background",this._onStreamerStoppedOnBackground.bind(this)),i.on("streamer_seek_handled",this._onSeekHandled.bind(this)),this.proxyEmitSync(i,"before_volume_change",E.BEFORE_VOLUME_CHANGE),this.proxyEmit(i,"autoplay_failed",E.AUTOPLAY_FAILED),this.proxyEmit(i,"stalled",E.BUFFER_STALLED),this.proxyEmit(i,"buffering_end",E.BUFFERING_END),this.proxyEmit(i,"buffering_start",E.BUFFERING_START),this.proxyEmit(i,"duration_changed",E.DURATION_CHANGED),this.proxyEmit(i,"max_list_errors_reached",E.MAX_LIST_ERRORS_REACHED),this.proxyEmit(i,"max_subscriptions_reached",E.MAX_SUBSCRIPTIONS_REACHED),this.proxyEmit(i,"playback_capped",E.PLAYBACK_CAPPED),this.proxyEmit(i,"player_initialization_done",E.PLAYER_INITIALIZATION_DONE),this.proxyEmit(i,"player_initialization_failed",E.PLAYER_INITIALIZATION_FAILED),this.proxyEmit(i,"progress",E.PROGRESS),this.proxyEmit(i,"registration_error",E.SERVICE_REGISTRATION_ERROR),this.proxyEmit(i,"track_ended",E.TRACK_ENDED),this.proxyEmit(i,"video_element_appended",E.VIDEO_ELEMENT_APPENDED),this.proxyEmit(i,"video_element_removed",E.VIDEO_ELEMENT_REMOVED),this.proxyEmit(i,"volume_changed",E.VOLUME_CHANGED),this.proxyEmit(i,"displayed_cues_changed",E.DISPLAYED_CUES_CHANGED),this.proxyEmit(i,"subtitle_languages_loaded",E.SUBTITLE_LANGUAGES_LOADED),this.proxyEmit(i,"speed_changed",E.SPEED_CHANGED),this.proxyEmitSync(i,"internal_endcontent","internal_endcontent"),i.on("context_ended",this.emit.bind(this,E.LOCAL_CONTEXT_ENDED,null)),i.on("logged_out",this.emit.bind(this,E.LOCAL_PLAYER_LOGGED_OUT,null))):(this._disableLocalTarget(),this.on(E.AUTHENTICATED,(function(){t.emit(E.LOCAL_PLAYER_DISABLED,null)})))}},{key:"_createStreamerDeferred",value:function(){this._deferredStreamer=(0,g.$)(),this._deferredStreamer.promise.catch((function(){}))}},{key:"_isTargetIdLocal",value:function(e){return e?e===S?Promise.resolve(!0):this._client.getDeviceDescriptor().then((function(t){return e===t.getId()})):Promise.resolve(!!this._localPlayback)}},{key:"_onStreamerRegistered",value:function(e){this._deferredStreamer.resolve(e.data),this._createStreamerDeferred(),this._deferredStreamer.resolve(e.data),this._localPlayerEnabled=!0,this._controller.register(),this.emit(E.LOCAL_PLAYER_ENABLED,null)}},{key:"_onStreamerDeregistered",value:function(){this._disableLocalTarget(),this.emit(E.LOCAL_PLAYER_DISABLED,null)}},{key:"_onStreamerRegistrationAborted",value:function(){this._disableLocalTarget(),this._enableControllerWithoutStreamer&&this._controller.register(),this.emit(E.LOCAL_PLAYER_DISABLED,null)}},{key:"_disableLocalTarget",value:function(){this._localPlayerEnabled=!1;var e=new P(i.HARMONY_LOCAL_PLAYER_DISABLED,"Cannot perform command; local player is disabled.");this._deferredStreamer.reject(e),this._createStreamerDeferred(),this._deferredStreamer.reject(e)}},{key:"_onStreamerConnect",value:function(){return this._deferredStreamer.promise}},{key:"_onDeviceStateChanged",value:function(e){var t=this,n=!!this._localPlayback,r=function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];t._generateLocalDeviceInfo(e).then((function(e){t.emit(E.LAST_ACTIVE_DEVICE_INFO_CHANGED,{deviceInfo:e,hasOrphanedState:!1})}))};if(this._localPlayerEnabled&&e.hasOrphanedState&&this._claimInactivePlayerStates)return this._hasFakeState=!0,void r(!0);if(this._hasFakeState=!1,this._localPlayback=!(!e.deviceInfo||!e.deviceInfo.local),this._localPlayback){if(!this._streamer)throw new P(i.HARMONY_OPERATION_FORBIDDEN,"No streamer provided.");this._streamer.getVolume().then((function(n){e.deviceInfo&&(e.deviceInfo.volume=n),t.emit(E.LAST_ACTIVE_DEVICE_INFO_CHANGED,e)})).catch((function(){}))}else this._onlyLocalState?(this._localPlayback||n)&&r():this.emit(E.LAST_ACTIVE_DEVICE_INFO_CHANGED,e)}},{key:"_onDevicesChanged",value:function(e){var t=this;this._parseDeviceList(e.data).then((function(e){(function(e,t){if(!Array.isArray(e)||!Array.isArray(t))throw new TypeError("Invalid devices list.");if(e.length!==t.length)return!1;for(var n=0,r=e.length;n<r;n++)if(!L(e[n],t[n]))return!1;return!0})(t._lastDeviceList,e)||(t._lastDeviceList=e,t.emit(E.DEVICES_CHANGED,{devices:e,localDevice:null}))}))}},{key:"_onError",value:function(e){var t=e.data.error;e.data.source===y.PLAYBACK&&t&&t.unrecoverable&&(this._disableLocalTarget(),this._streamer&&this._streamer.deregister()),this.emit(E.ERROR,e.data)}},{key:"_onPlayerStateChanged",value:function(e){var t;this._onlyLocalState||(!this._preferController&&this._localPlayback||(t=this._localPlayerEnabled&&this._claimInactivePlayerStates?e.data.state:e.data.orphaned?null:e.data.state,this.emit(E.STATE_CHANGED,{state:t})))}},{key:"_onControllerProgress",value:function(e){this._onlyLocalState||this._localPlayback||this.emit(E.PROGRESS,e.data)}},{key:"_onStreamerStateChanged",value:function(e){this._preferController||(this._onlyLocalState?this._triggerLocalStateChanges(e.data):this._hidden?this._handleHidden(e.data):this._localPlayback&&this.emit(E.STATE_CHANGED,e.data))}},{key:"_onStreamerStoppedOnBackground",value:function(){this._deactivateOnStop&&(this._localPlayback=!1),this.emit(E.STOPPED_ON_BACKGROUND,null)}},{key:"_handleHidden",value:function(e){e.state?(this._controller.suppressEvents(),this._triggerLocalStateChanges(e)):this._controller.unsuppressEvents()}},{key:"_parseDeviceList",value:function(e){var t=e.devices.slice(0).map((function(e){return Promise.resolve(e)}));return t.length&&e.localDevice?this._hasFakeState&&e.localDevice&&(e.localDevice.is_active=!0):t.push(this._generateLocalDeviceInfo(this._hasFakeState)),Promise.all(t).then((function(e){return e}))}},{key:"_triggerLocalStateChanges",value:function(e){var t=this;this._generateLocalDeviceInfo().then((function(e){t._onDeviceStateChanged({deviceInfo:e,hasOrphanedState:!1})})),this.emit(E.STATE_CHANGED,e)}},{key:"_canStartNewContext",value:function(e){var t=this;return this._runOnDevice(e,(function(){return t._streamer?Promise.resolve(!0):Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"No streamer provided."))}),(function(){return Promise.resolve(!0)}),{bypassFakeState:!0})}},{key:"_activateElement",value:function(){this._autoActivateElement=!1,this._streamer&&this._streamer.activateElement().catch((function(){}))}},{key:"_runOnDevice",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0,n=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0;return this._hasFakeState&&!(null==i?void 0:i.bypassFakeState)?(this._autoActivateElement&&this._activateElement(),this._claimStateAndRun(r,i)):this._isTargetIdLocal(t).then((function(t){return t?e._onStreamerConnect().then(n):r()}))}},{key:"_claimStateAndRun",value:function(e,t){var n=this;return this._onStreamerConnect().then((function(){n._hasFakeState=!1;var e={paused:!0};return(null==t?void 0:t.loggingParams)&&(e.loggingParams=t.loggingParams),Promise.all([n._controller.transfer(S,e),new Promise((function(e,t){n._streamer?n._streamer.once("track_loaded",e):t(new P(i.HARMONY_OPERATION_FORBIDDEN,"No streamer provided."))}))])})).then((function(){return e()}))}},{key:"_generateLocalDeviceInfo",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=this._client,r=this._streamer,i=Promise.resolve(!1),a=Promise.resolve(-1);return this._localPlayerEnabled&&(t?i=Promise.resolve(!0):r&&(i=r.getCurrentState().then((function(e){return!!e}))),r&&(a=r.getVolume())),Promise.all([n.getClientDescriptor(),n.getSDKId(),i,a]).then((function(t){var n,r=(0,u.Z)(t,4),i=r[0],a=r[1],o=r[2],s=r[3],l={hifi_status:{fully_supported:void 0,user_eligible:void 0,device_supported:null===(n=i.capabilities)||void 0===n?void 0:n.lossless_playback}};return{hidden:e._hidden,id:i.id,is_active:o,is_group:!1,is_being_activated:!1,is_controllable:e._localPlayerEnabled,is_observable:!!e._localPlayerEnabled&&!e._hidden,local:!0,metadata:i.metadata||{},name:i.name,type:i.type,version:a,volume:s,capabilities:{supports_lossless_audio:!1},playback_features:l,has_inactive_player_state:e._hasFakeState}}))}},{key:"_movePosition",value:function(e,t){var n=this;return this.getCurrentState().then((function(r){if(!r||isNaN(r.position))return Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"Seeking not allowed with invalid track."));var a=e,o=Math.min(r.duration,Math.max(0,r.position+a));return n.seek(o,t)}))}},{key:"_prepareSkipTrack",value:function(e){return"string"==typeof e?U(e):e}},{key:"_cycleRepeatMode",value:function(e){var t=this;return this.getCurrentState().then((function(n){if(!n)return Promise.reject(new P(i.CONNECTAPI_CLIENT_NO_STATE,"Nothing playing"));var r=null,a=n.disallows;switch(n.repeat_mode){case m.OFF:if(a.toggling_repeat_context){if(a.toggling_repeat_track)return Promise.resolve(!1);r=m.TRACK}else r=m.CONTEXT;break;case m.CONTEXT:r=a.toggling_repeat_track?m.OFF:m.TRACK;break;case m.TRACK:default:r=m.OFF}return t.setRepeatMode(r,e)}))}},{key:"_onSeekHandled",value:function(e){this._controller.seek(e.data.position)}},{key:"getClientDescriptor",value:function(){return this._client.getClientDescriptor()}},{key:"getProductState",value:function(){return this._client.getProductState()}},{key:"getPublicTransport",value:function(){return this._client.getPublicTransport()}},{key:"getUserInfo",value:function(){return this._client.getUserInfo()}},{key:"getVersionDescriptor",value:function(){return this._client.getVersionDescriptor()}},{key:"logAppMetrics",value:function(e,t){return this._client.logAppMetrics(e,t)}},{key:"setName",value:function(e){return this._client.setName(e)}},{key:"setNameTemplate",value:function(e){return this._client.setNameTemplate(e)}},{key:"getContextPlayerState",value:function(){return this._controller.getContextPlayerState()}},{key:"updateCurrentContext",value:function(e,t){return this._controller.updateCurrentContext(e,t)}},{key:"getLastActiveDevice",value:function(){var e=this;return this._onlyLocalState||this._hasFakeState?this._generateLocalDeviceInfo(this._hasFakeState):this._controller.getActiveDevice().then((function(t){return(null==t?void 0:t.local)&&e._streamer?(t.hidden=e._hidden,e._streamer.getVolume().then((function(e){return t.volume=e,t}))):t}))}},{key:"getCurrentState",value:function(){var e=this;if(!this._onlyLocalState&&(this._preferController||!this._localPlayback)){var t=!this._localPlayerEnabled||!this._claimInactivePlayerStates;return this._controller.getCurrentState(t).then((function(t){return!e._preferController&&e._localPlayback?e.getCurrentState():t}))}return this._onStreamerConnect().then(this._streamer.getCurrentState.bind(this._streamer))}},{key:"pause",value:function(e,t){var n=this;return this._runOnDevice(e,(function(){return n._streamer.pause()}),this._controller.pause.bind(this._controller,e,t),{loggingParams:null==t?void 0:t.loggingParams})}},{key:"resume",value:function(e,t){var n=this;return this._runOnDevice(e,(function(){return n._streamer.resume()}),this._controller.resume.bind(this._controller,e,t),{loggingParams:null==t?void 0:t.loggingParams})}},{key:"togglePlay",value:function(e,t){var n=this;return this._runOnDevice(e,(function(){return n._streamer.togglePlay()}),this._controller.togglePlay.bind(this._controller,e,t),{loggingParams:null==t?void 0:t.loggingParams})}},{key:"playURI",value:function(e,t,n){var r=this;return this._canStartNewContext(t).then((function(){return r._autoActivateElement&&r._activateElement(),r._controller.playURI(e,t,n)}))}},{key:"playPages",value:function(e,t,n){var r=this;return this._canStartNewContext(t).then((function(){return r._autoActivateElement&&r._activateElement(),r._controller.playPages(e,t,n)}))}},{key:"playTracks",value:function(e,t,n){var r=this;return this._canStartNewContext(t).then((function(){return r._autoActivateElement&&r._activateElement(),r._controller.playTracks(e,t,n)}))}},{key:"nextTrack",value:function(e,t){var n=this,r={},i=function(){return n._streamer.nextTrack(s.FORWARD_BUTTON)},a=this._controller.nextTrack.bind(this._controller,e,r);return(null==t?void 0:t.track)&&(i=a,r.track=this._prepareSkipTrack(t.track)),(null==t?void 0:t.loggingParams)&&(r.loggingParams=t.loggingParams),this._runOnDevice(e,i,a,{loggingParams:null==t?void 0:t.loggingParams})}},{key:"smartPreviousTrack",value:function(e,t){var n=this;return this.getCurrentState().then((function(r){return r?(r.disallows||{}).seeking||r.position<3e3&&r.track_window&&r.track_window.previous_tracks&&r.track_window.previous_tracks.length>0?n.previousTrack(e,t):n.seek(0,e):Promise.reject(new P(i.HARMONY_NO_TRACKS_LOADED,"No current state."))}))}},{key:"previousTrack",value:function(e,t){var n=this,r={},i=function(){return n._streamer.previousTrack(s.FORWARD_BUTTON)},a=this._controller.previousTrack.bind(this._controller,e,r);return(null==t?void 0:t.track)&&(i=a,r.track=this._prepareSkipTrack(t.track)),(null==t?void 0:t.loggingParams)&&(r.loggingParams=t.loggingParams),this._runOnDevice(e,i,a,{loggingParams:null==t?void 0:t.loggingParams})}},{key:"seek",value:function(e,t){var n=this;return this._runOnDevice(t,(function(){return n._streamer.seek(e)}),this._controller.seek.bind(this._controller,e,t))}},{key:"seekForward",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:15e3,t=arguments.length>1?arguments[1]:void 0;return this._movePosition(e,t)}},{key:"seekBackward",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:15e3,t=arguments.length>1?arguments[1]:void 0;return this._movePosition(-1*e,t)}},{key:"getVolume",value:function(){return this._streamer?this._streamer.getVolume():Promise.resolve(-1)}},{key:"setVolume",value:function(e,t){var n=this;return this._runOnDevice(t,(function(){return n._streamer.setVolume(e)}),this._controller.setVolume.bind(this._controller,e),{bypassFakeState:!0})}},{key:"getVideoProfiles",value:function(){if(!this._streamer)throw new P(i.HARMONY_OPERATION_FORBIDDEN,"No streamer provided.");return this._streamer.getVideoVariants()}},{key:"setPreferredBitrate",value:function(e){if(!this._streamer)throw new P(i.HARMONY_OPERATION_FORBIDDEN,"No streamer provided.");return this._streamer.setPreferredBitrate(e)}},{key:"getDevices",value:function(){var e=this;return this._controller.getDevices().then(this._parseDeviceList).then((function(t){return e._lastDeviceList=t,t}))}},{key:"setQueue",value:function(e,t,n){var r=this._controller.setQueue.bind(this._controller,e,t,n);return this._runOnDevice(n,r,r)}},{key:"addToQueue",value:function(e,t){var n=e.map((function(e){return"string"==typeof e?e:e.uri}));return this._controller.getQueueManager().addToQueue(n,t)}},{key:"setShuffle",value:function(e,t,n){var r=this._controller.setShuffle.bind(this._controller,e,t,n);return this._runOnDevice(t,r,r,{loggingParams:null==n?void 0:n.loggingParams})}},{key:"toggleShuffle",value:function(e,t){var n=this._controller.toggleShuffle.bind(this._controller,e,t);return this._runOnDevice(e,n,n,{loggingParams:null==t?void 0:t.loggingParams})}},{key:"setRepeatMode",value:function(e,t){var n=this._controller.setRepeatMode.bind(this._controller,e,t);return this._runOnDevice(t,n,n)}},{key:"cycleRepeatMode",value:function(e){var t=this._cycleRepeatMode.bind(this,e);return this._runOnDevice(e,t,t)}},{key:"transfer",value:function(e,t){var n=e||S,r=this._controller.transfer.bind(this._controller,n,t);return this._autoActivateElement&&this._activateElement(),this._runOnDevice(n,r,r,{bypassFakeState:!0,loggingParams:null==t?void 0:t.loggingParams})}},{key:"logout",value:function(e){return this._controller.logout(e||S)}},{key:"activateElement",value:function(){return this._streamer?this._streamer.activateElement():Promise.reject(new P(i.HARMONY_LOCAL_PLAYER_DISABLED,"Cannot activate element; local player is disabled."))}},{key:"getQueueManager",value:function(){var e=this;return this._controller.getQueueManager((function(t,n){return e._runOnDevice(n,t,t)}),{reportInactiveQueues:this._claimInactivePlayerStates,onlyLocalQueue:this._onlyLocalState,reportInitial:this._hasFakeState||this._localPlayback})}},{key:"hideSubtitles",value:function(){return this._localPlayback?this._streamer?this._streamer.hideSubtitles():Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"No streamer provided.")):Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"Cannot hide subtitles on remote player."))}},{key:"showSubtitles",value:function(){return this._localPlayback?this._streamer?this._streamer.showSubtitles():Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"No streamer provided.")):Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"Cannot show subtitles on remote player."))}},{key:"areSubtitlesShown",value:function(){return this._localPlayback?this._streamer?this._streamer.areSubtitlesShown():Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"No streamer provided.")):Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"Cannot show subtitles on remote player."))}},{key:"getSubtitleLanguages",value:function(){return this._localPlayback?this._streamer?this._streamer.getSubtitleLanguages():Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"No streamer provided.")):Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"Cannot get subtitle languages on remote player."))}},{key:"getActiveSubtitleLanguage",value:function(){return this._localPlayback?this._streamer?this._streamer.getActiveSubtitleLanguage():Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"No streamer provided.")):Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"Cannot get subtitle language on remote player."))}},{key:"setSubtitleLanguage",value:function(e){return this._localPlayback?this._streamer?this._streamer.setSubtitleLanguage(e):Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"No streamer provided.")):Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"Cannot set subtitle languages on remote player."))}},{key:"deactivateSubtitleEvents",value:function(){return this._localPlayback?this._streamer?this._streamer.activateSubtitleEvents():Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"No streamer provided.")):Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"Cannot deactivate subtitle events on remote player."))}},{key:"activateSubtitleEvents",value:function(){return this._localPlayback?this._streamer?this._streamer.activateSubtitleEvents():Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"No streamer provided.")):Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"Cannot activate subtitle events on remote player."))}},{key:"setBackgrounded",value:function(e){return this._localPlayback?this._streamer?this._streamer.setBackgrounded(e):Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"No streamer provided.")):Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"Cannot set background mode on remote player."))}},{key:"setVideoResolution",value:function(e){return this._localPlayback?this._streamer?this._streamer.setVideoResolution(e):Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"No streamer provided.")):Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"Cannot set preferred video resolution on remote player."))}},{key:"getMediaConfig",value:function(){return this._streamer?this._streamer.getMediaConfig():Promise.reject(new P(i.HARMONY_LOCAL_PLAYER_DISABLED,"Cannot activate element; local player is disabled."))}},{key:"setPlaybackSpeed",value:function(e){var t=this._streamer;return t?this.getCurrentState().then((function(n){var r;return"episode"!==(null===(r=null==n?void 0:n.track_window.current_track)||void 0===r?void 0:r.type)?Promise.reject(new P(i.HARMONY_OPERATION_FORBIDDEN,"Cannot change playback speed; content type is not an episode.")):t.setPlaybackSpeed(e)})):Promise.reject(new P(i.HARMONY_LOCAL_PLAYER_DISABLED,"Cannot change speed; local player is disabled."))}}],[{key:"create",value:function(e){return new n(e)}}]),n}(p.vp),K=(n(86061),n(37557),n(77321)),V=n(85295),G=n(71568);!function(e){e.FILE_URLS_MP3="file_urls_mp3",e.FILE_URLS_EXTERNAL="file_urls_external",e.FILE_IDS_MP3="file_ids_mp3",e.FILE_IDS_MP4="file_ids_mp4",e.FILE_IDS_MP4_DUAL="file_ids_mp4_dual",e.FILE_IDS_CBCS="file_ids_mp4_cbcs",e.FILE_IDS_MP4FLAC="file_ids_mp4flac",e.MANIFEST_IDS_VIDEO="manifest_ids_video"}(B||(B={})),function(e){e.UNKNOWN="unknown",e.COMPUTER="computer",e.TABLET="tablet",e.SMARTPHONE="smartphone",e.SPEAKER="speaker",e.TV="tv",e.AVR="avr",e.STB="stb",e.AUDIO_DONGLE="audio_dongle",e.GAME_CONSOLE="game_console",e.CAST_VIDEO="cast_video",e.CAST_AUDIO="cast_audio",e.AUTOMOBILE="automobile",e.SMARTWATCH="smartwatch",e.CHROMEBOOK="chromebook"}(x||(x={}));n(92782),n(40049),n(69253),n(32869),n(10534),n(65859),n(35943),n(65928),n(85532),n(69858),n(92166),n(15645),n(83013),n(88673),n(89802),n(10388),n(81536),n(82506),n(91),n(66259),n(82775),n(38281),n(7243),n(91200),n(43178),n(16751),n(66607),n(99051),n(97343),n(47869),n(71044),n(33428);var H=n(23265);function j(){var e=new Uint8Array(16);return crypto.getRandomValues(e),H.R.toHex(e.join(""),40).slice(0,40)}function q(){for(var e=new Array(27),t=e.length;t--;)e[t]=Math.floor(8*Math.random());return H.R.toHex(e.join(""),40)}var W="undefined"!=typeof crypto&&"function"==typeof crypto.getRandomValues?j:q,Q="_spharmony_device_id";var z={get:function(e){if(e&&"string"==typeof e)return e;if(arguments.length>1&&void 0!==arguments[1]&&arguments[1])return W();var t=localStorage.getItem(Q);return t||(t=W(),localStorage.setItem(Q,t)),t},generate:W,generateWithCrypto:j,generateWithRandom:q};n(17520);function X(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var J=function(e){(0,f.Z)(n,e);var t=X(n);function n(e){var r,i;if((0,c.Z)(this,n),(r=t.call(this))._platformVersion="",r._metadata={},r._manifestPrependOffset=0,!e)throw new TypeError("Invalid argument `options`.");if(!e.id)throw new TypeError("Argument `options.id` is required.");if(!e.name||!e.model||!e.type)throw new TypeError("Incomplete `options` value.");return r._id=e.id,r._type=e.type,r._brand=e.brand,r._model=e.model,r._isGroup=!!e.is_group,r._name=e.name,r._platformName=e.platform_name,r._platformIdentifier=e.platform_identifier,r._platformVersion=e.platform_version||"",r._metadata=e.metadata||{},r._capabilities=e.capabilities||{manifest_formats:[]},r._manifestPrependOffset=(null===(i=r._capabilities.manifest_formats)||void 0===i?void 0:i.length)||0,r}return(0,_.Z)(n,[{key:"getId",value:function(){return this._id}},{key:"setCapability",value:function(e,t){if("manifest_formats"===e)throw new TypeError('Cannot change capability "manifest_formats"');return this._capabilities[e]=t,this.emit("descriptor_changed",{descriptor:this.toJSON()}),!0}},{key:"getCapability",value:function(e){if("manifest_formats"===e)throw new TypeError("Use `descriptor.getManifestFormats()`.");return this._capabilities[e]}},{key:"setName",value:function(e){return this._name=e,this.emit("descriptor_changed",{descriptor:this.toJSON()}),!0}},{key:"getName",value:function(){return this._name}},{key:"getType",value:function(){return this._type}},{key:"getBrand",value:function(){return this._brand}},{key:"getModel",value:function(){return this._model}},{key:"getPlatformIdentifier",value:function(){return this._platformIdentifier||"Partner ".concat(this._brand," ").concat(this._model)}},{key:"getPlatformName",value:function(){return this._platformName||this.getPlatformIdentifier()}},{key:"getPlatformVersion",value:function(){return this._platformVersion}},{key:"getManifestFormats",value:function(){return this._capabilities.manifest_formats||[]}},{key:"appendManifestFormat",value:function(){var e=this._capabilities.manifest_formats;Array.isArray(e)&&e.push.apply(e,arguments)}},{key:"prependManifestFormat",value:function(){var e=this._capabilities.manifest_formats;if(Array.isArray(e)){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];e.splice.apply(e,[this._manifestPrependOffset,0].concat(n))}}},{key:"toJSON",value:function(){return{brand:this._brand,capabilities:Object.assign({},this._capabilities),id:this._id,metadata:Object.assign({},this._metadata),model:this._model,name:this._name,platform_name:this._platformName,platform_identifier:this._platformIdentifier,platform_version:this._platformVersion,type:this._type}}},{key:"toTrackPlaybackDeviceInfo",value:function(){return{brand:this._brand,capabilities:Object.assign({},this._capabilities),device_id:this._id,device_type:this._type,metadata:Object.assign({},this._metadata),model:this._model,name:this._name,platform_name:this._platformName,platform_identifier:this._platformIdentifier,is_group:this._isGroup}}}],[{key:"create",value:function(e){return new n({id:z.get(e.id,e.randomizeId),model:e.model||(0,G._)("harmony-{{name}}.{{version}}-{{platform}}").toLowerCase(),name:e.nameTemplate?(0,G._)(e.nameTemplate):e.name||(t=(0,G._)("Spotify ({{name}}/{{platform}})"),t.replace(/\b[a-z]/g,(function(e){return e.toUpperCase()}))),type:e.type||x.COMPUTER,brand:e.brand||"SpotifyHarmonyGeneric",platform_name:e.platform_name,platform_identifier:e.platform_identifier,platform_version:e.platform_version,metadata:e.metadata||{},capabilities:e.capabilities||{},is_group:!!e.is_group});var t}}]),n}(p.vp);const $={tagged:"4.27.1-af7f4f3",version:"4.27.1",revision:"af7f4f3"};n(84995);var ee=n(6768);function te(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return ne(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ne(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function ne(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var re=function(){function e(t){(0,c.Z)(this,e),this._melodyLogger=new ee.Hx(t)}return(0,_.Z)(e,[{key:"logClientEvent",value:function(e,t){return e?this._melodyLogger.sendLog("/v1/msg/batch",{type:"client_event",message:{source:e.source||ee.eV.UNKNOWN,context:e.context||ee.eV.UNKNOWN,event:e.event||ee.eV.UNKNOWN,event_version:e.event_version||ee.eV.EMPTY,test_version:e.test_version||ee.eV.EMPTY,source_version:e.source_version||ee.eV.UNKNOWN,source_vendor:e.source_vendor||ee.eV.UNKNOWN,json_data:"json"===t?e.json_data||"{}":JSON.stringify(e.json_data||{})}},{batch:!0}):Promise.reject(new TypeError("Logger.logClientEvent `data` cannot be null."))}},{key:"logMetrics",value:function(e,t){if(!e&&!t)return Promise.resolve(!0);var n=e||[],r=t||[];if(!n.length&&!r.length)return Promise.resolve(!0);if(!Array.isArray(n)||!Array.isArray(r))return Promise.reject(new TypeError("Logger.logMetrics `meters` and `timers` must be null or an array."));var i,a=te(n);try{for(a.s();!(i=a.n()).done;){var o=i.value;if(!("what"in o)||!("result"in o)||!("reason"in o))return Promise.reject(new TypeError("Logger.logMetrics: Invalid meter format in `meters` array."))}}catch(c){a.e(c)}finally{a.f()}var s,u=te(r);try{for(u.s();!(s=u.n()).done;){var l=s.value;if(!("what"in l)||!("duration"in l))return Promise.reject(new TypeError("Logger.logMetrics: Invalid timer format in `timers` array."))}}catch(c){u.e(c)}finally{u.f()}return this._melodyLogger.sendLog("/v1/metric",{sdk_id:void 0,platform:void 0,client_version:void 0,meters:n,timers:r})}},{key:"logJSSDKError",value:function(e,t){return this._melodyLogger.sendLog("/v1/msg/batch",{type:"jssdk_error",message:{source:e.source||ee.eV.UNKNOWN,source_version:e.source_version||ee.eV.UNKNOWN,type:e.type||ee.eV.UNKNOWN,message:e.message||ee.eV.EMPTY,stack:JSON.stringify(e.stack||ee.eV.EMPTY),json_data:"json"===t?e.json_data||"{}":JSON.stringify(e.json_data||{}),json_data_version:e.json_data_version||ee.eV.EMPTY_VERSION}},{batch:!0})}},{key:"logJSSDKContentRequest",value:function(e){var t;return this._melodyLogger.sendLog("/v1/msg/jssdk_content_request",{source:e.source||ee.eV.UNKNOWN,type:e.type||ee.eV.UNKNOWN,http_status:null!==(t=e.http_status)&&void 0!==t?t:void 0,ms_request_duration:e.ms_request_duration||ee.eV.EMPTY,n_retries:e.n_retries||ee.eV.ZERO,playback_id:e.playback_id||ee.eV.EMPTY})}}]),e}();function ie(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var ae=K.P.forTag("harmonyclient"),oe=/^[a-zA-Z0-9_%:-]{1,40}$/,se=function(e){(0,f.Z)(n,e);var t=ie(n);function n(e){var r;if((0,c.Z)(this,n),(r=t.call(this))._platformIdentifier=(0,g.$)(),r._platformVersion=(0,g.$)(),!e)throw new TypeError("Argument `options` is not defined.");if(!e.transport)throw new TypeError("No Transport instance provided");if(!e.transport.hasPlugin("dealer"))throw new TypeError("Transport has no Dealer plugin.");return r._transport=e.transport,r._deviceDescriptor=r._initDeviceDescriptor(e),r._logger=new re({transport:r._transport.toPublic(),sdkId:r.getSDKId(),platform:r._platformIdentifier.promise,clientVersion:r._platformVersion.promise}),r._productStateObserver=V.A.create({transport:r._transport}),r._onConnected=r._onConnected.bind((0,d.Z)(r)),r._onAuthenticated=r._onAuthenticated.bind((0,d.Z)(r)),r._onConnectionError=r._onConnectionError.bind((0,d.Z)(r)),r._onAuthenticationError=r._onAuthenticationError.bind((0,d.Z)(r)),r._onShortSessionDisconnect=r._onShortSessionDisconnect.bind((0,d.Z)(r)),r._attachListeners(),r}return(0,_.Z)(n,[{key:"_createDeviceDescriptor",value:function(e){var t,n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if((null==r?void 0:r.id)&&!oe.test(r.id))throw P.fatal(i.HARMONY_INVALID_DESCRIPTOR_ID,"Invalid device id.");var a=r.capabilities||{},o={change_volume:null===(t=a.change_volume)||void 0===t||t,endsong_snooping:a.endsong_snooping,enable_play_token:!0,supports_file_media_type:!0,play_token_lost_behavior:e.playTokenLostBehavior||"pause",disable_connect:!!e.hidden,audio_podcasts:null===(n=a.audio_podcasts)||void 0===n||n,video_playback:a.video_playback,lossless_playback:a.lossless_playback,volume_steps:void 0!==a.volume_steps&&a.volume_steps>=0&&a.volume_steps<R?a.volume_steps:void 0,manifest_formats:[B.FILE_IDS_MP3,B.FILE_URLS_MP3]},s=J.create(Object.assign(Object.assign({},r),{capabilities:o}));return this._platformIdentifier.resolve(s.getPlatformIdentifier()),this._platformVersion.resolve(s.getPlatformVersion()),this.proxyEmit(s,"descriptor_changed","descriptor_changed"),s}},{key:"_initDeviceDescriptor",value:function(e){var t=this;return Promise.resolve(e.descriptor).then(this._createDeviceDescriptor.bind(this,e)).catch((function(e){return t._onError(y.HARMONY,{error:e}),Promise.reject(e)}))}},{key:"_attachListeners",value:function(){var e=this,t=this._transport;t.on(o.TransportEvent.CONNECTED,this._onConnected),t.on(o.TransportEvent.AUTHENTICATED,this._onAuthenticated),t.on(o.TransportEvent.CONNECTION_FAILED,this._onConnectionError),t.on(o.TransportEvent.AUTHENTICATION_FAILED,this._onAuthenticationError),this.proxyEmit(t,o.TransportEvent.RECONNECTING,"reconnecting"),this.proxyEmit(t,o.TransportEvent.RECONNECTED,"reconnected"),this.proxyEmit(t,o.TransportEvent.LOGGED_OUT,"logged_out"),this.proxyEmitSync(t,o.TransportEvent.BEFORE_OFFLINE_DISCONNECT,"before_offline_disconnect"),this.proxyEmitSync(t,o.TransportEvent.BEFORE_ONLINE_DISCONNECT,"before_disconnect"),t.on(o.TransportEvent.SHORT_SESSION_DISCONNECTED,this._onShortSessionDisconnect.bind(this)),this.proxyEmit(this._productStateObserver,o.TransportEvent.PRODUCT_STATE_CHANGED,"product_state_changed"),this.on("before_disconnect",(function(t){var n=e._productStateObserver.deregister().catch((function(){}));t.data.awaitPromise(n)}))}},{key:"_onError",value:function(e,t){this.emit("error",{source:e,error:t.error}),t.error&&t.error.unrecoverable&&this.emit("unrecoverable_failure",{source:e,error:t.error})}},{key:"_onConnected",value:function(){this.emit("connected",null)}},{key:"_onAuthenticated",value:function(){this.emit("authenticated",null)}},{key:"_onConnectionError",value:function(e){this._onError(y.TRANSPORT,{error:e.data.error}),this.emit("connection_error",e.data)}},{key:"_onAuthenticationError",value:function(e){this._onError(y.TRANSPORT,{error:e.data.error}),this.emit("authentication_error",e.data)}},{key:"_onShortSessionDisconnect",value:function(e){this._logger.logClientEvent({source:"transport",source_version:$.tagged,source_vendor:"spotify",event:e.type,event_version:"1.0.0",json_data:{disconnectCount:e.data.disconnectCount,sessionLength:e.data.sessionLength}},"object").catch((function(t){return ae.warn("".concat(e.type," Logging Error:"),t)}))}},{key:"getVersionDescriptor",value:function(){return Object.assign({},$)}},{key:"getSDKId",value:function(){return"harmony:".concat($.tagged)}},{key:"getUntaggedSDKId",value:function(){return"harmony:".concat($.version)}},{key:"getPlatformIdentifier",value:function(){return this._platformIdentifier.promise}},{key:"getPlatformVersion",value:function(){return this._platformVersion.promise}},{key:"getLogger",value:function(){return this._logger}},{key:"logAppMetrics",value:function(e,t){if(!this._logger)throw new TypeError("Invalid logger instance");return this._logger.logMetrics(e,t)}},{key:"request",value:function(e,t){return this._transport.request(e,t)}},{key:"getPublicTransport",value:function(){return this._transport.toPublic()}},{key:"getClientDescriptor",value:function(){return this._deviceDescriptor.then((function(e){return e.toJSON()}))}},{key:"getDeviceDescriptor",value:function(){return this._deviceDescriptor}},{key:"getUserInfo",value:function(){return this._transport.request("@webapi/v1/me",{responseType:"json"}).then((function(e){var t=e.body;if(200!==e.status){var n=new P(i.USER_INFO_REQUEST_FAILED_WITH_STATUS,"User info request failed with status ".concat(e.status));return n.status=e.status,Promise.reject(n)}return t?{display_name:t.display_name,followers:t.followers,id:t.id,images:t.images,uri:t.uri}:Promise.reject(new P(i.USER_INFO_REQUEST_EMPTY_RESPONSE,"Unexpected empty response."))}))}},{key:"getProductState",value:function(){return this._productStateObserver.getCurrentState()}},{key:"setName",value:function(e){return this._deviceDescriptor.then((function(t){return t.setName(e)}))}},{key:"setNameTemplate",value:function(e){return this.setName((0,G._)(e))}},{key:"setCapability",value:function(e,t){return this._deviceDescriptor.then((function(n){return n.setCapability(e,t)}))}},{key:"notifyError",value:function(e,t){this._onError(e,{error:t})}}],[{key:"create",value:function(e){return new n(e)}},{key:"of",value:function(e){return e._client}}]),n}(p.vp);n(53301);var ue,le,ce,_e,de,fe=n(26336),he=n(46506),ve=(n(2661),n(473),n(77418),n(11937),n(69956),n(84366));function pe(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}!function(e){e.KEY_SESSION_MESSAGE="message",e.KEY_SESSION_STATUSES_CHANGE="keystatuseschange",e.MEDIA_SOURCE_OPEN="sourceopen",e.MEDIA_SOURCE_CLOSE="sourceclose",e.SOURCE_BUFFER_UPDATE_END="updateend",e.MS_KEY_ADDED="mskeyadded",e.MS_KEY_ERROR="mskeyerror",e.MS_KEY_MESSAGE="mskeymessage",e.MS_NEEDKEY="msneedkey",e.WEBKIT_KEY_ADDED="webkitkeyadded",e.WEBKIT_KEY_ERROR="webkitkeyerror",e.WEBKIT_KEY_MESSAGE="webkitkeymessage",e.WEBKIT_NEEDKEY="webkitneedkey",e.V0_1B_KEY_ADDED="keyadded",e.V0_1B_KEY_ERROR="keyerror",e.V0_1B_KEY_MESSAGE="keymessage",e.V0_1B_NEEDKEY="needkey",e.MEDIA_CANPLAY="canplay",e.MEDIA_CANPLAYTHROUGH="canplaythrough",e.MEDIA_DURATIONCHANGE="durationchange",e.MEDIA_ENCRYPTED="encrypted",e.MEDIA_ENDED="ended",e.MEDIA_ERROR="error",e.MEDIA_LOADEDMETADATA="loadedmetadata",e.MEDIA_PAUSE="pause",e.MEDIA_PLAY="play",e.MEDIA_PLAYING="playing",e.MEDIA_SEEKING="seeking",e.MEDIA_TIMEUPDATE="timeupdate",e.MEDIA_WAITING="waiting",e.MEDIA_RATECHANGE="ratechange",e.MEDIA_RESIZE="resize",e.INTERNAL_ENCRYPTED="__encrypted",e.INTERNAL_PLAYER_CANPLAY="__canplay",e.INTERNAL_PLAYER_CANPLAYTHROUGH="__canplaythrough",e.INTERNAL_MEDIA_REQUIRES_DURATION="__requiresduration",e.INTERNAL_PLAYER_LOADED_METADATA="__loadedmetadata",e.BUFFER_APPEND_ERROR="append_error",e.BUFFER_STALLED="stalled",e.BUFFERING_START="buffering_start",e.BUFFERING_END="buffering_end",e.BUFFER_SOURCE_OPEN="source_open",e.BUFFER_SOURCE_CLOSE="source_close",e.BUFFER_QUOTA_EXCEEDED="quota_exceeded",e.FRAGMENT_APPENDED="fragment_appended",e.EME_LICENSE_REQUEST_ERROR="license_request_error",e.EME_LICENSE_REQUEST_CAPPED="license_request_capped",e.LIST_PLAYER_AUTOPLAY_FAILED="player_autoplay_failed",e.LIST_PLAYER_BEFORE_LIST_CHANGE="before_list_change",e.LIST_PLAYER_BEFORE_NEXT="before_next",e.LIST_PLAYER_BEFORE_PLAYER_LOAD="before_player_load",e.LIST_PLAYER_BEFORE_PREVIOUS="before_previous",e.LIST_PLAYER_BEFORE_TRACK_LOAD="before_track_load",e.LIST_PLAYER_BEFORE_VOLUME_CHANGE="before_volume_change",e.LIST_PLAYER_BUFFER_STALLED="stalled",e.LIST_PLAYER_BUFFERING_START="buffering_start",e.LIST_PLAYER_BUFFERING_END="buffering_end",e.LIST_PLAYER_CAPPED="capped",e.LIST_PLAYER_CLEARED="cleared",e.LIST_PLAYER_DURATION_CHANGED="duration_changed",e.LIST_PLAYER_ERROR="error",e.LIST_PLAYER_ERROR_SYNC="error_sync",e.LIST_PLAYER_LIST_CHANGED="list_change",e.LIST_PLAYER_LIST_ENDED="list_ended",e.LIST_PLAYER_LOAD_VIDEO="load_video",e.LIST_PLAYER_MAX_LIST_ERRORS_REACHED="max_list_errors_reached",e.LIST_PLAYER_PAUSED="paused",e.LIST_PLAYER_PLAYED_THRESHOLD_REACHED="played_threshold_reached",e.LIST_PLAYER_PLAYER_LOAD="player_load",e.LIST_PLAYER_PLAYING="playing",e.LIST_PLAYER_POSITION_CHANGED="position_changed",e.LIST_PLAYER_PROGRESS="progress",e.LIST_PLAYER_REPEAT_MODE_CHANGED="repeat_mode_changed",e.LIST_PLAYER_SHUFFLE_CHANGED="shuffle_changed",e.LIST_PLAYER_STOPPED="stopped",e.LIST_PLAYER_STOPPED_VIDEO="stopped_video",e.LIST_PLAYER_TRACKING_DATA_CREATED="tracking_data_created",e.LIST_PLAYER_TRACKING_DATA_FINALIZED="tracking_data_finalized",e.LIST_PLAYER_TRACK_ENDED="track_ended",e.LIST_PLAYER_TRACK_LOADED="track_loaded",e.LIST_PLAYER_TRACK_TIMEOUT="track_timeout",e.LIST_PLAYER_TRACK_UNPLAYABLE="track_unplayable",e.LIST_PLAYER_DATA_CREATED="tracking_data_created",e.LIST_PLAYER_DATA_FINALIZED="tracking_data_finalized",e.LIST_PLAYER_VOLUME_CHANGED="volume_changed",e.LIST_PLAYER_VIDEO_ELEMENT_APPENDED="video_element_appended",e.LIST_PLAYER_VIDEO_ELEMENT_REMOVED="video_element_removed",e.LIST_PLAYER_VIDEO_PROFILE_CHANGED="video_profile_changed",e.LIST_PLAYER_SEEK_HANDLED="list_player_seek_handled",e.LIST_PLAYER_DISPLAYED_CUES_CHANGED="displayed_cues_changed",e.LIST_PLAYER_PLAYBACK_SPEED_CHANGED="playback_speed_changed",e.LIST_PLAYER_SUBTITLE_LANGUAGES_LOADED="subtitle_languages_loaded",e.LOGGER_ERROR="error",e.PLAYER_AUTOPLAY_FAILED="player_autoplay_failed",e.PLAYER_BEFORE_LOAD="before_load",e.PLAYER_BEFORE_STOP="before_stop",e.PLAYER_BEFORE_VOLUME_CHANGE="before_volume_change",e.PLAYER_BUFFER_STALLED="stalled",e.PLAYER_BUFFERING_START="buffering_start",e.PLAYER_BUFFERING_END="buffering_end",e.PLAYER_CAN_PRELOAD="can_preload",e.PLAYER_CAPPED="capped",e.PLAYER_DURATION_CHANGED="duration_changed",e.PLAYER_ENDED="ended",e.PLAYER_ENDED_VIDEO="ended_video",e.PLAYER_ERROR="error",e.PLAYER_WARNING="warning",e.PLAYER_FIRST_BYTES="first_bytes",e.PLAYER_KEY_RECEIVED="key",e.PLAYER_LOAD="load",e.PLAYER_LOAD_VIDEO="load_video",e.PLAYER_LOADING_FAILED="loading_failed",e.PLAYER_PAUSED="paused",e.PLAYER_PLAY="play",e.PLAYER_PLAYING="playing",e.PLAYER_POSITION_CHANGED="position_changed",e.PLAYER_PRELOADING_ERROR="preloading_error",e.PLAYER_PROGRESS="progress",e.PLAYER_STALLED="stalled",e.PLAYER_STOPPED="stopped",e.PLAYER_STOPPED_VIDEO="stopped_video",e.PLAYER_PLAYED_THRESHOLD_REACHED="played_threshold_reached",e.PLAYER_TIMEOUT="timeout",e.PLAYER_PLAYBACK_START="playback_start",e.PLAYER_TRACKING_DATA_CREATED="tracking_data_created",e.PLAYER_TRACKING_DATA_FINALIZED="tracking_data_finalized",e.PLAYER_VIDEO_ELEMENT_APPENDED="video_element_appended",e.PLAYER_VIDEO_ELEMENT_REMOVED="video_element_removed",e.PLAYER_VIDEO_PROFILE_CHANGED="video_profile_changed",e.PLAYER_DISPLAYED_CUES_CHANGED="displayed_cues_changed",e.PLAYER_SEEKING="seeking",e.PLAYER_FRAGMENT_FETCHED="fragment_fetched",e.PLAYER_FRAGMENT_FETCH_ERROR="fragment_fetch_error",e.PLAYER_VIDEO_MANIFEST_RESOLVED="video_manifest_resolved",e.PLAYER_VIDEO_MANIFEST_RESOLVE_FAILED="video_manifest_resolve_failed",e.PLAYER_PLAYBACK_SPEED_CHANGED="playback_speed_changed",e.PLAYER_SUBTITLE_LANGUAGES_LOADED="subtitle_languages_loaded",e.PLAYER_VIDEO_RESIZED="resize",e.PLAYER_MANAGER_READY="ready",e.TRACKER_PLAYBACK_START="playback_start",e.TRACKER_PLAYED_THRESHOLD_REACHED="played_threshold_reached",e.TRACKER_TRACKING_DATA_CREATED="tracking_data_created",e.TRACKER_TRACKING_DATA_FINALIZED="tracking_data_finalized",e.VIDEO_MANIFEST_RESOLVED="video_manifest_resolved",e.VIDEO_MANIFEST_RESOLVE_FAILED="video_manifest_resolve_failed",e.ABR_MANAGER_BITRATE_CHANGE="bitrate_change"}(ue||(ue={})),function(e){e.WIDEVINE="com.widevine.alpha",e.PLAYREADY="com.microsoft.playready",e.PLAYREADY_HARDWARE="com.microsoft.playready.hardware",e.FAIRPLAY="com.apple.fps.1_0",e.INVALID_SPOTIFY_KEY="com.spotify.invalid"}(le||(le={})),function(e){e.SUCCESS="RESULT_SUCCESS",e.INVALID="RESULT_INVALID",e.FORBIDDEN="RESULT_FORBIDDEN",e.OUT_OF_BOUNDS="RESULT_OUT_OF_BOUNDS",e.NO_LIST="RESULT_NO_LIST",e.NO_TRACK="RESULT_NO_TRACK",e.LIST_END="RESULT_LIST_END",e.INVALID_TRACK="RESULT_INVALID_TRACK",e.CANCELLED="CANCELLED",e.NO_TRACK_PLAYER="NO_TRACK_PLAYER"}(ce||(ce={})),function(e){e.MP3="MP3",e.MP4="MP4",e.MP4_DUAL="MP4_DUAL",e.MP4_CBCS="MP4_CBCS",e.MP4_FLAC="MP4_FLAC",e.MANIFEST_ID="MANIFEST_ID"}(_e||(_e={})),function(e){e.FRAGMENT_FETCHED="fragment_fetched",e.FRAGMENT_FETCH_ERROR="fragment_fetch_error",e.VIDEO_PROFILE_CHANGED="video_profile",e.SUBTITLE_LANGUAGES_LOADED="subtitle_languages_loaded"}(de||(de={}));var Ee=function(e){(0,f.Z)(n,e);var t=pe(n);function n(e,r){var i;return(0,c.Z)(this,n),(i=t.call(this,r)).unrecoverable=!1,i.listPlayerIgnore=!1,i.debug={},i.code=e,i.message=r,i.name="PlaybackError",i}return(0,_.Z)(n,null,[{key:"fatal",value:function(e,t){var r=new n(e,t);return r.unrecoverable=!0,r}}]),n}((0,A.Z)(Error));function ye(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var me=function(e){(0,f.Z)(n,e);var t=ye(n);function n(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:r.STORAGE_ERROR,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"File Error";return(0,c.Z)(this,n),(e=t.call(this,a)).canPlayNext=!0,e.debug={},e.code=i,e.message=a,e.name="FileError",e}return(0,_.Z)(n)}((0,A.Z)(Error)),ge=(n(414),n(33194),n(48802),n(28648),n(30536),n(95919),n(11177),n(45397),n(20464),n(25248),n(40274),n(39222));function Se(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var Re=function(e){(0,f.Z)(n,e);var t=Se(n);function n(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:r.EME_ERROR_UNKNOWN,a=arguments.length>1?arguments[1]:void 0;return(0,c.Z)(this,n),(e=t.call(this,a)).status=-1,e.licenseServer="",e.shouldRefreshEndpoint=!1,e.unrecoverable=!1,e.debug={},e.code=i,e.message=a,e.name="EMEError",e}return(0,_.Z)(n,null,[{key:"fatal",value:function(){var e=new n(arguments.length>0&&void 0!==arguments[0]?arguments[0]:r.EME_ERROR_UNKNOWN,arguments.length>1?arguments[1]:void 0);return e.unrecoverable=!0,e}}]),n}((0,A.Z)(Error));function Ae(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var Te=function(e){(0,f.Z)(n,e);var t=Ae(n);function n(e,r){var i;return(0,c.Z)(this,n),(i=t.call(this,r)).name="CappingError",i.message=r,i.code=e,i}return(0,_.Z)(n)}((0,A.Z)(Error));function Pe(e){var t=document.createEvent("Event");t.initEvent("encrypted",!1,!1),t.initDataType="cenc",t.initData=e.initData,t.fromPolyfill=!0,this.dispatchEvent(t)}function Le(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var Ie=function(e){(0,f.Z)(n,e);var t=Le(n);function n(e){var r;return(0,c.Z)(this,n),(r=t.call(this,ue.KEY_SESSION_MESSAGE,null)).messageType="license-request",r.message=e,r}return(0,_.Z)(n)}(p.B);function ke(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return De(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return De(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function De(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Ce(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var be=function(e){(0,f.Z)(n,e);var t=Ce(n);function n(e){var r;return(0,c.Z)(this,n),(r=t.call(this))._nativeKeySession=null,r._lastUpdateDeferred=(0,ge.$)(),r._lastGenerateDeferred=(0,ge.$)(),r.addEventListener=r.addListener,r.removeEventListener=r.removeListener,r._nativeMediaKeys=e,r._onKeyMessage=r._onKeyMessage.bind((0,d.Z)(r)),r._onKeyAdded=r._onKeyAdded.bind((0,d.Z)(r)),r._onKeyError=r._onKeyError.bind((0,d.Z)(r)),r}return(0,_.Z)(n,[{key:"_attach",value:function(){var e=this._nativeKeySession;e&&(e.addEventListener(ue.MS_KEY_ADDED,this._onKeyAdded),e.addEventListener(ue.MS_KEY_ERROR,this._onKeyError),e.addEventListener(ue.MS_KEY_MESSAGE,this._onKeyMessage))}},{key:"_detach",value:function(){var e=this._nativeKeySession;e&&(e.removeEventListener(ue.MS_KEY_ADDED,this._onKeyAdded),e.removeEventListener(ue.MS_KEY_ERROR,this._onKeyError),e.removeEventListener(ue.MS_KEY_MESSAGE,this._onKeyMessage))}},{key:"_onKeyMessage",value:function(e){e.message&&e.message.buffer&&(this.emitEvent(new Ie(e.message.buffer)),this._lastGenerateDeferred&&(this._lastGenerateDeferred.resolve(!0),this._lastGenerateDeferred=null))}},{key:"_onKeyAdded",value:function(){this._lastUpdateDeferred&&(this._lastUpdateDeferred.resolve(!0),this._lastUpdateDeferred=null),this._lastGenerateDeferred&&(this._lastGenerateDeferred.resolve(!0),this._lastGenerateDeferred=null),this.emit(ue.KEY_SESSION_STATUSES_CHANGE,null)}},{key:"_onKeyError",value:function(){var e=this._nativeKeySession&&this._nativeKeySession.error;this._lastGenerateDeferred&&(this._lastGenerateDeferred.reject(e),this._lastGenerateDeferred=null),this._lastUpdateDeferred&&(this._lastUpdateDeferred.reject(e),this._lastUpdateDeferred=null),this.emit(ue.KEY_SESSION_STATUSES_CHANGE,null)}},{key:"generateRequest",value:function(e,t){var n=this;return new Promise((function(e,r){n._lastGenerateDeferred&&(n._lastGenerateDeferred.resolve=e,n._lastGenerateDeferred.reject=r),n._nativeKeySession=n._nativeMediaKeys.createSession("audio/mp4",new Uint8Array(t),null),n._attach()}))}},{key:"update",value:function(e){var t=this;return new Promise((function(n,r){t._lastGenerateDeferred&&(t._lastGenerateDeferred.resolve=n,t._lastGenerateDeferred.reject=r),t._nativeKeySession&&t._nativeKeySession.update(new Uint8Array(e))}))}},{key:"close",value:function(){var e=this;return new Promise((function(t){e._nativeKeySession&&e._nativeKeySession.close(),e._detach(),t(!0)}))}}]),n}(p.vp),Oe=function(){function e(t){(0,c.Z)(this,e),this._lastBoundSetter=null,this.shouldRefreshPerTrack=!0,this._nativeMediaKeys=new MSMediaKeys(t)}return(0,_.Z)(e,[{key:"attach",value:function(e){var t=this;return new Promise((function(n){if(e.readyState>=1)return e.msSetMediaKeys(t._nativeMediaKeys),void n();var r=function n(){e.removeEventListener(ue.MEDIA_LOADEDMETADATA,n),t._lastBoundSetter=null,e.msSetMediaKeys(t._nativeMediaKeys)};t._lastBoundSetter=r,e.addEventListener(ue.MEDIA_LOADEDMETADATA,r),e.addEventListener(ue.MS_NEEDKEY,Pe),n()}))}},{key:"detach",value:function(e){this._lastBoundSetter&&(e.removeEventListener(ue.MS_NEEDKEY,Pe),e.removeEventListener(ue.MEDIA_LOADEDMETADATA,this._lastBoundSetter),this._lastBoundSetter=null)}},{key:"setServerCertificate",value:function(){return Promise.reject(new Re(r.EME_CANNOT_SET_CERTIFICATE_FOR_PLATFORM,"Cannot set server certificate on this platform."))}},{key:"createSession",value:function(){return new be(this._nativeMediaKeys)}}]),e}();function Ne(e){var t=this.mediaKeys;return t&&t!==e&&t.detach(this),delete this.mediaKeys,this.mediaKeys=e,e&&e.attach(this),Promise.resolve()}var Me=function(){function e(t,n){if((0,c.Z)(this,e),this._configuration=null,this.keySystem=t,!this._checkConfig(n))throw new Re(r.EME_NO_SUPPORTED_CONFIGURATION,"No supported configurations")}return(0,_.Z)(e,[{key:"_checkConfig",value:function(e){var t,n,r,i=this.keySystem,a=ke(e);try{for(a.s();!(r=a.n()).done;){var o=r.value,s={initDataTypes:o.initDataTypes,audioCapabilities:[],videoCapabilities:[],persistentState:"optional",distinctiveIdentifier:"optional",sessionTypes:["temporary"],label:o.label},u=void 0;if(o.audioCapabilities&&o.audioCapabilities.length&&s.audioCapabilities){u=!1;var l,c=ke(o.audioCapabilities);try{for(c.s();!(l=c.n()).done;){var _=l.value,d=null===(t=_.contentType)||void 0===t?void 0:t.split(";")[0];MSMediaKeys.isTypeSupported(i,d)&&(s.audioCapabilities.push(_),u=!0)}}catch(E){c.e(E)}finally{c.f()}}if(o.videoCapabilities&&o.videoCapabilities.length&&s.videoCapabilities){u=!1;var f,h=ke(o.videoCapabilities);try{for(h.s();!(f=h.n()).done;){var v=f.value,p=null===(n=v.contentType)||void 0===n?void 0:n.split(";")[0];MSMediaKeys.isTypeSupported(i,p)&&(s.videoCapabilities.push(v),u=!0)}}catch(E){h.e(E)}finally{h.f()}}if(u)return this._configuration=s,!0}}catch(E){a.e(E)}finally{a.f()}return!1}},{key:"getConfiguration",value:function(){return this._configuration}},{key:"createMediaKeys",value:function(){var e=this;return new Promise((function(t){t(new Oe(e.keySystem))}))}}]),e}();function we(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Ue(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Ue(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function Ue(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Fe(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var Ye=he.P.forTag("eme_polyfill.v0_1b"),Be=function(e){(0,f.Z)(n,e);var t=Fe(n);function n(e,r,i){var a;return(0,c.Z)(this,n),(a=t.call(this))._mediaElement=null,a._lastUpdateDeferred=null,a._lastGenerateResolver=null,a.sessionId=null,a._keySystem=e,a._mediaElement=r,a._prefix=i,a.addEventListener=a.addListener,a.removeEventListener=a.removeListener,a}return(0,_.Z)(n,[{key:"_addPrefix",value:function(e){return this._prefix?this._prefix+e.replace(/\b[a-z]/,(function(e){return e.toUpperCase()})):e}},{key:"generateComplete",value:function(e){this.emitEvent(new Ie(e)),this._lastGenerateResolver&&(this._lastGenerateResolver.resolve(!0),this._lastGenerateResolver=null)}},{key:"updateComplete",value:function(){this._lastUpdateDeferred&&(this._lastUpdateDeferred.resolve(!0),this._lastUpdateDeferred=null),this.emit(ue.KEY_SESSION_STATUSES_CHANGE,null)}},{key:"handleErrorEvent",value:function(e){var t=new Re(r.EME_MEDIA_KEY_SESSION_V0_1B_ERROR,"MediaKeySession v0.1b Error");t.debug.errorCode=e.errorCode,t.debug.systemCode=e.systemCode,!e.sessionId&&this._lastGenerateResolver?(this._lastGenerateResolver.reject(t),this._lastGenerateResolver=null):e.sessionId&&this._lastUpdateDeferred?(this._lastUpdateDeferred.reject(t),this._lastUpdateDeferred=null):this.emit(ue.KEY_SESSION_STATUSES_CHANGE,null)}},{key:"generateRequest",value:function(e,t){var n=this;return this._mediaElement?new Promise((function(e,r){n._lastGenerateResolver={resolve:e,reject:r};try{n._mediaElement[n._addPrefix("generateKeyRequest")](n._keySystem,new Uint8Array(t))}catch(i){r(i),n._lastGenerateResolver=null}})):Promise.reject(new ReferenceError("InvalidState: Media keys are not attached."))}},{key:"update",value:function(e){if(!this._mediaElement)return Promise.reject(new ReferenceError("InvalidState: Media keys are not attached."));if(this._lastUpdateDeferred){var t=this.update.bind(this,e);return this._lastUpdateDeferred.promise.then(t,t)}var n=(0,ge.$)();this._lastUpdateDeferred=n;try{this._mediaElement[this._addPrefix("addKey")](this._keySystem,new Uint8Array(e),null,this.sessionId)}catch(r){n.reject(r),this._lastUpdateDeferred=null}return n.promise}},{key:"close",value:function(){if(this.sessionId&&this._mediaElement)try{this._mediaElement[this._addPrefix("cancelKeyRequest")](this._keySystem,this.sessionId)}catch(e){Ye.warn("Could not close keysession",e)}return Promise.resolve(!0)}}]),n}(p.vp),xe=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";(0,c.Z)(this,e),this._mediaElement=null,this._waitingForSessionIds=[],this._sessionMap={},this.shouldRefreshPerTrack=!0,this._keySystem=t,this._prefix=n,this._onKeyMessage=this._onKeyMessage.bind(this),this._onKeyAdded=this._onKeyAdded.bind(this),this._onKeyError=this._onKeyError.bind(this)}return(0,_.Z)(e,[{key:"attach",value:function(e){this._mediaElement=e;var t=this._prefix;e.addEventListener(t+ue.V0_1B_NEEDKEY,Pe);var n=e.addEventListener.bind(e);n(t+ue.V0_1B_KEY_ADDED,this._onKeyAdded),n(t+ue.V0_1B_KEY_ERROR,this._onKeyError),n(t+ue.V0_1B_KEY_MESSAGE,this._onKeyMessage)}},{key:"detach",value:function(e){this._mediaElement=null;var t=this._prefix;e.removeEventListener(t+ue.V0_1B_NEEDKEY,Pe);var n=e.removeEventListener.bind(e);n(t+ue.V0_1B_KEY_ADDED,this._onKeyAdded),n(t+ue.V0_1B_KEY_ERROR,this._onKeyError),n(t+ue.V0_1B_KEY_MESSAGE,this._onKeyMessage)}},{key:"_getSession",value:function(e){var t=this._sessionMap[e];if(t)return t;var n=this._waitingForSessionIds.shift();return n?(n.sessionId=e,this._sessionMap[e]=n,n):null}},{key:"_onKeyMessage",value:function(e){var t=this._getSession(e.sessionId);t?t.generateComplete(e.message):Ye.warn("Got keymessage without session.")}},{key:"_onKeyAdded",value:function(e){var t=this._getSession(e.sessionId);t?t.updateComplete():Ye.warn("Got keyadded without session.")}},{key:"_onKeyError",value:function(e){var t=this._getSession(e.sessionId);t?t.handleErrorEvent(e):Ye.warn("Got keyerror without session.")}},{key:"setServerCertificate",value:function(){return Promise.reject(new Re(r.EME_CANNOT_SET_CERTIFICATE_FOR_PLATFORM,"Cannot set server certificate on this platform."))}},{key:"createSession",value:function(){var e=new Be(this._keySystem,this._mediaElement,this._prefix);return this._waitingForSessionIds.push(e),e}}]),e}();function Ze(e){var t=this.mediaKeys;return t&&t!==e&&t.detach(this),delete this.mediaKeys,this.mediaKeys=e,e&&e.attach(this),Promise.resolve()}var Ke=function(){function e(t,n,i){if((0,c.Z)(this,e),this._configuration=null,this.keySystem=t,this._prefix=i,!this._checkConfig(n))throw new Re(r.EME_NO_SUPPORTED_CONFIGURATION,"No supported configurations")}return(0,_.Z)(e,[{key:"_checkConfig",value:function(e){var t,n,r,i=this.keySystem,a=document.createElement("video"),o=we(e);try{for(o.s();!(r=o.n()).done;){var s=r.value,u={initDataTypes:s.initDataTypes,audioCapabilities:[],videoCapabilities:[],persistentState:"optional",distinctiveIdentifier:"optional",sessionTypes:["temporary"],label:s.label},l=!1;if(s.audioCapabilities&&s.audioCapabilities.length&&u.audioCapabilities){l=!1;var c,_=we(s.audioCapabilities);try{for(_.s();!(c=_.n()).done;){var d=c.value,f=null===(t=d.contentType)||void 0===t?void 0:t.split(";")[0];f&&a.canPlayType(f,i)&&(u.audioCapabilities.push(d),l=!0)}}catch(y){_.e(y)}finally{_.f()}}if(s.videoCapabilities&&s.videoCapabilities.length&&u.videoCapabilities){l=!1;var h,v=we(s.videoCapabilities);try{for(v.s();!(h=v.n()).done;){var p=h.value,E=null===(n=p.contentType)||void 0===n?void 0:n.split(";")[0];E&&a.canPlayType(E,i)&&(u.videoCapabilities.push(p),l=!0)}}catch(y){v.e(y)}finally{v.f()}}if(l)return this._configuration=u,!0}}catch(y){o.e(y)}finally{o.f()}return!1}},{key:"getConfiguration",value:function(){return this._configuration}},{key:"createMediaKeys",value:function(){var e=this;return new Promise((function(t){t(new xe(e.keySystem,e._prefix))}))}}]),e}();function Ve(e){navigator.requestMediaKeySystemAccess=function(t,n){return new Promise((function(r){r(new Ke(t,n,e))}))};var t=HTMLMediaElement.prototype;delete t.mediaKeys,t.setMediaKeys=Ze}n(74522);function Ge(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return He(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return He(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function He(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function je(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var qe=he.P.forTag("eme_polyfill.safari");var We=function(e){(0,f.Z)(n,e);var t=je(n);function n(e,r){var i;return(0,c.Z)(this,n),(i=t.call(this))._attached=!1,i._nativeKeySession=null,i._lastGenerateResolver=(0,ge.$)(),i._lastUpdateResolver=(0,ge.$)(),i.addEventListener=i.addListener,i.removeEventListener=i.removeListener,i._nativeMediaKeys=e,i._serverCertificate=r,i._onKeyMessage=i._onKeyMessage.bind((0,d.Z)(i)),i._onKeyAdded=i._onKeyAdded.bind((0,d.Z)(i)),i._onKeyError=i._onKeyError.bind((0,d.Z)(i)),i}return(0,_.Z)(n,[{key:"_attach",value:function(){if(!this._attached){var e=this._nativeKeySession;e?(e.addEventListener(ue.WEBKIT_KEY_MESSAGE,this._onKeyMessage),e.addEventListener(ue.WEBKIT_KEY_ADDED,this._onKeyAdded),e.addEventListener(ue.WEBKIT_KEY_ERROR,this._onKeyError)):qe.warn("Tried to attach with no WebKitMediaKeySession")}}},{key:"_detach",value:function(){if(this._attached){var e=this._nativeKeySession;e?(e.removeEventListener(ue.WEBKIT_KEY_MESSAGE,this._onKeyMessage),e.removeEventListener(ue.WEBKIT_KEY_ADDED,this._onKeyAdded),e.removeEventListener(ue.WEBKIT_KEY_ERROR,this._onKeyError)):qe.warn("Tried to detach with no WebKitMediaKeySession")}}},{key:"_onKeyMessage",value:function(e){e.message&&e.message.buffer&&(this.emitEvent(new Ie(e.message.buffer)),this._lastGenerateResolver&&(this._lastGenerateResolver.resolve(!0),this._lastGenerateResolver=null))}},{key:"_onKeyAdded",value:function(){this._lastUpdateResolver&&(this._lastUpdateResolver.resolve(!0),this._lastUpdateResolver=null),this.emit(ue.KEY_SESSION_STATUSES_CHANGE,null)}},{key:"_onKeyError",value:function(){var e=this._nativeKeySession&&this._nativeKeySession.error,t=new Re(r.EME_MEDIA_KEY_SESSION_SAFARI_ERROR,e&&e.message||"MediaKeySession Safari Error");e&&(t.debug.errorCode=e.code,t.debug.systemCode=e.systemCode),this._lastGenerateResolver?(this._lastGenerateResolver.reject(t),this._lastGenerateResolver=null):this._lastUpdateResolver&&(this._lastUpdateResolver.reject(t),this._lastUpdateResolver=null)}},{key:"_rebuildInitData",value:function(e){var t=new Uint8Array(e);if(new DataView(t.buffer).getUint32(0,!0)+4!==t.byteLength)throw new Re(r.EME_INIT_DATA_MALFORMED,"Malformed init data");var n=function(e){for(var t=Math.floor(e.byteLength/2),n=new Uint16Array(t),r=new DataView(e.buffer),i=0;i<t;i++)n[i]=r.getUint16(2*i,!0);return String.fromCharCode.apply(null,n)}(t.slice(4)),i=n.match(/^skd:\/\/([0-9a-fA-F]+)/);if(!(null==i?void 0:i[1]))throw new Re(r.EME_INIT_DATA_MALFORMED,"Invalid content ID");var a=i[1],o=new Uint8Array(function(e){for(var t=new Uint8Array(2*e.length),n=new DataView(t.buffer),r=e.split(""),i=0,a=r.length;i<a;i++){var o=r[i].charCodeAt(0);n.setUint16(2*i,o,!0)}return t.buffer}(a)),s=this._serverCertificate,u=new Uint8Array(t.byteLength+4+o.byteLength+4+s.byteLength),l=0;u.set(t,l),l+=t.byteLength;var c=new DataView(u.buffer);return c.setUint32(l,o.byteLength,!0),l+=4,u.set(o,l),l+=o.byteLength,c.setUint32(l,s.byteLength,!0),l+=4,u.set(s,l),u}},{key:"generateRequest",value:function(e,t){var n=this;return new Promise((function(e,r){n._lastGenerateResolver={resolve:e,reject:r};try{var i=n._rebuildInitData(t);n._nativeKeySession=n._nativeMediaKeys.createSession("video/mp4",new Uint8Array(i),null),n._attach()}catch(a){n._lastGenerateResolver=null,r(a)}}))}},{key:"update",value:function(e){var t=(0,ge.$)();if(this._lastUpdateResolver=t,!this._nativeKeySession)return qe.warn("Tried to update with no WebKitMediaKeySession"),t.promise;try{this._nativeKeySession.update(new Uint8Array(e))}catch(n){t.reject(n)}return t.promise}},{key:"close",value:function(){var e=this;return new Promise((function(t){e._detach(),t(!0)}))}}]),n}(p.vp),Qe=function(){function e(t){(0,c.Z)(this,e),this._lastBoundSetter=null,this._serverCertificate=null,this.shouldRefreshPerTrack=!0,this._nativeMediaKeys=new WebKitMediaKeys(t)}return(0,_.Z)(e,[{key:"attach",value:function(e){var t=this;return new Promise((function(n){if(e.readyState>=1)return e.webkitSetMediaKeys(t._nativeMediaKeys),void n();var r=function n(){e.removeEventListener(ue.MEDIA_LOADEDMETADATA,n),t._lastBoundSetter=null,e.webkitSetMediaKeys(t._nativeMediaKeys)};t._lastBoundSetter=r,e.addEventListener(ue.MEDIA_LOADEDMETADATA,r),e.addEventListener(ue.WEBKIT_NEEDKEY,Pe),n()}))}},{key:"detach",value:function(e){e.removeEventListener(ue.WEBKIT_NEEDKEY,Pe),this._lastBoundSetter&&(e.removeEventListener(ue.MEDIA_LOADEDMETADATA,this._lastBoundSetter),this._lastBoundSetter=null)}},{key:"setServerCertificate",value:function(e){return this._serverCertificate=new Uint8Array(e),Promise.resolve(!0)}},{key:"createSession",value:function(){if(!this._serverCertificate)throw new Re(r.EME_INVALID_STATE_ERROR,"The server certificate is not available");return new We(this._nativeMediaKeys,this._serverCertificate)}}]),e}(),ze=function(){function e(t,n){(0,c.Z)(this,e),this.keySystem=t;var i=this._checkConfig(n);if(!i)throw new Re(r.EME_NO_SUPPORTED_CONFIGURATION,"No supported configurations");this._configuration=i}return(0,_.Z)(e,[{key:"_checkConfig",value:function(e){var t,n=this.keySystem,r=!1,i=Ge(e);try{for(i.s();!(t=i.n()).done;){var a=t.value,o={initDataTypes:a.initDataTypes,audioCapabilities:[],videoCapabilities:[],persistentState:"optional",distinctiveIdentifier:"optional",sessionTypes:["temporary"]};if(a.audioCapabilities){var s,u=Ge(a.audioCapabilities);try{for(u.s();!(s=u.n()).done;){var l=s.value;if(l.contentType){var c=l.contentType.split(";")[0];WebKitMediaKeys.isTypeSupported(n,c)&&(o.audioCapabilities.push(l),r=!0)}}}catch(v){u.e(v)}finally{u.f()}}if(a.videoCapabilities){var _,d=Ge(a.videoCapabilities);try{for(d.s();!(_=d.n()).done;){var f=_.value;if(f.contentType){var h=f.contentType.split(";")[0];WebKitMediaKeys.isTypeSupported(n,h)&&(o.videoCapabilities.push(f),r=!0)}}}catch(v){d.e(v)}finally{d.f()}}if(r)return o}}catch(v){i.e(v)}finally{i.f()}return null}},{key:"getConfiguration",value:function(){return this._configuration}},{key:"createMediaKeys",value:function(){var e=this;return new Promise((function(t){t(new Qe(e.keySystem))}))}}]),e}();function Xe(e){var t=this.mediaKeys;return t&&t!==e&&t.detach(this),delete this.mediaKeys,this.mediaKeys=e,e?e.attach(this):Promise.resolve()}var Je,$e=he.P.forTag("eme_polyfills.tester");function et(){return"undefined"!=typeof navigator&&(null===navigator||void 0===navigator?void 0:navigator.requestMediaKeySystemAccess)&&"undefined"==typeof WebKitMediaKeys&&"undefined"!=typeof MediaKeySystemAccess&&(null===MediaKeySystemAccess||void 0===MediaKeySystemAccess?void 0:MediaKeySystemAccess.prototype.getConfiguration)?($e.log("Using native EME implementation."),"native"):"undefined"!=typeof HTMLMediaElement&&(null===HTMLMediaElement||void 0===HTMLMediaElement?void 0:HTMLMediaElement.prototype.webkitGenerateKeyRequest)?($e.log('Detected "webkit" Prefixed EME v0.1b. Polyfilling.'),Ve("webkit"),"v0.1b-webkit"):"undefined"!=typeof HTMLMediaElement&&(null===HTMLMediaElement||void 0===HTMLMediaElement?void 0:HTMLMediaElement.prototype.generateKeyRequest)?($e.log("Detected Unprefixed EME v0.1b. Polyfilling."),Ve(),"v0.1b"):"undefined"!=typeof MSMediaKeys?($e.log("Detected MS IE EME. Polyfilling."),function(){navigator.requestMediaKeySystemAccess=function(e,t){return new Promise((function(n){n(new Me(e,t))}))};var e=HTMLMediaElement.prototype;delete e.mediaKeys,e.setMediaKeys=Ne}(),"ms-ie"):"function"==typeof WebKitMediaKeys?($e.log("Detected Safari EME. Polyfilling."),function(){navigator.requestMediaKeySystemAccess=function(e,t){return new Promise((function(n){n(new ze(e,t))}))};var e=HTMLMediaElement.prototype;delete e.mediaKeys,e.setMediaKeys=Xe}(),"safari"):($e.warn("Detected no EME APIs."),null)}var tt=(Je={},(0,l.Z)(Je,le.WIDEVINE,{commonName:"widevine",licenseServer:"https://@webgate/widevine-license",withCertificate:!0,pssh_field:{audio:"pssh_widevine",video:"encryption_data"}}),(0,l.Z)(Je,le.PLAYREADY,{commonName:"playready",licenseServer:"https://@webgate/playready-license",withCertificate:!1,pssh_field:{audio:"pssh_playready",video:"encryption_data"}}),(0,l.Z)(Je,le.PLAYREADY_HARDWARE,{commonName:"playready",licenseServer:"https://@webgate/playready-license",withCertificate:!1,pssh_field:{audio:"pssh_playready",video:"encryption_data"}}),(0,l.Z)(Je,le.FAIRPLAY,{commonName:"fairplay",licenseServer:"https://@webgate/fairplay-license",withCertificate:!0,pssh_field:{audio:"pssh_fairplay",video:"asset_id"}}),(0,l.Z)(Je,le.INVALID_SPOTIFY_KEY,{commonName:"spotify-invalid",licenseServer:"https://@webgate",withCertificate:!1,pssh_field:{audio:"pssh_invalid",video:"encryption_data"}}),Je),nt=[{label:"video-sw-decode",initDataTypes:["cenc"],audioCapabilities:[{contentType:'audio/webm; codecs="opus"',robustness:"SW_SECURE_CRYPTO"},{contentType:'audio/mp4; codecs="flac"',robustness:"SW_SECURE_CRYPTO"},{contentType:'audio/mp4; codecs="mp4a.40.2"',robustness:"SW_SECURE_CRYPTO"}],videoCapabilities:[{contentType:'video/webm; codecs="vp9"',robustness:"SW_SECURE_DECODE"},{contentType:'video/webm; codecs="vp8"',robustness:"SW_SECURE_DECODE"},{contentType:'video/mp4; codecs="avc1.4d401f"',robustness:"SW_SECURE_DECODE"},{contentType:'video/mp2t; codecs="avc1.4d401f"',robustness:"SW_SECURE_DECODE"}],distinctiveIdentifier:"optional",persistentState:"optional",sessionTypes:["temporary"]},{label:"video-sw-crypto",initDataTypes:["cenc"],audioCapabilities:[{contentType:'audio/webm; codecs="opus"',robustness:"SW_SECURE_CRYPTO"},{contentType:'audio/mp4; codecs="flac"',robustness:"SW_SECURE_CRYPTO"},{contentType:'audio/mp4; codecs="mp4a.40.2"',robustness:"SW_SECURE_CRYPTO"}],videoCapabilities:[{contentType:'video/webm; codecs="vp9"',robustness:"SW_SECURE_CRYPTO"},{contentType:'video/webm; codecs="vp8"',robustness:"SW_SECURE_CRYPTO"},{contentType:'video/mp4; codecs="avc1.4d401f"',robustness:"SW_SECURE_CRYPTO"},{contentType:'video/mp2t; codecs="avc1.4d401f"',robustness:"SW_SECURE_CRYPTO"}],distinctiveIdentifier:"optional",persistentState:"optional",sessionTypes:["temporary"]},{label:"video-no-robustness",initDataTypes:["cenc"],audioCapabilities:[{contentType:'audio/webm; codecs="opus"',robustness:""},{contentType:'audio/mp4; codecs="flac"',robustness:""},{contentType:'audio/mp4; codecs="mp4a.40.2"',robustness:""}],videoCapabilities:[{contentType:'video/webm; codecs="vp9"',robustness:""},{contentType:'video/webm; codecs="vp8"',robustness:""},{contentType:'video/mp4; codecs="avc1.4d401f"',robustness:""},{contentType:'video/mp2t; codecs="avc1.4d401f"',robustness:""}],distinctiveIdentifier:"optional",persistentState:"optional",sessionTypes:["temporary"]},{label:"audio-flac-sw-crypto",initDataTypes:["cenc"],audioCapabilities:[{contentType:'audio/mp4; codecs="flac"',robustness:"SW_SECURE_CRYPTO"},{contentType:'audio/mp4; codecs="mp4a.40.2"',robustness:"SW_SECURE_CRYPTO"}],videoCapabilities:[],distinctiveIdentifier:"optional",persistentState:"optional",sessionTypes:["temporary"]},{label:"audio-flac-no-robustness",initDataTypes:["cenc"],audioCapabilities:[{contentType:'audio/mp4; codecs="flac"',robustness:""},{contentType:'audio/mp4; codecs="mp4a.40.2"',robustness:""}],videoCapabilities:[],distinctiveIdentifier:"optional",persistentState:"optional",sessionTypes:["temporary"]},{label:"audio-sw-crypto",initDataTypes:["cenc"],audioCapabilities:[{contentType:'audio/mp4; codecs="mp4a.40.2"',robustness:"SW_SECURE_CRYPTO"}],videoCapabilities:[],distinctiveIdentifier:"optional",persistentState:"optional",sessionTypes:["temporary"]},{label:"audio-no-robustness",initDataTypes:["cenc"],audioCapabilities:[{contentType:'audio/mp4; codecs="mp4a.40.2"',robustness:""}],videoCapabilities:[],distinctiveIdentifier:"optional",persistentState:"optional",sessionTypes:["temporary"]}];function rt(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return it(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return it(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function it(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function at(e,t){var n,r,i,a=rt(e);try{for(a.s();!(i=a.n()).done;){var o=i.value,s={audioCapabilities:[],videoCapabilities:[]},u=void 0,l=!1;if(null===(n=o.audioCapabilities)||void 0===n?void 0:n.length){l=!1;var c,_=rt(o.audioCapabilities);try{for(_.s();!(c=_.n()).done;){var d=c.value;(u=d.contentType)&&(t(u)&&(s.audioCapabilities.push(d),l=!0))}}catch(p){_.e(p)}finally{_.f()}}if(null===(r=o.videoCapabilities)||void 0===r?void 0:r.length){l=!1;var f,h=rt(o.videoCapabilities);try{for(h.s();!(f=h.n()).done;){var v=f.value;(u=v.contentType)&&(t(u)&&(s.videoCapabilities.push(v),l=!0))}}catch(p){h.e(p)}finally{h.f()}}if(l)return s}}catch(p){a.e(p)}finally{a.f()}return null}var ot=/([^;]+)(?:;\s?codecs="(.*)")?/;function st(e){var t,n=null!==(t=e.match(ot))&&void 0!==t?t:[],r=(0,u.Z)(n,3),i=r[1],a=void 0===i?"unknown":i,o=r[2];return{mimeType:a,codec:void 0===o?"unknown":o,contentType:e}}function ut(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}function lt(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return ct(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ct(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function ct(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var _t=/([^;]+)(?:;\s?codecs="(.*)")?/,dt=he.P.forTag("playback.eme_manager"),ft={EMPTY:"-no-robustness",SW_CRYPTO:"-sw-crypto",SW_DECODE:"-sw-decode",HW_CRYPTO:"-hw-crypto",HW_DECODE:"-hw-decode",HW_ALL:"-hw-all"};function ht(e,t){var n,r,i=[],a=new RegExp('codecs="('.concat(t.join("|"),')"')),o=lt(e);try{for(o.s();!(r=o.n()).done;){var s=r.value;a.test(null!==(n=s.contentType)&&void 0!==n?n:"")||i.push(s)}}catch(u){o.e(u)}finally{o.f()}return i.length?i:null}function vt(e,t){var n,r,i,a,o=t.audio,s=t.video;if(!(null==o?void 0:o.length)&&!(null==s?void 0:s.length))return e;var u=e.audioCapabilities,l=e.videoCapabilities;return(null==o?void 0:o.length)&&(null===(n=e.audioCapabilities)||void 0===n?void 0:n.length)&&!(u=null!==(r=ht(e.audioCapabilities,o))&&void 0!==r?r:void 0)||(null==s?void 0:s.length)&&(null===(i=e.videoCapabilities)||void 0===i?void 0:i.length)&&!(l=null!==(a=ht(e.videoCapabilities,s))&&void 0!==a?a:void 0)?null:Object.assign(Object.assign({},e),{audioCapabilities:u,videoCapabilities:l})}var pt=function(e){(0,f.Z)(n,e);var t=ut(n);function n(e){var r,i;return(0,c.Z)(this,n),(r=t.call(this))._unauthServerCertificateBase="",r._disallowCodecs={},r._keySystemDeferred=(0,ge.$)(),r._configuration=(0,ge.$)(),r._keySystemSettings=null,r._keySessions=[],r._configs=[],r._pendingCertificateRequest=null,r._certificate=null,r._transport=e.transport,r._emeImpl=e.emeImpl,r._noServerCertificate=!!e.noServerCertificate,r._precacheServerCertificate=null===(i=e.precacheServerCertificate)||void 0===i||i,r._unauthServerCertificateBase=e.unauthServerCertificateBase||"https://spclient.wg.spotify.com",r._configFilter=function(e){var t=["--ensure-no-match--"];if(null==e?void 0:e.length)for(var n=e.length;n--;){var r=e[n];r&&ft.hasOwnProperty(r)&&t.push(ft[r])}return new RegExp("(".concat(t.join("|"),")$"))}(e.disallowRobustnessValues||[]),r._disallowCodecs=e.disallowCodecs,r._preferredKeySystems=e.preferredKeySystems||[le.WIDEVINE,le.PLAYREADY,le.PLAYREADY_HARDWARE,le.FAIRPLAY],r}return(0,_.Z)(n,[{key:"_prepareConfiguration",value:function(e){var t=e.getConfiguration();dt.info("KeySystem configured as ",t.label),t.audioCapabilities&&t.audioCapabilities.length||this._appendProbableMediaCapabilities(e.keySystem,t);var n={keySystem:e.keySystem,keySystemImpl:this._emeImpl,audioFormats:this._parseCapabilities(t.audioCapabilities),videoFormats:this._parseCapabilities(t.videoCapabilities)};return this._keySystemSettings=tt[e.keySystem],this._configuration.resolve(n),n}},{key:"_parseCapabilities",value:function(e){var t;if(!e)return[];var n,r=[],i=lt(e);try{for(i.s();!(n=i.n()).done;){var a=n.value;if(null==a?void 0:a.contentType){var o=null!==(t=a.contentType.match(_t))&&void 0!==t?t:[],s=(0,u.Z)(o,3),l=s[1],c=s[2];l&&r.push({contentType:a.contentType,mimeType:l,codec:null!=c?c:""})}}}catch(_){i.e(_)}finally{i.f()}return r}},{key:"_appendProbableMediaCapabilities",value:function(e,t){var n=at(this._configs,(function(t){return(-1===t.indexOf("webm")||e!==le.PLAYREADY&&e!==le.PLAYREADY_HARDWARE)&&!!MediaSource.isTypeSupported(t)}));n&&(t.audioCapabilities=n.audioCapabilities,t.videoCapabilities=n.videoCapabilities)}},{key:"_trySetServerCertificate",value:function(e,t){var n=this,r=this._certificate;return(r&&r.expiry>Date.now()?Promise.resolve(r):this._requestServerCertificate(e)).then((function(e){return t.setServerCertificate(e.contents)})).then((function(){return n})).catch((function(e){return dt.warn("Error from setting server certificate",e),n}))}},{key:"_cacheServerCertificate",value:function(e){var t=this,n="";switch(e){case le.FAIRPLAY:n="fairplay";break;case le.WIDEVINE:n="widevine";break;default:return Promise.resolve(this)}return this._requestServerCertificate("".concat(this._unauthServerCertificateBase,"/").concat(n,"-license"),!1).then((function(){return t}),(function(e){return dt.warn("Cannot precache server certificate",e),t}))}},{key:"_requestServerCertificate",value:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this._pendingCertificateRequest?this._pendingCertificateRequest:this._transport.request("".concat(e,"/v1/application-certificate"),{authorize:n,responseType:"arraybuffer",parseResponseHeaders:!0,retry:{condition:function(e,t){return e.getStatusFamily()===t.SERVER_ERROR}}}).then((function(e){var n;if(!e.body)throw new TypeError("Response body is invalid");t._pendingCertificateRequest=null;var r=3600,i=null===(n=e.headers)||void 0===n?void 0:n.get("cache-control");if(i){var a=i.match(/(?:^|,|\s)max-age=(\d+)(?:,|$)/);a&&a[1]&&(r=1e3*parseInt(a[1],10))}return t._certificate={expiry:Date.now()+(r-600),contents:e.body},t._certificate}))}},{key:"_extractPlayReadyChallenge",value:function(e,t){var n,i=null,a=new Uint16Array(e),o=String.fromCharCode.apply(null,a);if(-1===o.indexOf("PlayReadyKeyMessage"))return dt.info("Using unextracted PlayReady message."),e;var s=(new DOMParser).parseFromString(o,"application/xml"),u=s.getElementsByTagName("Challenge")[0],l=null===(n=null==u?void 0:u.childNodes[0])||void 0===n?void 0:n.nodeValue;if(l)try{i=atob(l);var c=s.getElementsByTagName("name"),_=s.getElementsByTagName("value");if(c.length!==_.length)throw new Re(r.EME_HEADER_KEY_VALUE_MISMATCH,"Mismatched header <name>/<value> pair in key message")}catch(d){this.emit(ue.EME_LICENSE_REQUEST_ERROR,{signal:t,error:d}),i=null}else this.emit(ue.EME_LICENSE_REQUEST_ERROR,{signal:t,error:new Re(r.EME_HEADER_KEY_VALUE_MISMATCH,"Mismatched header <name>/<value> pair in key message")});return i}},{key:"_onMessage",value:function(e,t){e.timeMap.generate.end=Date.now();var n="message"in t?t.message:null,r="messageType"in t?t.messageType:void 0;if(dt.info("Got EME message event with type",r),n&&e.keySystem===le.PLAYREADY&&(n=this._extractPlayReadyChallenge(n,e.signal)),n)if(e.licenseServer){e.timeMap.request.start=Date.now();var i=e.licenseServer;e.keySystem===le.FAIRPLAY&&(i="".concat(i).concat(-1!==i.indexOf("?")?"&":"?","assetId=hex")),this._transport.request(i,{method:"POST",payload:n,responseType:"arraybuffer",retry:{condition:function(e,t){return 400!==e.status&&402!==e.status&&403!==e.status&&(!e.body||e.getStatusFamily()!==t.SUCCESS)}}}).then(this._handleLicenseResponse.bind(this,e))}else dt.info("Ignoring message event: no licenseServer url");else dt.info("Ignoring message event: no valid request payload")}},{key:"_handleLicenseResponse",value:function(e,t){var n,i=this,a=function(t){e.licenseServer&&(t.licenseServer=e.licenseServer),i.emit(ue.EME_LICENSE_REQUEST_ERROR,{signal:e.signal,error:t})};if(e.timeMap.request.end=Date.now(),200!==t.status){var o;try{if(t.body){var s=new Uint8Array(t.body),u=String.fromCharCode.apply(String,s);o=JSON.parse(u).errorMsg}}catch(c){}402===t.status?this.emit(ue.EME_LICENSE_REQUEST_CAPPED,{signal:e.signal,error:new Te(r.CAPPING_USER_IS_CAPPED,"User is capped.")}):400===t.status&&"widevine error"===o?((n=Re.fatal(r.EME_LICENSE_REQUEST_WIDEVINE_ERROR,"Widevine license server failed to parse request.")).status=t.status,n.shouldRefreshEndpoint=!0,a(n)):((n=new Re(r.EME_LICENSE_REQUEST_FAILED_WITH_STATUS,"License request failed (".concat(o||"unknown",")"))).status=t.status,n.shouldRefreshEndpoint=400===t.status||403===t.status,a(n))}else{if(!t.body)return(n=new Re(r.EME_LICENSE_REQUEST_EMPTY_RESPONSE,"Empty license response body")).status=t.status,void a(n);try{e.timeMap.update.start=Date.now(),e.keySession.update(t.body).catch((function(e){a(new Re(r.EME_LICENSE_UPDATE_FAILED,e.message||"License update failed."))})),dt.info("KeySession updated.")}catch(_){var l=_.message;a(new Re(r.EME_LICENSE_UPDATE_FAILED,l||"License update failed."))}}}},{key:"_selectKeySystem",value:function(e){for(var t=this._preferredKeySystems,n=0,r=t.length;n<r;n++){var i=t[n];if(i&&i in e)return e[i]}return null}},{key:"_testMediaKeys",value:function(e){return new Promise((function(t){t(e.createMediaKeys())})).then((function(t){if(!t)return Promise.reject(Re.fatal(r.EME_MEDIA_KEYS_NOT_SUPPORTED,"Cannot create MediaKeys from KeySystemAccess"));e.keySystem===le.FAIRPLAY&&t.setServerCertificate(new ArrayBuffer(0));try{if(!t.createSession())throw new Error("")}catch(i){var n=i.message;return Promise.reject(Re.fatal(r.EME_MEDIA_KEY_SESSION_NOT_SUPPORTED,n||"Cannot create MediaKeySession from KeySystemAccess"))}return Promise.resolve(e)}),(function(e){return dt.error(e.name),Promise.reject(Re.fatal(r.EME_MEDIA_KEYS_NOT_SUPPORTED,e.message||"Unknown error"))}))}},{key:"_saveSession",value:function(e){this._keySessions.push(e)}},{key:"destroySessions",value:function(){var e,t=[],n=lt(this._keySessions);try{for(n.s();!(e=n.n()).done;){var r=e.value;try{var i=r.keySession;if(!i)continue;r.onMessageListener&&i.removeEventListener(ue.KEY_SESSION_MESSAGE,r.onMessageListener),r.onKeyStatusChangeListener&&i.removeEventListener(ue.KEY_SESSION_STATUSES_CHANGE,r.onKeyStatusChangeListener);var a=Promise.resolve(i.close()).catch((function(e){dt.warn("Failed to close KeySession",e)}));t.push(a),r.keySession=null,r.onMessageListener=null,r.onKeyStatusChangeListener=null,dt.info("Closed KeySession")}catch(o){dt.warn("Failed to close KeySession",o)}}}catch(s){n.e(s)}finally{n.f()}return this._keySessions=[],Promise.all(t)}},{key:"init",value:function(){var e,t=this,n=this._keySystemDeferred,i={},a=[],o=[],s=lt(nt);try{for(s.s();!(e=s.n()).done;){var u=e.value;if(!u.label||!this._configFilter.test(u.label)){if(this._disallowCodecs){var l=vt(u,this._disallowCodecs);if(!l)continue;u=l}o.push(u)}}}catch(d){s.e(d)}finally{s.f()}for(var c in this._configs=o,le)if(Object.prototype.hasOwnProperty.call(le,c)){var _=c;a.push(navigator.requestMediaKeySystemAccess(le[_],o).then((function(e){i[e.keySystem]=e})).catch((function(){})))}return Promise.all(a).then(this._selectKeySystem.bind(this,i)).then((function(e){return e?t._testMediaKeys(e):Promise.reject(new Re(r.EME_NO_SUPPORTED_KEYSYSTEM,"No supported keysystem was found."))})).then((function(e){return t._prepareConfiguration(e),n.resolve(e),t._precacheServerCertificate?t._cacheServerCertificate(e.keySystem):t})).catch((function(e){var i=e.code||r.EME_NO_SUPPORTED_KEYSYSTEM,a=e.message||"No supported keysystem";return n.reject(Re.fatal(i,a)),n.promise.then((function(){return t}))}))}},{key:"createMediaKeys",value:function(e){var t=this;return this._keySystemDeferred.promise.then((function(e){return e.createMediaKeys()})).then((function(t){return Promise.all([e.setMediaKeys(t),t])})).then((function(n){var i=(0,u.Z)(n,2),a=(i[0],i[1]);if(!e.mediaKeys)throw new Re(r.EME_PLAYER_MEDIA_KEYS_SETTING_FAILED,"Failed to set MediaKeys on HTMLMediaElement");return t._configuration.promise.then((function(){var e=t._keySystemSettings;return e&&!t._noServerCertificate&&e.withCertificate?t._trySetServerCertificate(e.licenseServer,a):t}))}))}},{key:"removeMediaKeys",value:function(e){var t=this;return Promise.resolve(e.setMediaKeys(null)).then((function(){return t}))}},{key:"getKeySystemInfo",value:function(){return this._configuration.promise}},{key:"getKeySystemImpl",value:function(){return this._emeImpl}},{key:"createSessionWithParams",value:function(e){var t=this;return new Promise((function(n,i){dt.info("Creating KeySession",e.keySystem);var a=e.mediaKeys.createSession(),o={generate:{start:0,end:0},request:{start:0,end:0},update:{start:0,end:0}},s=t._keySystemSettings&&t._keySystemSettings.licenseServer||void 0,u=t._onMessage.bind(t,{keySystem:e.keySystem,keySession:a,licenseServer:e.licenseServer||s,signal:e.signal,timeMap:o});a.addEventListener(ue.KEY_SESSION_MESSAGE,u);var l=function(){dt.info("KeyStatus change"),o.update.end=Date.now(),n({elapsed:{generate:Math.max(o.generate.end-o.generate.start,0),request:Math.max(o.request.end-o.request.start,0),update:Math.max(o.update.end-o.update.start,0)}})};return a.addEventListener(ue.KEY_SESSION_STATUSES_CHANGE,l),t._saveSession({keySession:a,onMessageListener:u,onKeyStatusChangeListener:l}),dt.info("Generating KeySession request",e.keySystem),o.generate.start=Date.now(),Promise.resolve(a.generateRequest(e.initDataType,e.initData.buffer)).catch((function(e){if(e){var t;switch(e.name){case"NotSupportedError":t=r.EME_NOT_SUPPORTED_ERROR;break;case"InvalidStateError":t=r.EME_INVALID_STATE_ERROR;break;default:t=r.EME_UNKNOWN_ERROR}i(new Re(t,e.message||"Unknown error message."))}}))}))}}],[{key:"create",value:function(e){return new Promise((function(t){var i=et();if(!i)throw Re.fatal(r.EME_API_NOT_SUPPORTED,"Platform does not support navigator.requestMediaKeySystemAccess");t(new n(Object.assign(Object.assign({},e),{emeImpl:i})).init())}))}}]),n}(p.vp),Et=n(9942);n(5988),n(46340),n(32287);function yt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var mt=function(e){(0,f.Z)(n,e);var t=yt(n);function n(e,r,i){var a,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return(0,c.Z)(this,n),(a=t.call(this,r)).code=e,a.message=r,a.status=i,a.debug=o,a.name="FragmentError",a}return(0,_.Z)(n)}((0,A.Z)(Error)),gt=n(68035),St=function(){function e(t){var n;if((0,c.Z)(this,e),this._fallbackURLs=[],this._fragments=[],this._loaded=!1,this._mediaType="audio",this._noAuth=!1,this._resolvedURLs=[],this._segmentLength=0,this._duration=0,!t.fileId&&!t.resolvedURL)throw new TypeError("Missing: provide either fileId or resolvedURL");this._abrManager=t.abrManager,this._mediator=t.mediator,this._disableCache=t.disableCache,this._fileId=t.fileId,this._format=t.format,this._isAd=t.isAd||!1,this._keySystem=t.keySystem,this._keySystemSettings=tt[this._keySystem],this._licenseEndpoint=t.licenseEndpoint,this._logData=t.logData||{displayTrack:"",playbackId:""},this._resolver=t.resolver,this._resolvedURL=t.resolvedURL,this._noAuth=null!==(n=t.noAuth)&&void 0!==n&&n,this._transport=t.transport,this._uri=t.uri,this._audioGainDb=t.audioGain}return(0,_.Z)(e,[{key:"_parsePSSHBox",value:function(e){for(var t=gt.D.decode(e),n=new Uint8Array(t.length),r=0,i=t.length;r<i;r++)n[r]=t.charCodeAt(r);return n}},{key:"_parseAssetID",value:function(e){for(var t=gt.D.decode(e),n=new Array(t.length),r=0,i=t.length;r<i;r++){var a=t.charCodeAt(r).toString(16);n[r]=1===a.length?"0".concat(a):a}return n.join("")}},{key:"getCalculatedDuration",value:function(){return this._duration}},{key:"getFileId",value:function(){return this._fileId}},{key:"getFormat",value:function(){return this._format||""}},{key:"getAudioGain",value:function(){return this._audioGainDb}},{key:"getFragmentLength",value:function(){return this._segmentLength}},{key:"canLowerBitrate",value:function(){return!1}},{key:"getInitFragment",value:function(){return this._initFragment}},{key:"getInitParams",value:function(){var e={keySystem:this._keySystem,initDataType:this._protection,initData:this._psshBox,licenseServer:null};return Promise.resolve(e)}},{key:"getKeySystem",value:function(){return this._keySystem}},{key:"getLicenseEndpoint",value:function(){return this._licenseEndpoint}},{key:"getLogData",value:function(){return this._logData||{}}},{key:"getMediaType",value:function(){return this._mediaType}},{key:"getResolvedURL",value:function(){return this._resolvedURL}},{key:"getResolvedURLs",value:function(){return this._resolvedURLs}},{key:"getHLSURL",value:function(){throw new me(r.FILE_NOT_RESOLVED,"Cannot return HLS Manifest URL: File not resolved.")}},{key:"releaseHLSURL",value:function(){}},{key:"getURI",value:function(){return this._uri}},{key:"isAd",value:function(){return this._isAd}},{key:"isProtected",value:function(){return!!this._protection&&!!this._psshBox}},{key:"setLogData",value:function(e){return this._logData=e,this}},{key:"toLogJSON",value:function(){return{uri:this._uri,fileId:this._fileId,format:this._format||"",resolved_url:this._resolvedURL}}}]),e}(),Rt=(n(61874),"application/vnd.apple.mpegurl");function At(e){var t,n=function(e){return e.map((function(e){if(e.byteEnd&&void 0!==e.byteStart){var t="".concat(1+e.byteEnd-e.byteStart);return t+="@".concat(e.byteStart),"#EXTINF:".concat(e.duration,",\n#EXT-X-BYTERANGE:").concat(t,"\n").concat(e.url)}return"#EXTINF:".concat(e.duration,",\n").concat(e.url)})).join("\n")}(e.segments),r=e.assetID?'#EXT-X-KEY:METHOD=SAMPLE-AES,URI="skd://'.concat(e.assetID,'",KEYFORMATVERSIONS="1",KEYFORMAT="com.apple.streamingkeydelivery"'):"",i=e.map?'#EXT-X-MAP:URI="'.concat(e.map.url,'"'):"";return(null===(t=e.map)||void 0===t?void 0:t.byteEnd)&&void 0!==e.map.byteStart&&(i+=',BYTERANGE="'.concat(1+e.map.byteEnd,"@").concat(e.map.byteStart,'"')),"#EXTM3U\n#EXT-X-VERSION:6\n#EXT-X-TARGETDURATION:".concat(Math.floor(e.targetDuration),"\n#EXT-X-MEDIA-SEQUENCE:0\n#EXT-X-PLAYLIST-TYPE:VOD\n").concat(i?"".concat(r,"\n").concat(i):r,"\n").concat(n,"\n#EXT-X-ENDLIST")}function Tt(e){return"data:application/vnd.apple.mpegurl;base64,".concat(btoa(e))}function Pt(e){var t=new Blob([e],{type:Rt});return URL.createObjectURL(t)}function Lt(e){return Pt(At(e))}function It(e){return Tt(At(e))}n(66057);var kt=/avc1\.(([0-9a-f]{2})[0-9a-f]{2}([0-9a-f]{2}))/,Dt="4d";function Ct(e,t){var n=e.toLowerCase().match(kt),r=t.toLowerCase().match(kt);if(!n||!r)return!1;var i=(0,u.Z)(n,4),a=i[1],o=i[2],s=i[3],l=(0,u.Z)(r,4),c=l[1],_=l[2],d=l[3];return a===c||o===Dt&&_===Dt&&parseInt(s,16)>=parseInt(d,16)}function bt(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Ot(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Ot(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function Ot(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Nt(e,t){return e.sort((function(e,n){return"video_bitrate"in e&&"video_bitrate"in n?t?e.video_resolution===n.video_resolution?e.video_bitrate-n.video_bitrate:e.video_resolution-n.video_resolution:e.video_bitrate-n.video_bitrate:e.max_bitrate-n.max_bitrate}))}function Mt(e,t){return void 0!==t&&Array.isArray(e.encryption_indices)&&-1===e.encryption_indices.indexOf(t)}function wt(e,t){return!!t&&t(Object.assign({mimeType:e.mime_type},function(e){return"video_codec"in e}(e)?{type:"video",codec:e.video_codec,bitrate:e.video_bitrate,height:e.video_height,width:e.video_width,resolution:e.video_resolution}:{type:"audio",codec:e.audio_codec,bitrate:e.audio_bitrate}))}function Ut(e){return"audio_codec"in e?e.audio_codec:e.video_codec}function Ft(e){var t,n=e.codec,r=e.formats,i=e.profiles,a=e.encryptionIndex,o=e.disallowProfile,s=e.preferredKeySystem,u=e.preferredVideoResolution,l=e.allowMixedAVC1Codecs,c=bt(r);try{for(c.s();!(t=c.n()).done;){var _,d=t.value,f=[],h="spotify/unknown-mimetype",v="unknown-codec",p=bt(i);try{for(p.s();!(_=p.n()).done;){var E=_.value,y=Ut(E);!(n in E)||Mt(E,a)||s===le.FAIRPLAY&&"ts"!==E.file_type||wt(E,o)||(s!==le.FAIRPLAY||"ts"!==E.file_type?"unknown-codec"!==v||E.mime_type!==d.mimeType||y!==d.codec&&!Ct(d.codec,y)?E.mime_type===h&&(y===v||l&&Ct(v,y))&&(f.push(E),E.__effective_codec=v):(h=d.mimeType,v=l?d.codec:y,f.push(E),E.__effective_codec=d.codec):f.push(E))}}catch(m){p.e(m)}finally{p.f()}if(f.length)return Nt(f,u)}}catch(m){c.e(m)}finally{c.f()}return[]}function Yt(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Bt(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Bt(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function Bt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function xt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var Zt=he.P.forTag("playback.video_content");function Kt(e){if(!e)return"";var t=e.__effective_codec||("audio_codec"in e?e.audio_codec:e.video_codec);return"".concat(e.mime_type,';codecs="').concat(t,'"')}var Vt,Gt,Ht={method:"GET",responseType:"arraybuffer",timing:!0,retry:{condition:function(e,t){if(0===e.status)return!0;var n=e.getStatusFamily();return n===t.CONNECTION_ERROR||n===t.SERVER_ERROR}}},jt=function(e){(0,f.Z)(n,e);var t=xt(n);function n(e){var r;return(0,c.Z)(this,n),(r=t.call(this,e))._assetId="",r._endTime=0,r._videoFormats=[],r._audioFormats=[],r._subtitleLanguages=[],r._videoProfile=null,r._videoProfiles=[],r._audioProfile=null,r._audioProfiles=[],r._baseURL="",r._initTemplate="",r._segmentTemplate="",r._subtitleTemplate="",r._initSegments={},r._hlsURLs=[],r._allowMixedAVC1Codecs=!1,r._initTemplate="",r._isAd=e.isAd||!1,r._mediaType="video",r._resolver=e.resolver,r._videoFormats=e.videoFormats,r._audioFormats=e.audioFormats,r._disallowProfile=e.disallowProfile,r._videoResolution=e.videoResolution,r._allowMixedAVC1Codecs=!!e.allowMixedAVC1Codecs,r._keySystem===le.FAIRPLAY&&r._audioFormats.unshift({mimeType:"audio/mp2t",codec:"mp4a.40.2"}),r._parseFragmentResponse=r._parseFragmentResponse.bind((0,d.Z)(r)),r}return(0,_.Z)(n,[{key:"_isQualityMatched",value:function(e,t,n){var r,i,a,o;if(this._videoResolution){var s=null!==(r=this._videoResolution.max)&&void 0!==r?r:9007199254740991,u=null!==(i=this._videoResolution.min)&&void 0!==i?i:0;if(n){var l=null!==(a=this._videoResolution.start)&&void 0!==a?a:s;return e.video_resolution<=l}return e.video_resolution>=u&&e.video_resolution<=s}var c=null!==(o=null==t?void 0:t.audio_bitrate)&&void 0!==o?o:0,_=this._abrManager.getBandwidthEstimate();return e.video_bitrate+c<2*_-1e5}},{key:"_updateVariants",value:function(e){var t,n=this._audioProfiles[0];this._audioProfile=null!=n?n:null;var r=this._videoProfiles,i=this._videoProfile,a=null,o=r.length;if(o){for(;o--;){var s=r[o];if(s&&this._isQualityMatched(s,n,!!e)){a=s;break}}a||(a=r[0]),this._videoProfile=a,(null==i?void 0:i.id)!==a.id&&(Zt.log("Video profile changed. ID ".concat(a.id," (").concat(a.video_codec,"), Bitrate ").concat(a.video_bitrate,", ").concat(a.video_width,"x").concat(a.video_height)),null===(t=this._mediator)||void 0===t||t.emit(de.VIDEO_PROFILE_CHANGED,{profile:{type:"video",mimeType:a.mime_type,codec:a.video_codec,bitrate:a.video_bitrate,height:a.video_height,width:a.video_width,resolution:a.video_resolution}}))}}},{key:"_constructFragmentURL",value:function(e,t,n){if(!t&&!n)throw new Error("Both audioProfile and videoProfile is null");return e.init?this._resolver.getInitSegmentURLs(this._baseURL,this._initTemplate,t,n):this._resolver.getSegmentURLs(this._baseURL,this._segmentTemplate,e.timeStart,t,n)}},{key:"_fetchBufferData",value:function(e,t,n,r){return this._transport.request(e,Object.assign(Object.assign({},Ht),{metadata:{timeStart:Date.now(),fragment:t,profile:n,loggingURL:r}})).then(this._parseFragmentResponse)}},{key:"_fetchInitSegmentBuffers",value:function(e,t){var n,i=this._initFragment;if(!i)return Promise.reject(new me(r.FILE_NOT_RESOLVED,"Cannot fetch Init Segment buffers: File not resolved."));try{n=this._constructFragmentURL(i,e,t)}catch(_){return Promise.reject(_)}var a=this._initSegments,o=Promise.resolve(null);if(e){var s=a[e.id];(null==s?void 0:s.buffer.byteLength)?o=Promise.resolve(s):(null==n?void 0:n.audio)&&(o=this._fetchBufferData(n.audio,i,e,n.audioLogging).then((function(t){return a[e.id]=t,t})))}var l=Promise.resolve(null);if(t){var c=a[t.id];(null==c?void 0:c.buffer.byteLength)?l=Promise.resolve(c):(null==n?void 0:n.video)&&(l=this._fetchBufferData(n.video,i,t,n.videoLogging).then((function(e){return a[t.id]=e,e})))}return Promise.all([o,l]).then((function(e){var t=(0,u.Z)(e,2);return{audio:t[0],video:t[1]}}))}},{key:"_fetchBufferForFragment",value:function(e,t,n){var r;try{r=this._constructFragmentURL(e,t,n)}catch(i){return Promise.reject(i)}return Promise.all([this._fetchInitSegmentBuffers(t,n),!e.init&&r.audio?this._fetchBufferData(r.audio,e,t,r.audioLogging):null,!e.init&&r.video?this._fetchBufferData(r.video,e,n,r.videoLogging):null]).then((function(t){var n,r,i,a=(0,u.Z)(t,3),o=a[0],s=a[1],l=a[2];return e.init?i={audio:null!==(n=o.audio)&&void 0!==n?n:void 0,video:null!==(r=o.video)&&void 0!==r?r:void 0}:(i={audio:null!=s?s:void 0,video:null!=l?l:void 0},e.cacheBufferSet&&(e.bufferSet=i),i.audio&&(null==o?void 0:o.audio)&&(i.audio.initBuffer=o.audio.buffer),i.video&&(null==o?void 0:o.video)&&(i.video.initBuffer=o.video.buffer)),i})).catch((function(e){return Promise.reject(e)}))}},{key:"_parseFragmentResponse",value:function(e){var t,n,i,a,o=e.metadata,s=o.fragment,u=o.profile,l=o.timeStart,c=o.loggingURL,_=Kt(u),d=function(e){return e?"audio_bitrate"in e?e.audio_bitrate:e.video_bitrate:0}(u),f="video_resolution"in u?u.video_resolution:void 0,h="".concat(s.timeStart,"-").concat(s.timeEnd),v="video_resolution"in u?"video":"audio";switch(e.status){case 0:var p=new mt(r.FRAGMENT_REQUEST_FAILED_WITH_ZERO,"Request failed with status 0.",0,{time_range:h,mimetype:_,resolution:f,bitrate:d});return null===(t=this._mediator)||void 0===t||t.emit(de.FRAGMENT_FETCH_ERROR,{media_type:"video",segment_type:v,url:c,start_time:l,init:s.init,error:p}),Promise.reject(p);case 200:case 206:var E=e.body;if(!(null==E?void 0:E.byteLength)){var y=new mt(r.FRAGMENT_REQUEST_EMPTY_RESPONSE,"Empty response for successful buffer.",e.status,{time_range:h,mimetype:_,resolution:f,bitrate:d});return null===(n=this._mediator)||void 0===n||n.emit(de.FRAGMENT_FETCH_ERROR,{media_type:"video",segment_type:v,url:c,start_time:l,init:s.init,error:y}),Promise.reject(y)}var m=E.byteLength;this._abrManager.sample(m,Date.now()-l),this._updateVariants();var g=8e3*m/e.timing.completed;return null===(i=this._mediator)||void 0===i||i.emit(de.FRAGMENT_FETCHED,{media_type:"video",segment_type:v,url:c,init:s.init,byte_length:m,start_time:l,end_time:Date.now(),resolution:f,bandwidth:g}),Promise.resolve({profileId:"".concat(this._fileId,"-").concat(u.id),bufferURL:c,byteStart:0,byteEnd:m-1,buffer:E,mimetype:_,resolution:f,bitrate:d,bandwidth:g})}var S=new mt(r.FRAGMENT_REQUEST_FAILED_WITH_STATUS,"Buffer request failed with status ".concat(e.status),e.status,{time_range:h,mimetype:_,resolution:f,bitrate:d});return null===(a=this._mediator)||void 0===a||a.emit(de.FRAGMENT_FETCH_ERROR,{media_type:"video",segment_type:v,url:c,init:s.init,start_time:l,error:S}),Promise.reject(S)}},{key:"_getHLSURLForProfile",value:function(e){for(var t=this._duration,n=this._segmentLength,r=this._segmentTemplate,i=[],a=0;a<t;a+=n){var o=a+n>t?t-a:n,s=r.replace("{{profile_id}}",e.id.toString(10)).replace("{{segment_timestamp}}",a.toString(10)).replace("{{file_type}}",e.file_type);i.push({duration:o,url:"".concat(this._baseURL).concat(s)})}var u=("undefined"==typeof MediaSource?Lt:It)({assetID:this._assetId,targetDuration:n,segments:i});return this._hlsURLs.push(u),u}},{key:"_calculateFragments",value:function(e){this._duration=e.end_time_millis/1e3;var t=this._segmentLength;this._initFragment={init:!0,cacheBufferSet:!1,timeStart:-1,timeEnd:-1,byteRanges:{}};for(var n=0;n<this._duration;n+=t)this._fragments.push({cacheBufferSet:!n&&!this._disableCache,timeStart:n,timeEnd:n+t,byteRanges:{}})}},{key:"setVideoResolution",value:function(e){this._videoResolution=Object.assign(Object.assign({},this._videoResolution),e),this._updateVariants()}},{key:"getCurrentBitrate",value:function(){var e,t;return null!==(t=null===(e=this._videoProfile)||void 0===e?void 0:e.video_bitrate)&&void 0!==t?t:0}},{key:"getBufferForFragment",value:function(e){var t,n;if(!e)return Promise.reject(new TypeError("No fragment provided"));var r=this._audioProfile,i=this._videoProfile,a=null===(n=null===(t=e.bufferSet)||void 0===t?void 0:t.video)||void 0===n?void 0:n.resolution;return e.bufferSet&&(!i||a&&a>=i.video_resolution)?Promise.resolve(e.bufferSet):this._fetchBufferForFragment(e,null!=r?r:void 0,null!=i?i:void 0)}},{key:"clearCachedBuffers",value:function(){this._initFragment&&(this._initSegments={}),this._fragments.forEach((function(e){e.bufferSet=null}))}},{key:"getDuration",value:function(){return this._endTime}},{key:"getFragmentAfterTime",value:function(e){var t;if(!(null===(t=this._fragments)||void 0===t?void 0:t.length))return null;if(0===e||.01===e)return this._fragments[1];var n,r=Yt(this._fragments);try{for(r.s();!(n=r.n()).done;){var i=n.value;if(i.timeStart>e)return i}}catch(a){r.e(a)}finally{r.f()}return null}},{key:"getFragmentForTime",value:function(e){var t;if(!(null===(t=this._fragments)||void 0===t?void 0:t.length))return null;if(0===e||.01===e)return this._fragments[0];var n,r=Yt(this._fragments);try{for(r.s();!(n=r.n()).done;){var i=n.value;if(i.timeStart<=e&&i.timeEnd>=e)return i}}catch(a){r.e(a)}finally{r.f()}return null}},{key:"getSubtitleLanguages",value:function(){return this._subtitleLanguages}},{key:"getSubtitles",value:function(){var e=this;return this._subtitleLanguages.map((function(t){return{lang:t,url:e._subtitleTemplate.replace("{{language_code}}",t)}}))}},{key:"load",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{resolveLatency:0,manifestLatency:0};if(this._loaded)return t.resolveLatency=0,t.manifestLatency=0,Promise.resolve(this);if(!this._fileId)throw new TypeError("Missing: provide either fileId or resolvedURL");var n=Date.now();return this._resolver.getManifest(this._fileId,this._noAuth).then((function(i){var a,o,s,u;t.resolveLatency=0,t.manifestLatency=Date.now()-n;var l=i.contents[0];if(!l)return(u=new me(r.FILE_MALFORMED_SEEKTABLE,"Malformed seektable: no contents.")).track=e.toLogJSON(),Promise.reject(u);e._resolvedURLs=i.base_urls.slice();var c=(0,Et.Z)(i.base_urls),_=c[0],d=c.slice(1);_&&(e._baseURL=_,e._fallbackURLs=d),e._resolvedURL=e._baseURL,e._initTemplate=i.initialization_template,e._segmentTemplate=i.segment_template,e._segmentLength=l.segment_length;var f=void 0;if(null===(a=l.encryption_infos)||void 0===a?void 0:a.length){for(var h,v=l.encryption_infos,p=e._keySystemSettings.commonName,E=0,y=v.length;E<y;E++){var m=v[E];if(m&&m.key_system===p){f=E,h=m[e._keySystemSettings.pssh_field.video];break}}if(!h)return(u=new me(r.FILE_FORMAT_NOT_SUPPORTED,"KeySystem does not support the file format.")).track=e.toLogJSON(),Promise.reject(u);switch(e._keySystemSettings.commonName){case"widevine":case"playready":e._protection="cenc";try{e._psshBox=e._parsePSSHBox(h)}catch(g){return(u=new me(r.FILE_MALFORMED_PSSH,"Invalid PSSH value.")).track=e.toLogJSON(),Promise.reject(u)}break;case"fairplay":e._protection="hls",e._psshBox=new Uint8Array([]);try{e._assetId=e._parseAssetID(h)}catch(g){return(u=new me(r.FILE_MALFORMED_PSSH,"Invalid PSSH value.")).track=e.toLogJSON(),Promise.reject(u)}break;default:return(u=new me(r.FILE_FORMAT_NOT_SUPPORTED,"KeySystem does not support the file format.")).track=e.toLogJSON(),Promise.reject(u)}}return e._endTime=i.end_time_millis,e._videoProfiles=Ft({codec:"video_codec",formats:e._videoFormats,profiles:l.profiles,encryptionIndex:f,disallowProfile:e._disallowProfile,preferredKeySystem:e._keySystem,preferredVideoResolution:e._videoResolution,allowMixedAVC1Codecs:e._allowMixedAVC1Codecs}),e._audioProfiles=Ft({codec:"audio_codec",formats:e._audioFormats,profiles:l.profiles,encryptionIndex:f,preferredKeySystem:e._keySystem}),e._updateVariants(!0),e._calculateFragments(i),e._subtitleLanguages=i.subtitle_language_codes||[],null===(o=e._mediator)||void 0===o||o.emit(de.SUBTITLE_LANGUAGES_LOADED,{languages:e._subtitleLanguages}),(null===(s=i.subtitle_base_urls)||void 0===s?void 0:s.length)&&i.subtitle_template?e._subtitleTemplate="".concat(i.subtitle_base_urls[0]).concat(i.subtitle_template):(Zt.info("No subtitles available"),e._subtitleTemplate=""),e}))}},{key:"adaptToBandwidth",value:function(){return this._updateVariants(),Promise.resolve(!0)}},{key:"getPlayableCodecs",value:function(){var e,t;return[Kt(null!==(e=this._videoProfile)&&void 0!==e?e:void 0),Kt(null!==(t=this._audioProfile)&&void 0!==t?t:void 0)].filter((function(e){return!!e}))}},{key:"getAudioProfile",value:function(){return this._audioProfile}},{key:"getVideoProfile",value:function(){return this._videoProfile}},{key:"getVideoProfiles",value:function(){return this._videoProfiles}},{key:"getHLSURL",value:function(){if(!this._resolvedURL)throw new me(r.FILE_NOT_RESOLVED,"Cannot return HLS Manifest URL: File not resolved.");this.releaseHLSURL();var e=[],t=this._audioProfiles[0];t&&e.push('#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID="audio",LANGUAGE="eng",NAME="English",AUTOSELECT=YES,URI="'.concat(this._getHLSURLForProfile(t),'"'));var n,i=Yt(this._videoProfiles);try{for(i.s();!(n=i.n()).done;){var a=n.value;e.push("#EXT-X-STREAM-INF:BANDWIDTH=".concat(a.max_bitrate,",RESOLUTION=").concat(a.video_width,"x").concat(a.video_height,',CODECS="').concat((null==t?void 0:t.audio_codec)?"mp4a.40.2, ".concat(a.video_codec):a.video_codec,'"').concat((null==t?void 0:t.audio_codec)?',AUDIO="audio"':"","\n").concat(this._getHLSURLForProfile(a)))}}catch(u){i.e(u)}finally{i.f()}var o="#EXTM3U\n".concat(e.join("\n")),s=("undefined"==typeof MediaSource?Pt:Tt)(o);return this._hlsURLs.push(s),s}},{key:"releaseHLSURL",value:function(){var e,t=Yt(this._hlsURLs);try{for(t.s();!(e=t.n()).done;){var n=e.value;URL.revokeObjectURL(n)}}catch(r){t.e(r)}finally{t.f()}this._hlsURLs=[]}},{key:"canLowerBitrate",value:function(){var e,t=this._videoProfiles[0];return(null===(e=this._videoProfile)||void 0===e?void 0:e.id)!==(null==t?void 0:t.id)}}],[{key:"create",value:function(e){return new n(e)}}]),n}(St);!function(e){e[e.MP3_256=3]="MP3_256",e[e.MP3_320=4]="MP3_320",e[e.MP3_160=5]="MP3_160",e[e.MP3_96=6]="MP3_96",e[e.MP4_128=10]="MP4_128",e[e.MP4_256=11]="MP4_256",e[e.MP4_128_DUAL=12]="MP4_128_DUAL",e[e.MP4_256_DUAL=13]="MP4_256_DUAL",e[e.MP4_128_CBCS=14]="MP4_128_CBCS",e[e.MP4_256_CBCS=15]="MP4_256_CBCS",e[e.MP4_FLAC=17]="MP4_FLAC"}(Vt||(Vt={}));var qt=(Gt={},(0,l.Z)(Gt,Vt.MP3_256,"audio/mp3"),(0,l.Z)(Gt,Vt.MP3_320,"audio/mp3"),(0,l.Z)(Gt,Vt.MP3_160,"audio/mp3"),(0,l.Z)(Gt,Vt.MP3_96,"audio/mp3"),(0,l.Z)(Gt,Vt.MP4_128,'audio/mp4; codecs="mp4a.40.2"'),(0,l.Z)(Gt,Vt.MP4_256,'audio/mp4; codecs="mp4a.40.2"'),(0,l.Z)(Gt,Vt.MP4_128_DUAL,'audio/mp4; codecs="mp4a.40.2"'),(0,l.Z)(Gt,Vt.MP4_256_DUAL,'audio/mp4; codecs="mp4a.40.2"'),(0,l.Z)(Gt,Vt.MP4_128_CBCS,'audio/mp4; codecs="mp4a.40.2"'),(0,l.Z)(Gt,Vt.MP4_256_CBCS,'audio/mp4; codecs="mp4a.40.2"'),(0,l.Z)(Gt,Vt.MP4_FLAC,'audio/mp4; codecs="flac"'),Gt);function Wt(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Qt(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Qt(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function Qt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function zt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var Xt,Jt=function(e){(0,f.Z)(n,e);var t=zt(n);function n(e){var r;if((0,c.Z)(this,n),(r=t.call(this,e))._lastResolveTimestamp=0,r._profileId="".concat(Date.now()),r._initBufferPromise=null,r._lastFetchedBuffer=null,r._hlsURL=null,r._bypassResolve=!!r._resolvedURL,r._emitWarning=e.emitWarning||function(){},r._mediaType="audio",r._noManifest=!!e.noManifest,r._preloadedManifest=e.preloadedManifest,r._resolver=e.resolver,r._segmentLength=0,r._fileFormat=e.fileFormat,r._fileFormat)r._audioCodec=qt[r._fileFormat];else switch(r._format){case _e.MP3:r._audioCodec=qt[Vt.MP3_160];break;case _e.MP4:case _e.MP4_DUAL:case _e.MP4_CBCS:r._audioCodec=qt[Vt.MP4_128];break;default:throw new TypeError("Unknown audio format ".concat(r._format))}return r._fileId&&(r._profileId=r._fileId),r._parseFragmentResponse=r._parseFragmentResponse.bind((0,d.Z)(r)),r}return(0,_.Z)(n,[{key:"_parseFragmentResponse",value:function(e){var t=this,n=e.metadata,i=n.requestURL,a=n.fragment,o=n.byteRangeHeader,s=n.expectedLength,u="".concat(a.timeStart,"-").concat(a.timeEnd);switch(e.status){case 0:if(e.offline)return Promise.reject(new mt(r.FRAGMENT_OFFLINE_REQUEST_FAILED_WITH_ZERO,"Request failed with status 0.",0,{time_range:u,byte_range:o}));var l=new mt(r.FRAGMENT_ONLINE_REQUEST_FAILED_WITH_ZERO,"Request failed with status 0.",0),c=!1;return this._resolvedURL!==i?c=!0:this._fallbackURLs.length&&this._resolvedURL===i&&(c=!0,this._resolvedURL=this._fallbackURLs.shift()),l.debug.has_fallback=c,c?(this._emitWarning(l,this.toLogJSON()),this.getBufferForFragment(a)):Promise.reject(l);case 200:case 206:var _=e.body;if(!_)return Promise.reject(new mt(r.FRAGMENT_REQUEST_EMPTY_RESPONSE,"Empty response for successful buffer.",e.status,{time_range:u,byte_range:o}));if(_.byteLength!==s)return Promise.reject(new mt(r.FRAGMENT_REQUEST_UNEXPECTED_LENGTH,"Received buffer of unexpected length.",e.status,{time_range:u,byte_range:o,received_length:_.byteLength,expected_length:s}));var d={audio:{profileId:this._profileId,bufferURL:i,byteStart:a.byteRanges.audio.start,byteEnd:a.byteRanges.audio.end,buffer:_,mimetype:this._audioCodec,bandwidth:8e3*_.byteLength/e.timing.completed}};if(a.cacheBufferSet&&_&&_.byteLength){a.bufferSet=d;var f=a.sliceInto;if(null==f?void 0:f.length){var h,v=Wt(f);try{for(v.s();!(h=v.n()).done;){var p=h.value,E=p.fragment;(null==E?void 0:E.cacheBufferSet)&&(E.bufferSet={audio:Object.assign(Object.assign({},d.audio),{buffer:_.slice(p.start,p.end),byteStart:E.byteRanges.audio.start,byteEnd:E.byteRanges.audio.end})})}}catch(m){v.e(m)}finally{v.f()}}}return this._abrManager.sample(_.byteLength,e.timing.completed),Promise.resolve(d);case 403:return this.resolve().then((function(){return t.getBufferForFragment(a)}));default:var y=!1;return this._resolvedURL!==i?y=!0:this._fallbackURLs.length&&this._resolvedURL===i&&(y=!0,this._resolvedURL=this._fallbackURLs.shift()),y?this.getBufferForFragment(a):Promise.reject(new mt(r.FRAGMENT_REQUEST_FAILED_WITH_STATUS,"Buffer request failed with status ".concat(e.status),e.status,{time_range:u,byte_range:o}))}}},{key:"_getInitBuffer",value:function(){var e,t;if(!this._initFragment)throw new me(r.FILE_NOT_RESOLVED,"Cannot return HLS Manifest URL: File not resolved.");return(null===(t=null===(e=this._initFragment.bufferSet)||void 0===e?void 0:e.audio)||void 0===t?void 0:t.buffer.byteLength)?Promise.resolve(this._initFragment.bufferSet.audio.buffer):(this._initBufferPromise||(this._initBufferPromise=this.getBufferForFragment(this._initFragment).then((function(e){var t;if(!(null===(t=e.audio)||void 0===t?void 0:t.buffer.byteLength))throw new Error("Empty initialization segment buffer");return e.audio.buffer}))),this._initBufferPromise)}},{key:"_calculateFragments",value:function(e){var t=e.offset;this._initFragment={init:!0,cacheBufferSet:!this._disableCache,timeStart:0,timeEnd:0,byteRanges:{audio:{start:0,end:t-1}}};for(var n=e.segments,r=e.timescale,i=n.length,a=new Array(i),o=0,s=0,l=0,c=i;l<c;l++){var _=n[l];if(null==_?void 0:_.length){var d=(0,u.Z)(_,2),f=d[0],h=d[1],v=h/r,p={init:!1,cacheBufferSet:!l&&!this._disableCache,timeStart:o,timeEnd:o+v,byteRanges:{audio:{start:t,end:t+(f-1)}}};a[l]=p,t+=f,s+=h,o+=v,Math.floor(v)>this._segmentLength&&(this._segmentLength=Math.floor(v))}}a[a.length-1].isLastFragment=!0,this._fragments=a,this._duration=s/r}},{key:"_calculateFragmentsV1",value:function(e){var t=e.offset;this._initFragment={init:!0,cacheBufferSet:!this._disableCache,timeStart:0,timeEnd:0,byteRanges:{audio:{start:0,end:t-1}}};for(var n=e.references,r=e.timescale,i=n.length,a=new Array(i),o=0,s=0,u=0,l=i;u<l;u++){var c=n[u];if(c){var _=c.duration/r,d={init:!1,cacheBufferSet:!u&&!this._disableCache,timeStart:s,timeEnd:s+_,byteRanges:{audio:{start:t,end:t+(c.size-1)}}};a[u]=d,t+=c.size,o+=c.duration,s+=_,Math.floor(_)>this._segmentLength&&(this._segmentLength=Math.floor(_))}}a[a.length-1].isLastFragment=!0,this._fragments=a,this._duration=o/r}},{key:"_getManifest",value:function(e){if(this._noManifest)return e&&(e.manifestLatency=0),Promise.resolve(null);if(this._preloadedManifest)return e&&(e.manifestLatency=0),Promise.resolve(this._preloadedManifest);if(!this._fileId)throw new TypeError("Missing: fileId");var t=Date.now();return this._resolver.getManifest(this._fileId).then((function(n){return e&&(e.manifestLatency=Date.now()-t),n}))}},{key:"getHLSURL",value:function(){var e,t,n=this._resolvedURL,i=this._initFragment;if(!n||!i)throw new me(r.FILE_NOT_RESOLVED,"Cannot return HLS Manifest URL: File not resolved.");this.releaseHLSURL();var a={url:n,byteStart:null===(e=i.byteRanges.audio)||void 0===e?void 0:e.start,byteEnd:null===(t=i.byteRanges.audio)||void 0===t?void 0:t.end},o=this._fragments.map((function(e){var t,r;return{url:n,duration:e.timeEnd-e.timeStart,byteStart:null===(t=e.byteRanges.audio)||void 0===t?void 0:t.start,byteEnd:null===(r=e.byteRanges.audio)||void 0===r?void 0:r.end}})),s="undefined"==typeof MediaSource?Lt:It;return this._hlsURL=s({assetID:this._fileId,targetDuration:10,map:a,segments:o}),this._hlsURL}},{key:"releaseHLSURL",value:function(){this._hlsURL&&URL.revokeObjectURL(this._hlsURL),this._hlsURL=null}},{key:"clearCachedBuffers",value:function(){this._headFragment&&delete this._headFragment,this._initFragment&&(this._initFragment.bufferSet=null),this._fragments[0]&&(this._fragments[0].bufferSet=null),this._lastFetchedBuffer=null}},{key:"getPlayableCodecs",value:function(){return[this._audioCodec]}},{key:"getFirstFragment",value:function(){var e;return null!==(e=this._fragments[0])&&void 0!==e?e:null}},{key:"getHeadFragment",value:function(){var e=this._initFragment,t=this._fragments[0];if(!(null==e?void 0:e.byteRanges.audio)||!(null==t?void 0:t.byteRanges.audio))throw new me(r.FILE_NOT_RESOLVED,"Cannot return HLS Manifest URL: File not resolved.");return this._headFragment||(this._headFragment={init:!0,cacheBufferSet:!0,timeStart:0,timeEnd:0,byteRanges:{audio:{start:e.byteRanges.audio.start,end:t.byteRanges.audio.end}},sliceInto:[{fragment:e,start:0,end:t.byteRanges.audio.start},{fragment:t,start:t.byteRanges.audio.start,end:void 0}]}),this._headFragment}},{key:"getFragmentAfterTime",value:function(e){var t,n;if(!(null===(t=this._fragments)||void 0===t?void 0:t.length))return null;if(0===e||.01===e)return null!==(n=this._fragments[1])&&void 0!==n?n:null;var r,i=Wt(this._fragments);try{for(i.s();!(r=i.n()).done;){var a=r.value;if(a.timeStart>e)return a}}catch(o){i.e(o)}finally{i.f()}return null}},{key:"getFragmentForTime",value:function(e){var t,n;if(!(null===(t=this._fragments)||void 0===t?void 0:t.length))return null;if(0===e||.01===e)return null!==(n=this._fragments[0])&&void 0!==n?n:null;var r,i=Wt(this._fragments);try{for(i.s();!(r=i.n()).done;){var a=r.value;if(a.timeStart<=e&&a.timeEnd>=e)return a}}catch(o){i.e(o)}finally{i.f()}return null}},{key:"getBufferForFragment",value:function(e){var t,n=this;if(!e)return Promise.reject(new Error("FIXME: error type?"));if((null===(t=this._lastFetchedBuffer)||void 0===t?void 0:t.fragment)===e)return Promise.resolve(this._lastFetchedBuffer.bufferSet);if(e.bufferSet)return Promise.resolve(e.bufferSet);if(!this._resolvedURL)return Promise.reject(new me(r.FILE_NOT_RESOLVED,"Cannot fetch buffer: No resolved URL"));var i=e.byteRanges.audio,a="".concat(i.start,"-").concat(i.end),o=i.end+1-i.start,s=this._resolvedURL,l=e.init?Promise.resolve(null):this._getInitBuffer();return Promise.all([l,this._transport.request(s,{method:"GET",responseType:"arraybuffer",headers:{Range:"bytes=".concat(a)},timing:!0,metadata:{requestURL:s,fragment:e,byteRangeHeader:a,expectedLength:o},retry:{condition:function(e,t){if(0===e.status)return e.offline;var n=e.getStatusFamily();return n===t.CONNECTION_ERROR||n===t.SERVER_ERROR||!(n!==t.SUCCESS||!e.body)&&e.body.byteLength!==o}}}).then(this._parseFragmentResponse)]).then((function(t){var r=(0,u.Z)(t,2),i=r[0],a=r[1];return i&&a.audio&&(a.audio.initBuffer=i),n._lastFetchedBuffer={fragment:e,bufferSet:a},a}))}},{key:"resolve",value:function(e){var t=this,n=this._fileId;if(this._bypassResolve)return e&&(e.resolveLatency=0),Promise.resolve({uri:this._resolvedURL,uris:[],protection:this._preloadedManifest||!this._noManifest?"cenc":void 0});if(!n)throw new TypeError("Missing: fileId is required to resolve content URL");clearTimeout(this._lastResolveToken);var r,i=function(){return t._lastResolveTimestamp=Date.now(),t._resolver.getCDNURL(n,t._fileFormat).then((function(n){return e&&(e.resolveLatency=Date.now()-t._lastResolveTimestamp),n}))},a=Date.now()-this._lastResolveTimestamp;return r=a<1001?new Promise((function(e,n){t._lastResolveToken=setTimeout((function(){i().then(e,n)}),1001-a)})):i(),r.then((function(e){t._resolvedURLs=[];var n,r=Wt(e.uris);try{for(r.s();!(n=r.n()).done;){var i=n.value.split("?")[0];t._resolvedURLs.push(i)}}catch(a){r.e(a)}finally{r.f()}return t._fallbackURLs=e.uris,t._resolvedURL=t._fallbackURLs.shift(),e})).catch((function(e){return e&&(e.track=t.toLogJSON()),Promise.reject(e)}))}},{key:"load",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{resolveLatency:0,manifestLatency:0};return this._loaded?(t.resolveLatency=0,t.manifestLatency=0,Promise.resolve(this)):Promise.all([this.resolve(t),this._getManifest(t)]).then((function(t){var n,i,a=(0,u.Z)(t,2),o=a[0],s=a[1];if(e._loaded=!0,!o.protection||!s)return e;if(e._keySystem===le.INVALID_SPOTIFY_KEY)return e._protection=s.protection||"cenc",e._psshBox=new Uint8Array(0),e;var l=e._keySystemSettings.pssh_field.audio,c=function(e,t){return t.hasOwnProperty(e)}(l,s)?"".concat(s[l]):null;if(!c&&"pssh_widevine"===l&&"pssh"in s&&(c=null!==(n=s.pssh)&&void 0!==n?n:null),!c)return(i=new me(r.FILE_FORMAT_NOT_SUPPORTED,"KeySystem does not support the file format.")).track=e.toLogJSON(),Promise.reject(i);if(e._protection=s.protection||"cenc",e._psshBox=e._parsePSSHBox(c),"segments"in s&&s.segments)e._calculateFragments(s);else{if(!("references"in s)||!s.references)return(i=new me(r.FILE_MALFORMED_SEEKTABLE,"Malformed seektable.")).track=e.toLogJSON(),Promise.reject(i);e._calculateFragmentsV1(s)}return e}))}},{key:"adaptToBandwidth",value:function(){return Promise.resolve(!1)}}],[{key:"create",value:function(e){return new n(e)}}]),n}(St),$t=function(){function e(t){if((0,c.Z)(this,e),this._estimate=0,this._totalWeight=0,t<0)throw new TypeError("Halflife must be set to a positive value.");this._weightingDecrease=Math.exp(Math.log(.5)/t)}return(0,_.Z)(e,[{key:"sample",value:function(e,t){var n=Math.pow(this._weightingDecrease,e),r=t*(1-n)+n*this._estimate;isNaN(r)||(this._estimate=r,this._totalWeight+=t)}},{key:"getEstimate",value:function(){return this._estimate/1-Math.pow(this._weightingDecrease,this._totalWeight)}}]),e}(),en=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:4e5;(0,c.Z)(this,e),this._totalBytes=0,this._overrideBitrate=0,this._currentBandwidth=t,this._short=new $t(2),this._long=new $t(5),this._init()}return(0,_.Z)(e,[{key:"_init",value:function(){if("undefined"!=typeof navigator){var e=navigator;e.connection&&e.connection.downlink&&(this._currentBandwidth=1e6*e.connection.downlink,this._onConnectionChange=this._onConnectionChange.bind(this),e.connection.addEventListener("change",this._onConnectionChange))}}},{key:"_onConnectionChange",value:function(e){var t=e.target.downlink||0;this._setBandwidth(t)}},{key:"_setBandwidth",value:function(e){this._currentBandwidth=1e6*e}},{key:"getBandwidthEstimate",value:function(){if(this._overrideBitrate)return this._overrideBitrate;if(this._totalBytes<128e3)return this._currentBandwidth;var e=this._short.getEstimate(),t=this._long.getEstimate();return Math.min(e,t)}},{key:"sample",value:function(e,t){if(!(e<16e3)){var n=t/1e3,r=8*e/n;this._totalBytes+=e,this._short.sample(n,r),this._long.sample(n,r)}}},{key:"overrideBitrate",value:function(e){this._overrideBitrate=e<=0?0:e}}]),e}();function tn(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return nn(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return nn(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function nn(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}!function(e){e.SHOWING="showing",e.HIDDEN="hidden"}(Xt||(Xt={}));var rn=Array.prototype.slice,an="function"==typeof Array.from?function(e){return Array.from(e)}:function(e){return rn.call(e)};function on(e,t){var n,r=tn(an(e.getElementsByTagName(t)));try{for(r.s();!(n=r.n()).done;){var i=n.value;e.removeChild(i)}}catch(a){r.e(a)}finally{r.f()}}function sn(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return un(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return un(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function un(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function ln(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}function cn(e){var t=e;return{id:t.id,text:t.text}}var _n="visible",dn="hidden",fn=/^[A-Za-z]{2,4}([_-][A-Za-z]{4})?([_-]([A-Za-z]{2}|[0-9]{3}))?$/,hn=function(e){(0,f.Z)(n,e);var t=ln(n);function n(e){var r;return(0,c.Z)(this,n),(r=t.call(this))._isVisible=!1,r._player=null,r._crossOrigin=null,r._currentVideoContent=null,r._unsubscribers=[],r._displayedCues=[],r._deactivateListeners=!1,r._activeLanguage=void 0,r._preferredLanguage=e.language.toLowerCase(),e.deactivateListeners&&(r._deactivateListeners=!0),r._onEnter=r._onEnter.bind((0,d.Z)(r)),r._onExit=r._onExit.bind((0,d.Z)(r)),r._onLoadedMetadata=r._onLoadedMetadata.bind((0,d.Z)(r)),r.setPlayer(e.player),r}return(0,_.Z)(n,[{key:"_subscribeToCueEvents",value:function(e){var t,n=this,r=e.track;if(!r)throw new Error("No track");if(r.mode=this._isVisible?Xt.SHOWING:Xt.HIDDEN,null===(t=r.cues)||void 0===t?void 0:t.length){this._displayedCues=r.activeCues?Array.from(r.activeCues):[],this._emitDisplayedCues();for(var i=function(){var e=r.cues[a];if(!e)return"continue";e.addEventListener("enter",n._onEnter),e.addEventListener("exit",n._onExit),n._unsubscribers.push((function(){e.removeEventListener("enter",n._onEnter),e.removeEventListener("exit",n._onExit)}))},a=0;a<r.cues.length;a++)i()}else{e.addEventListener("load",(function t(){n._subscribeToCueEvents(e),e.removeEventListener("load",t)}))}}},{key:"_unsubscribeFromCueEvents",value:function(){this._unsubscribers.forEach((function(e){return e()})),this._unsubscribers=[]}},{key:"_onEnter",value:function(e){var t=e.target;this._displayedCues.indexOf(t)>-1||(this._displayedCues.push(t),this._emitDisplayedCues())}},{key:"_onExit",value:function(e){var t=e.target,n=this._displayedCues.indexOf(t);n>-1&&(this._displayedCues.splice(n,1),this._emitDisplayedCues())}},{key:"_emitDisplayedCues",value:function(){this.emit(ue.PLAYER_DISPLAYED_CUES_CHANGED,{cues:this._displayedCues.map(cn)})}},{key:"_updateVisibleState",value:function(){var e,t,n=this;if(this._player){var r=this.getActiveLanguage();Array.from(null!==(t=null===(e=this._player)||void 0===e?void 0:e.querySelectorAll("track"))&&void 0!==t?t:[]).forEach((function(e){e.style.visibility=n._isVisible?_n:dn}));for(var i=this._player.textTracks,a=0,o=i.length;a<o;a++){var s=i[a];s&&(s.mode=this._isVisible&&s.language.toLowerCase()===r?Xt.SHOWING:Xt.HIDDEN)}}}},{key:"_updateTextTracks",value:function(){var e=this._player;e&&(e.readyState>=1?this._onLoadedMetadata():this._currentVideoContent&&e.addEventListener(ue.MEDIA_LOADEDMETADATA,this._onLoadedMetadata))}},{key:"_onLoadedMetadata",value:function(){var e=this._player;if(e&&(on(e,"track"),this._currentVideoContent)){e.crossOrigin="anonymous";var t,n=this._updateActiveLanguage(),r=sn(this._currentVideoContent.getSubtitles());try{for(r.s();!(t=r.n()).done;){var i=t.value,a=i.lang,o=i.url,s=a.toLowerCase()===n,u=document.createElement("track");u.label="".concat(a," subtitles"),u.kind="subtitles",u.srclang=a,u.src=o,u.default=s,u.style.visibility=this._isVisible?_n:dn,e.appendChild(u),s&&!this._deactivateListeners&&this._subscribeToCueEvents(u)}}catch(l){r.e(l)}finally{r.f()}}}},{key:"_updateActiveLanguage",value:function(){if(this._player&&this._currentVideoContent){var e,t=this._currentVideoContent.getSubtitleLanguages(),n=this._preferredLanguage.split("-")[0],r=null,i=sn(t);try{for(i.s();!(e=i.n()).done;){var a=e.value.toLowerCase();if(a===this._preferredLanguage)return this._activeLanguage=a,this._activeLanguage;a.split("-")[0]===n&&null===r&&(r=a)}}catch(o){i.e(o)}finally{i.f()}return this._activeLanguage=null!=r?r:"en-us",this._activeLanguage}this._activeLanguage=void 0}},{key:"getActiveLanguage",value:function(){if(this._player&&this._currentVideoContent)return this._activeLanguage}},{key:"setVideoContent",value:function(e){this._unsubscribeFromCueEvents(),this._displayedCues=[],this._currentVideoContent=e,e||this.clear(),this._updateTextTracks()}},{key:"setPlayer",value:function(e){var t,n="VIDEO"===(null==e?void 0:e.tagName)?e:null;this._player!==n&&this.clear(),this._player=n||null,this._crossOrigin=null!==(t=null==n?void 0:n.crossOrigin)&&void 0!==t?t:null,this._updateTextTracks()}},{key:"getAvailableLanguages",value:function(){var e,t;return null!==(t=null===(e=this._currentVideoContent)||void 0===e?void 0:e.getSubtitleLanguages())&&void 0!==t?t:[]}},{key:"setLanguage",value:function(e){if(!e.length)throw new TypeError("Argument `code` must be a non-empty string. Hide subtitles using `hideSubtitles()`.");if(!fn.test(e))throw new TypeError("Argument `code` must be a valid BCP 47 formatted language code");this._preferredLanguage=e.toLowerCase(),this._updateTextTracks()}},{key:"hide",value:function(){this._isVisible=!1,this._updateVisibleState()}},{key:"show",value:function(){this._isVisible=!0,this._updateVisibleState()}},{key:"deactivateListeners",value:function(){this._deactivateListeners||this._player&&(this._deactivateListeners=!0,this._unsubscribeFromCueEvents())}},{key:"activateListeners",value:function(){this._deactivateListeners&&(this._deactivateListeners=!1,this._updateTextTracks())}},{key:"areListenersActivated",value:function(){return!this._deactivateListeners}},{key:"clear",value:function(){var e=this._player;e&&(this._unsubscribeFromCueEvents(),this._currentVideoContent=null,this._displayedCues=[],on(e,"track"),e.removeEventListener(ue.MEDIA_LOADEDMETADATA,this._onLoadedMetadata),e.crossOrigin=this._crossOrigin)}},{key:"visible",value:function(){return this._isVisible}}]),n}(p.vp);var vn=function(){function e(t){(0,c.Z)(this,e),this.bandwidthEstimator=t.bandwidthEstimator}return(0,_.Z)(e,[{key:"getSample",value:function(e,t){var n,r,i=this.bandwidthEstimator.getBandwidthEstimate(),a=function(e,t){for(var n=e.length,r=0;r<n;r++)if(e.start(r)<=t&&t<=e.end(r))return 1e3*(e.end(r)-t);return 0}(e.buffered,e.currentTime);if(t instanceof Jt){var o=null===(r=null===(n=t.getFirstFragment())||void 0===n?void 0:n.bufferSet)||void 0===r?void 0:r.audio,s=null==o?void 0:o.bitrate;return{bandwidth:i,bufferAvailability:a,audio:{contentType:null==o?void 0:o.mimetype,bitrate:s}}}var u=t.getAudioProfile(),l=t.getVideoProfile(),c=t.getVideoProfiles(),_="getVideoPlaybackQuality"in e?e.getVideoPlaybackQuality():{creationTime:void 0,droppedVideoFrames:void 0,totalVideoFrames:void 0};return{bandwidth:i,bufferAvailability:a,video:{creationTime:_.creationTime,droppedVideoFrames:_.droppedVideoFrames,totalVideoFrames:_.totalVideoFrames,bitrate:null==l?void 0:l.video_bitrate,availableBitrates:c.map((function(e){return e.video_bitrate})),height:null==l?void 0:l.video_height,width:null==l?void 0:l.video_width,resolution:null==l?void 0:l.video_resolution,contentType:Kt(null!=l?l:void 0)},audio:{bitrate:null==u?void 0:u.audio_bitrate,contentType:Kt(null!=u?u:void 0)}}}}],[{key:"create",value:function(t){return new e(t)}}]),e}();function pn(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return En(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return En(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function En(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var yn=he.P.forTag("playback.audio_processor"),mn=function(){function e(t){(0,c.Z)(this,e),this._audioContext=null,this._mediaElementSource=null,this._gainNode=null,this._nodes=[],(null==t?void 0:t.disable)?yn.info("AudioProcessor disabled"):(this._audioContext=(null==t?void 0:t.audioContext)||("undefined"!=typeof AudioContext?new AudioContext:null),this._audioContext?(this._gainNode=this._audioContext.createGain(),this._buildNodePipeline(null==t?void 0:t.nodes)):yn.warn("The AudioContext API is not supported. Any future operation related to `AudioProcessor` will be skipped."))}return(0,_.Z)(e,[{key:"_setMediaElementSource",value:function(e){var t;this._audioContext&&(this._mediaElementSource&&(yn.info("Disconnecting previous media element source"),this._mediaElementSource.disconnect()),yn.info("Creating new media element source"),this._mediaElementSource=this._audioContext.createMediaElementSource(e)||null,this._mediaElementSource.connect(null!==(t=this._nodes[0])&&void 0!==t?t:this._audioContext.destination))}},{key:"_buildNodePipeline",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];if(this._audioContext){yn.info("Disconnecting previous nodes");var n,r=pn(this._nodes);try{for(r.s();!(n=r.n()).done;){n.value.disconnect()}}catch(l){r.e(l)}finally{r.f()}var i,a=[this._gainNode].concat((0,I.Z)(t)),o=null,s=pn(a);try{for(s.s();!(i=s.n()).done;){var u=i.value;o&&o.connect(u),o=u}}catch(l){s.e(l)}finally{s.f()}null===(e=a[a.length-1])||void 0===e||e.connect(this._audioContext.destination),yn.info("Node pipeline built"),this._nodes=a}}},{key:"setPlayer",value:function(e){var t;e&&((null===(t=this._mediaElementSource)||void 0===t?void 0:t.mediaElement)!==e?this._setMediaElementSource(e):yn.info("The new player is the same as the current player"))}},{key:"setAudioGain",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(!this._gainNode)return yn.info("The default gain node is not available"),!1;var t=Math.pow(10,e/20);return this._gainNode.gain.value=t,yn.info("Main gain set to",t),!0}},{key:"getAudioContext",value:function(){return this._audioContext}},{key:"resume",value:function(){return this._audioContext&&"running"!==this._audioContext.state?this._audioContext.resume():Promise.resolve()}},{key:"suspend",value:function(){return this._audioContext&&"suspended"!==this._audioContext.state?this._audioContext.suspend():Promise.resolve()}},{key:"destroy",value:function(){var e;this._audioContext&&(null===(e=this._mediaElementSource)||void 0===e||e.connect(this._audioContext.destination)),this._nodes=[],this._audioContext=null,this._gainNode=null,this._mediaElementSource=null,yn.info("The AudioProcessor is destroyed")}}],[{key:"create",value:function(t){return new e(t)}}]),e}();function gn(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Sn(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Sn(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function Sn(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Rn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var An=he.P.forTag("playback.media_source_manager");function Tn(e){if(!e)return"";var t=[];for(var n in e)if(e.hasOwnProperty(n)){var r=e[n]?'="'.concat(e[n],'"'):"";t.push("".concat(n).concat(r))}return t.length?"; ".concat(t.join("; ")):""}var Pn=function(e){(0,f.Z)(n,e);var t=Rn(n);function n(e){var r;(0,c.Z)(this,n),(r=t.call(this))._mediaSource=null,r._sourceBuffers={},r._currentInitSegments={},r._updateQueue=[],r._codecs=[],r._playId=0,r._lastBufferClearTime=Date.now(),r._customSourceBufferParams="";var i=e.codecs,a=e.customSourceBufferParams,o=e.disableBufferAbort;return r._codecs=i,r._customSourceBufferParams=Tn(a),r._disableBufferAbort=!!o,r._onSourceOpen=r._onSourceOpen.bind((0,d.Z)(r)),r._onSourceClose=r._onSourceClose.bind((0,d.Z)(r)),r.dequeueUpdates=r.dequeueUpdates.bind((0,d.Z)(r)),e.noInit||r._init(),r}return(0,_.Z)(n,[{key:"_init",value:function(){this._mediaSource=new MediaSource,this._mediaSource.addEventListener(ue.MEDIA_SOURCE_OPEN,this._onSourceOpen),this._mediaSource.addEventListener(ue.MEDIA_SOURCE_CLOSE,this._onSourceClose),this._sourceBuffers={},this._currentInitSegments={}}},{key:"_onSourceOpen",value:function(){var e;An.info("MediaSource opened.");var t=this._mediaSource;if(0===(null===(e=null==t?void 0:t.sourceBuffers)||void 0===e?void 0:e.length)&&"open"===(null==t?void 0:t.readyState)){An.info("Creating source buffers for codecs",this._codecs);var n,r=gn(this._codecs);try{for(r.s();!(n=r.n()).done;){var i=n.value,a=t.addSourceBuffer(i+this._customSourceBufferParams);a.addEventListener(ue.SOURCE_BUFFER_UPDATE_END,this.dequeueUpdates),this._sourceBuffers[i]=a}}catch(o){r.e(o)}finally{r.f()}}this.dequeueUpdates(),this.emit(ue.BUFFER_SOURCE_OPEN,null)}},{key:"_onSourceClose",value:function(){An.info("MediaSource closed."),this._destroySourceBuffers(),this.emit(ue.BUFFER_SOURCE_CLOSE,null)}},{key:"_destroySourceBuffers",value:function(){var e=this._mediaSource;if(e){var t=e.sourceBuffers;if(t.length)for(var n=0,r=t.length;n<r;n++){var i=t[n];if(i){i.removeEventListener("updateend",this.dequeueUpdates);try{e.removeSourceBuffer(i),An.info("Removed source buffer")}catch(a){An.warn("Failed to remove sourcebuffer",a)}}}this._sourceBuffers={},this._currentInitSegments={}}}},{key:"_endUpdate",value:function(e){var t;this._isUpdating()?this._updateQueue.push(e):"open"===(null===(t=this._mediaSource)||void 0===t?void 0:t.readyState)&&(this._mediaSource.endOfStream(),e.resolve&&e.resolve(!0))}},{key:"_durationUpdate",value:function(e){this._isUpdating()?this._updateQueue.push(e):(this._mediaSource&&(this._mediaSource.duration=e.duration),e.resolve&&e.resolve(!0))}},{key:"_isUpdating",value:function(){if(!this._mediaSource)return!1;for(var e=this._mediaSource.sourceBuffers,t=0,n=e.length;t<n;t++){var r=e[t];if(r&&r.updating)return!0}return!1}},{key:"_appendUpdate",value:function(e){var t,n,r=this,i=this._sourceBuffers[e.codec];if(i&&!i.updating){var a=e.buffer;if(e.fragment.init&&this._currentInitSegments[e.codec]===e.profileId)return null===(t=e.resolve)||void 0===t||t.call(e,!0),void Promise.resolve().then(this.dequeueUpdates);if(e.initBuffer&&e.buffer&&this._currentInitSegments[e.codec]!==e.profileId){var o=new Uint8Array(e.initBuffer.byteLength+e.buffer.byteLength);o.set(new Uint8Array(e.initBuffer),0),o.set(new Uint8Array(e.buffer),e.initBuffer.byteLength),a=o.buffer}try{i.appendBuffer(a)}catch(l){var s=!1;return"QuotaExceededError"===l.name?(An.warn("Failed to append buffer: exceeded quota."),s=!0,this.emitSync(ue.BUFFER_QUOTA_EXCEEDED,null)):An.warn("Failed to append buffer",l),void new Promise((function(e){s?setTimeout(e,500):e()})).then((function(){r.emitSync(ue.FRAGMENT_APPENDED,e.fragment),r.dequeueUpdates()})).then((function(){e.init&&r._updateQueue.push(e)}))}this.emitSync(ue.FRAGMENT_APPENDED,e.fragment);var u=a.byteLength>e.buffer.byteLength;(e.fragment.init||u)&&(this._currentInitSegments[e.codec]=e.profileId),null===(n=e.resolve)||void 0===n||n.call(e,!0),u?An.info("Injected combined init segment and playable segment (".concat(e.codec,", ").concat(e.profileId,")")):e.init&&An.info("Injected individual init segment (".concat(e.codec,", ").concat(e.profileId,")"))}else this._updateQueue.push(e)}},{key:"_abortUpdate",value:function(e){var t;"fragment"in e&&this.emitSync(ue.FRAGMENT_APPENDED,e.fragment),null===(t=e.resolve)||void 0===t||t.call(e,!1),Promise.resolve().then(this.dequeueUpdates)}},{key:"dequeueUpdates",value:function(){var e=this._updateQueue.shift();e&&this.tryUpdate(e)}},{key:"tryUpdate",value:function(e){if(e.playId!==this._playId)return An.info("Try update dropped: playId has changed"),void this._abortUpdate(e);if(e.timestamp<this._lastBufferClearTime)return An.info("Try update dropped: update is older than the last clear"),void this._abortUpdate(e);var t=this._mediaSource;t&&"open"!==t.readyState&&"ended"!==t.readyState?this._updateQueue.push(e):"end"===e.type?this._endUpdate(e):"duration"===e.type?this._durationUpdate(e):"append"===e.type&&this._appendUpdate(e)}},{key:"appendBufferData",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Date.now(),i=[];if(e.audio){var a=(0,ge.$)();this.tryUpdate({playId:n,timestamp:r,fragment:t,type:"append",profileId:e.audio.profileId,buffer:e.audio.buffer,initBuffer:e.audio.initBuffer,codec:e.audio.mimetype,init:!!t.init,resolve:a.resolve}),i.push(a.promise)}if(e.video){var o=(0,ge.$)();this.tryUpdate({playId:n,timestamp:r,fragment:t,type:"append",profileId:e.video.profileId,buffer:e.video.buffer,initBuffer:e.video.initBuffer,codec:e.video.mimetype,init:!!t.init,resolve:o.resolve}),i.push(o.promise)}return Promise.all(i)}},{key:"endOfStream",value:function(){this._mediaSource&&"ended"!==this._mediaSource.readyState&&this.tryUpdate({playId:this._playId,timestamp:Date.now(),type:"end"})}},{key:"abort",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._lastBufferClearTime=Date.now(),this._disableBufferAbort)An.info("MediaSource abort skipped; action disabled.");else{var t=this._mediaSource;if(t)for(var n=t.sourceBuffers,r=0,i=n.length;r<i;r++){var a=n[r];if("open"===t.readyState&&a)try{a.abort();var o=a.buffered;if(e&&o.length){var s=o.start(0),u=o.end(o.length-1);a.remove(s,u),An.info("Cleared buffer range",s,u)}}catch(l){An.warn("MediaSourceManager.clear failed.",l)}}this._currentInitSegments={}}}},{key:"destroy",value:function(){var e=this._mediaSource;e&&(An.info("Source destroyed"),e.removeEventListener("sourceopen",this._onSourceOpen),e.removeEventListener("sourceclose",this._onSourceClose),this._destroySourceBuffers(),this._mediaSource=null)}},{key:"recreate",value:function(e){this.abort(),this.destroy(),this._codecs=e.codecs,e.customSourceBufferParams&&(this._customSourceBufferParams=Tn(e.customSourceBufferParams)),this._init()}},{key:"setDuration",value:function(e){var t=this;return new Promise((function(n){t.tryUpdate({playId:t._playId,timestamp:Date.now(),type:"duration",duration:e,resolve:n})}))}},{key:"getMediaSource",value:function(){return this._mediaSource}},{key:"setPlayId",value:function(e){this._playId=e}},{key:"getPlayId",value:function(){return this._playId}}],[{key:"create",value:function(e){return new n(e)}}]),n}(p.vp);function Ln(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var In,kn=he.P.forTag("playback.content_buffer");function Dn(){}!function(e){e[e.AUDIO=10]="AUDIO",e[e.VIDEO=20]="VIDEO"}(In||(In={}));var Cn,bn=function(e){(0,f.Z)(n,e);var t=Ln(n);function n(e){var r,i,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};(0,c.Z)(this,n),(i=t.call(this))._appendingFragments=[],i._tracker=e;var s=o.customSourceBufferParams,u=o.noInit,_=o.disableBufferAbort;return i._mediaSourceManager=Pn.create({codecs:a,noInit:u,customSourceBufferParams:s,disableBufferAbort:_}),i._removeAppendingFragment=i._removeAppendingFragment.bind((0,d.Z)(i)),i._mediaSourceManager.on(ue.FRAGMENT_APPENDED,(function(e){var t=e.data;return i._removeAppendingFragment(t)})),i.proxyEmitAll(i._mediaSourceManager,(r={},(0,l.Z)(r,ue.BUFFER_SOURCE_OPEN,ue.BUFFER_SOURCE_OPEN),(0,l.Z)(r,ue.BUFFER_SOURCE_CLOSE,ue.BUFFER_SOURCE_CLOSE),(0,l.Z)(r,ue.BUFFER_QUOTA_EXCEEDED,ue.BUFFER_QUOTA_EXCEEDED),r)),i}return(0,_.Z)(n,[{key:"_trackBufferingProgress",value:function(e){e.audio&&e.audio.buffer&&this._tracker.trackBytesDownloaded(e.audio.buffer.byteLength),e.video&&e.video.buffer&&this._tracker.trackBytesDownloaded(e.video.buffer.byteLength)}},{key:"_checkStalling",value:function(e,t,n){var r,i,a,o=t.byteRanges.video?t.byteRanges.video.start:null!==(i=null===(r=t.byteRanges.audio)||void 0===r?void 0:r.start)&&void 0!==i?i:-1;e>9e3&&this.emit(ue.BUFFER_STALLED,{byteStart:o,timeStart:(a=t.timeStart,Math.ceil(1e3*a)),stallAmount:e-9e3,didTimeout:n})}},{key:"_removeAppendingFragment",value:function(e){if(e){var t=this._appendingFragments,n=t.indexOf(e);-1!==n&&t.splice(n,1)}}},{key:"dequeueUpdates",value:function(){this._mediaSourceManager.dequeueUpdates()}},{key:"appendFragment",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(-1!==this._appendingFragments.indexOf(t))return Promise.resolve([]);this._appendingFragments.push(t),this.emit(ue.BUFFERING_START,null);var i=Date.now(),a=this._mediaSourceManager.getPlayId(),o=e.toLogJSON();return e.getBufferForFragment(t).then((function(e){var o,s,u,l,c,_;return n._trackBufferingProgress(e),a!==n._mediaSourceManager.getPlayId()?(kn.info("Append fragment dropped: playId has changed."),[]):(r||n._checkStalling(Date.now()-i,t,!1),null!==(null===(o=e.audio)||void 0===o?void 0:o.bandwidth)&&n._tracker.trackBufferURL((null===(s=e.audio)||void 0===s?void 0:s.bufferURL)||"",{bandwidth:(null===(u=e.audio)||void 0===u?void 0:u.bandwidth)||0}),null!==(null===(l=e.video)||void 0===l?void 0:l.bandwidth)&&n._tracker.trackBufferURL((null===(c=e.video)||void 0===c?void 0:c.bufferURL)||"",{bandwidth:(null===(_=e.video)||void 0===_?void 0:_.bandwidth)||0}),n.emit(ue.BUFFERING_END,null),n._mediaSourceManager.appendBufferData(e,t,a,i))})).catch((function(e){return n._removeAppendingFragment(t),r||n._checkStalling(Date.now()-i,t,!0),n.emit(ue.BUFFER_APPEND_ERROR,{error:e,canPlayNext:!0,track:o}),Promise.reject(e)}))}},{key:"abort",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._appendingFragments=[],this._mediaSourceManager.abort(e)}},{key:"getMediaSource",value:function(){return this._mediaSourceManager.getMediaSource()}},{key:"destroy",value:function(){this._mediaSourceManager.destroy()}},{key:"progress",value:function(e,t,n){var r=this,i=this._mediaSourceManager.getMediaSource();if(i){var a="video"===e.getMediaType()?In.VIDEO:In.AUDIO;if("open"===i.readyState||"ended"===i.readyState){var o,s=function(e,t){var n,r=null===(n=e.sourceBuffers[e.sourceBuffers.length-1])||void 0===n?void 0:n.buffered;if(r)for(var i,a,o=0;o<r.length;o++)if(i=r.start(o),a=r.end(o),i<=t&&t<=a)return{start:i,end:a};return null}(i,n);if(s){if(n+a>i.duration)return void("open"===i.readyState&&this._mediaSourceManager.endOfStream());var u=e.getFragmentLength();Math.ceil(n/u)>Math.floor(s.end/u)&&(o=e.getFragmentForTime(n))&&this.appendFragment(e,o,t).catch(Dn);var l=Math.floor(s.end-n);if(l>a)return;var c=Math.min(e.getFragmentLength(),a-l);if(c<1)return;var _=Math.floor(s.end+c);(o=e.getFragmentForTime(_))?this.appendFragment(e,o,t).catch(Dn):this._mediaSourceManager.endOfStream()}else if(o=e.getFragmentForTime(n)){var d=this.appendFragment(e,o,t).catch(Dn);if(o.timeEnd<n+5){var f=e.getFragmentAfterTime(o.timeStart);f?this.appendFragment(e,f,t).catch(Dn):d.then((function(){r._mediaSourceManager.endOfStream()}))}}else this._mediaSourceManager.endOfStream()}}}},{key:"recreate",value:function(e){this._appendingFragments=[],this._mediaSourceManager.recreate({codecs:e})}},{key:"setDuration",value:function(e){return this._mediaSourceManager.setDuration(e)}},{key:"setPlayId",value:function(e){this._mediaSourceManager.setPlayId(e)}}],[{key:"create",value:function(e){return new n(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],arguments.length>2&&void 0!==arguments[2]?arguments[2]:{})}}]),n}(p.vp);function On(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}function Nn(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Mn(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Mn(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function Mn(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var wn=he.P.forTag("playback.player"),Un=/^blob:/,Fn=(Cn={},(0,l.Z)(Cn,_e.MP4,!0),(0,l.Z)(Cn,_e.MP4_DUAL,!0),(0,l.Z)(Cn,_e.MP4_CBCS,!0),(0,l.Z)(Cn,_e.MP4_FLAC,!0),(0,l.Z)(Cn,_e.MP3,!1),(0,l.Z)(Cn,_e.MANIFEST_ID,!1),Cn);function Yn(e){return Math.ceil(1e3*e)}function Bn(e){return e/1e3}function xn(e){return document.createElement(e)}var Zn=function(e){(0,f.Z)(n,e);var t=On(n);function n(e){var r;return(0,c.Z)(this,n),(r=t.call(this))._cubicVolume=!1,r._player=null,r._emeManager=null,r._mediator=new p.vp,r._currentContent=null,r._upcomingContent=null,r._preloadingTracks={},r._playId=0,r._abortController=null,r._loaded=!1,r._licenseRequested=!1,r._playerActivated=!1,r._pauseToken=0,r._syntheticEndedToken=0,r._activeCodecs=[],r._playerVolume=1,r._playerSpeed=1,r._fatalOnNextError=!1,r._canPreloadEmitted=!1,r._lastTimeUpdatePostion=0,r._buffering=!1,r._preferredBitrate=0,r._disableLicensePrefetch=!1,r._allowMixedAVC1Codecs=!1,r._disableBufferingBeforeLicense=!1,r._audioResolver=e.audioResolver,r._clearBufferOnSeek=!!e.clearBufferOnSeek,r._createPlayer=e.createPlayer||xn,r._cubicVolume=e.cubicVolume,r._disableCache=!!e.disableCache,r._licenseURLResolver=e.licenseURLResolver,r._newBufferPerTrack=!!e.newBufferPerTrack,r._newElementPerTrack=!!e.newElementPerTrack,r._newMediaKeysPerTrack=!!e.newMediaKeysPerTrack,r._rebufferOnQuotaExceeded=!!e.rebufferOnQuotaExceeded,r._disableLicensePrefetch=!!e.disableLicensePrefetch,r._synthesizeEnded=!!e.synthesizeEnded,r._tracker=e.tracker,r._transport=e.transport,r._videoPlayerContainer=e.videoPlayerContainer,r._audioPlayerContainer=e.audioPlayerContainer,r._allowMixedAVC1Codecs=e.allowMixedAVC1Codecs,r._videoResolver=e.videoResolver,r._abrManager=new en,r._emeManager=e.disallowProtectedTracks?null:e.emeManager||null,r._disallowProfile=e.disallowProfile,r._disableBufferingBeforeLicense=!!e.disableBufferingBeforeLicense,r._cache=new ve.z6(e.trackCacheSize||2),r._subtitleManager=new hn({language:e.preferredSubtitleLanguage||navigator.language,player:r._player}),r._videoResolution=e.videoResolution,wn.info("Setting Player track cache to:",e.trackCacheSize||2),r._bufferManager=bn.create(r._tracker,void 0,{disableBufferAbort:!!e.disableBufferAbort,reinjectInitsOnAbort:!!e.reinjectInitsOnAbort,noInit:!0,customSourceBufferParams:e.customSourceBufferParams}),r._statistics=vn.create({bandwidthEstimator:r._abrManager}),r._audioProcessor=mn.create(e.audioProcessorOptions),r._onCanPlay=r._onCanPlay.bind((0,d.Z)(r)),r._onCanPlayThrough=r._onCanPlayThrough.bind((0,d.Z)(r)),r._onTimeUpdate=r._onTimeUpdate.bind((0,d.Z)(r)),r._onDurationChange=r._onDurationChange.bind((0,d.Z)(r)),r._onPlay=r._onPlay.bind((0,d.Z)(r)),r._onPlaying=r._onPlaying.bind((0,d.Z)(r)),r._onPause=r._onPause.bind((0,d.Z)(r)),r._onSeeking=r._onSeeking.bind((0,d.Z)(r)),r._onEncrypted=r._onEncrypted.bind((0,d.Z)(r)),r._onEnded=r._onEnded.bind((0,d.Z)(r)),r._onError=r._onError.bind((0,d.Z)(r)),r._onRequiresDuration=r._onRequiresDuration.bind((0,d.Z)(r)),r._onQuotaExceeded=r._onQuotaExceeded.bind((0,d.Z)(r)),r._onLoadedMetadata=r._onLoadedMetadata.bind((0,d.Z)(r)),r._onWaiting=r._onWaiting.bind((0,d.Z)(r)),r._onFragmentFetched=r._onFragmentFetched.bind((0,d.Z)(r)),r._onProfileChanged=r._onProfileChanged.bind((0,d.Z)(r)),r._onPlayedThresholdReached=r._onPlayedThresholdReached.bind((0,d.Z)(r)),r._onSyntheticEnded=r._onSyntheticEnded.bind((0,d.Z)(r)),r._onLicenseRequestCapped=r._onLicenseRequestCapped.bind((0,d.Z)(r)),r._onLicenseRequestError=r._onLicenseRequestError.bind((0,d.Z)(r)),r._onNavigatorOffline=r._onNavigatorOffline.bind((0,d.Z)(r)),r._onBufferError=r._onBufferError.bind((0,d.Z)(r)),r._emitWarning=r._emitWarning.bind((0,d.Z)(r)),r._handleLoadingComplete=r._handleLoadingComplete.bind((0,d.Z)(r)),r._onRateChange=r._onRateChange.bind((0,d.Z)(r)),r._onVideoResize=r._onVideoResize.bind((0,d.Z)(r)),r._setAudioGain=r._setAudioGain.bind((0,d.Z)(r)),r._init(),r}return(0,_.Z)(n,[{key:"_init",value:function(){var e,t,n,r,i,a;(this._disableCache&&wn.info("Cache disabled."),this._transport.on(this._transport.EVENT_CONNECTION_OFFLINE,this._onNavigatorOffline),this.proxyEmitAllSync(this._tracker,(e={},(0,l.Z)(e,ue.TRACKER_TRACKING_DATA_CREATED,ue.PLAYER_TRACKING_DATA_CREATED),(0,l.Z)(e,ue.TRACKER_TRACKING_DATA_FINALIZED,ue.PLAYER_TRACKING_DATA_FINALIZED),(0,l.Z)(e,ue.TRACKER_PLAYBACK_START,ue.PLAYER_PLAYBACK_START),e)),this._tracker.on(ue.TRACKER_PLAYED_THRESHOLD_REACHED,this._onPlayedThresholdReached),this._emeManager)&&this._emeManager.addListeners((a={},(0,l.Z)(a,ue.EME_LICENSE_REQUEST_CAPPED,this._onLicenseRequestCapped),(0,l.Z)(a,ue.EME_LICENSE_REQUEST_ERROR,this._onLicenseRequestError),a));this._bufferManager.addListeners((t={},(0,l.Z)(t,ue.BUFFER_APPEND_ERROR,this._onBufferError),(0,l.Z)(t,ue.BUFFER_QUOTA_EXCEEDED,this._onQuotaExceeded),t)),this.proxyEmitAll(this._bufferManager,(0,l.Z)({},ue.BUFFER_STALLED,ue.PLAYER_BUFFER_STALLED)),this._mediator.addListeners((n={},(0,l.Z)(n,de.FRAGMENT_FETCHED,this._onFragmentFetched),(0,l.Z)(n,de.VIDEO_PROFILE_CHANGED,this._onProfileChanged),n)),this.proxyEmitAll(this._mediator,(r={},(0,l.Z)(r,de.FRAGMENT_FETCH_ERROR,ue.PLAYER_FRAGMENT_FETCH_ERROR),(0,l.Z)(r,de.SUBTITLE_LANGUAGES_LOADED,ue.PLAYER_SUBTITLE_LANGUAGES_LOADED),r)),this.proxyEmitSync(this._subtitleManager,ue.PLAYER_DISPLAYED_CUES_CHANGED,ue.PLAYER_DISPLAYED_CUES_CHANGED),this.proxyEmitAll(this._videoResolver,(i={},(0,l.Z)(i,ue.VIDEO_MANIFEST_RESOLVED,ue.PLAYER_VIDEO_MANIFEST_RESOLVED),(0,l.Z)(i,ue.VIDEO_MANIFEST_RESOLVE_FAILED,ue.PLAYER_VIDEO_MANIFEST_RESOLVE_FAILED),i))}},{key:"_onRateChange",value:function(){this._player&&(this._tracker.trackSpeedChanged(this._player.playbackRate),this.emit(ue.PLAYER_PLAYBACK_SPEED_CHANGED,{playback_speed:this._player.playbackRate}))}},{key:"_onLicenseRequestError",value:function(e){if(!e.data.signal.aborted){var t=this._currentContent;if(t){var n=e.data.error;n.shouldRefreshEndpoint&&this._licenseURLResolver.remove(t.getKeySystem(),t.getMediaType()),this._emitError(n,!n.unrecoverable,t.toLogJSON())}}}},{key:"_onFragmentFetched",value:function(e){var t=e.data;this._tracker.trackFragment(t),this.emit(ue.PLAYER_FRAGMENT_FETCHED,t)}},{key:"_onProfileChanged",value:function(e){var t=e.data;this._tracker.trackProfileChanged(t.profile),this.emit(ue.PLAYER_VIDEO_PROFILE_CHANGED,t)}},{key:"_onLicenseRequestCapped",value:function(e){e.data.signal.aborted||this._currentContent&&(this.pause(),this.emit(ue.PLAYER_CAPPED,null))}},{key:"_shouldNextErrorBeFatal",value:function(){var e=this._currentContent;if(!e)return!1;if(e.isAd()||!e.isProtected())return!1;if(!this._player)return!1;var t=this._player.error;if(!(t&&t instanceof MediaError))return this._fatalOnNextError=!1,!1;switch(t.code){case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:case MediaError.MEDIA_ERR_DECODE:return!0;default:return!1}}},{key:"_onNavigatorOffline",value:function(){this._tracker.trackNavigatorOffline()}},{key:"_onBufferError",value:function(e){this._emitError(e.data.error,e.data.canPlayNext,e.data.track)}},{key:"_addPlayerEvents",value:function(e){e.addEventListener(ue.MEDIA_TIMEUPDATE,this._onTimeUpdate),e.addEventListener(ue.MEDIA_PLAY,this._onPlay),e.addEventListener(ue.MEDIA_PLAYING,this._onPlaying),e.addEventListener(ue.MEDIA_PAUSE,this._onPause),e.addEventListener(ue.MEDIA_SEEKING,this._onSeeking),e.addEventListener(ue.MEDIA_ENCRYPTED,this._onEncrypted),e.addEventListener(ue.MEDIA_ENDED,this._onEnded),e.addEventListener(ue.MEDIA_ERROR,this._onError),e.addEventListener(ue.MEDIA_LOADEDMETADATA,this._onLoadedMetadata),e.addEventListener(ue.MEDIA_DURATIONCHANGE,this._onDurationChange),e.addEventListener(ue.MEDIA_WAITING,this._onWaiting),e.addEventListener(ue.MEDIA_CANPLAY,this._onCanPlay),e.addEventListener(ue.MEDIA_CANPLAYTHROUGH,this._onCanPlayThrough),e.addEventListener(ue.MEDIA_RATECHANGE,this._onRateChange),e.addEventListener(ue.INTERNAL_MEDIA_REQUIRES_DURATION,this._onRequiresDuration),e.addEventListener(ue.MEDIA_RESIZE,this._onVideoResize)}},{key:"_removePlayerEvents",value:function(e){e.removeEventListener(ue.MEDIA_TIMEUPDATE,this._onTimeUpdate),e.removeEventListener(ue.MEDIA_PLAY,this._onPlay),e.removeEventListener(ue.MEDIA_PLAYING,this._onPlaying),e.removeEventListener(ue.MEDIA_PAUSE,this._onPause),e.removeEventListener(ue.MEDIA_SEEKING,this._onSeeking),e.removeEventListener(ue.MEDIA_ENCRYPTED,this._onEncrypted),e.removeEventListener(ue.MEDIA_ENDED,this._onEnded),e.removeEventListener(ue.MEDIA_ERROR,this._onError),e.removeEventListener(ue.MEDIA_WAITING,this._onWaiting),e.removeEventListener(ue.MEDIA_CANPLAY,this._onCanPlay),e.removeEventListener(ue.MEDIA_RATECHANGE,this._onRateChange),e.removeEventListener(ue.MEDIA_CANPLAYTHROUGH,this._onCanPlayThrough),e.removeEventListener(ue.MEDIA_LOADEDMETADATA,this._onLoadedMetadata),e.removeEventListener(ue.MEDIA_DURATIONCHANGE,this._onDurationChange),e.removeEventListener(ue.INTERNAL_MEDIA_REQUIRES_DURATION,this._onRequiresDuration),e.removeEventListener(ue.MEDIA_RESIZE,this._onVideoResize)}},{key:"_recreateMediaElement",value:function(e,t,n,r){if(t.aborted)return wn.info("Recreate player dropped: operation aborted."),Promise.resolve(!1);var i=this._player;if(i){if(!this._newElementPerTrack&&("AUDIO"!==i.tagName||"video"!==n)){var a,o=!0,s=Nn(e);try{for(s.s();!(a=s.n()).done;){var u=a.value;if('audio/mp2t;codecs="mp4a.40.2"'!==u&&!i.canPlayType(u)){o=!1;break}}}catch(f){s.e(f)}finally{s.f()}if(o)return wn.info("Reusing media element."),e.join(",")===this._activeCodecs.join(",")&&!this._newBufferPerTrack||r||(wn.info("Recreating buffer."),this._bufferManager.recreate(e),this._activeCodecs=e),Promise.resolve(!0)}this._removePlayerEvents(i),i.pause(),this._emeManager&&this._emeManager.removeMediaKeys(i).catch((function(e){wn.warn("Failed to remove media keys.",e)})),this._player=null;var l=this._getContainerElement(this._videoPlayerContainer);l&&i.parentNode===l&&(l.removeChild(i),this.emit(ue.PLAYER_VIDEO_ELEMENT_REMOVED,null));var c=this._getContainerElement(this._audioPlayerContainer);c&&i.parentNode===c&&c.removeChild(i)}wn.info("Creating new media element.");var _=this._createPlayer(n),d=this._playerVolume;return _.volume=this._cubicVolume?d*d*d:d,_.autoplay=!1,_.loop=!1,"playsInline"in _&&(_.playsInline=!0),this._player=_,this._subtitleManager.setPlayer(_),this._playerActivated=!1,this._addPlayerEvents(_),r||this._bufferManager.recreate(e),this._activeCodecs=e,Promise.resolve(!0)}},{key:"_getContainerElement",value:function(e){return"string"==typeof e?document.querySelector(e):e||null}},{key:"_onVideoResize",value:function(){if(this._player instanceof HTMLVideoElement){var e=this._player,t=e.videoWidth,n=e.videoHeight;this.emit(ue.PLAYER_VIDEO_RESIZED,{width:t,height:n})}}},{key:"_onDurationChange",value:function(){var e,t=this,n=null===(e=this._abortController)||void 0===e?void 0:e.signal,r=function(){if(t._player)if(null==n?void 0:n.aborted)wn.info("Duration changed drop: operation aborted.");else{var e=Yn(t._player.duration),r=Yn(t._player.currentTime);t._tracker.setActualDuration(e),t.emit(ue.PLAYER_DURATION_CHANGED,{timestamp:Date.now(),position:r,duration:e})}};this._loaded?r():this.once(ue.PLAYER_LOAD,r)}},{key:"_onPlay",value:function(){var e;if(this._player&&this._currentContent){var t=Yn(this._player.currentTime);this._tracker.trackPlay(t,this._player.playbackRate),this.emit(ue.PLAYER_PLAY,{timestamp:Date.now(),position:t,logData:null!==(e=this._currentContent.getLogData())&&void 0!==e?e:null})}}},{key:"_onPlaying",value:function(){if(this._player){this._playerActivated=!0;var e=this._currentContent,t=Yn(this._player.currentTime);this._tracker.trackPlaying(t),this.emit(ue.PLAYER_PLAYING,{timestamp:Date.now(),position:t,logData:e?e.getLogData():null})}}},{key:"_onPause",value:function(){var e=this;if(this._player){var t=Yn(this._player.currentTime);this._tracker.trackPaused(t);var n=this._currentContent?this._currentContent.getLogData():null;this._pauseToken=setTimeout((function(){clearTimeout(e._syntheticEndedToken),e.emit(ue.PLAYER_PAUSED,{position:t,logData:n})}),10)}}},{key:"_onSeeking",value:function(){this.emit(ue.PLAYER_SEEKING,null),this._bufferManager.abort(this._clearBufferOnSeek),this._lastTimeUpdatePostion=0,this._onTimeUpdate()}},{key:"_onRequiresDuration",value:function(){this._currentContent&&this._currentContent.isProtected()&&this._player&&(this._player.duration=this._currentContent.getCalculatedDuration())}},{key:"_onQuotaExceeded",value:function(){this._player&&this._rebufferOnQuotaExceeded&&(wn.info("Exceeded quota: rebuffering current track."),this._bufferManager.abort(!0),this._player.currentTime=this._player.currentTime,this._onTimeUpdate())}},{key:"_onEncrypted",value:function(e){wn.info("Got Encrypted event"),this._currentContent&&this.emitSync(ue.INTERNAL_ENCRYPTED,{initData:e.initData,fromPolyfill:!!e.fromPolyfill})}},{key:"_onEnded",value:function(){!this._currentContent||this._synthesizeEnded&&this._currentContent.isProtected()||(wn.info("Native ended emitted."),this._emitEnded())}},{key:"_onSyntheticEnded",value:function(){this._synthesizeEnded&&this._currentContent&&this._currentContent.isProtected()&&(wn.info("Synthetic ended emitted."),this._emitEnded())}},{key:"_onError",value:function(){if(this._player){var e,t,n,i,a=this._player.error,o=!1,s=this._currentContent,u=!1;s&&(o=s.isProtected(),e=s.toLogJSON(),u=s.isAd(),s.clearCachedBuffers());var l=!0,c=!s||u||!this._fatalOnNextError,_=a&&a.msExtendedCode?"0x".concat((a.msExtendedCode>>>0).toString(16).toUpperCase()):null,d="data:".concat((null==e?void 0:e.fileId)||"unknown");if(a instanceof MediaError){switch(a.code){case MediaError.MEDIA_ERR_ABORTED:t=r.MEDIA_ABORTED,n="Media aborted.";break;case MediaError.MEDIA_ERR_NETWORK:t=r.MEDIA_NETWORK_ERROR,n="Network error.";break;case MediaError.MEDIA_ERR_DECODE:t=r.MEDIA_DECODING_ERROR,n="Media decoding error.",l=c;break;case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:t=r.MEDIA_NOT_SUPPORTED,n="Media not supported.",l=c;break;default:t=r.PLAYER_MEDIA_ERROR,n="Media error.",i=!0}var f=a.message||_||d||a.toString();n+=" (".concat(f,")")}else t=r.PLAYER_PLAYBACK_ERROR,n="Error message undefined",i=!0;this._bufferManager.abort(!0);var h=new Ee(t,n);l||(h.unrecoverable=!0),h.listPlayerIgnore=u,h.debug.src_url=d,h.debug.protected=o,h.debug.extendedCode=_,h.debug.rawExCode=a&&a.msExtendedCode||null,i&&a&&(h.debug.nativeCode=a.code||null,h.debug.errorData=a),this._emitError(h,l,e)}}},{key:"_onLoadedMetadata",value:function(){this.emitSync(ue.INTERNAL_PLAYER_LOADED_METADATA,null)}},{key:"_onCanPlay",value:function(){this._buffering=!1,this.emitSync(ue.INTERNAL_PLAYER_CANPLAY,null),this.emit(ue.PLAYER_FIRST_BYTES,null)}},{key:"_onCanPlayThrough",value:function(){this.emitSync(ue.INTERNAL_PLAYER_CANPLAYTHROUGH,null)}},{key:"_onWaiting",value:function(){var e=this;clearTimeout(this._syntheticEndedToken);var t=this._player;if(t&&this._currentContent){var n=t.seeking;this._buffering=!0;var r=this._currentContent.canLowerBitrate(),i=this._tracker;this.emit(ue.PLAYER_BUFFERING_START,Object.assign({position:Yn(t.currentTime),msPlayed:this._tracker.getMSPlayed(),canLowerBitrate:r,seeking:n},i.getStallsInformation())),this._getBufferingLatency().then((function(a){n||e._tracker.trackMsStalled(a),e.emit(ue.PLAYER_BUFFERING_END,Object.assign({position:Yn(t.currentTime),msPlayed:e._tracker.getMSPlayed(),canLowerBitrate:r,msStalled:a,seeking:n},i.getStallsInformation()))}))}}},{key:"_onPlayedThresholdReached",value:function(e){this._currentContent&&this._player&&this.emit(ue.PLAYER_PLAYED_THRESHOLD_REACHED,{played:e.data.played,threshold:e.data.threshold,position:Yn(this._player.currentTime)})}},{key:"_emitEnded",value:function(){this._currentContent&&"video"===this._currentContent.getMediaType()&&this.emit(ue.PLAYER_ENDED_VIDEO,null),clearTimeout(this._pauseToken),this.emit(ue.PLAYER_ENDED,null)}},{key:"_emitError",value:function(e,t,n){wn.error("Player Error",e,n,t),this._tracker.setHadError(!0),!this._disableCache&&n&&n.fileId&&this._cache.remove(n.fileId),this.emit(ue.PLAYER_ERROR,{playId:this._playId,error:e,track:n,canPlayNext:t,position:this._player?Yn(this._player.currentTime):0})}},{key:"_emitWarning",value:function(e,t){wn.error("Player Warning",e,t,!0),this._tracker.trackWarning(),this.emit(ue.PLAYER_WARNING,{playId:this._playId,error:e,track:t,canPlayNext:!0,position:this._player?Yn(this._player.currentTime):0})}},{key:"_prepareMediaElement",value:function(e,t){var n=this;return t.aborted||!this._upcomingContent?(wn.info("Loading content dropped: operation aborted."),Promise.resolve(!1)):this._recreateMediaElement(this._upcomingContent.getPlayableCodecs(),t,this._upcomingContent.getMediaType(),this._upcomingContent.getKeySystem()===le.FAIRPLAY).then((function(r){var i;if(!r||t.aborted)return wn.info("Loading content dropped after recreate: operation aborted."),Promise.resolve(!1);n._player.playbackRate=(null===(i=n._loadingOptions)||void 0===i?void 0:i.useDefaultPlaybackSpeed)?1:n._playerSpeed;var a=n._player;return"VIDEO"===(null==a?void 0:a.tagName)&&(e.poster?a.poster=e.poster:a.removeAttribute("poster")),a&&n._upcomingContent&&n._upcomingContent.isProtected()&&n._emeManager&&(!a.mediaKeys||a.mediaKeys.shouldRefreshPerTrack||n._newMediaKeysPerTrack)?(wn.info("Creating media keys"),n._emeManager.createMediaKeys(a).then((function(){return!0})).catch((function(e){return e.unrecoverable=!0,n._emitError(e,!1,n._upcomingContent?n._upcomingContent.toLogJSON():void 0),Promise.reject(e)}))):Promise.resolve(!0)}))}},{key:"_handleLoadingComplete",value:function(e){var t=this._currentContent&&this._currentContent.getMediaType(),n=this._getContainerElement("video"===t?this._videoPlayerContainer:this._audioPlayerContainer);return n&&this._player&&this._player.parentNode!==n&&(n.appendChild(this._player),"video"===t&&this.emit(ue.PLAYER_VIDEO_ELEMENT_APPENDED,null)),this._upcomingContent=null,e}},{key:"_handleLoadingError",value:function(e,t,n,r){if(this._upcomingContent=null,n.aborted)return Promise.resolve(!1);if(this._tracker.trackLoadFailed(),this.emit(ue.PLAYER_LOADING_FAILED,{uri:e,logData:t.logData}),r){var i=r.track||{uri:e,fileId:t.fileId,format:t.format,deviceId:t.logData.deviceId};this._emitError(r,"StorageError"!==r.name||!!r.canPlayNext,i)}return Promise.reject(r)}},{key:"_handleLoadedMetadata",value:function(e,t,n){var r=this;if(e.aborted)wn.info("LoadedMetadata operations dropped: operation aborted.");else{this._loaded=!0;var i=this._player;if(i){this._bufferManager.dequeueUpdates();var a=n.position>i.duration?0:n.position;this._lastTimeUpdatePostion=0,(isNaN(i.currentTime)||i.currentTime<a)&&(wn.info("Resetting initial position after metadata."),i.currentTime=a),this._tracker.trackLoadDone(Yn(i.currentTime)),this.emitSync(ue.PLAYER_LOAD,{autoplay:n.autoplay,position:Yn(a),logData:t}),Promise.resolve().then((function(){r._onTimeUpdate()}));var o=function(){i.currentTime<a&&(wn.info("Resetting initial position after playable."),i.currentTime=a)};n.autoplay&&!i.error&&(o=function(){(i.currentTime<a&&(wn.info("Resetting initial position after playable."),i.currentTime=a),e.aborted)?wn.info("Play trigger dropped: operation aborted"):new Promise((function(e){return e(r._player&&r._player.play())})).catch((function(e){if(e){if("NotSupportedError"===e.name)return Promise.reject(e);if("NotAllowedError"===e.name)return r.emit(ue.PLAYER_AUTOPLAY_FAILED,null),Promise.reject(e)}return r._player?r._player.play():Promise.resolve()})).catch((function(){r._onPause()}))}),i.readyState>2?(wn.info("Ready to play, triggering play."),o()):(wn.info("Waiting to be playable."),this.once(ue.INTERNAL_PLAYER_CANPLAY,o))}}}},{key:"_handleCanPlayThrough",value:function(e){e.aborted?wn.info("CanPlayThrough operations dropped: operation aborted."):this._tracker.trackCanPlayThrough()}},{key:"_loadContent",value:function(e,t){if(t.aborted||!this._upcomingContent)return wn.info("Loading content dropped: operation aborted."),Promise.resolve(!1);if(!this._player)throw new Ee(r.PLAYER_INVALID_INTERNAL_STATE,"Cannot load content without an HTMLMediaElement");this._canPreloadEmitted=!1;var n=this._upcomingContent;this._upcomingContent=null,this._currentContent=n,this._setAudioGain(n),this._subtitleManager.setVideoContent(n instanceof jt?n:null);var i=e.callback;i&&this.once(ue.PLAYER_LOAD,(function(){t.aborted?wn.info("Load content event dropped: operation aborted."):i()})),this.once(ue.INTERNAL_PLAYER_LOADED_METADATA,this._handleLoadedMetadata.bind(this,t,this._currentContent.getLogData(),e)),this.once(ue.INTERNAL_PLAYER_CANPLAYTHROUGH,this._handleCanPlayThrough.bind(this,t));var a=e.position,o=n.getCalculatedDuration();o&&a>o&&(a=e.position=0);try{this._player.currentTime=a}catch(u){wn.warn("Cannot set initial position before loading.",u)}var s=n.isProtected();return this._tracker.setProtected(s),n.getKeySystem()===le.FAIRPLAY?n instanceof Jt&&!s?Promise.resolve(this._loadUnprotectedTrack()):Promise.resolve(this._loadHLSProtectedTrack(e,t)):n instanceof jt?this._loadVideoTrack(e,t):s?this._loadProtectedTrack(e,t):Promise.resolve(this._loadUnprotectedTrack())}},{key:"_getBufferingLatency",value:function(){var e=this;return new Promise((function(t){if(e._player){var n=Date.now();e._player.addEventListener("canplaythrough",(function e(){this.removeEventListener("canplaythrough",e),t(Date.now()-n)}))}else t(0)}))}},{key:"_loadVideoTrack",value:function(e,t){var n=this;if(!(this._player&&this._currentContent&&this._currentContent instanceof jt))return Promise.resolve(!1);var i=this._currentContent;wn.info("_loadVideoTrack");var a=function(){n._currentContent&&n._currentContent.isProtected()&&n._requestLicense(t).then((function(){t.aborted||(n._licenseRequested=!0,n._disableBufferingBeforeLicense&&n._onTimeUpdate())}))};this._disableLicensePrefetch?this.once(ue.INTERNAL_ENCRYPTED,a):this._bufferManager.once(ue.BUFFER_SOURCE_OPEN,a);var o=this.getMediaSource();if(!o)throw new Ee(r.PLAYER_INVALID_INTERNAL_STATE,"No media source.");this._player.src=URL.createObjectURL(o);var s=i.getVideoProfile(),u=i.getAudioProfile();return u||s?(this._tracker.trackVideoLoadStart({bitrate:null==s?void 0:s.video_bitrate,audioProfile:null!=u?u:void 0,videoProfile:null!=s?s:void 0}),this._tracker.trackBufferLoadStart(),this._bufferManager.setDuration(i.getCalculatedDuration()).then((function(){return n._bufferManager.appendFragment(i,i.getInitFragment())})).then(this._onAppendedHeadSegment(t))):Promise.resolve(!1)}},{key:"_loadHLSProtectedTrack",value:function(e,t){var n=this;if(wn.info("Load HLS Protected Track"),!this._player||!this._currentContent)return!1;var i=this._currentContent.getResolvedURL();if(!i)throw new me(r.FILE_NOT_RESOLVED,"Cannot load HLS protected track: File not resolved.");this.on(ue.INTERNAL_ENCRYPTED,(function e(r){r.data.fromPolyfill&&(n.removeListener(ue.INTERNAL_ENCRYPTED,e),n._requestLicense(t,{initData:r.data.initData}))}));var a=this._currentContent;if(a instanceof jt){var o=a.getVideoProfile(),s=a.getAudioProfile();this._tracker.trackVideoLoadStart({bitrate:null==o?void 0:o.video_bitrate,audioProfile:null!=s?s:void 0,videoProfile:null!=o?o:void 0})}this._tracker.trackBufferLoadStart(),this._tracker.trackBufferURL(i,{bandwidth:0});var u=document.createElement("source");return u.src=this._currentContent.getHLSURL(),u.type=Rt,this._player.appendChild(u),this._player.load(),!0}},{key:"_loadUnprotectedTrack",value:function(){if(!this._player||!this._currentContent)return!1;var e=this._currentContent.getResolvedURL();return!!e&&(wn.info("_loadUnprotectedTrack",this._currentContent.getURI()),this._tracker.trackBufferLoadStart(),this._tracker.trackBufferURL(e,{bandwidth:0}),this._player.src=e,this._player.load(),!0)}},{key:"_onAppendedHeadSegment",value:function(e){var t=this;return function(){return!e.aborted&&(t._player&&t._player.spload&&t._player.spload(),wn.info("Head segment appended."),!0)}}},{key:"_loadProtectedTrack",value:function(e,t){var n=this;if(!(this._currentContent&&this._player&&this._currentContent instanceof Jt))return Promise.resolve(!1);var i=this._currentContent;wn.info("_loadProtectedTrack",i.getURI());var a=function(){return n._requestLicense(t).then((function(){t.aborted||(n._licenseRequested=!0,n._disableBufferingBeforeLicense&&n._onTimeUpdate())}))};this._disableLicensePrefetch?this.once(ue.INTERNAL_ENCRYPTED,a):this._bufferManager.once(ue.BUFFER_SOURCE_OPEN,a);var o=this.getMediaSource();if(!o)throw new Ee(r.PLAYER_INVALID_INTERNAL_STATE,"No media source.");this._player.src=URL.createObjectURL(o),this._tracker.trackBufferLoadStart();var s=i.getFragmentForTime(e.position),u=null;return s===i.getFirstFragment()?(wn.info("Appending combined init and playable fragment."),u=this._bufferManager.appendFragment(i,i.getHeadFragment())):(wn.info("Appending split init and playable fragment."),u=this._bufferManager.appendFragment(i,s)),u.then(this._onAppendedHeadSegment(t)).then((function(){return Promise.resolve(!t.aborted)}))}},{key:"_requestLicense",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e.aborted){return wn.info("Request license dropped: operation aborted."),Promise.resolve(!1)}if(!this._player||!this._currentContent||!this._emeManager)return Promise.resolve(!1);var r,i=Date.now(),a=this._player.mediaKeys,o=this._currentContent,s=o.getFileId(),l=o.getLogData(),c=o.toLogJSON(),_=o.getKeySystem(),d=o.getLicenseEndpoint();if(d)r=Promise.resolve(d);else{if(!s)return Promise.reject(new TypeError("Missing: fileId or licenseEndpoint"));r=this._licenseURLResolver.get(_,o.getMediaType()).then((function(e){return e.replace(/\{contentId\}/,s)}))}var f=this._emeManager,h=this._tracker;return h.setKeySystem(_),h.setKeySystemImpl(f.getKeySystemImpl()),Promise.all([r,o.getInitParams()]).then((function(t){var r=(0,u.Z)(t,2),o=r[0],s=r[1];h.setLicenseSessionLatency(Date.now()-i);var l=s.initDataType,c=n.initData||s.initData;if(a&&c&&l){var _=Object.assign(Object.assign({},s),{signal:e,initData:c,mediaKeys:a,licenseServer:o,initDataType:l});return f.createSessionWithParams(_)}return Promise.resolve(!1)})).then((function(n){if(e.aborted)return wn.info("License tracking dropped: operation aborted."),Promise.resolve(!1);"boolean"!=typeof n&&"elapsed"in n&&(h.setLicenseGenerationLatency(n.elapsed.generate),h.setLicenseRequestLatency(n.elapsed.request),h.setLicenseUpdateLatency(n.elapsed.update));var r=Date.now()-i;return h.setKeyLatency(r),t.emit(ue.PLAYER_KEY_RECEIVED,{requestTime:r,logData:l}),wn.info("License updated."),Promise.resolve(!0)})).catch((function(n){if(e.aborted)return Promise.resolve(!1);var r=!n||!("canPlayNext"in n)||n.canPlayNext;return t._emitError(n,r,c),Promise.reject(n)}))}},{key:"_onTimeUpdate",value:function(){var e;if(this._loaded&&(null===(e=this._player)||void 0===e?void 0:e.readyState)&&this._currentContent){var t=this._currentContent,n=this._player.seeking,r=this._player.currentTime,i="video"===t.getMediaType();if(t.isProtected()&&this._disableBufferingBeforeLicense&&!this._licenseRequested)wn.log("Dropping time update event: buffering before license disabled.");else if(n||!this._lastTimeUpdatePostion||this._lastTimeUpdatePostion!==r){this._lastTimeUpdatePostion=n?0:r,t.getKeySystem()!==le.FAIRPLAY&&(i||t.isProtected())&&this._bufferManager.progress(t,n,r);var a=this._player.duration,o=Yn(r),s=t.getLogData();n?(this._tracker.trackPositionChanged(o),this.emit(ue.PLAYER_POSITION_CHANGED,{position:o,logData:s})):(this._tracker.trackProgress(o,"getCurrentBitrate"in t?t.getCurrentBitrate():0),this.emit(ue.PLAYER_PROGRESS,{timestamp:Date.now(),position:o,played:this._tracker.getMSPlayed(),interval:500,logData:s})),!this._canPreloadEmitted&&a-r<=10?(this._canPreloadEmitted=!0,this.emit(ue.PLAYER_CAN_PRELOAD,null)):this._canPreloadEmitted=!1,clearTimeout(this._syntheticEndedToken),this._synthesizeEnded&&t.isProtected()&&this._isPlaying()&&(this._syntheticEndedToken=setTimeout(this._onSyntheticEnded,Yn(a-r)))}else wn.warn("Dropping duplicate time update.")}}},{key:"_isPlaying",value:function(){return!!this._player&&!this._player.paused}},{key:"_createAudioContent",value:function(e,t){var n=this,r={manifestLatency:0,resolveLatency:0};return(this._emeManager?this._emeManager.getKeySystemInfo():Promise.resolve({keySystem:le.INVALID_SPOTIFY_KEY})).then((function(i){return Jt.create({abrManager:n._abrManager,mediator:n._mediator,keySystem:i.keySystem,licenseEndpoint:t.licenseEndpoint,transport:n._transport,resolver:n._audioResolver,uri:e,fileId:t.fileId,fileFormat:t.fileFormat,format:t.format,isAd:t.isAd,resolvedURL:t.resolvedURL,noManifest:t.noManifest,preloadedManifest:t.preloadedManifest,logData:t.logData,disableCache:n._disableCache,emitWarning:n._emitWarning,audioGain:t.audioGain}).load(r)})).then((function(e){var i=n._tracker;return i.setResolveLatency(r.resolveLatency),i.setManifestLatency(r.manifestLatency),e.isProtected()&&t.fileId&&!n._disableCache&&n._cache.set(t.fileId,e),e}))}},{key:"_createVideoContent",value:function(e,t){var n=this,r={manifestLatency:0,resolveLatency:0},i=t.fileId;return(this._emeManager?this._emeManager.getKeySystemInfo():this.getMediaConfig().then((function(e){return{keySystem:le.INVALID_SPOTIFY_KEY,audioFormats:e.formatsInfo.audio,videoFormats:e.formatsInfo.video}}))).then((function(a){return jt.create({uri:e,abrManager:n._abrManager,mediator:n._mediator,resolver:n._videoResolver,keySystem:a.keySystem,licenseEndpoint:t.licenseEndpoint,fileId:i,noAuth:t.noAuth,format:_e.MANIFEST_ID,isAd:t.isAd,transport:n._transport,videoFormats:a.videoFormats,videoResolution:n._videoResolution,audioFormats:a.audioFormats,disableCache:n._disableCache,disallowProfile:n._disallowProfile,allowMixedAVC1Codecs:n._allowMixedAVC1Codecs,audioGain:t.audioGain}).load(r)})).then((function(e){var t=n._tracker;return t.setResolveLatency(r.resolveLatency),t.setManifestLatency(r.manifestLatency),e.isProtected()&&i&&!n._disableCache&&n._cache.set(i,e),e}))}},{key:"_preinitMediaElement",value:function(){var e=this;if(this._player||!this._emeManager)return Promise.resolve(this);var t=(0,o.createAbortControllerLike)();return this._emeManager.getKeySystemInfo().then((function(n){var r,i,a=[];return(null===(r=n.audioFormats)||void 0===r?void 0:r[0])&&a.push(n.audioFormats[0].contentType),(null===(i=n.videoFormats)||void 0===i?void 0:i[0])&&a.push(n.videoFormats[0].contentType),!!a.length&&e._recreateMediaElement(a,t.signal,a.length>1?"video":"audio",n.keySystem!==le.FAIRPLAY)})).then((function(){return e}),(function(t){return wn.warn("Cannot precreate media element:",null==t?void 0:t.message),e}))}},{key:"_setAudioGain",value:function(e){var t;null===(t=this._audioProcessor)||void 0===t||t.setAudioGain(e.getAudioGain())}},{key:"getCodecInfo",value:function(){return{audiocodec:"mp3",bitrate:160}}},{key:"getMediaSource",value:function(){return this._bufferManager.getMediaSource()}},{key:"load",value:function(e,t,n){var i,a=this,s=function(e,t){return t&&t.hasOwnProperty(e)}(t.uriProperty,e)?t.uriProperty:"uri",u=e[s];if(wn.info("load",u),!u)return Promise.reject(new Ee(r.PLAYER_CANNOT_FIND_PLAYABLE_URI,"Cannot find a playable URI."));if(!e.logData)return Promise.reject(new Error("Invalid track: logging info not specified"));this.stop(e.logData,e.mediaType),this._loaded=!1,this._licenseRequested=!1,this._buffering=!0,this._currentContent=null,this._subtitleManager.setVideoContent(null);var l=++this._playId;this._abortController=(0,o.createAbortControllerLike)();var c,_=this._abortController.signal,d=this._tracker;d.trackLoadStart(u,e.fileId,l.toString(),e.logData,e.metadata),this.emit(ue.PLAYER_BEFORE_LOAD,{track:e,options:t,logData:e.logData,uri:u,timestamp:Date.now()}),this._bufferManager.setPlayId(l),this._loadingOptions={position:Bn(t.position||0),autoplay:!("autoplay"in t)||t.autoplay,poster:e.poster,useDefaultPlaybackSpeed:!!(null===(i=e.options)||void 0===i?void 0:i.useDefaultPlaybackSpeed),callback:n},d.setPlayIntended(this._loadingOptions.autoplay),d.setPlayedThreshold(t.playedThreshold);var f=this._cache,h="video"===e.mediaType?this._createVideoContent.bind(this,u,e):this._createAudioContent.bind(this,u,e);if(e.fileId){var v=e.fileId,p=this._preloadingTracks[v],E=this._disableCache?null:f.get(v);p?(wn.info("Waiting for preloading track.",v),c=p.then((function(e){return wn.info("Preloading succeeded.",v),d.setResolveLatency(e.resolveLatency),d.setManifestLatency(e.manifestLatency),f.get(v)}),(function(){return wn.info("Preloading failed, creating new track",v),h()}))):E?(wn.info("Using cached track.",v,E),d.setMemoryCached(!0),c=Promise.resolve(E)):(wn.info("Creating new track from fileId",v),c=h())}else wn.info("Creating new track without fileId",e.resolvedURL),c=h();return c.then((function(t){if(t.isProtected()&&!a._emeManager)throw new Ee(r.DISALLOW_PROTECTED_TRACK_ERROR,"Protected tracks not supported");t.setLogData(e.logData),d.setCalculatedDuration(Yn(t.getCalculatedDuration())),a._upcomingContent=t})).then(this._prepareMediaElement.bind(this,this._loadingOptions,_)).then((function(){a._audioProcessor.setPlayer(a._player)})).then(this._loadContent.bind(this,this._loadingOptions,_)).then(this._handleLoadingComplete,this._handleLoadingError.bind(this,u,e,_))}},{key:"preload",value:function(e){var t=this,n=!this._disableCache,r=e.uri,i=e.fileId,a=this._cache;if(!n||!i||!this._emeManager)return Promise.resolve(null);var o="video"===e.mediaType;if(!(Fn[e.format]&&!o)||a.get(i))return Promise.resolve(null);var s=this._preloadingTracks,l=s[i];if(l)return l;wn.info("Preloading track",i);var c={manifestLatency:0,resolveLatency:0},_=this._emeManager.getKeySystemInfo().then((function(n){return Jt.create({abrManager:t._abrManager,keySystem:n.keySystem,licenseEndpoint:e.licenseEndpoint,transport:t._transport,resolver:t._audioResolver,uri:r,fileId:i,format:e.format,fileFormat:e.fileFormat,isAd:e.isAd,resolvedURL:e.resolvedURL,noManifest:e.noManifest,preloadedManifest:e.preloadedManifest,logData:e.logData,disableCache:t._disableCache,emitWarning:t._emitWarning,audioGain:e.audioGain}).load(c)})).then((function(t){return Promise.all([t,"MP4_CBCS"!==e.format?t.getBufferForFragment(t.getHeadFragment()):null])})).then((function(e){var t=(0,u.Z)(e,1)[0];return a.set(i,t),delete s[i],wn.info("Cached",i),c})).catch((function(e){return delete s[i],wn.warn("Preloading error",e),t.emit(ue.PLAYER_PRELOADING_ERROR,{error:e,track:e.track||null,canPlayNext:!("canPlayNext"in e)||e.canPlayNext,preloading:!0}),Promise.reject(e)}));return s[i]=_,_}},{key:"togglePlay",value:function(){return this._isPlaying()?this.pause():this.resume()}},{key:"setSubtitleLanguage",value:function(e){this._subtitleManager.setLanguage(e)}},{key:"getSubtitleLanguages",value:function(){return this._subtitleManager.getAvailableLanguages()}},{key:"getActiveSubtitleLanguage",value:function(){return this._subtitleManager.getActiveLanguage()}},{key:"deactivateCueEvents",value:function(){this._subtitleManager.deactivateListeners()}},{key:"activateCueEvents",value:function(){this._subtitleManager.activateListeners()}},{key:"setVolume",value:function(e,t){if(!this.emitSync(ue.PLAYER_BEFORE_VOLUME_CHANGE,{volume:e,options:t}).defaultPrevented){if(e<0||e>1)throw new Ee(r.PLAYER_ATTEMPTED_VOLUME_OUT_OF_RANGE,"Volume should be in range [0, 1]");this._playerVolume=e,this._player&&(this._player.volume=this._cubicVolume?e*e*e:e)}}},{key:"getVolume",value:function(){return this._playerVolume}},{key:"getPlayerState",value:function(){var e,t,n,r=this._player,i=this._currentContent,a={src:(null==r?void 0:r.src)?"data:".concat((null==i?void 0:i.getFileId())||"unknown"):void 0,height:(null==r?void 0:r.clientWidth)||0,width:(null==r?void 0:r.clientHeight)||0},o={};if(i){var s=i.getPlayableCodecs(),l=(0,u.Z)(s,2),c=l[0],_=l[1];o.audio_format=c,o.video_format=_,i instanceof jt&&r instanceof HTMLVideoElement&&(o.video_height=r.videoHeight,o.video_width=r.videoWidth,a.poster=r.poster)}return{playing:null!==(e=!(null==r?void 0:r.paused))&&void 0!==e&&e,position:r?Yn(r.currentTime):0,duration:r?Yn(r.duration):0,volume:null!==(t=this._playerVolume)&&void 0!==t?t:1,playback_speed:null!==(n=null==r?void 0:r.playbackRate)&&void 0!==n?n:0,buffering:this._buffering,media_type:(null==i?void 0:i.getMediaType())||null,media_info:o,player_element:a}}},{key:"getPlayerPosition",value:function(){return this._player?Yn(this._player.currentTime):0}},{key:"seek",value:function(e){var t,n=this;if(this._player){var r=null===(t=this._abortController)||void 0===t?void 0:t.signal,i=function(){if(n._player&&!(null==r?void 0:r.aborted)){var t=Bn(e);t<0?t=0:t>=n._player.duration&&(t=n._player.duration),n._player.currentTime=t}else wn.info("Seek dropped: operation aborted.")};this._loaded?i():this.once(ue.PLAYER_LOAD,i),this._getBufferingLatency().then((function(e){n._tracker.trackSeekRebuffering(e)}))}}},{key:"pause",value:function(){var e=this;return new Promise((function(t){e._player&&e._isPlaying()?t(e._player&&e._player.pause()):t()}))}},{key:"resume",value:function(){var e=this;return this._audioProcessor.resume().then((function(){e._player&&!e._isPlaying()&&Promise.resolve(e._player.play())}))}},{key:"stop",value:function(e,t){var n,r,i=[],a=e||{};this.emit(ue.PLAYER_BEFORE_STOP,{timestamp:Date.now(),logData:a}),null===(n=this._abortController)||void 0===n||n.abort(),this._tracker.trackStopped(this._player?Yn(this._player.currentTime):-1,e,this.getStatistics()||void 0),this._bufferManager.abort(!0),this._emeManager&&i.push(this._emeManager.destroySessions());var o=this._player;if(o){this._subtitleManager.clear(),this._fatalOnNextError=this._shouldNextErrorBeFatal(),this._fatalOnNextError&&wn.warn("MediaError detected: next immediate media error will be fatal.");var s=o.src;if(s)Un.test(s)&&URL.revokeObjectURL(s),o.removeAttribute("src");else{var u=an(o.getElementsByTagName("source"));wn.info("HTMLSourceElements to removed: ".concat(u.length));var l,c=Nn(u);try{for(c.s();!(l=c.n()).done;){var _=l.value;o.removeChild(_)}}catch(h){c.e(h)}finally{c.f()}wn.info("Releasing HLS URLs"),null===(r=this._currentContent)||void 0===r||r.releaseHLSURL()}o.load()}if(this._currentContent&&this._disableCache&&this._currentContent.clearCachedBuffers(),o&&this._currentContent&&"video"===this._currentContent.getMediaType()){var d=this._getContainerElement(this._videoPlayerContainer);d&&o.parentNode===d&&(this._newElementPerTrack||"video"!==t)&&(this._subtitleManager.setPlayer(null),d.removeChild(o),this.emit(ue.PLAYER_VIDEO_ELEMENT_REMOVED,null))}else if(o&&this._currentContent&&"audio"===this._currentContent.getMediaType()){var f=this._getContainerElement(this._audioPlayerContainer);f&&o.parentNode===f&&(this._newElementPerTrack||"audio"!==t)&&f.removeChild(o)}return this.emit(ue.PLAYER_STOPPED,null),Promise.all(i).then((function(){return!0}))}},{key:"hideSubtitles",value:function(){this._subtitleManager.hide()}},{key:"showSubtitles",value:function(){this._subtitleManager.show()}},{key:"areSubtitlesShown",value:function(){return this._subtitleManager.visible()}},{key:"getKeySystemInfo",value:function(){return this._emeManager?this._emeManager.getKeySystemInfo():Promise.resolve(null)}},{key:"getVideoVariants",value:function(){if(!(this._currentContent&&this._currentContent instanceof jt))return[];var e,t=[],n=Nn(this._currentContent.getVideoProfiles());try{for(n.s();!(e=n.n()).done;){var r=e.value;t.push({width:r.video_width,height:r.video_height,bitrate:r.video_bitrate})}}catch(i){n.e(i)}finally{n.f()}return t}},{key:"setPreferredBitrate",value:function(e){return"number"!=typeof e?Promise.resolve(ce.INVALID):(this._preferredBitrate=e,this._currentContent&&"video"===this._currentContent.getMediaType()&&e>0&&this._bufferManager.abort(!0),this._abrManager.overrideBitrate(e),Promise.resolve(ce.SUCCESS))}},{key:"getCurrentBandwidth",value:function(){return this._abrManager.getBandwidthEstimate()}},{key:"setBackgrounded",value:function(e){this._abrManager.overrideBitrate(e?1e-32:this._preferredBitrate)}},{key:"setVideoResolution",value:function(e){this._videoResolution=Object.assign(Object.assign({},this._videoResolution),e),this._currentContent instanceof jt&&this._currentContent.setVideoResolution(this._videoResolution)}},{key:"activateElement",value:function(){var e=this;return this._playerActivated||!this._player||this._player.src?(this._audioProcessor.resume(),!1):(this._audioProcessor.resume().then((function(){var t;return null===(t=e._player)||void 0===t?void 0:t.load()})),this._playerActivated=!0,!0)}},{key:"getMediaConfig",value:function(){var e=this;return void 0===this._mediaConfig?function(e,t){var n=t||xn("video"),r=function(e){n.canPlayType("audio/mp3")&&(e.formats.audio.push("audio/mp3"),e.formatsInfo.audio.push({mimeType:"audio/mp3",codec:"mp3",contentType:'audio/mp3; codecs="mp3"'}),e.supports.unprotected_audio=!0)};if(e)return e.getKeySystemInfo().then((function(e){var t=e.audioFormats,n=e.videoFormats,i={supports:{protected_audio:!!t.length,unprotected_audio:!0,protected_video:!!n.length,unprotected_video:!0},formats:{audio:t.map((function(e){return e.contentType})),video:n.map((function(e){return e.contentType}))},formatsInfo:{audio:(0,I.Z)(t),video:(0,I.Z)(n)}};return i.keysystem=e.keySystem,i.keysystem_impl=e.keySystemImpl,r(i),i}));var i="undefined"!=typeof window&&window.MediaSource?function(e){return MediaSource.isTypeSupported(e)}:function(e){return"probably"===n.canPlayType(e)||"probably"===n.canPlayType(e.split(";")[0])},a=at([nt[0]],i),o=[],s=[],u=[],l=[];if(a){var c,_=a.audioCapabilities,d=a.videoCapabilities,f=Nn(_);try{for(f.s();!(c=f.n()).done;){var h=c.value;o.push(h.contentType),u.push(st(h.contentType))}}catch(m){f.e(m)}finally{f.f()}var v,p=Nn(d);try{for(p.s();!(v=p.n()).done;){var E=v.value;s.push(E.contentType),l.push(st(E.contentType))}}catch(m){p.e(m)}finally{p.f()}}var y={supports:{protected_audio:!1,unprotected_audio:!!o.length,protected_video:!1,unprotected_video:!!s.length},formats:{audio:o,video:s},formatsInfo:{audio:u,video:l}};return r(y),Promise.resolve(y)}(this._emeManager,this._player).then((function(t){return e._mediaConfig=t,e._mediaConfig})):Promise.resolve(this._mediaConfig)}},{key:"setPlaybackSpeed",value:function(e){var t;return!(!isFinite(e)||e<=0)&&(!(null===(t=this._loadingOptions)||void 0===t?void 0:t.useDefaultPlaybackSpeed)&&(this._playerSpeed=null!=e?e:1,this._player&&(this._player.playbackRate=this._playerSpeed,this._tracker.trackSpeedChanged(this._playerSpeed)),!0))}},{key:"getStatistics",value:function(){return this._player&&this._currentContent?this._statistics.getSample(this._player,this._currentContent):null}},{key:"getAudioProcessor",value:function(){return this._audioProcessor}}],[{key:"create",value:function(e){var t=Object.assign({},e);return e.disallowProtectedTracks?n.createWithOptions(t):pt.create({transport:e.transport,disallowRobustnessValues:e.disallowRobustnessValues,disallowCodecs:e.disallowCodecs,noServerCertificate:e.noServerCertificate,precacheServerCertificate:e.precacheServerCertificate,unauthServerCertificateBase:e.unauthServerCertificateBase,preferredKeySystems:e.preferredKeySystems}).then((function(e){t.emeManager=e;var r=new n(t);return t.preinitMediaElement?r._preinitMediaElement():r})).catch((function(r){if(e.enableWithoutEME)return n.createWithOptions(t);throw r}))}},{key:"createWithOptions",value:function(e){return new Promise((function(t){var r=new n(e);t(e.preinitMediaElement?r._preinitMediaElement():r)}))}}]),n}(p.vp);function Kn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var Vn=function(e){(0,f.Z)(n,e);var t=Kn(n);function n(e,r){var i;return(0,c.Z)(this,n),(i=t.call(this,r)).debug={},i.name="LoggingError",i.message=r,i.code=e,i}return(0,_.Z)(n)}((0,A.Z)(Error));const Gn="7.21.3-1cb09a4",Hn="7.21.3";function jn(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return qn(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return qn(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function qn(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Wn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var Qn=he.P.forTag("playback.logger"),zn=function(e){(0,f.Z)(n,e);var t=Wn(n);function n(e){var r;return(0,c.Z)(this,n),(r=t.call(this))._currentTrackingData=null,r._sequenceId=0,r._sequenceSessionStorage={},r._sessionId="0",r._transport=e.transport,r._logSender=e.logSender,r._player=e.player,r._init(),r}return(0,_.Z)(n,[{key:"_init",value:function(){var e=this._player;e.on(ue.PLAYER_LOAD,this._onPlayerLoad.bind(this)),e.on(ue.PLAYER_ERROR,this._onError.bind(this,!1)),e.on(ue.PLAYER_WARNING,this._onError.bind(this,!0)),e.on(ue.PLAYER_PRELOADING_ERROR,this._onError.bind(this,!1)),e.on(ue.PLAYER_TRACKING_DATA_CREATED,this._onTrackingDataCreated.bind(this)),e.on(ue.PLAYER_TRACKING_DATA_FINALIZED,this._onTrackingDataFinalized.bind(this)),e.on(ue.PLAYER_PLAYBACK_START,this._onPlaybackStart.bind(this))}},{key:"_emitError",value:function(e,t){this.emit(ue.LOGGER_ERROR,{error:e,trackingData:t})}},{key:"_onError",value:function(e,t){var n,i,a,o=t.data,s=this._currentTrackingData;if(s&&!s.noLog){var u=o.error,l=null!==(n=null==u?void 0:u.debug)&&void 0!==n?n:{};l.position="position"in o?o.position:0;var c={track:o.track||{},debug:l,preloading:"preloading"in o&&!!o.preloading,session_id:this._sessionId,playback_id:s.playbackId||null,player_play_id:"playId"in o?o.playId:null,http_status_code:null!==(i=null==u?void 0:u.status)&&void 0!==i?i:null,license_server:null!==(a=null==u?void 0:u.licenseServer)&&void 0!==a?a:null};this._logError(u.code||r.UNKNOWN,u,c,s,e)}}},{key:"_onPlayerLoad",value:function(e){var t=e.data.logData;if(t)if(t.impressionURLs){var n,r=jn(t.impressionURLs);try{for(r.s();!(n=r.n()).done;){var i=n.value;this._logImpression(i)}}catch(a){r.e(a)}finally{r.f()}}else t.impressionURL&&this._logImpression(t.impressionURL)}},{key:"_onPlaybackStart",value:function(e){var t=e.data.trackingData;t.noLog||t.noStats||this._logPlaybackStart(t)}},{key:"_onTrackingDataCreated",value:function(e){var t=e.data.trackingData;t.noLog?this._currentTrackingData=null:(this._currentTrackingData=t,this._setSessionId(),t.noTSV||this._setSequenceId())}},{key:"_setSessionId",value:function(){this._sessionId=this._transport.getInitTime().toString()}},{key:"_setSequenceId",value:function(){this._sessionId&&(this._sequenceId=this._getSequenceId(this._sessionId))}},{key:"_onTrackingDataFinalized",value:function(e){var t=e.data.trackingData;if(!t.noLog){var n=this._sessionId!==this._transport.getInitTime().toString();if(n&&this._setSessionId(),t.playbackId&&!t.noTSV){if(n&&this._setSequenceId(),!t.playIntended&&!t.played)return void this._rollbackSequenceId(this._sessionId);this._logTrackStreamVerification(t)}t.noStats||this._logPlaybackStats(t)}}},{key:"_logTrackStreamVerification",value:function(e){var t=this,n={play_track:e.currentTrackUri,playback_id:e.playbackId,ms_played:e.msPlayed,ms_nominal_played:e.msNominalPlayed,session_id:this._sessionId,sequence_id:this._sequenceId,next_playback_id:e.nextPlaybackId};Qn.debug("Logged TrackStreamVerification",n),this._logSender.logTrackStreamVerification(n).catch((function(i){var a=new Vn(r.TSV_SENDING_FAILED,i.message||"Unknown reason.");t._logError(a.code,i,n,e,!1),t._emitError(a,e)}))}},{key:"_logPlaybackStats",value:function(e){var t=this,n={play_track:e.currentTrackUri,file_id:e.fileId,playback_id:e.playbackId,internal_play_id:e.internalPlayId,memory_cached:e.memoryCached,persistent_cached:e.persistentCached,audio_format:e.audiocodec||"",video_format:e.videocodec||"",manifest_id:e.fileId,protected:!1,key_system:e.keySystem,key_system_impl:e.keySystemImpl,urls_json:JSON.stringify(e.urls),start_time:e.loadTime,end_time:e.stopTime,external_start_time:e.externalLoadTime,ms_play_latency:e.msPlayLatency,ms_init_latency:e.msInitLatency,ms_head_latency:e.msHeadLatency,ms_manifest_latency:e.msManifestLatency,ms_resolve_latency:e.msResolveLatency,ms_license_session_latency:e.msLicenseSessionLatency,ms_license_generation_latency:e.msLicenseGenerationLatency,ms_license_request_latency:e.msLicenseRequestLatency,ms_license_update_latency:e.msLicenseUpdateLatency,ms_played:e.msPlayed,ms_nominal_played:e.msNominalPlayed,ms_file_duration:e.msFileDuration,ms_actual_duration:e.msActualDuration,ms_metadata_duration:e.msMetadataDuration,ms_start_position:e.startPosition,ms_end_position:e.position,ms_seek_rebuffer:e.msSeekRebuffering,ms_seek_rebuffer_longest:e.maxMsSeekRebuffering,ms_stall_rebuffer:e.msStalled,ms_stall_rebuffer_longest:e.maxMsStalled,n_stalls:e.nStalls,n_rendition_upgrade:e.nRenditionUpgrade,n_rendition_downgrade:e.nRenditionDowngrade,bps_bandwidth_max:e.bpsBandwidthMax,bps_bandwidth_min:e.bpsBandwidthMin,bps_bandwidth_avg:e.bpsBandwidthAvg,n_seekback:e.nSeeksBackward,n_seekforward:e.nSeeksForward,start_bitrate:e.startBitrate||e.bitrate||0,audio_quality:e.audioQuality,time_weighted_bitrate:e.timeWeightedBitrate,reason_start:e.reasonStart,reason_end:e.reasonEnd,initially_paused:!e.playIntended,had_error:e.hadError,n_warnings:e.nWarnings,n_navigator_offline:e.nOffline,session_id:this._sessionId,sequence_id:this._sequenceId,client_id:e.clientId,correlation_id:e.correlationId,n_dropped_video_frames:e.droppedVideoFrames,n_total_video_frames:e.totalVideoFrames,resolution_max:e.maxResolution||0,resolution_min:e.minResolution||0};Qn.info("Logging PlaybackStats"),this._logSender.logJSSDKPlaybackStats(n).catch((function(i){var a=new Vn(r.PLAYBACK_STATS_SENDING_FAILED,i.message||"Unknown reason.");t._logError(a.code,i,n,e,!1),t._emitError(a,e)}))}},{key:"_logPlaybackStart",value:function(e){var t=this,n={play_track:e.currentTrackUri,file_id:e.fileId,playback_id:e.playbackId,session_id:this._sessionId,ms_start_position:e.startPosition,initially_paused:!e.playIntended,client_id:e.clientId,correlation_id:e.correlationId};Qn.info("Logging PlaybackStart"),this._logSender.logJSSDKPlaybackStart(n).catch((function(i){var a=new Vn(r.PLAYBACK_START_SENDING_FAILED,i.message||"Unknown reason.");t._logError(a.code,i,n,e,!1),t._emitError(a,e)}))}},{key:"_getSequenceId",value:function(e){var t=this._sequenceSessionStorage[e];return t||(t=0),t+1>=9007199254740991&&(t=0),this._sequenceSessionStorage[e]=t+1,t}},{key:"_rollbackSequenceId",value:function(e){var t=this._sequenceSessionStorage[e];t&&(this._sequenceSessionStorage[e]=Math.max(t-1,0))}},{key:"_logImpression",value:function(e){this._transport.request(e,{forget:!0}).catch((function(e){Qn.warn("Unable to send impression request",e)}))}},{key:"_logError",value:function(e,t,n,r,i){var a="";t&&((a=t.stack||"")||(a=t.toString()));var o={source:"playback",source_version:Gn||ee.eV.UNKNOWN,type:e||ee.eV.UNKNOWN,message:t&&t.message||ee.eV.EMPTY,stack:JSON.stringify(a),json_data:JSON.stringify(n||{}),json_data_version:"1.0.0",client_id:r.clientId,correlation_id:r.correlationId};i?this._logSender.logJSSDKWarning(o).catch((function(e){return Qn.warn("Failed to log warning",o,e)})):this._logSender.logJSSDKError(o).catch((function(e){return Qn.warn("Failed to log error",o,e)}))}}],[{key:"create",value:function(e){return new n(e)}}]),n}(p.vp);function Xn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var Jn=function(e){(0,f.Z)(n,e);var t=Xn(n);function n(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:r.STORAGE_ERROR,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Storage Error";return(0,c.Z)(this,n),(e=t.call(this,a)).status=-1,e.fileId="",e.debug={},e.canPlayNext=!0,e.code=i,e.message=a,e.name="StorageError",e}return(0,_.Z)(n)}((0,A.Z)(Error)),$n=he.P.forTag("playback.storage_resolve"),er=function(){function e(t){(0,c.Z)(this,e),this._transport=t}return(0,_.Z)(e,[{key:"_parseResponse",value:function(e,t){var n,i;if(200!==t.status)return(i=new Jn(r.STORAGE_FAILED_WITH_STATUS,"Storage Resolve responded with ".concat(t.status))).status=t.status,i.fileId=e,Promise.reject(i);var a=t.body;if(!(null===(n=null==a?void 0:a.cdnurl)||void 0===n?void 0:n.length))return(i=new Jn(r.STORAGE_RETURNED_NO_TRACKS,"Storage Resolve returned no tracks for fileId ".concat(e))).fileId=e,Promise.reject(i);var o={uri:a.cdnurl[0],uris:a.cdnurl,protection:"cenc"};return Promise.resolve(o)}},{key:"getCDNURL",value:function(e,t){$n.info("Requesting CDN URL for ",e);var n="files/audio/interactive",r=t?"v2/".concat(n,"/").concat(t,"/").concat(e):"".concat(n,"/").concat(e),i="@webgate/storage-resolve/".concat(r,"?").concat("version=10000000&product=9&platform=39&alt=json");return this._transport.request(i,{responseType:"json",retry:{condition:function(e,t){return e.getStatusFamily()!==t.SUCCESS}}}).then(this._parseResponse.bind(this,e))}},{key:"getManifest",value:function(e){var t="".concat("https://seektables.scdn.co/seektable","/").concat(e,".json");return $n.info("Requesting JSON manifest for ",e),this._transport.request(t,{responseType:"json",retry:{condition:function(e,t){return e.getStatusFamily()!==t.SUCCESS}}}).then((function(t){var n;return 200!==t.status?((n=new Jn(r.STORAGE_TRACK_MANIFEST_FAILED,"Track manifest request failed with status code ".concat(t.status))).debug.file_id=e,n.status=t.status,Promise.reject(n)):t.body?t.body:((n=new Jn(r.STORAGE_TRACK_MANIFEST_EMPTY,"Received empty manifest.")).debug.file_id=e,n.status=t.status,Promise.reject(n))}))}}]),e}();function tr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var nr=function(e){(0,f.Z)(n,e);var t=tr(n);function n(e,r){var i;return(0,c.Z)(this,n),(i=t.call(this,r)).debug={},i.name="TrackingError",i.message=r,i.code=e,i}return(0,_.Z)(n)}((0,A.Z)(Error)),rr=(n(43975),n(90699),function(){function e(){(0,c.Z)(this,e),this._version="1.0.0",this._map={}}return(0,_.Z)(e,[{key:"clear",value:function(){this._map={}}},{key:"track",value:function(e,t){var n=this._map[e];n||(n={url:e,segments:0,bandwidths:[],totalBandwidth:0},this._map[e]=n),n.segments+=1,n.bandwidths.push(t.bandwidth),n.totalBandwidth+=t.bandwidth}},{key:"toJSON",value:function(){var e=[];for(var t in this._map)if(this._map[t]){var n=this._map[t];n&&e.push({url:t,segments:n.segments,avg_bw:parseFloat((n.totalBandwidth/n.bandwidths.length).toFixed(7))})}return{version:this._version,urls:e}}}]),e}()),ir=function(){function e(){(0,c.Z)(this,e),this._bitrates={},this._isFinalized=!1,this._needsEndSegment=!1,this._segments=[],this._cdnURLTracker=new rr,this._currentSpeed=1,this.audiocodec=null,this.bitrate=0,this.audioQuality=void 0,this.bufferLoadStartTime=0,this.urls={},this.currentTrackUri="",this.displayTrack="",this.externalLoadTime=0,this.fileId="",this.gaiaDevId="none",this.hadError=!1,this.internalPlayId="",this.isProtected=!1,this.keySystem="",this.keySystemImpl="",this.lastPlayPosition=-1,this.loadTime=0,this.localTimeMs=-1,this.maxContinuous=0,this.maxMsSeekRebuffering=0,this.maxMsStalled=0,this.memoryCached=!1,this.msActualDuration=0,this.msMetadataDuration=0,this.msFileDuration=0,this.msHeadLatency=0,this.msInitLatency=0,this.msKeyLatency=0,this.msLicenseGenerationLatency=0,this.msLicenseRequestLatency=0,this.msLicenseSessionLatency=0,this.msLicenseUpdateLatency=0,this.msManifestLatency=0,this.msPlayed=0,this.msNominalPlayed=0,this.msPlayedUnion=0,this.msPlayLatency=0,this.msResolveLatency=0,this.msSeekRebuffering=0,this.msSeeksBackward=0,this.msSeeksForward=0,this.nextPlaybackId="",this.nOffline=0,this.noLog=!1,this.noTSV=!1,this.noStats=!1,this.nWarnings=0,this.msStalled=0,this.nSeeksBackward=0,this.nSeeksForward=0,this.nSpeedChanges=!1,this.nStalls=0,this.nRenditionUpgrade=0,this.nRenditionDowngrade=0,this.bpsBandwidthMax=0,this.bpsBandwidthMin=0,this.bpsBandwidthAvg=0,this.totalBandwidth=0,this.lastBitrate=0,this.persistentCached=!1,this.playbackId="",this.playContext="",this.played=!1,this.position=0,this.reasonEnd="unknown",this.reasonStart="unknown",this.referrer="unknown",this.referrerVendor="unknown",this.referrerVersion="unknown",this.sourceEnd="unknown",this.sourceStart="unknown",this.startPosition=0,this.stopTime=0,this.streamingRule="none",this.timeWeightedBitrate=0,this.totalBytes=0,this.playIntended=!1,this.videocodec=null,this.clientId="unknown",this.correlationId="unknown",this.droppedVideoFrames=0,this.totalVideoFrames=0,this.maxResolution=0,this.minResolution=0}return(0,_.Z)(e,[{key:"_calculateUnion",value:function(){for(var e=this._segments.slice(0),t=0,n=0,r=0,i=0,a=0,o=0,s=this.maxContinuous;a<e.length;a++)a%2!=0&&void 0!==e[a-1]&&"start"===e[a-1].type&&(s=(o=e[a].time-e[a-1].time)>s?o:s);for(this.maxContinuous=s,e.sort((function(e,t){return e.time-t.time}));i<e.length;i++)"start"===e[i].type&&(0===n&&(r=i),++n),"end"===e[i].type&&0===--n&&(t+=e[i].time-e[r].time);return t}},{key:"_calculateWeightedBitrate",value:function(e){var t=this._bitrates,n=0;for(var r in t)r&&t.hasOwnProperty(r)&&e>0&&(n+=parseInt(r,10)*t[r]/e);return Math.round(n)}},{key:"registerVideoVariant",value:function(e){var t=e.bitrate;t&&(this._bitrates[t]=this._bitrates[t]||0,this.startBitrate||(this.startBitrate=t)),e.audioProfile&&(this.audiocodec=e.audioProfile.audio_codec),e.videoProfile&&(this.videocodec=e.videoProfile.video_codec,this.lastBitrate=e.videoProfile.video_bitrate,this.minResolution=e.videoProfile.video_resolution,this.maxResolution=e.videoProfile.video_resolution)}},{key:"addStartSegment",value:function(){this._segments.push({type:"start",time:this.position}),this._needsEndSegment=!0}},{key:"addEndSegment",value:function(){this._needsEndSegment&&(this._segments.push({type:"end",time:this.position}),this._needsEndSegment=!1)}},{key:"addMSPlayed",value:function(e){if(e){if(e<0)throw new TypeError("Cannot add negative msPlayed value: ".concat(e));this.msPlayed+=e/this._currentSpeed,this.msNominalPlayed+=e}}},{key:"addSpeedChange",value:function(e){this.nSpeedChanges=!0,this._currentSpeed=e}},{key:"trackBitrate",value:function(e,t){var n=e||"dummy";this._bitrates[n]=this._bitrates[n]||0,this._bitrates[n]+=t}},{key:"trackBufferURL",value:function(e,t){this._cdnURLTracker.track(e,t)}},{key:"finalize",value:function(){if(this._isFinalized)throw new nr(r.TRACK_DATA_ALREADY_FINALIZED,"TrackData already finalized.");this.msPlayedUnion=this._calculateUnion(),this.nSeeksBackward||this.nSeeksForward||this.nSpeedChanges||(this.msNominalPlayed=this.maxContinuous=this.msPlayedUnion,this.msPlayed=this.msNominalPlayed/this._currentSpeed,this.nSpeedChanges=!1);var e=this.msPlayed;return this.timeWeightedBitrate=this._calculateWeightedBitrate(e),this.startBitrate||(this.startBitrate=this.bitrate),this.urls=this._cdnURLTracker.toJSON(),this._isFinalized=!0,!0}},{key:"getURLsJSON",value:function(){var e,t;return null!==(t=null===(e=this._cdnURLTracker.toJSON().urls)||void 0===e?void 0:e.map((function(e){return e.url})))&&void 0!==t?t:[]}},{key:"getPlaybackStats",value:function(){var e;switch(this.keySystem){case le.WIDEVINE:e="widevine";break;case le.PLAYREADY:case le.PLAYREADY_HARDWARE:e="playready";break;default:e="none"}return{ms_total_est:this.msActualDuration,ms_metadata_duration:this.msMetadataDuration,ms_manifest_latency:this.msManifestLatency,ms_latency:this.msPlayLatency,start_offset_ms:this.startPosition,ms_initial_buffering:this.msPlayLatency,ms_seek_rebuffering:this.msSeekRebuffering,ms_stalled:this.msStalled,max_ms_seek_rebuffering:this.maxMsSeekRebuffering,max_ms_stalled:this.maxMsStalled,n_stalls:this.nStalls,n_rendition_upgrade:this.nRenditionUpgrade,n_rendition_downgrade:this.nRenditionDowngrade,bps_bandwidth_max:this.bpsBandwidthMax,bps_bandwidth_min:this.bpsBandwidthMin,bps_bandwidth_avg:this.bpsBandwidthAvg,audiocodec:this.audiocodec?this.audiocodec.toLowerCase():void 0,videocodec:this.videocodec?this.videocodec.toLowerCase():void 0,start_bitrate:this.startBitrate||this.bitrate||void 0,full_screen:void 0,time_weighted_bitrate:this.timeWeightedBitrate,buffering_percentage:void 0,prefetched_bytes:void 0,prefetched_bytes_loaded:void 0,prefetched_initial_bitrate:void 0,key_system:e,ms_key_latency:this.msKeyLatency,total_bytes:this.totalBytes,local_time_ms:this.localTimeMs,ms_played_background:void 0,n_dropped_video_frames:this.droppedVideoFrames,n_total_video_frames:this.totalVideoFrames,resolution_max:this.maxResolution,resolution_min:this.minResolution}}},{key:"isFinalized",value:function(){return this._isFinalized}}],[{key:"create",value:function(){return new e}}]),e}();function ar(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var or=he.P.forTag("playback.tracker"),sr=function(e){(0,f.Z)(n,e);var t=ar(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,c.Z)(this,n),(e=t.call(this))._playedThreshold=31e3,e._playedThresholdReached=!1,e._trackingData=null,e._playedThreshold=r.playerThreshold||31e3,e}return(0,_.Z)(n,[{key:"_checkPlayedThreshold",value:function(){var e=this._trackingData;!e||!this._playedThreshold||this._playedThresholdReached||e.msPlayed<this._playedThreshold||(this._playedThresholdReached=!0,this.emit(ue.TRACKER_PLAYED_THRESHOLD_REACHED,{played:e&&e.msPlayed||0,threshold:this._playedThreshold}))}},{key:"getMSPlayed",value:function(){return this._trackingData?this._trackingData.msPlayed:0}},{key:"getStallsInformation",value:function(){return this._trackingData?{nStalls:this._trackingData.nStalls,msTotalStalled:this._trackingData.msStalled}:{nStalls:0,msTotalStalled:0}}},{key:"trackLoadStart",value:function(e,t,n,r,i){var a=ir.create();this._trackingData=a,this._playedThresholdReached=!1,a.fileId=null!=t?t:"",a.currentTrackUri=e,a.loadTime=Date.now(),a.internalPlayId=n,a.externalLoadTime=r.externalLoadTime||0,a.displayTrack=r.displayTrack||"",a.playbackId=r.playbackId||"",a.playContext=r.playContext||"",a.reasonStart=r.reason||"unknown",a.sourceStart=r.source||"unknown",a.clientId=r.clientId||"",a.correlationId=r.correlationId||"";var o=r.referrer||{};a.referrer=void 0!==o.name?o.name:"unknown",a.referrerVersion=void 0!==o.version?o.version:"unknown",a.referrerVendor=void 0!==o.vendor?o.vendor:"unknown";var s=r.format||{};s.codec&&(a.audiocodec=s.codec.toLowerCase()),s.bitrate&&(a.bitrate=s.bitrate),s.audioQuality&&(a.audioQuality=s.audioQuality),a.gaiaDevId=r.deviceId||"none",a.noLog=r.noLog||!1,a.noTSV=r.noTSV||!1,a.noStats=r.noStats||!1,a.contentMetadata=i,"number"==typeof(null==i?void 0:i.displayDuration)&&(a.msMetadataDuration=i.displayDuration),this.emit(ue.TRACKER_TRACKING_DATA_CREATED,{trackingData:a})}},{key:"trackBufferLoadStart",value:function(){var e=this._trackingData;e&&(e.bufferLoadStartTime=Date.now())}},{key:"trackBytesDownloaded",value:function(e){var t=this._trackingData;t&&(t.totalBytes+=e)}},{key:"trackLoadDone",value:function(e){var t=this._trackingData;if(t){var n=Date.now();t.msInitLatency=n-t.bufferLoadStartTime,t.localTimeMs=n,t.position=e,t.addStartSegment()}}},{key:"trackPlay",value:function(e,t){var n=this._trackingData;n&&(n.played||this.emit(ue.TRACKER_PLAYBACK_START,{trackingData:n}),n.played=!0,n.position=e,n.startPosition=e,n.addSpeedChange(t||1))}},{key:"trackCanPlayThrough",value:function(){var e=this._trackingData;if(e&&!e.msPlayLatency){var t=Date.now();e.msPlayLatency=t-e.loadTime,e.msHeadLatency=t-e.bufferLoadStartTime}}},{key:"trackBufferURL",value:function(e,t){var n=this._trackingData;n&&n.trackBufferURL(e,t)}},{key:"trackNavigatorOffline",value:function(){var e=this._trackingData;e&&(e.nOffline+=1)}},{key:"trackSeekRebuffering",value:function(e){var t=this._trackingData;t&&(e>t.maxMsSeekRebuffering&&(t.maxMsSeekRebuffering=e),t.msSeekRebuffering+=e)}},{key:"trackMsStalled",value:function(e){var t=this._trackingData;t&&(e>t.maxMsStalled&&(t.maxMsStalled=e),t.msStalled+=e,t.nStalls++)}},{key:"trackLoadFailed",value:function(){var e=this._trackingData;e&&(e.msPlayLatency=Date.now()-e.loadTime,e.position=0,e.addStartSegment())}},{key:"trackStopped",value:function(e,t,n){var r,i,a,o,s=this._trackingData;if(s&&!s.isFinalized()){var u=Date.now();if(s.stopTime=u,s.lastPlayPosition>=0&&e>=0&&s.lastPlayPosition<e){var l=e-s.lastPlayPosition;s.addMSPlayed(l)}s.addEndSegment(),s.sourceEnd=t.source||"unknown",s.reasonEnd=t.reason||"unknown",s.nextPlaybackId=t.playbackId||"",s.droppedVideoFrames=null!==(i=null===(r=null==n?void 0:n.video)||void 0===r?void 0:r.droppedVideoFrames)&&void 0!==i?i:0,s.totalVideoFrames=null!==(o=null===(a=null==n?void 0:n.video)||void 0===a?void 0:a.totalVideoFrames)&&void 0!==o?o:0,s.finalize(),or.info("Tracker data finalized.");var c=s.getPlaybackStats();this.emit(ue.TRACKER_TRACKING_DATA_FINALIZED,{trackingData:s,playbackStats:c})}}},{key:"trackPositionChanged",value:function(e){var t=this._trackingData;if(t){var n=t.position;e!==n&&(t.addEndSegment(),e>n?(t.nSeeksForward++,t.msSeeksForward+=e-n):e<n&&(t.nSeeksBackward++,t.msSeeksBackward+=n-e),t.position=e,t.lastPlayPosition=-1,t.addStartSegment())}}},{key:"trackPlaying",value:function(e){var t=this._trackingData;if(t){if(t.lastPlayPosition>=0&&t.lastPlayPosition<e){var n=e-t.lastPlayPosition;t.addMSPlayed(n)}t.position=e,t.lastPlayPosition=e}}},{key:"trackPaused",value:function(e){var t=this._trackingData;if(t){if(t.lastPlayPosition>=0&&t.lastPlayPosition<e){var n=e-t.lastPlayPosition;t.addMSPlayed(n)}t.position=e,t.lastPlayPosition=e}}},{key:"trackProgress",value:function(e,t){var n=this._trackingData;if(null==n?void 0:n.played){var r=0;if(n.lastPlayPosition>=0){if((r=e-n.lastPlayPosition)<0)return void or.warn("Skipping msPlayed calculation: late progress event.");n.addMSPlayed(r)}this._checkPlayedThreshold(),n.position=e,n.lastPlayPosition=e,t&&n.trackBitrate(t,r)}}},{key:"trackSpeedChanged",value:function(e){var t=this._trackingData;t&&t.addSpeedChange(e)}},{key:"trackVideoLoadStart",value:function(e){var t=this._trackingData;t&&t.registerVideoVariant(e)}},{key:"trackWarning",value:function(){var e=this._trackingData;e&&e.nWarnings++}},{key:"trackOffline",value:function(){var e=this._trackingData;e&&e.nOffline++}},{key:"setActualDuration",value:function(e){var t=this._trackingData;t&&(t.msActualDuration=e)}},{key:"setKeySystem",value:function(e){var t=this._trackingData;t&&(t.keySystem=e)}},{key:"setKeySystemImpl",value:function(e){var t=this._trackingData;t&&(t.keySystemImpl=e)}},{key:"setManifestLatency",value:function(e){var t=this._trackingData;t&&(t.msManifestLatency=e)}},{key:"setPlayIntended",value:function(e){var t=this._trackingData;t&&(t.playIntended=e)}},{key:"setKeyLatency",value:function(e){var t=this._trackingData;t&&(t.msKeyLatency=e)}},{key:"setMemoryCached",value:function(e){var t=this._trackingData;t&&(t.memoryCached=e)}},{key:"setPersistentCached",value:function(e){var t=this._trackingData;t&&(t.persistentCached=e)}},{key:"setProtected",value:function(e){var t=this._trackingData;t&&(t.isProtected=e)}},{key:"setHadError",value:function(e){var t=this._trackingData;t&&(t.hadError=e)}},{key:"setLicenseSessionLatency",value:function(e){var t=this._trackingData;t&&(t.msLicenseSessionLatency=e)}},{key:"setLicenseGenerationLatency",value:function(e){var t=this._trackingData;t&&(t.msLicenseGenerationLatency=e)}},{key:"setLicenseRequestLatency",value:function(e){var t=this._trackingData;t&&(t.msLicenseRequestLatency=e)}},{key:"setLicenseUpdateLatency",value:function(e){var t=this._trackingData;t&&(t.msLicenseUpdateLatency=e)}},{key:"setResolveLatency",value:function(e){var t=this._trackingData;t&&(t.msResolveLatency=e)}},{key:"setCalculatedDuration",value:function(e){var t=this._trackingData;t&&(t.msFileDuration=e)}},{key:"setPlayedThreshold",value:function(e){this._playedThreshold=e}},{key:"trackFragment",value:function(e){var t=this._trackingData;if(t){var n=e.bandwidth,r=e.resolution;r&&((r<t.minResolution||!t.minResolution)&&(t.minResolution=r),r>t.maxResolution&&(t.maxResolution=r)),(n<t.bpsBandwidthMin||!t.bpsBandwidthMin)&&(t.bpsBandwidthMin=n),n>t.bpsBandwidthMax&&(t.bpsBandwidthMax=n),t.bpsBandwidthAvg=t.bpsBandwidthAvg?(t.bpsBandwidthAvg+n)/2:n}}},{key:"trackProfileChanged",value:function(e){var t=this._trackingData;if(t){var n=e.bitrate;n<t.lastBitrate&&t.nRenditionDowngrade++,n>t.lastBitrate&&t.nRenditionUpgrade++,t.lastBitrate=n}}}],[{key:"create",value:function(e){return new n(e)}}]),n}(p.vp);function ur(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var lr=function(e){(0,f.Z)(n,e);var t=ur(n);function n(e){var r;return(0,c.Z)(this,n),(r=t.call(this))._transport=e,r._parseManifestResponse=r._parseManifestResponse.bind((0,d.Z)(r)),r}return(0,_.Z)(n,[{key:"_parseManifestResponse",value:function(e){var t,n=e.metadata.startTime;if(200!==e.status){var i=new Jn(r.STORAGE_VIDEO_MANIFEST_FAILED,"Video manifest request failed with status ".concat(e.status));return i.status=e.status,this.emit(ue.VIDEO_MANIFEST_RESOLVE_FAILED,{url:e.url,error:i,start_time:n}),Promise.reject(i)}var a=e.body,o=null===(t=e.headers)||void 0===t?void 0:t.get("content-length");return this.emit(ue.VIDEO_MANIFEST_RESOLVED,{url:e.url,manifest_size:o?parseInt(o,10):JSON.stringify(a).length,start_time:n,end_time:Date.now()}),Promise.resolve(a)}},{key:"getInitSegmentURLs",value:function(e,t,n,r){var i="";n&&(i=e+t.replace("{{profile_id}}",n.id.toString(10)).replace("{{file_type}}",n.file_type));var a="";return r&&(a=e+t.replace("{{profile_id}}",r.id.toString(10)).replace("{{file_type}}",r.file_type)),{audio:i,video:a,audioLogging:i,videoLogging:a}}},{key:"getSegmentURLs",value:function(e,t,n,r,i){var a="";r&&(a=e+t.replace("{{profile_id}}",r.id.toString(10)).replace("{{file_type}}",r.file_type));var o="";return i&&(o=e+t.replace("{{profile_id}}",i.id.toString(10)).replace("{{file_type}}",i.file_type)),{audio:a.replace("{{segment_timestamp}}",n.toString()),video:o.replace("{{segment_timestamp}}",n.toString()),audioLogging:a,videoLogging:o}}},{key:"getManifest",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n="".concat(t?"@webgate/manifests/v8/unauth/json/sources":"@webgate/manifests/v7/json/sources","/").concat(e,"/options/supports_drm");return this._transport.request(n,{authorize:!t,responseType:"json",parseResponseHeaders:!0,retry:{condition:function(e,t){return e.getStatusFamily()!==t.SUCCESS}},metadata:{startTime:Date.now()}}).then(this._parseManifestResponse)}}],[{key:"create",value:function(e){return new n(e)}}]),n}(p.vp);function cr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var _r,dr,fr=function(e){(0,f.Z)(n,e);var t=cr(n);function n(e,r){var i;return(0,c.Z)(this,n),(i=t.call(this)).status=-1,i.debug={},i.canPlayNext=!0,i.unrecoverable=!1,i.name="LicenseError",i.code=e,i.message=r,i}return(0,_.Z)(n,null,[{key:"fatal",value:function(e,t){var r=new n(e,t);return r.unrecoverable=!0,r.canPlayNext=!1,r}}]),n}((0,A.Z)(Error)),hr=function(){function e(t){var n=this;(0,c.Z)(this,e),this._sdk={name:"",version:""},this._securityLevel=null,this._urls={},t.sdk&&(this._sdk=t.sdk),t.securityLevel&&(this._securityLevel=t.securityLevel),this._transport=t.transport,this._useTestLicenseServer=!!t.useTestLicenseServer,this._transport.on(this._transport.EVENT_CONNECTION_ID,(function(){n._urls={}}))}return(0,_.Z)(e,[{key:"get",value:function(e,t){var n=this,i="".concat(e,":").concat(t),a=this._urls[i];if(a&&a.expires>Date.now()+6e4)return Promise.resolve(a.uri);var o=this._useTestLicenseServer?"&use_test_license_server=true":"",s="".concat("@webgate/melody/v1/license_url","?keysystem=").concat(e,"&mediatype=").concat(t,"&sdk_name=").concat(this._sdk.name,"&sdk_version=").concat(this._sdk.version).concat(o);return this._transport.request(s,{responseType:"json",retry:{condition:function(e,t){var n=e.getStatusFamily();return n===t.SERVER_ERROR||n===t.CONNECTION_ERROR}}}).then((function(e){var t,a=e.body;return a&&200===e.status?(a.expires*=1e3,a.uri="@webgate/".concat(a.uri),n._securityLevel&&(a.uri+=[-1!==a.uri.indexOf("?")?"&":"?","sl=",n._securityLevel].join("")),n._urls[i]=a,a.uri):((t=a?400===e.status&&a&&"deprecated-version"===a.code?fr.fatal(r.LICENSE_RESOLVER_DEPRECATED_VERSION,"This version of the SDK is no longer supported. Please upgrade"):new fr(r.LICENSE_RESOLVER_CANT_RESOLVE_URL,"License URL endpoint responded with status ".concat(e.status)):fr.fatal(r.LICENSE_RESOLVE_INVALID_RESPONSE,"License URL endpoint responded with invalid response")).status=e.status,Promise.reject(t))}))}},{key:"remove",value:function(e,t){this._urls["".concat(e,":").concat(t)]=null}}]),e}(),vr=function(){function e(t){(0,c.Z)(this,e),this._melodyLogger=new ee.Hx(t)}return(0,_.Z)(e,[{key:"logTrackStreamVerification",value:function(e){return this._melodyLogger.sendLog("/v1/msg/batch",{type:"track_stream_verification",message:e},{batch:!0})}},{key:"logJSSDKPlaybackStats",value:function(e){return this._melodyLogger.sendLog("/v1/msg/batch",{type:"jssdk_playback_stats",message:e},{batch:!0})}},{key:"logJSSDKPlaybackStart",value:function(e){return this._melodyLogger.sendLog("/v1/msg/batch",{type:"jssdk_playback_start",message:e},{batch:!0})}},{key:"logJSSDKError",value:function(e){return this._melodyLogger.sendLog("/v1/msg/batch",{type:"jssdk_error",message:e},{batch:!0})}},{key:"logJSSDKWarning",value:function(e){return this._melodyLogger.sendLog("/v1/msg/batch",{type:"jssdk_warning",message:e},{batch:!0})}}]),e}();!function(e){e[e.ABORTED=101]="ABORTED",e[e.NETWORK=102]="NETWORK",e[e.MEDIA_DECODING=103]="MEDIA_DECODING",e[e.SRC_NOT_SUPPORTED=104]="SRC_NOT_SUPPORTED",e[e.EME=105]="EME",e[e.GENERIC=100]="GENERIC"}(dr||(dr={}));var pr,Er=(_r={},(0,l.Z)(_r,r.MEDIA_ABORTED,dr.ABORTED),(0,l.Z)(_r,r.MEDIA_DECODING_ERROR,dr.MEDIA_DECODING),(0,l.Z)(_r,r.MEDIA_NOT_SUPPORTED,dr.SRC_NOT_SUPPORTED),(0,l.Z)(_r,r.MEDIA_NETWORK_ERROR,dr.NETWORK),_r);function yr(e){var t=Er[e];return/_REQUEST_|_RESPONSE$/.test(e)?t=dr.NETWORK:t||(t=/^EME_/.test(e)?dr.EME:dr.GENERIC),t}function mr(e){var t,n=e.match(/^https?:\/\/([^\/]+@)?([^\/?#]+)/);return null!==(t=null==n?void 0:n[2])&&void 0!==t?t:""}!function(e){e.READY="playerready",e.VIDEO_CHANGE="videochange",e.PLAY="play",e.PLAYING="playing",e.PAUSE="pause",e.TIMEUPDATE="timeupdate",e.SEEKING="seeking",e.SEEKED="seeked",e.ERROR="error",e.ENDED="ended",e.RENDITION_CHANGE="renditionchange",e.REQUEST_COMPLETED="requestcompleted",e.REQUEST_FAILED="requestfailed",e.REQUEST_CANCELED="requestcanceled"}(pr||(pr={}));var gr,Sr,Rr,Ar,Tr,Pr,Lr={player_is_paused:!0,player_width:0,player_height:0,video_source_height:0,video_source_width:0,player_is_fullscreen:void 0,player_autoplay_on:void 0,player_preload_on:void 0,video_source_url:void 0,video_source_mime_type:void 0,video_source_duration:void 0,video_poster_url:void 0,player_language_code:void 0},Ir=function(){function e(t){(0,c.Z)(this,e),this._playerId="spotify-playback-".concat(Date.now()),this._currentContentInfo=null,this._readyDeferred=(0,ge.$)(),this._isMuxInitialized=!1,this._muxInitData=null,this._player=t.player,this._mux=t.mux,this._getPlayheadTime=this._getPlayheadTime.bind(this),this._getStateData=this._getStateData.bind(this),this._init(t)}return(0,_.Z)(e,[{key:"_init",value:function(e){var t=this;Promise.all([Promise.resolve(e.deviceInfo)]).then((function(n){var r,i,a=(0,u.Z)(n,1)[0];t._muxInitData={data:Object.assign({env_key:e.envKey||"2qbjhhcl4u87btjbo7dh8vi2n",player_name:null!==(i=null==a?void 0:a.platform_name)&&void 0!==i?i:null==a?void 0:a.platform,player_version:null==a?void 0:a.version,viewer_device_manufacturer:null==a?void 0:a.brand,viewer_device_category:null==a?void 0:a.type,viewer_device_name:null==a?void 0:a.model,player_software_name:e.sdk||"spotify-playback",player_software_version:e.sdkVersion||Hn,player_mux_plugin_name:"spotify-playback-mux-reporter",player_mux_plugin_version:Hn},e.muxCustomDimensions),getPlayheadTime:t._getPlayheadTime,getStateData:t._getStateData},t._player.addListeners((r={},(0,l.Z)(r,ue.PLAYER_BEFORE_LOAD,t._onBeforeLoad.bind(t)),(0,l.Z)(r,ue.PLAYER_PLAY,t._onPlay.bind(t)),(0,l.Z)(r,ue.PLAYER_PLAYING,t._onPlaying.bind(t)),(0,l.Z)(r,ue.PLAYER_PAUSED,t._onPause.bind(t)),(0,l.Z)(r,ue.PLAYER_PROGRESS,t._onProgress.bind(t)),(0,l.Z)(r,ue.PLAYER_SEEKING,t._onSeeking.bind(t)),(0,l.Z)(r,ue.PLAYER_POSITION_CHANGED,t._onPositionChanged.bind(t)),(0,l.Z)(r,ue.PLAYER_ERROR,t._onError.bind(t)),(0,l.Z)(r,ue.PLAYER_ENDED,t._onEnded.bind(t)),(0,l.Z)(r,ue.PLAYER_DURATION_CHANGED,t._onDurationChanged.bind(t)),(0,l.Z)(r,ue.PLAYER_VIDEO_RESIZED,t._onVideoResized.bind(t)),(0,l.Z)(r,ue.PLAYER_VIDEO_PROFILE_CHANGED,t._onVideoProfileChanged.bind(t)),(0,l.Z)(r,ue.PLAYER_FRAGMENT_FETCHED,t._onFragmentFetched.bind(t)),(0,l.Z)(r,ue.PLAYER_FRAGMENT_FETCH_ERROR,t._onFragmentFetchError.bind(t)),(0,l.Z)(r,ue.PLAYER_VIDEO_MANIFEST_RESOLVED,t._onVideoManifestResolved.bind(t)),(0,l.Z)(r,ue.PLAYER_VIDEO_MANIFEST_RESOLVE_FAILED,t._onVideoManifestResolveFailed.bind(t)),r))})).then(this._readyDeferred.resolve,this._readyDeferred.reject)}},{key:"_getPlayheadTime",value:function(){return this._player.getPlayerPosition()}},{key:"_getStateData",value:function(){return this._currentContentInfo?Object.assign(Object.assign({},this._currentContentInfo.stateData),{player_language_code:this._player.getActiveSubtitleLanguage()}):null}},{key:"_onDurationChanged",value:function(e){this._currentContentInfo&&(this._currentContentInfo.stateData.video_source_duration=e.data.duration)}},{key:"_onVideoResized",value:function(e){this._currentContentInfo&&(this._currentContentInfo.stateData.player_width=e.data.width,this._currentContentInfo.stateData.player_height=e.data.height)}},{key:"_onBeforeLoad",value:function(e){var t=e.data,n=t.track,r=t.options,i=t.logData,a=!!this._currentContentInfo;if("video"!==n.mediaType||(null==i?void 0:i.noLog)||(null==i?void 0:i.noMuxEvents))return a&&this._mux.emit(this._playerId,pr.VIDEO_CHANGE,{}),void(this._currentContentInfo=null);var o={video_id:n.fileId,video_title:(null==i?void 0:i.displayTitle)||void 0,video_series:(null==i?void 0:i.displayGroup)||void 0,video_duration:(null==i?void 0:i.displayDuration)||void 0},s=Object.assign({},Lr);this._currentContentInfo={track:n,options:r,videoData:o,stateData:s},!this._isMuxInitialized&&this._muxInitData?(this._mux.init(this._playerId,this._muxInitData),this._mux.emit(this._playerId,pr.READY),this._isMuxInitialized=!0):a&&this._mux.emit(this._playerId,pr.VIDEO_CHANGE,o)}},{key:"_onPlay",value:function(){var e,t;if(this._currentContentInfo){var n=this._currentContentInfo.stateData,r=this._player.getPlayerState(),i=r.media_info,a=(null===(t=null===(e=this._currentContentInfo)||void 0===e?void 0:e.options)||void 0===t?void 0:t.autoplay)||!1,o=r.player_element,s=o.width,u=o.height,l=o.src,c=o.poster;n.player_is_paused=!r.playing,n.player_width=s||0,n.player_height=u||0,n.video_source_height=i.video_height||0,n.video_source_width=i.video_width||0,n.player_autoplay_on=a,n.video_source_url=l,n.video_source_mime_type=i.video_format,n.video_source_duration=r.duration,n.video_poster_url=c,this._mux.emit(this._playerId,pr.PLAY,this._currentContentInfo.videoData)}}},{key:"_onPlaying",value:function(){this._currentContentInfo&&(this._currentContentInfo.stateData.player_is_paused=!1,this._mux.emit(this._playerId,pr.PLAYING))}},{key:"_onPause",value:function(){this._currentContentInfo&&(this._currentContentInfo.stateData.player_is_paused=!0,this._mux.emit(this._playerId,pr.PAUSE))}},{key:"_onProgress",value:function(e){this._currentContentInfo&&this._mux.emit(this._playerId,pr.TIMEUPDATE,{player_playhead_time:e.data.position})}},{key:"_onSeeking",value:function(){this._currentContentInfo&&this._mux.emit(this._playerId,pr.SEEKING)}},{key:"_onPositionChanged",value:function(){this._currentContentInfo&&this._mux.emit(this._playerId,pr.SEEKED)}},{key:"_onError",value:function(e){var t,n,r=null===(n=null===(t=e.data)||void 0===t?void 0:t.error)||void 0===n?void 0:n.code;this._currentContentInfo&&r&&this._mux.emit(this._playerId,pr.ERROR,{player_error_code:yr(r),player_error_message:r})}},{key:"_onEnded",value:function(){this._currentContentInfo&&this._mux.emit(this._playerId,pr.ENDED)}},{key:"_onVideoProfileChanged",value:function(e){if(this._currentContentInfo){var t=e.data.profile,n=this._currentContentInfo.stateData;n.video_source_height=t.height||0,n.video_source_width=t.width||0,n.video_source_mime_type=t.mimeType,this._mux.emit(this._playerId,pr.RENDITION_CHANGE,{video_source_bitrate:t.bitrate,video_source_width:t.width,video_source_height:t.height})}}},{key:"_onFragmentFetched",value:function(e){var t=e.data;if(this._currentContentInfo||"video"===t.media_type){var n="".concat(t.segment_type).concat(t.init?"_init":"");this._mux.emit(this._playerId,pr.REQUEST_COMPLETED,{request_type:n,request_hostname:mr(t.url),request_start:t.start_time,request_response_end:t.end_time,request_bytes_loaded:t.byte_length})}}},{key:"_onFragmentFetchError",value:function(e){var t=e.data;if(this._currentContentInfo||"video"===t.media_type){var n="".concat(t.segment_type).concat(t.init?"_init":"");this._mux.emit(this._playerId,pr.REQUEST_FAILED,{request_type:n,request_hostname:mr(t.url),request_start:t.start_time,request_error:t.error.code,request_error_code:t.error.status,request_error_text:""})}}},{key:"_onVideoManifestResolved",value:function(e){var t=e.data;this._currentContentInfo&&this._mux.emit(this._playerId,pr.REQUEST_COMPLETED,{request_type:"manifest",request_hostname:mr(t.url),request_start:t.start_time,request_response_end:t.end_time,request_bytes_loaded:t.manifest_size})}},{key:"_onVideoManifestResolveFailed",value:function(e){var t=e.data;this._currentContentInfo&&this._mux.emit(this._playerId,pr.REQUEST_FAILED,{request_type:"manifest",request_hostname:mr(t.url),request_start:t.start_time,request_error:t.error.code,request_error_code:t.error.status,request_error_text:""})}},{key:"ready",value:function(){return this._readyDeferred.promise}}],[{key:"create",value:function(t){return new e(t)}}]),e}();function kr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}!function(e){e.NULL_VALUE="NULL_VALUE",e.LIST_START="LIST_START",e.LIST_END="LIST_END",e.FORBIDDEN="FORBIDDEN",e.IGNORE="IGNORE",e.PAUSE="PAUSE"}(gr||(gr={})),function(e){e.MP4_AUDIO="audio/mp4",e.MP4_VIDEO="video/mp4",e.MTS_VIDEO="video/mp2t",e.WEBM_AUDIO="audio/webm",e.WEBM_VIDEO="video/webm"}(Sr||(Sr={})),function(e){e.AAC_LC="mp4a.40.2",e.FLAC="flac",e.OPUS="opus",e.VP9="vp9",e.VP8="vp8",e.H264_31="avc1.4d401f"}(Rr||(Rr={})),function(e){e.UNKNOWN="UNKNOWN",e.DEFAULT="DEFAULT",e.LOW="LOW",e.NORMAL="NORMAL",e.HIGH="HIGH",e.VERY_HIGH="VERY_HIGH",e.HIFI="HIFI"}(Ar||(Ar={})),function(e){e.NONE="NONE",e.CONTEXT="CONTEXT",e.TRACK="TRACK"}(Tr||(Tr={})),function(e){e.EMPTY="EMPTY",e.SW_CRYPTO="SW_CRYPTO",e.SW_DECODE="SW_DECODE",e.HW_CRYPTO="HW_CRYPTO",e.HW_DECODE="HW_DECODE",e.HW_ALL="HW_ALL"}(Pr||(Pr={}));var Dr=function(e){(0,f.Z)(n,e);var t=kr(n);function n(e,r){var i;return(0,c.Z)(this,n),(i=t.call(this)).unrecoverable=!1,i.listPlayerIgnore=!1,i.debug={},i.name="PlaybackError",i.code=e,i.message=r,i}return(0,_.Z)(n,null,[{key:"fatal",value:function(e,t){var r=new n(e,t);return r.unrecoverable=!0,r}}]),n}((0,A.Z)(Error));function Cr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}function br(e){return"uri"in e}var Or=function(e){(0,f.Z)(n,e);var t=Cr(n);function n(e){var r;if((0,c.Z)(this,n),(r=t.call(this))._trackPlayerPromise=(0,ge.$)(),r._maxListErrors=5,r._uid=0,r._loadedList=null,r._loadedOptions=null,r._currentTrack=null,r._currentTrackOptions=null,r._listPlayCount=0,r._listErrorCount=0,r._shuffled=!1,r._repeatMode=Tr.NONE,r._currentSeqId=0,!e.trackPlayer)throw new TypeError("Argument `options.trackPlayerManager` not found.");return e.maxListErrors&&(r._maxListErrors=e.maxListErrors),r._setListOptions=r._setListOptions.bind((0,d.Z)(r)),r._replaceCurrentList=r._replaceCurrentList.bind((0,d.Z)(r)),r._handleCapped=r._handleCapped.bind((0,d.Z)(r)),r._handlePlaying=r._handlePlaying.bind((0,d.Z)(r)),r._handlePaused=r._handlePaused.bind((0,d.Z)(r)),r._handleEnded=r._handleEnded.bind((0,d.Z)(r)),r._handleCanPreload=r._handleCanPreload.bind((0,d.Z)(r)),r._handleError=r._handleError.bind((0,d.Z)(r)),r._handlePositionChanged=r._handlePositionChanged.bind((0,d.Z)(r)),r._handleDurationChanged=r._handleDurationChanged.bind((0,d.Z)(r)),r._handleTimeout=r._handleTimeout.bind((0,d.Z)(r)),r._handlePlayerInitError=r._handlePlayerInitError.bind((0,d.Z)(r)),r._handleProgress=r._handleProgress.bind((0,d.Z)(r)),r._handlePlayedThresholdReached=r._handlePlayedThresholdReached.bind((0,d.Z)(r)),r._handleBeforeLoad=r._handleBeforeLoad.bind((0,d.Z)(r)),r._init(e.trackPlayer),r}return(0,_.Z)(n,[{key:"_init",value:function(e){var t=this;this._trackPlayerPromise.promise.catch((function(){})),Promise.resolve(e).then((function(e){t._attachPlayerEvents(e),t._trackPlayerPromise.resolve(e)})).catch(this._handlePlayerInitError)}},{key:"_attachPlayerEvents",value:function(e){var t,n,r;e.addListeners((t={},(0,l.Z)(t,ue.PLAYER_CAN_PRELOAD,this._handleCanPreload),(0,l.Z)(t,ue.PLAYER_CAPPED,this._handleCapped),(0,l.Z)(t,ue.PLAYER_ENDED,this._handleEnded),(0,l.Z)(t,ue.PLAYER_ERROR,this._handleError),(0,l.Z)(t,ue.PLAYER_PAUSED,this._handlePaused),(0,l.Z)(t,ue.PLAYER_PLAYING,this._handlePlaying),(0,l.Z)(t,ue.PLAYER_TIMEOUT,this._handleTimeout),(0,l.Z)(t,ue.PLAYER_POSITION_CHANGED,this._handlePositionChanged),(0,l.Z)(t,ue.PLAYER_DURATION_CHANGED,this._handleDurationChanged),(0,l.Z)(t,ue.PLAYER_PROGRESS,this._handleProgress),(0,l.Z)(t,ue.PLAYER_BEFORE_LOAD,this._handleBeforeLoad),(0,l.Z)(t,ue.PLAYER_PLAYED_THRESHOLD_REACHED,this._handlePlayedThresholdReached),t)),this.proxyEmitAllSync(e,(n={},(0,l.Z)(n,ue.PLAYER_BEFORE_VOLUME_CHANGE,ue.LIST_PLAYER_BEFORE_VOLUME_CHANGE),(0,l.Z)(n,ue.PLAYER_LOAD,ue.LIST_PLAYER_PLAYER_LOAD),n)),this.proxyEmitAll(e,(r={},(0,l.Z)(r,ue.PLAYER_AUTOPLAY_FAILED,ue.LIST_PLAYER_AUTOPLAY_FAILED),(0,l.Z)(r,ue.PLAYER_TRACKING_DATA_CREATED,ue.LIST_PLAYER_TRACKING_DATA_CREATED),(0,l.Z)(r,ue.PLAYER_TRACKING_DATA_FINALIZED,ue.LIST_PLAYER_TRACKING_DATA_FINALIZED),(0,l.Z)(r,ue.PLAYER_BUFFER_STALLED,ue.LIST_PLAYER_BUFFER_STALLED),(0,l.Z)(r,ue.PLAYER_BUFFERING_START,ue.LIST_PLAYER_BUFFERING_START),(0,l.Z)(r,ue.PLAYER_BUFFERING_END,ue.LIST_PLAYER_BUFFERING_END),(0,l.Z)(r,ue.PLAYER_VIDEO_ELEMENT_APPENDED,ue.LIST_PLAYER_VIDEO_ELEMENT_APPENDED),(0,l.Z)(r,ue.PLAYER_VIDEO_ELEMENT_REMOVED,ue.LIST_PLAYER_VIDEO_ELEMENT_REMOVED),(0,l.Z)(r,ue.PLAYER_DISPLAYED_CUES_CHANGED,ue.LIST_PLAYER_DISPLAYED_CUES_CHANGED),(0,l.Z)(r,ue.LIST_PLAYER_VIDEO_PROFILE_CHANGED,ue.PLAYER_VIDEO_PROFILE_CHANGED),(0,l.Z)(r,ue.LIST_PLAYER_PLAYBACK_SPEED_CHANGED,ue.PLAYER_PLAYBACK_SPEED_CHANGED),(0,l.Z)(r,ue.LIST_PLAYER_SUBTITLE_LANGUAGES_LOADED,ue.PLAYER_SUBTITLE_LANGUAGES_LOADED),r))}},{key:"_translatePosition",value:function(e){var t,n,r;return null!==(r=null===(n=null===(t=this._loadedList)||void 0===t?void 0:t.translatePosition)||void 0===n?void 0:n.call(t,e))&&void 0!==r?r:e}},{key:"_translateDuration",value:function(e){var t,n,r;return null!==(r=null===(n=null===(t=this._loadedList)||void 0===t?void 0:t.translateDuration)||void 0===n?void 0:n.call(t,e))&&void 0!==r?r:e}},{key:"_handleProgress",value:function(e){var t=e.data;this.emit(ue.LIST_PLAYER_PROGRESS,Object.assign(Object.assign({},t),{position:this._translatePosition(t.position)}))}},{key:"_handleBeforeLoad",value:function(e){var t=e.data;this.emit(ue.LIST_PLAYER_BEFORE_PLAYER_LOAD,Object.assign(Object.assign({},t),{options:Object.assign(Object.assign({},t.options),{position:this._translatePosition(t.options.position)})}))}},{key:"_handlePlayerInitError",value:function(e){this._trackPlayerPromise.reject(new Dr(r.LIST_PLAYER_NO_TRACK_PLAYER,e.message||"Track player promise was rejected."))}},{key:"_handleCapped",value:function(){var e=this._currentTrack;e&&this.emit(ue.LIST_PLAYER_CAPPED,{uid:this._uid,track:e,options:this._currentTrackOptions,list:this._loadedList})}},{key:"_handlePlaying",value:function(e){var t=this._currentTrack;t&&this.emit(ue.LIST_PLAYER_PLAYING,{uid:this._uid,track:t,options:this._currentTrackOptions,list:this._loadedList,position:this._translatePosition(e.data.position)})}},{key:"_handlePaused",value:function(e){var t=this._currentTrack;t&&this.emit(ue.LIST_PLAYER_PAUSED,{uid:this._uid,track:t,options:this._currentTrackOptions,list:this._loadedList,position:this._translatePosition(e.data.position)})}},{key:"_handleCanPreload",value:function(){this._preloadUpcomingTrack().catch((function(){}))}},{key:"_handleEnded",value:function(){var e=this._currentTrack;e&&(this.emit(ue.LIST_PLAYER_TRACK_ENDED,{uid:this._uid,track:e,options:this._currentTrackOptions,list:this._loadedList}),this.next(s.TRACK_DONE))}},{key:"_handleTimeout",value:function(){var e=this._currentTrack;e&&(this.emit(ue.LIST_PLAYER_TRACK_TIMEOUT,{uid:this._uid,track:e,options:this._currentTrackOptions,list:this._loadedList}),this.next(s.TRACK_ERROR))}},{key:"_handlePositionChanged",value:function(e){var t=this._currentTrack;t&&this.emit(ue.LIST_PLAYER_POSITION_CHANGED,{uid:this._uid,track:t,options:this._currentTrackOptions,list:this._loadedList,position:this._translatePosition(e.data.position)})}},{key:"_handleDurationChanged",value:function(e){var t=this._currentTrack;t&&this.emit(ue.LIST_PLAYER_DURATION_CHANGED,{uid:this._uid,track:t,options:this._currentTrackOptions,list:this._loadedList,position:this._translatePosition(e.data.position),duration:this._translateDuration(e.data.duration)})}},{key:"_handlePlayedThresholdReached",value:function(e){var t=this._currentTrack;t&&this.emit(ue.LIST_PLAYER_PLAYED_THRESHOLD_REACHED,{uid:this._uid,track:t,options:this._currentTrackOptions,list:this._loadedList,threshold:e.data.threshold,position:this._translatePosition(e.data.position)})}},{key:"_handleError",value:function(e){var t=this._currentTrack,n=e.data;if(t){n.position=this._translatePosition(e.data.position),this.emit(ue.LIST_PLAYER_ERROR,n),this.emitSync(ue.LIST_PLAYER_ERROR_SYNC,n);var r=!!n.error&&n.error.listPlayerIgnore;r||this._listErrorCount++,n.canPlayNext&&(r||this._listErrorCount<=this._maxListErrors?this.next(s.TRACK_ERROR):this.emit(ue.LIST_PLAYER_MAX_LIST_ERRORS_REACHED,{count:this._listErrorCount,threshold:this._maxListErrors}))}}},{key:"_handleTrackLoaded",value:function(e){this.emitSync(ue.LIST_PLAYER_TRACK_LOADED,e)}},{key:"_incrementSeqId",value:function(){return this._currentSeqId>=9007199254740991?this._currentSeqId=0:this._currentSeqId+=1,this._currentSeqId}},{key:"_getTrackPlayer",value:function(){return this._trackPlayerPromise.promise}},{key:"_setListIndex",value:function(e,t){var n=t.index&&-1!==t.index?t.index:0;return Promise.all([e,t,e.startAt(n)])}},{key:"_setListOptions",value:function(e){var t=(0,u.Z)(e,3),n=t[0],r=t[1];t[2];return Promise.all([n.setShuffle(!!this._shuffled),n.setRepeatMode(this._repeatMode)]).then((function(){return[n,r]}))}},{key:"_replaceCurrentList",value:function(e){var t=(0,u.Z)(e,2),n=t[0],r=t[1];return this.emitSync(ue.LIST_PLAYER_BEFORE_LIST_CHANGE,{newList:n,newOptions:r,oldList:this._loadedList,oldOptions:this._loadedOptions}),this._loadedList=n,this._loadedOptions=r,this._listPlayCount=0,this._listErrorCount=0,this.emit(ue.LIST_PLAYER_LIST_CHANGED,{list:n,options:r}),ce.SUCCESS}},{key:"_preloadTrack",value:function(e){return this._getTrackPlayer().then((function(t){return t.preload(e).catch((function(){})),ce.SUCCESS}))}},{key:"_changeTrack",value:function(e,t,n){var r=this;if(this._currentSeqId!==n)return Promise.resolve(ce.CANCELLED);this.emitSync(ue.LIST_PLAYER_BEFORE_TRACK_LOAD,{list:this._loadedList,newTrack:e,oldTrack:this._currentTrack}),this._uid++;var i=++this._listPlayCount,a=this._loadedOptions,o=!0,u=0,l=3e4;a&&(1===i?(o=!a.paused,u=a.initialPosition||a.position||0):u=a.position||0);var c=t===s.TRACK_DONE;if(e.options){var _=e.options;void 0!==_.paused&&(o=!_.paused),void 0!==_.position&&(u=_.position),void 0!==_.playedThreshold&&(l=_.playedThreshold)}this._currentTrack=e,this._currentTrackOptions={reason:t,paused:!o,position:u,playedThreshold:l};var d=this._handleTrackLoaded.bind(this,{uid:this._uid,track:this._currentTrack,options:this._currentTrackOptions,list:this._loadedList});return this._getTrackPlayer().then((function(t){return r._currentSeqId!==n?ce.CANCELLED:(Promise.resolve(t.load(e,{uriProperty:"playableURI",autoplay:o,position:u,playedThreshold:l,continuePrevious:c},d)).catch((function(){})),ce.SUCCESS)}))}},{key:"_preloadUpcomingTrack",value:function(){var e=this,t=this._loadedList;if(!t)return Promise.reject(new Dr(r.LIST_PLAYER_NO_LIST,"Cannot perform operation; no list was loaded."));var n={reason:s.TRACK_DONE,listConstants:gr};return t.peekNext(n).then((function(t){return t===gr.FORBIDDEN?ce.FORBIDDEN:t===gr.NULL_VALUE?e._preloadUpcomingTrack():t===gr.LIST_END?ce.LIST_END:br(t)&&t.playable?e._preloadTrack(t):ce.INVALID}))}},{key:"activateElement",value:function(){return this._getTrackPlayer().then((function(e){return e.activateElement(),ce.SUCCESS}))}},{key:"load",value:function(e,t){var n=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t={index:-1,position:0,initialPosition:0,duration:-1,paused:!1,reason:s.UNKNOWN};return void 0!==e.index&&(t.index=e.index),void 0!==e.position&&(t.position=e.position),void 0!==e.initialPosition&&(t.initialPosition=e.initialPosition),void 0!==e.duration&&(t.duration=e.duration),void 0!==e.paused&&(t.paused=e.paused),void 0!==e.reason&&(t.reason=e.reason),t}(t||this._loadedOptions||{});return this._setListIndex(e,n).then(this._setListOptions).then(this._replaceCurrentList)}},{key:"play",value:function(e,t){var n=this;return this.load(e,t).then((function(){if(n._loadedList!==e)return ce.CANCELLED;var t=n._loadedOptions?n._loadedOptions.reason:s.UNKNOWN;return n.next(t)}))}},{key:"canChangeTrack",value:function(){return this._loadedList?this._loadedList.peekNext({reason:s.FORWARD_BUTTON,listConstants:gr}).then((function(e){return e!==gr.FORBIDDEN})):Promise.resolve(!0)}},{key:"next",value:function(e){var t=this;if(!e)return Promise.reject(new Dr(r.LIST_PLAYER_INVALID_ARGUMENT,"The argument `reason` is required."));var n=this._loadedList;if(!n)return Promise.reject(new Dr(r.LIST_PLAYER_NO_LIST,"Cannot perform operation; no list was loaded."));this.emitSync(ue.LIST_PLAYER_BEFORE_NEXT,{list:n,reason:e});var i=this._incrementSeqId(),a={reason:e,listConstants:gr};return n.next(a).then((function(r){return t._currentSeqId!==i?ce.CANCELLED:r===gr.FORBIDDEN?ce.FORBIDDEN:r===gr.NULL_VALUE?t.next(e):r===gr.LIST_END?(t.emit(ue.LIST_PLAYER_LIST_ENDED,{list:n,reason:s.END_PLAY}),t.clear(e),ce.LIST_END):br(r)?r.playable?t._changeTrack(r,e,i):(t.emit(ue.LIST_PLAYER_TRACK_UNPLAYABLE,{track:r,list:n}),t.next(e)):ce.INVALID}))}},{key:"previous",value:function(e){var t=this;if(!e)return Promise.reject(new Dr(r.LIST_PLAYER_INVALID_ARGUMENT,"The argument `reason` is required."));var n=this._loadedList;if(!n)return Promise.reject(new Dr(r.LIST_PLAYER_NO_LIST,"Cannot perform operation; no list was loaded."));this.emitSync(ue.LIST_PLAYER_BEFORE_PREVIOUS,{list:n,reason:e});var i=this._incrementSeqId(),a={reason:e,listConstants:gr};return n.previous(a).then((function(r){return t._currentSeqId!==i?ce.CANCELLED:r===gr.FORBIDDEN?ce.FORBIDDEN:r===gr.NULL_VALUE?t.previous(e):r===gr.LIST_START?(t.emit(ue.LIST_PLAYER_LIST_ENDED,{list:n,reason:s.END_PLAY}),t.clear(e),ce.LIST_END):br(r)?r.playable?t._changeTrack(r,e,i):(t.emit(ue.LIST_PLAYER_TRACK_UNPLAYABLE,{track:r,list:n}),t.previous(e)):ce.INVALID}))}},{key:"pause",value:function(){return this._loadedList?this._currentTrack?this._getTrackPlayer().then((function(e){return e.pause().then((function(){return ce.SUCCESS})).catch((function(e){return"AbortError"===(null==e?void 0:e.name)?ce.CANCELLED:ce.FORBIDDEN}))})):Promise.resolve(ce.SUCCESS):Promise.reject(new Dr(r.LIST_PLAYER_NO_LIST,"Cannot perform operation; no list was loaded."))}},{key:"resume",value:function(){return this._loadedList?this._currentTrack?this._getTrackPlayer().then((function(e){return e.resume().then((function(){return ce.SUCCESS})).catch((function(e){return"AbortError"===(null==e?void 0:e.name)?ce.CANCELLED:ce.FORBIDDEN}))})):Promise.resolve(ce.SUCCESS):Promise.reject(new Dr(r.LIST_PLAYER_NO_LIST,"Cannot perform operation; no list was loaded."))}},{key:"togglePlay",value:function(){return this._loadedList?this._currentTrack?this._getTrackPlayer().then((function(e){return e.togglePlay().then((function(){return ce.SUCCESS})).catch((function(e){return"AbortError"===(null==e?void 0:e.name)?ce.CANCELLED:ce.FORBIDDEN}))})):Promise.resolve(ce.SUCCESS):Promise.reject(new Dr(r.LIST_PLAYER_NO_LIST,"Cannot perform operation; no list was loaded."))}},{key:"stop",value:function(e){var t=this,n={reason:e||s.UNKNOWN},r=this._currentTrack;return r&&r.logData&&(n.source=r.logData.source),this._incrementSeqId(),this._getTrackPlayer().then((function(e){return e.stop(n),t.emit(ue.LIST_PLAYER_STOPPED,{uid:t._uid,options:t._currentTrackOptions,list:t._loadedList}),ce.SUCCESS}))}},{key:"clear",value:function(e){var t=this;return this.stop(e).then((function(){return t._loadedList=null,t._loadedOptions=null,t._currentTrack=null,t._currentTrackOptions=null,t.emit(ue.LIST_PLAYER_CLEARED,null),ce.SUCCESS}))}},{key:"setShuffle",value:function(e){var t=!!e;if(this._shuffled!==t){this._shuffled=t,this.emit(ue.LIST_PLAYER_SHUFFLE_CHANGED,{player:this,shuffled:t});var n=this._loadedList;n&&n.setShuffle(this._shuffled)}return Promise.resolve(ce.SUCCESS)}},{key:"setRepeatMode",value:function(e){if(!(e in Tr))return Promise.reject(new Dr(r.LIST_PLAYER_INVALID_ARGUMENT,"The value of repeat mode is not a correct RepeatMode enum value"));if(this._repeatMode!==e){this._repeatMode=e,this.emit(ue.LIST_PLAYER_REPEAT_MODE_CHANGED,{player:this,repeatMode:e});var t=this._loadedList;t&&t.setRepeatMode(this._repeatMode)}return Promise.resolve(ce.SUCCESS)}},{key:"getVolume",value:function(){return this._getTrackPlayer().then((function(e){return e.getVolume()}))}},{key:"setVolume",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this._getTrackPlayer().then((function(r){return r.setVolume(e,{commandId:null!=n?n:void 0}),t.emit(ue.LIST_PLAYER_VOLUME_CHANGED,{volume:e,commandId:n}),ce.SUCCESS}))}},{key:"seek",value:function(e){var t,n,i=this,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:s.SEEK,o=this._loadedList;if(!o)return Promise.reject(new Dr(r.LIST_PLAYER_NO_LIST,"Cannot perform operation; no list was loaded."));if("function"==typeof o.allowSeeking&&!o.allowSeeking())return Promise.reject(new Dr(r.LIST_PLAYER_FORBIDDEN,"The operation is not allowed."));var u=null!==(n=null===(t=o.handleSeek)||void 0===t?void 0:t.call(o,e,{reason:a,listConstants:gr}))&&void 0!==n?n:e;return u===gr.PAUSE?this.pause().then((function(t){return i.emit(ue.LIST_PLAYER_SEEK_HANDLED,{position:e,reason:u}),t})):u===gr.IGNORE?(this.emit(ue.LIST_PLAYER_SEEK_HANDLED,{position:e,reason:u}),Promise.resolve(ce.SUCCESS)):this._currentTrack?this._getTrackPlayer().then((function(e){return e.seek(u),ce.SUCCESS})):Promise.resolve(ce.SUCCESS)}},{key:"getListConstants",value:function(){return gr}},{key:"getLoadedList",value:function(){return this._loadedList}},{key:"getLoadedOptions",value:function(){return this._loadedOptions}},{key:"getPlayerState",value:function(){var e=this;return this._getTrackPlayer().then((function(t){var n=t.getPlayerState();return Object.assign(Object.assign({},n),{position:e._translatePosition(n.position),duration:e._translateDuration(n.duration)})}))}},{key:"getState",value:function(){var e=this;return this.getPlayerState().then((function(t){return{playbackState:t,track:e._currentTrack,list:e._loadedList,options:e._loadedOptions}}))}},{key:"getMediaConfig",value:function(){return this._getTrackPlayer().then((function(e){return e.getMediaConfig()}))}},{key:"hideSubtitles",value:function(){return this._getTrackPlayer().then((function(e){return e.hideSubtitles()})).then((function(){return ce.SUCCESS}))}},{key:"showSubtitles",value:function(){return this._getTrackPlayer().then((function(e){return e.showSubtitles()})).then((function(){return ce.SUCCESS}))}},{key:"areSubtitlesShown",value:function(){return this._getTrackPlayer().then((function(e){return e.areSubtitlesShown()}))}},{key:"getSubtitleLanguages",value:function(){return this._getTrackPlayer().then((function(e){return e.getSubtitleLanguages()}))}},{key:"getActiveSubtitleLanguage",value:function(){return this._getTrackPlayer().then((function(e){var t;return null!==(t=e.getActiveSubtitleLanguage())&&void 0!==t?t:null}))}},{key:"deactivateCueEvents",value:function(){return this._getTrackPlayer().then((function(e){return e.deactivateCueEvents()})).then((function(){return ce.SUCCESS}))}},{key:"activateCueEvents",value:function(){return this._getTrackPlayer().then((function(e){return e.activateCueEvents()})).then((function(){return ce.SUCCESS}))}},{key:"getCurrentBandwidth",value:function(){return this._getTrackPlayer().then((function(e){return e.getCurrentBandwidth()}))}},{key:"setSubtitleLanguage",value:function(e){return this._getTrackPlayer().then((function(t){return t.setSubtitleLanguage(e)})).then((function(){return ce.SUCCESS}))}},{key:"setPlaybackSpeed",value:function(e){return this._getTrackPlayer().then((function(t){return t.setPlaybackSpeed(e)})).then((function(e){return e?ce.SUCCESS:ce.FORBIDDEN}))}},{key:"getStatistics",value:function(){return this._getTrackPlayer().then((function(e){return e.getStatistics()}))}},{key:"getAudioProcessor",value:function(){return this._getTrackPlayer().then((function(e){return e.getAudioProcessor()}))}}],[{key:"create",value:function(e){return new n(e)}}]),n}(p.vp),Nr=he.P.forTag("playback.init");function Mr(e){return new Promise((function(t,n){var r,i,a,o,s,l,c;if(e.transport){if("undefined"!=typeof window)("boolean"==typeof window.isSecureContext?window.isSecureContext:function(){if("undefined"==typeof window||!window.location)return!1;var e=window.location;if("https"===e.protocol||"file"===e.protocol)return!0;var t=e.hostname;return!!/^127(\.[0-255]){3}$|^locahost\.?$|\.localhost\.?$/.test(t)}())||null===(r=window.console)||void 0===r||r.warn("%cDRM might not be available from unsecure contexts","background: #222; color: #bada55; font-size: 40px");var _=e.transport,d=(e.sdkId||"").split(":"),f=(0,u.Z)(d,2),h=f[0],v=void 0===h?"":h,p=f[1],E=void 0===p?"":p,y=Object.assign(Object.assign({},e),{tracker:sr.create(),audioResolver:new er(_),videoResolver:new lr(_),licenseURLResolver:new hr({transport:_,sdk:{name:v,version:E},securityLevel:e.securityLevel,useTestLicenseServer:e.useTestLicenseServer}),newBufferPerTrack:null===(i=e.newBufferPerTrack)||void 0===i||i,preinitMediaElement:null===(a=e.preinitMediaElement)||void 0===a||a});e.unauthenticatedLogs&&!(null===(o=e.loggerOptions)||void 0===o?void 0:o.endpoint)&&(e.loggerOptions=Object.assign(Object.assign({},e.loggerOptions),{endpoint:"https://spclient.wg.spotify.com/melody/unauth"})),(null===(s=null==e?void 0:e.loggerOptions)||void 0===s?void 0:s.deviceInfo)||Promise.all([null===(l=e.loggerOptions)||void 0===l?void 0:l.platform,null===(c=e.loggerOptions)||void 0===c?void 0:c.clientVersion]).then((function(t){var n=(0,u.Z)(t,2),r=n[0],i=n[1];e.loggerOptions=Object.assign(Object.assign({},e.loggerOptions),{deviceInfo:{platform:r,version:i}})})),Zn.create(y).then((function(t){var n=Object.assign({disableMux:!0},e.loggerOptions),r=function(e){return new vr(e)}(Object.assign(Object.assign({},n),{transport:_,sdkId:e.sdkId,platform:Promise.resolve(n.deviceInfo).then((function(e){var t;return null!==(t=null==e?void 0:e.platform)&&void 0!==t?t:""})),clientVersion:Promise.resolve(n.deviceInfo).then((function(e){var t;return null!==(t=null==e?void 0:e.version)&&void 0!==t?t:""}))})),i=zn.create({transport:_,player:t,logSender:r});return n.disableMux||Ir.create({player:t,mux:fe,envKey:null==n?void 0:n.muxEnvKey,sdk:v,sdkVersion:E,deviceInfo:n.deviceInfo,muxCustomDimensions:n.muxCustomDimensions}).ready().then((function(){return Nr.info("MuxReporter ready")}),(function(e){return Nr.error("Failed to instantiate MuxReporter",null==e?void 0:e.message)})),{player:t,logger:i}})).then(t,n)}else n(new TypeError("Argument transport is required."))}))}function wr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var Ur=function(e){(0,f.Z)(n,e);var t=wr(n);function n(e){var r;return(0,c.Z)(this,n),(r=t.call(this))._client=e.client,r._initialVolume=e.initialVolume,r._listPlayer=e.listPlayer,r._playerPromise=e.playerPromise,r._playbackServiceClient=e.playbackServiceClient,r._playbackStateObserver=e.playbackStateObserver,r._stopOnBackground=e.stopOnBackground,r._init(),r}return(0,_.Z)(n,[{key:"_init",value:function(){var e,t,n,r,i,a=this;this._client.addListeners((e={},(0,l.Z)(e,"before_disconnect",this._onClientBeforeDisconnect.bind(this)),(0,l.Z)(e,"before_offline_disconnect",this._onClientBeforeOfflineDisconnect.bind(this)),e));var o=this._listPlayer;o.addListeners((t={},(0,l.Z)(t,ue.LIST_PLAYER_CAPPED,this._onCapped.bind(this)),(0,l.Z)(t,ue.LIST_PLAYER_TRACK_ENDED,this._onTrackEnded.bind(this)),(0,l.Z)(t,ue.LIST_PLAYER_BEFORE_VOLUME_CHANGE,this._onBeforeVolumeChange.bind(this)),(0,l.Z)(t,ue.LIST_PLAYER_VOLUME_CHANGED,this._onVolumeChanged.bind(this)),(0,l.Z)(t,ue.LIST_PLAYER_ERROR,(function(e){a._onError(e,y.PLAYBACK)})),t)),this.proxyEmitAll(o,(n={},(0,l.Z)(n,ue.LIST_PLAYER_AUTOPLAY_FAILED,"autoplay_failed"),(0,l.Z)(n,ue.LIST_PLAYER_TRACK_LOADED,"track_loaded"),(0,l.Z)(n,ue.LIST_PLAYER_DURATION_CHANGED,"duration_changed"),(0,l.Z)(n,ue.LIST_PLAYER_POSITION_CHANGED,"position_changed"),(0,l.Z)(n,ue.LIST_PLAYER_PROGRESS,"progress"),(0,l.Z)(n,ue.LIST_PLAYER_BUFFER_STALLED,"stalled"),(0,l.Z)(n,ue.LIST_PLAYER_BUFFERING_END,"buffering_end"),(0,l.Z)(n,ue.LIST_PLAYER_BUFFERING_START,"buffering_start"),(0,l.Z)(n,ue.LIST_PLAYER_MAX_LIST_ERRORS_REACHED,"max_list_errors_reached"),(0,l.Z)(n,ue.LIST_PLAYER_VIDEO_ELEMENT_APPENDED,"video_element_appended"),(0,l.Z)(n,ue.LIST_PLAYER_VIDEO_ELEMENT_REMOVED,"video_element_removed"),(0,l.Z)(n,ue.LIST_PLAYER_LIST_ENDED,"context_ended"),(0,l.Z)(n,ue.LIST_PLAYER_SEEK_HANDLED,"streamer_seek_handled"),(0,l.Z)(n,ue.LIST_PLAYER_DISPLAYED_CUES_CHANGED,"displayed_cues_changed"),(0,l.Z)(n,ue.LIST_PLAYER_SUBTITLE_LANGUAGES_LOADED,"subtitle_languages_loaded"),(0,l.Z)(n,ue.LIST_PLAYER_PLAYBACK_SPEED_CHANGED,"speed_changed"),n));var s=this._playbackServiceClient;s.addListeners((r={},(0,l.Z)(r,"logout",this._onPlaybackClientLogout.bind(this)),(0,l.Z)(r,"error",(function(e){a._onError(e,e.data.source)})),r)),this.proxyEmitAll(s,(i={},(0,l.Z)(i,"max_subscriptions_reached","max_subscriptions_reached"),(0,l.Z)(i,"deregistered","deregistered"),(0,l.Z)(i,"registered","registered"),(0,l.Z)(i,"registration_aborted","registration_aborted"),(0,l.Z)(i,"internal_endcontent","internal_endcontent"),i)),this.proxyEmit(this._playbackStateObserver,"state_changed","state_changed"),this._stopOnBackground&&document.addEventListener&&document.addEventListener("visibilitychange",(function(){document.hidden&&a.stop()&&a.emitSync("stopped_on_background",null)})),this._playerPromise.then((function(e){e.setVolume(a._initialVolume),a.emit("player_initialization_done",null)}),(function(e){a.emit("player_initialization_failed",{reason:e.message,error:e})}))}},{key:"_assertOperationSuccess",value:function(e){return e===ce.SUCCESS}},{key:"_onTrackEnded",value:function(){this.emit("track_ended",null)}},{key:"_onClientBeforeDisconnect",value:function(e){e.data.awaitPromise(this.deregister().catch((function(){})))}},{key:"_onClientBeforeOfflineDisconnect",value:function(e){e.data.awaitPromise(this.pause().catch((function(){})))}},{key:"_onBeforeVolumeChange",value:function(e){var t;this.emitSync("before_volume_change",{volume:e.data.volume,remote:!!(null===(t=e.data.options)||void 0===t?void 0:t.commandId)}).defaultPrevented&&e.preventDefault()}},{key:"_onVolumeChanged",value:function(e){this.emit("volume_changed",{volume:e.data.volume,remote:!!e.data.commandId})}},{key:"_onCapped",value:function(){this.emit("playback_capped",null)}},{key:"_onError",value:function(e,t){var n=e.data.error;n&&(n.registration&&this.emit("registration_error",{error:n}),this.emit("error",{source:t,error:n}),this._client.notifyError(t,n))}},{key:"_onPlaybackClientLogout",value:function(){this.emit("logged_out",null)}},{key:"stop",value:function(){return this._playbackServiceClient.stop()}},{key:"register",value:function(){return this._playbackServiceClient.register()}},{key:"deregister",value:function(){return this._playbackServiceClient.deregister()}},{key:"resume",value:function(){return this._listPlayer.resume().then(this._assertOperationSuccess)}},{key:"pause",value:function(){return this._listPlayer.pause().then(this._assertOperationSuccess)}},{key:"nextTrack",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:s.FORWARD_BUTTON;return this._listPlayer.next(e).then(this._assertOperationSuccess)}},{key:"canChangeTrack",value:function(){return this._listPlayer.canChangeTrack()}},{key:"previousTrack",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:s.BACK_BUTTON;return this._listPlayer.previous(e).then(this._assertOperationSuccess)}},{key:"togglePlay",value:function(){return this._listPlayer.togglePlay().then(this._assertOperationSuccess)}},{key:"setVolume",value:function(e){return this._listPlayer.setVolume(e).then(this._assertOperationSuccess)}},{key:"getVolume",value:function(){return this._listPlayer.getVolume()}},{key:"seek",value:function(e){return this._listPlayer.seek(e).then(this._assertOperationSuccess)}},{key:"getCurrentState",value:function(){return this._playbackStateObserver.getCurrentState()}},{key:"getVideoVariants",value:function(){return this._playerPromise.then((function(e){return e.getVideoVariants()}))}},{key:"setPreferredBitrate",value:function(e){var t=this;return this._playerPromise.then((function(n){return n.setPreferredBitrate(e).then(t._assertOperationSuccess)}))}},{key:"setVideoResolution",value:function(e){return this._playerPromise.then((function(t){return t.setVideoResolution(e)}))}},{key:"setBackgrounded",value:function(e){return this._playerPromise.then((function(t){return t.setBackgrounded(e)}))}},{key:"activateElement",value:function(){return this._playerPromise.then((function(e){return e.activateElement()}))}},{key:"hideSubtitles",value:function(){return this._listPlayer.hideSubtitles().then(this._assertOperationSuccess)}},{key:"showSubtitles",value:function(){return this._listPlayer.showSubtitles().then(this._assertOperationSuccess)}},{key:"areSubtitlesShown",value:function(){return this._listPlayer.areSubtitlesShown()}},{key:"getSubtitleLanguages",value:function(){return this._listPlayer.getSubtitleLanguages()}},{key:"getActiveSubtitleLanguage",value:function(){return this._listPlayer.getActiveSubtitleLanguage()}},{key:"setSubtitleLanguage",value:function(e){return this._listPlayer.setSubtitleLanguage(e).then(this._assertOperationSuccess)}},{key:"getMediaConfig",value:function(){return this._listPlayer.getMediaConfig()}},{key:"setPlaybackSpeed",value:function(e){return this._listPlayer.setPlaybackSpeed(e).then(this._assertOperationSuccess)}},{key:"deactivateSubtitleEvents",value:function(){return this._listPlayer.deactivateCueEvents().then(this._assertOperationSuccess)}},{key:"activateSubtitleEvents",value:function(){return this._listPlayer.activateCueEvents().then(this._assertOperationSuccess)}}]),n}(p.vp);function Fr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var Yr,Br=function(e){(0,f.Z)(n,e);var t=Fr(n);function n(e,r){var i;return(0,c.Z)(this,n),(i=t.call(this,r)).status=-1,i.maxedSubscriptions=!1,i.unrecoverable=!1,i.debug={},i.registration=!1,i.code=e,i.name="TrackPlayerAPIClientError",i}return(0,_.Z)(n,null,[{key:"fatal",value:function(e,t){var r=new n(e,t);return r.unrecoverable=!0,r}}]),n}((0,A.Z)(Error)),xr=function(){function e(t,n){(0,c.Z)(this,e),this._stateMachine=null,this._currentState=null,this._currentStateIndex=null,this._pausedState=!1,this._initialPlaybackPosition=null,this._uri=t,this._manifestTrackResolver=n}return(0,_.Z)(e,[{key:"setPaused",value:function(e){this._pausedState=e}},{key:"isPaused",value:function(){return this._currentStateIndex&&this._currentStateIndex<0&&this._currentState&&this._currentState.transitions.advance?!!this._currentState.transitions.advance.paused:this._pausedState}},{key:"setInitialPosition",value:function(e){this._initialPlaybackPosition=e}},{key:"setStateMachine",value:function(e){this._stateMachine=e}},{key:"setDeviceId",value:function(e){this._deviceId=e}},{key:"startAtState",value:function(e){var t=this._stateMachine&&this._stateMachine.states[e.state_index];if(!t)throw new Br(i.TP_MISSING_INITIAL_STATE,"Invalid state reference.");var n=t.transitions;this._currentStateIndex=-1,this._currentState={decoy:!0,paused:!!e.paused,track:-1,state_id:null,transitions:{advance:e,show_next:n.show_next,show_prev:n.show_prev,skip_next:e,skip_prev:n.skip_prev},duration_override:t.duration_override,position_offset:t.position_offset}}},{key:"setCurrentState",value:function(e){var t=e.state_index;this._currentStateIndex=t,this._currentState=this._stateMachine&&this._stateMachine.states[t]}},{key:"getStateMachine",value:function(){return this._stateMachine}},{key:"getInternalStateRef",value:function(){var e=this._pausedState,t=this._currentStateIndex;if(!t)return null;if(t&&t<0){var n=this._currentState&&this._currentState.transitions.advance;n&&(t=n.state_index,e=!!n.paused)}return{paused:e,state_index:t}}},{key:"getStateRef",value:function(){var e,t,n=this._stateMachine;if(!n||null===this._currentStateIndex)return null;if(this._currentStateIndex<0){var r=this._currentState&&this._currentState.transitions.advance;r&&(e=n.states[r.state_index],t=r.paused)}else e=n.states[this._currentStateIndex],t=this._pausedState;return e?{state_machine_id:n.state_machine_id,state_id:e.state_id,paused:!!t}:null}},{key:"getCurrentTrack",value:function(){var e,t=this._stateMachine;if(!t||null===this._currentStateIndex)return null;if(this._currentStateIndex<0){var n=this._currentState&&this._currentState.transitions.advance;n&&(e=t.states[n.state_index])}else e=t.states[this._currentStateIndex];return e?t.tracks[e.track]:null}},{key:"startAt",value:function(){return Promise.resolve(ce.SUCCESS)}},{key:"setShuffle",value:function(){return Promise.resolve(ce.SUCCESS)}},{key:"setRepeatMode",value:function(){return Promise.resolve(ce.SUCCESS)}},{key:"next",value:function(e){var t=this._currentState,n=null;if(t){var r=t.transitions;if(e.reason===s.FORWARD_BUTTON)"skip_next"in r&&(n=r.skip_next);else"advance"in r&&(n=r.advance)}return this._transitionTo(e,n,!1)}},{key:"peekNext",value:function(e){var t=this._currentState,n=null;if(t){var r=t.transitions;if(e.reason===s.FORWARD_BUTTON)"skip_next"in r&&(n=r.skip_next);else"advance"in r&&(n=r.advance)}return this._transitionTo(e,n,!0)}},{key:"previous",value:function(e){var t=this._currentState,n=null;t&&(n=t.transitions.skip_prev);return this._transitionTo(e,n,!1)}},{key:"translatePosition",value:function(e){var t,n;return(null!==(n=null===(t=this._currentState)||void 0===t?void 0:t.position_offset)&&void 0!==n?n:0)+e}},{key:"translateDuration",value:function(e){var t,n;return null!==(n=null===(t=this._currentState)||void 0===t?void 0:t.duration_override)&&void 0!==n?n:e}},{key:"handleSeek",value:function(e,t){var n;return(null===(n=this._currentState)||void 0===n?void 0:n.duration_override)&&t.reason!==s.REMOTE?t.listConstants.IGNORE:e}},{key:"allowSeeking",value:function(){return!!this._currentState&&!this._currentState.disallow_seeking}},{key:"_transitionTo",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return new Promise((function(i){var a,o=e.reason,s=e.listConstants;if(!t)return i(s.FORBIDDEN);var u=n._stateMachine;if(!u)return i(s.NULL_VALUE);var l=u.states[t.state_index];if(!l)return i(s.NULL_VALUE);var c=u.tracks[l.track];if(!(null===(a=null==c?void 0:c.metadata)||void 0===a?void 0:a.uri))return i(s.NULL_VALUE);if(!n._currentState)return i(s.NULL_VALUE);var _=n._currentState,d=_.decoy?!!_.paused:t.paused;r||(n._currentState=l,n._currentStateIndex=t.state_index,n._pausedState=!!d);var f=0;return r||null===n._initialPlaybackPosition?"initial_playback_position"in l&&(f=l.initial_playback_position||0):(f=n._initialPlaybackPosition,n._initialPlaybackPosition=null),n._manifestTrackResolver.resolveFromStateTrack(c).then((function(e){if(!e)return i(s.NULL_VALUE);var t=n._uri;c.metadata&&c.metadata.context_uri&&(t=c.metadata.context_uri);var r=o,a=c.ms_played_until_update,u={playbackQuality:e.playbackQuality,hifiStatus:e.hifi_status},_={uri:e.uri,playableURI:e.uri,fileId:e.fileId,resolvedURL:e.resolvedURL,playable:e.playable,isAd:e.isAd,format:e.format,fileFormat:e.fileFormat,mediaType:e.mediaType,noManifest:e.noManifest,metadata:u,options:{position:f,paused:d,playedThreshold:a},logData:{noLog:!!e.noLog,noTSV:!!e.noTSV,noStats:!!e.noStats,deviceId:n._deviceId,playbackId:l.state_id?l.state_id:void 0,reason:r,displayTrack:e.uri,playContext:t,impressionURL:e.impressionURL,impressionURLs:e.impressionURLs,format:{codec:e.format,bitrate:e.bitrate},uriType:e.uriType,displayTitle:c.metadata.name,displayGroup:c.metadata.group_name,displayDuration:c.metadata.duration},stateId:l.state_id?l.state_id:void 0,audioGain:e.gainDb};return i(_)}))}))}},{key:"getCurrentState",value:function(){return this._currentState}}],[{key:"create",value:function(t,n){return new e(t,n)}}]),e}(),Zr=n(50346);!function(e){e.ON="ON",e.OFF="OFF",e.NONE="NONE"}(Yr||(Yr={}));var Kr=/^disallow_([^]+)_reasons$/;function Vr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var Gr,Hr=K.P.forTag("tp.stream.PlaybackStateObserver"),jr=function(e){(0,f.Z)(n,e);var t=Vr(n);function n(e){var r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,c.Z)(this,n),(r=t.call(this))._tpApiClient=e,r._numPreviousTracks=i.numPrevious||2,r._numNextTracks=i.numNextTracks||2,r._currentState=null,r._init(),r}return(0,_.Z)(n,[{key:"_init",value:function(){this._tpApiClient.on("state_changed",this._onStateChanged.bind(this)),this._tpApiClient.on("state_cleared",this._onStateCleared.bind(this))}},{key:"_onStateChanged",value:function(e){var t,n,r,i,a,o,s,u,l,c=e.data,_=c.stateMachine,d=c.stateRef,f=c.position,h=c.paused,v=c.loading,p=c.currentTrackInfo,E=null==_?void 0:_.states;if(_&&(null==E?void 0:E.length)&&d){var y=E[d.state_index],m=_.tracks[null==y?void 0:y.track];if(y&&m){var g=null!==(t=p.duration)&&void 0!==t?t:0,S=this._createTrackWindow(_,y,g);g||(g=null!==(r=null===(n=S.current_track)||void 0===n?void 0:n.duration_ms)&&void 0!==r?r:0);var R=function(e,t){var n={};for(var r in e)e.hasOwnProperty(r)&&"disallow_resuming_reasons"!==r&&"disallow_pausing_reasons"!==r&&(n[r]=e[r]);return t?n.disallow_pausing_reasons=["already_paused"]:n.disallow_resuming_reasons=["not_paused"],n}(y.restrictions||{},h),A=function(e){var t={};for(var n in e)if(e.hasOwnProperty(n)){var r=e[n],i=!(!r||!r.length);t[n.replace(Kr,"$1")]=i}return t}(R),T={timestamp:Date.now(),context:{uri:null!==(a=null===(i=m.metadata)||void 0===i?void 0:i.context_uri)&&void 0!==a?a:null,metadata:{}},position:f,duration:g,paused:h,playback_quality:null!==(o=p.playbackQuality)&&void 0!==o?o:Ar.UNKNOWN,playback_features:{hifi_status:null!==(s=p.hifiStatus)&&void 0!==s?s:Yr.NONE,change_playback_speed:null!==(u=p.changePlaybackSpeed)&&void 0!==u&&u},shuffle:this._getShuffleSetting(_),repeat_mode:this._getRepeatSetting(_),track_window:S,restrictions:R,disallows:A,loading:v,playback_speed:p.playbackSpeed,playback_id:y.state_id};(null===(l=m.metadata)||void 0===l?void 0:l.context_description)&&(T.context.metadata.context_description=m.metadata.context_description),this._currentState=T,this.emit("state_changed",{state:T?Object.assign({},T):null})}else Hr.warn("_onStateChanged called with no current state or track",e)}else Hr.warn("_onStateChanged called with no current state",e)}},{key:"_createTrackWindow",value:function(e,t,n){var r=this,i=e.states;return{current_track:this._getTrackMetadata(e,t,n),next_tracks:this._getNextStates(t,i).map((function(t){return r._getTrackMetadata(e,t,null)})).filter((function(e){return!!e})),previous_tracks:this._getPreviousStates(t,i).map((function(t){return r._getTrackMetadata(e,t,null)})).filter((function(e){return!!e}))}}},{key:"_onStateCleared",value:function(){this._currentState=null,this.emit("state_changed",{state:null})}},{key:"_getRepeatSetting",value:function(e){var t=e.attributes.options;return t.repeating_track?m.TRACK:t.repeating_context?m.CONTEXT:m.OFF}},{key:"_getShuffleSetting",value:function(e){return e.attributes.options.shuffling_context}},{key:"_getNextStates",value:function(e,t){for(var n=this._numNextTracks,r=[],i=e;i&&"show_next"in i.transitions&&i.transitions.show_next;){var a=t[i.transitions.show_next.state_index];if(a&&r.push(a),i=a,r.length>=n)break}return r}},{key:"_getPreviousStates",value:function(e,t){for(var n=this._numPreviousTracks,r=[],i=e;i&&"show_prev"in i.transitions&&i.transitions.show_prev;){var a=t[i.transitions.show_prev.state_index];if(a&&r.unshift(a),i=a,r.length>=n)break}return r}},{key:"_getTrackMetadata",value:function(e,t,n){var r=null==e?void 0:e.tracks[t.track];if(!(null==r?void 0:r.metadata))return null;var i=r.metadata,a=r.manifest&&"manifest_ids_video"in r.manifest,o=r.track_type.toLowerCase(),s=(0,Zr.EC)(i.uri),u=i.linked_from_uri?(0,Zr.EC)(i.linked_from_uri):null;return{id:s?s.id:null,uri:i.uri,type:(null==s?void 0:s.type)||"unknown",uid:t.track_uid,linked_from:{uri:i.linked_from_uri||null,id:u?u.id:null},media_type:a?"video":"audio",track_type:o,name:i.name,duration_ms:n||i.duration,artists:i.authors,album:{uri:i.group_uri,name:i.group_name,images:i.images},is_playable:!0}}},{key:"getCurrentState",value:function(){var e=this._currentState;if(e&&!e.paused){var t=Date.now(),n=e.position+(t-e.timestamp);e.position=n,e.timestamp=t}return Promise.resolve(this._currentState?Object.assign({},this._currentState):null)}}],[{key:"create",value:function(e,t){return new n(e,t)}}]),n}(p.vp);function qr(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Wr(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Wr(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function Wr(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Qr,zr=/^https:\/\//,Xr=(Gr={},(0,l.Z)(Gr,B.FILE_URLS_MP3,_e.MP3),(0,l.Z)(Gr,B.FILE_URLS_EXTERNAL,_e.MP3),(0,l.Z)(Gr,B.FILE_IDS_MP3,_e.MP3),(0,l.Z)(Gr,B.FILE_IDS_MP4,_e.MP4),(0,l.Z)(Gr,B.FILE_IDS_MP4_DUAL,_e.MP4),(0,l.Z)(Gr,B.FILE_IDS_CBCS,_e.MP4_CBCS),(0,l.Z)(Gr,B.FILE_IDS_MP4FLAC,_e.MP4_FLAC),(0,l.Z)(Gr,B.MANIFEST_IDS_VIDEO,_e.MANIFEST_ID),Gr),Jr=function(){function e(t){(0,c.Z)(this,e),this._descriptor=t.descriptor,this._listPlayer=t.listPlayer}return(0,_.Z)(e,[{key:"_resolveFromStateTrack",value:function(e,t,n){var r,i,a,o,s,u=e.manifest,l=e.metadata.uri,c=(0,Zr.EC)(l),_=null,d=qr(n);try{for(d.s();!(s=d.n()).done;){var f=s.value,h=u[f];if(h){var v,p=qr(h);try{for(p.s();!(v=p.n()).done;){var E=v.value;if(E.file_id||zr.test(null!==(r=E.file_url)&&void 0!==r?r:"")){var y=!(!c||c.type!==Zr.JM.AD&&c.type!==Zr.JM.INTERRUPTION);if(f!==B.FILE_IDS_MP3||y){var m=void 0;m=E.track_type?E.track_type.toLowerCase():f===B.MANIFEST_IDS_VIDEO?"video":"audio";var g=void 0;if(E.format){var S=parseInt(E.format,10);Vt[S]&&(g=S)}var R=null!==(i=E.bitrate)&&void 0!==i?i:f===B.FILE_IDS_MP4FLAC?1411200:128e3,A=null!==(a=E.bitrate)&&void 0!==a?a:f===B.FILE_IDS_MP4FLAC?7e5:128e3,T=Xr[f];if(_={uri:l,uriType:c&&c.type?c.type:void 0,fileId:null!==(o=E.file_id)&&void 0!==o?o:"",resolvedURL:E.file_url,mediaType:m,format:T,bitrate:A,fileFormat:null!=g?g:void 0,playbackQuality:E.audio_quality,hifi_status:E.hifi_status,impressionURL:E.impression_url,impressionURLs:E.impression_urls,gainDb:E.gain_db,isAd:y,noLog:!1,noTSV:y,noStats:y,noManifest:T===_e.MP3,playable:!0},f===B.MANIFEST_IDS_VIDEO||R<=t)return _}}}}catch(P){p.e(P)}finally{p.f()}}}}catch(P){d.e(P)}finally{d.f()}return _}},{key:"resolveFromStateTrack",value:function(e){var t=this;return Promise.all([Promise.resolve(this._descriptor),this._listPlayer.getCurrentBandwidth()]).then((function(n){var r=(0,u.Z)(n,2),i=r[0],a=r[1];return t._resolveFromStateTrack(e,a,i.getManifestFormats())}))}}],[{key:"create",value:function(t){return new e(t)}}]),e}(),$r=n(33603);function ei(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}!function(e){e.TRACK_DATA_FINALIZED="track_data_finalized",e.DEREGISTER="deregister",e.REGISTER="register",e.BEFORE_TRACK_LOAD="before_track_load",e.CAPPED="capped",e.ERROR="error",e.PAUSE="pause",e.RESUME="resume",e.PLAYED_THRESHOLD_REACHED="played_threshold_reached",e.POSITION_CHANGED="position_changed",e.SPEED_CHANGED="speed_changed",e.STARTED_PLAYING="started_playing",e.PROGRESS="progress",e.PING="ping",e.MODIFY_CURRENT_STATE="modify_current_state",e.STATE_CLEAR="state_clear"}(Qr||(Qr={}));var ti=K.P.forTag("tpapiclient"),ni=K.P.forTag("tpapiclient.endsong"),ri=K.P.forTag("tpapiclient.endsongs"),ii=/^hm:\/\/track-playback\/v1/,ai=/^hm:\/\/play-token\/lost/,oi=function(e,t){var n=e.getStatusFamily();return n===t.SERVER_ERROR||n===t.CONNECTION_ERROR},si={condition:oi,maxRetries:8},ui={condition:oi,maxRetries:2},li=function(e){(0,f.Z)(n,e);var t=ei(n);function n(e){var r;return(0,c.Z)(this,n),(r=t.call(this))._deviceId=null,r._sequenceNumber=0,r._currentContext=null,r._loading=!1,r._lastSentStateUpdatePayload=null,r._isSendingConflict=!1,r._queuedRejectedStates=[],r._isSendingUpdate=!1,r._queueSendUpdate=[],r._currentTrackInfo={},r._registered=!1,r._isDeregistering=!1,r._waitingForTrackingData=(0,g.$)(),r._lastProcessedStateId=null,r._limitStateUpdates=!1,r._lastUpdateStateTime=0,r._initialUpdateSent=!1,r._startedPlayingUpdateSent=!1,r._nextFinalizedDataPayload=null,r._switchingContext=!1,r._connectionId=null,r._transport=e.transport,r._logger=e.logger,r._endpoint=e.endpoint||"http://@webgate/track-playback",r._listPlayer=e.listPlayer,r._ListClass=e.ListClass,r._currentGaiaVolume=e.initialVolume*R,r._clientVersion=e.clientVersion,r._manifestTrackResolver=e.manifestTrackResolver,r._descriptorPromise=Promise.resolve(e.descriptor),r._init(),r._performCommand=r._performCommand.bind((0,d.Z)(r)),r._handleRegisterResponse=r._handleRegisterResponse.bind((0,d.Z)(r)),r._handleStateConflictResponse=r._handleStateConflictResponse.bind((0,d.Z)(r)),r.register=r.register.bind((0,d.Z)(r)),r._parseDescriptor=r._parseDescriptor.bind((0,d.Z)(r)),r._volumeDebouncer=new $r.d(r._sendVolume.bind((0,d.Z)(r)),{blockInitial:!0}),r}return(0,_.Z)(n,[{key:"_init",value:function(){var e,t=this;this._waitingForTrackingData=(0,g.$)(),this._waitingForTrackingData.resolve(!0),this._transport.on(this._transport.EVENT_CONNECTION_ID,this._onConnectionId.bind(this)),this._transport.matchMessages(ai,this._onPlayTokenLost.bind(this)),this._transport.matchMessages(ii,this._onTrackPlaybackMessage.bind(this)),this._listPlayer.addListeners((e={},(0,l.Z)(e,ue.LIST_PLAYER_CAPPED,this._onCapped.bind(this)),(0,l.Z)(e,ue.LIST_PLAYER_ERROR_SYNC,this._onError.bind(this)),(0,l.Z)(e,ue.LIST_PLAYER_BEFORE_NEXT,this._onBeforeTrackChange.bind(this)),(0,l.Z)(e,ue.LIST_PLAYER_BEFORE_PREVIOUS,this._onBeforeTrackChange.bind(this)),(0,l.Z)(e,ue.LIST_PLAYER_BEFORE_PLAYER_LOAD,this._onBeforePlayerLoad.bind(this)),(0,l.Z)(e,ue.LIST_PLAYER_PLAYER_LOAD,this._onListPlayerLoad.bind(this)),(0,l.Z)(e,ue.LIST_PLAYER_BEFORE_TRACK_LOAD,this._onBeforeTrackLoad.bind(this)),(0,l.Z)(e,ue.LIST_PLAYER_POSITION_CHANGED,this._onPositionChanged.bind(this)),(0,l.Z)(e,ue.LIST_PLAYER_DURATION_CHANGED,this._onDurationChanged.bind(this)),(0,l.Z)(e,ue.LIST_PLAYER_VOLUME_CHANGED,this._onVolumeChanged.bind(this)),(0,l.Z)(e,ue.LIST_PLAYER_PLAYBACK_SPEED_CHANGED,this._onSpeedChanged.bind(this)),(0,l.Z)(e,ue.LIST_PLAYER_PAUSED,this._onPlayPause.bind(this,!0)),(0,l.Z)(e,ue.LIST_PLAYER_PLAYING,this._onPlayPause.bind(this,!1)),(0,l.Z)(e,ue.LIST_PLAYER_PLAYED_THRESHOLD_REACHED,this._onPlayThresholdReached.bind(this)),(0,l.Z)(e,ue.LIST_PLAYER_PROGRESS,this._onProgress.bind(this)),(0,l.Z)(e,ue.LIST_PLAYER_TRACKING_DATA_CREATED,this._onTrackDataCreatedEvent.bind(this)),(0,l.Z)(e,ue.LIST_PLAYER_TRACKING_DATA_FINALIZED,this._onTrackDataFinalizedEvent.bind(this)),e)),this._descriptorPromise.then((function(e){e.on("descriptor_changed",(function(){t._parseDescriptor(e),t._updateDeviceInfo()}))}))}},{key:"_onBeforeTrackChange",value:function(){var e,t;if(!this._nextFinalizedDataPayload&&!this._switchingContext){var n=null!==(t=null===(e=this._currentContext)||void 0===e?void 0:e.getStateRef())&&void 0!==t?t:null,r=this._generateStatePayload(n,Qr.TRACK_DATA_FINALIZED);this._setSequenceNumber(r),this._nextFinalizedDataPayload=r}}},{key:"_onBeforeTrackLoad",value:function(e){var t;this._loading=!0,this._switchingContext=!1,this._currentTrackInfo.duration=void 0,this._stateEventPositionOverride=null===(t=e.data.newTrack.options)||void 0===t?void 0:t.position}},{key:"_onBeforePlayerLoad",value:function(e){var t,n,r,i,a,o,s,u,l=this._currentContext;if(l){var c=l.getCurrentTrack(),_=null===(t=l.getCurrentState)||void 0===t?void 0:t.call(l),d=null!==(r=null!==(n=null==_?void 0:_.duration_override)&&void 0!==n?n:null==c?void 0:c.metadata.duration)&&void 0!==r?r:0,f=e.data,h=f.track.metadata||{},v=this._currentTrackInfo.playbackSpeed||1;this._currentTrackInfo={duration:d,mediaType:f.track.mediaType.toUpperCase(),fileFormat:f.track.fileFormat,bitrate:null===(a=null===(i=f.logData)||void 0===i?void 0:i.format)||void 0===a?void 0:a.bitrate,playbackQuality:h.playbackQuality,hifiStatus:h.hifiStatus,changePlaybackSpeed:null!==(s=!(null===(o=f.track.options)||void 0===o?void 0:o.useDefaultPlaybackSpeed))&&void 0!==s&&s,playbackSpeed:(null===(u=e.data.track.options)||void 0===u?void 0:u.useDefaultPlaybackSpeed)?1:v};var p=f.options;l.setPaused(!p.autoplay),this._setCurrentTrackPosition(p&&p.position||0),this._updateState(Qr.BEFORE_TRACK_LOAD),this._startedPlayingUpdateSent=!1,this._initialUpdateSent=!1}}},{key:"_onCapped",value:function(){this._listPlayer.clear(s.CAPPED),this._currentContext=null,this._updateState(Qr.CAPPED),this._setCurrentTrackPosition(void 0),this._lastProcessedStateId=null,this.emit("state_cleared",null)}},{key:"_onConnectionId",value:function(e){var t=this;this._connectionId=e.data.id,this._isDeregistering||(this._registered=!1,Promise.all([this._listPlayer.getVolume(),this._descriptorPromise.then(this._parseDescriptor)]).then(this.register,(function(e){ti.info("Skipping registration due to error",e),t.emit("registration_aborted",{reason_error:e,source:y.TRACK_PLAYBACK})})).catch((function(){})))}},{key:"_onDurationChanged",value:function(e){var t,n=null===(t=this._currentContext)||void 0===t?void 0:t.getCurrentTrack();(null==n?void 0:n.metadata.uri)===e.data.track.uri&&(this._currentTrackInfo.duration=e.data.duration,this._emitStateChanged())}},{key:"_onError",value:function(e){"position"in e.data&&(this._setCurrentTrackPosition(e.data.position),this._updateState(Qr.ERROR))}},{key:"_onSpeedChanged",value:function(e){this._currentTrackInfo.playbackSpeed=e.data.playback_speed,this._updateState(Qr.SPEED_CHANGED)}},{key:"_onPlayPause",value:function(e,t){var n=this._currentContext;n&&(n.setPaused(e),"position"in t.data&&this._setAllTrackPositions(t.data.position),t.data.track.stateId&&this._shouldSendUpdateForEvent(t.data.track.stateId)?this._updateState(e?Qr.PAUSE:Qr.RESUME):(this._lastProcessedStateId=null,this._emitStateChanged()))}},{key:"_onPlayThresholdReached",value:function(e){this._initialUpdateSent=!0,this._setAllTrackPositions(e.data.position),this._updateState(Qr.PLAYED_THRESHOLD_REACHED)}},{key:"_onPlayTokenLost",value:function(){this._listPlayer.pause().catch((function(){}))}},{key:"_onPositionChanged",value:function(e){this._loading||(this._setCurrentTrackPosition(e.data.position),e.data.track&&this._shouldSendUpdateForEvent(e.data.track.stateId)?this._updateState(Qr.POSITION_CHANGED):(this._lastProcessedStateId=null,this._emitStateChanged()))}},{key:"_onProgress",value:function(e){if(!this._loading&&this._currentContext&&(this._setAllTrackPositions(e.data.position),!this._startedPlayingUpdateSent&&e.data.played>1e3&&(this._startedPlayingUpdateSent=!0,this._updateState(Qr.STARTED_PLAYING)),e.data.logData)){var t=this._currentContext.getCurrentTrack(),n=t&&"number"==typeof t.ms_playing_update_interval?t.ms_playing_update_interval:null;this._initialUpdateSent&&null!==n&&n>0&&Date.now()-this._lastUpdateStateTime>n&&this._updateState(Qr.PROGRESS)}}},{key:"_onTrackDataCreatedEvent",value:function(){this._waitingForTrackingData=(0,g.$)()}},{key:"_onTrackDataFinalizedEvent",value:function(e){var t=this._nextFinalizedDataPayload;t&&(t.playback_stats=e.data.playbackStats,this._updateState(Qr.TRACK_DATA_FINALIZED,t)),this._nextFinalizedDataPayload=null,this._waitingForTrackingData&&this._waitingForTrackingData.resolve(!0)}},{key:"_onListPlayerLoad",value:function(e){this._loading=!1;var t=this._currentContext;t&&(t.setPaused(!e.data.autoplay),this._setCurrentTrackPosition(e.data.position||0))}},{key:"_onTrackPlaybackMessage",value:function(e){var t=e.payloads;Array.isArray(t)&&t.length&&this._performCommand(t[0])}},{key:"_onVolumeChanged",value:function(e){var t;if(this._currentGaiaVolume=e.data.volume*R,this._registered){var n=null!==(t=e.data.commandId)&&void 0!==t?t:"",r={seq_num:void 0,volume:this._currentGaiaVolume,command_id:n};this._volumeDebouncer.async(r)}}},{key:"_clearSessionData",value:function(){this._connectionId=null,this._sequenceNumber=0,this._currentContext=null,this._lastSentStateUpdatePayload=null,this._isSendingConflict=!1,this._isSendingUpdate=!1,this._queueSendUpdate=[],this._previousTrackPosition=void 0,this._currentTrackPosition=void 0,this._currentTrackInfo={},this._lastProcessedStateId=null,this.emit("state_cleared",null)}},{key:"_createStateRef",value:function(e,t){if(!t)return null;var n=e.states[t.state_index];if(!n)throw new Br(i.TP_CANNOT_CREATE_STATE_REF,"Invalid state reference.");return{state_machine_id:e.state_machine_id,state_id:n.state_id,paused:t.paused}}},{key:"_deregisterFromService",value:function(e){var t=this,n=null,r=this._currentContext;r&&(e&&(r.setPaused(!e.playing),this._setAllTrackPositions(e.position)),n=r.getStateRef());var i=this._generateStatePayload(n,Qr.DEREGISTER);this._setSequenceNumber(i);var a="".concat(this._endpoint,"/v1/devices/").concat(this._deviceId);return this._transport.request(a,{authorize:!0,method:"DELETE",payload:JSON.stringify(i),responseType:"json",retry:ui}).then((function(e){if(200!==e.status&&204!==e.status)return t._registered=!0,!1;var n=e.body;return n&&(n.endsong&&ni.log(n.endsong),n.endsongs&&(ri.log(n.endsongs),t.emit("internal_endcontent",{endcontents:n.endsongs}))),t._clearSessionData(),t.emit("deregistered",null),!0}))}},{key:"_emitError",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.emit("error",{error:e,source:y.TRACK_PLAYBACK}),e.registration||this._logger.logJSSDKError({source:"tpapi-client",source_version:$.tagged,type:e.code,message:e&&e.message,stack:e&&e.stack,json_data:t,json_data_version:"1.0.0"},"object").catch((function(e){ti.error("Track-Playback Logging Error",e)}))}},{key:"_emitStateChanged",value:function(){var e=this._currentContext;if(e){var t=this._currentTrackPosition||0;void 0!==this._stateEventPositionOverride&&(t=this._stateEventPositionOverride,this._stateEventPositionOverride=void 0),this.emit("state_changed",{position:t,currentTrackInfo:this._currentTrackInfo,stateMachine:e.getStateMachine(),stateRef:e.getInternalStateRef(),paused:e.isPaused(),loading:this._loading})}}},{key:"_generateStatePayload",value:function(e,t){var n=this._currentTrackInfo;return{seq_num:void 0,seq_nums:void 0,state_ref:e,sub_state:{playback_speed:(null==e?void 0:e.paused)?0:this._currentTrackInfo.playbackSpeed||1,position:this._currentTrackPosition,duration:n.duration||void 0,media_type:n.mediaType,bitrate:n.bitrate,audio_quality:n.playbackQuality,format:n.fileFormat},previous_position:this._previousTrackPosition,playback_stats:void 0,rejected_state_refs:void 0,debug_source:t}}},{key:"_handleRegisterResponse",value:function(e){var t;if(429===e.status)return(t=Br.fatal(i.TP_MAX_SUBSCRIPTIONS_REACHED,"Max connections reached")).maxedSubscriptions=!0,t.status=e.status,this.emit("max_subscriptions_reached",{error:t}),Promise.reject(t);if(403===e.status&&e.body&&"PREMIUM_REQUIRED"===e.body.error_type?t=Br.fatal(i.TP_REGISTRATION_FAILED_NON_PREMIUM,"Cannot register to Track Playback with non-premium user."):200!==e.status?t=Br.fatal(i.TP_REGISTRATION_FAILED_WITH_STATUS,"track-playback service responded with status ".concat(e.status," when registering device")):e.body||(t=Br.fatal(i.TP_NO_RESPONSE_BODY,"Unexpected empty response body from registration request.")),t)return t.status=e.status,Promise.reject(t);var n=e.body;return n.endsong&&ni.log(n.endsong),n.endsongs&&(ri.log(n.endsongs),this.emit("internal_endcontent",{endcontents:n.endsongs})),this._sequenceNumber=n.initial_seq_num,this._registered=!0,this.emit("registered",{deviceId:this._deviceId}),Promise.resolve(!0)}},{key:"_handleStateConflictResponse",value:function(e){var t;if(e.status>=200&&e.status<300){var n=null===(t=e.body)||void 0===t?void 0:t.commands;if(!n||!n.length)return;for(var r=0,a=n.length;r<a;r++)this._performCommand(n[r])}else{var o=new Br(i.TP_CONFLICT_REQUEST_FAILED_WITH_STATUS,"Track-Playback service responded with ".concat(e.status));o.status=e.status,this._emitError(o)}}},{key:"_handleStateUpdateResponse",value:function(e,t){var n;if(200!==t.status)return(n=new Br(i.TP_PARSE_STATE_UPDATE_FAILED_WITH_STATUS,"Service responded with status ".concat(t.status))).status=t.status,Promise.reject(n);if(!t.body)return(n=new Br(i.TP_UPDATE_REQUEST_EMPTY_RESPONSE,"Unexpected empty response body from state update request.")).status=t.status,Promise.reject(n);var r=t.body;r.endsong&&ni.log(r.endsong),r.endsongs&&(ri.log(r.endsongs),this.emit("internal_endcontent",{endcontents:r.endsongs}));var a=this._currentContext;if(!a)return Promise.resolve();var o=r.state_machine,s=r.updated_state_ref;return this._isCurrentStateRef(e)?(a.setStateMachine(o),a.setCurrentState(s),this._emitStateChanged(),Promise.resolve()):Promise.resolve()}},{key:"_isCurrentStateRef",value:function(e){var t=this._currentContext?this._currentContext.getStateRef():null;return!t&&!e||!(!t||!e)&&(t.state_machine_id===e.state_machine_id&&t.state_id===e.state_id&&t.paused===e.paused)}},{key:"_logUnsentStateUpdate",value:function(e){ti.info("Unsent state update.",e),this._logger.logClientEvent({source:"tpapi-client",source_version:$.tagged,source_vendor:"spotify",event:"unsent-state-update",event_version:"1.0.0",json_data:e},"object").catch((function(e){ti.error("Track-Playback Logging Error",e)}))}},{key:"_logout",value:function(){var e=this;this._listPlayer.pause().catch((function(){})),this.emit("state_cleared",null),this.deregister().then((function(t){e._currentContext=null,e._setCurrentTrackPosition(void 0),t&&e.emit("logout",null)}))}},{key:"_parseDescriptor",value:function(e){return this._deviceId=e.getId(),this._deviceInfo=e.toTrackPlaybackDeviceInfo(),!0}},{key:"_performCommand",value:function(e){switch(e.type){case"set_volume":this._setVolume(e);break;case"log_out":this._logout();break;case"replace_state":this._replaceState(e);break;case"ping":this._updateState(Qr.PING);break;default:this._emitError(new Br(i.TP_UNKNOWN_COMMAND,"Received unknown command."),{command:e})}}},{key:"_rejectState",value:function(e){var t=this,n=this._queuedRejectedStates;if(void 0!==e&&n.push(e),this._registered&&!this._isSendingConflict&&n.length){this._isSendingConflict=!0;var r=n.splice(0,5),i=this._currentContext?this._currentContext.getStateRef():null,a=this._generateStatePayload(i);a.rejected_state_refs=r,this._setSequenceNumbers(a,r.length);var o=function(){t._isSendingConflict=!1,t._rejectState()},s="".concat(this._endpoint,"/v1/devices/").concat(this._deviceId,"/state_conflict");this._transport.request(s,{authorize:!0,method:"POST",headers:{"Content-Type":"application/json"},responseType:"json",payload:JSON.stringify(a),retry:ui}).then(this._handleStateConflictResponse).then(o,o)}}},{key:"_replaceState",value:function(e){var t,n,r,i=this._listPlayer,a=e.state_machine,o=e.state_ref,u=this._createStateRef(a,o);if(this._isCurrentStateRef(e.prev_state_ref))if(o){var l=null!==(n=null===(t=this._currentContext)||void 0===t?void 0:t.getStateRef())&&void 0!==n?n:null;if(function(e,t){if(!e)throw new Error("Assertion failed: ".concat(t))}(null!==u,"New state reference is null"),this._currentContext&&(null==l?void 0:l.state_id)===u.state_id){var c=this._currentContext;c.setStateMachine(a),c.setCurrentState(o);var _=!1;c.isPaused()!==o.paused&&(_=!0),o.paused?(c.setPaused(!0),i.pause()):(c.setPaused(!1),i.resume());var d=parseInt(e.seek_to,10);c.allowSeeking()&&!isNaN(d)&&(i.seek(d,s.REMOTE),this._setCurrentTrackPosition(d),_=!0),_?this._emitStateChanged():(this._lastProcessedStateId=null,this._updateState(Qr.MODIFY_CURRENT_STATE))}else{this._lastProcessedStateId=null!==(r=u.state_id)&&void 0!==r?r:null,this._currentContext&&this._onBeforeTrackChange();var f=this._ListClass.create("spotify:app:jsspeaker",this._manifestTrackResolver);f.setStateMachine(a),f.startAtState(o),this._deviceId&&f.setDeviceId(this._deviceId),this._currentContext=f;var h=e.seek_to||0;f.setInitialPosition(h),this._loading=!0,this._switchingContext=!0,i.play(f,{reason:s.REMOTE})}}else this._clearContextAndState();else this._rejectState(u)}},{key:"_clearContextAndState",value:function(){var e=this._listPlayer;e.pause().catch((function(){})),e.clear(s.REMOTE),this._currentContext=null,this._updateState(Qr.STATE_CLEAR),this._setAllTrackPositions(void 0),this._lastProcessedStateId=null,this.emit("state_cleared",null),this._loading=!0}},{key:"_sendDevicesRequest",value:function(e,t){var n="".concat(this._endpoint,"/v1/devices");return"PUT"===e&&(n="".concat(n,"/").concat(this._deviceId)),this._transport.request(n,{authorize:!0,method:e||"POST",headers:{"Content-Type":"application/json"},responseType:"json",payload:JSON.stringify(t),retry:si})}},{key:"_sendVolume",value:function(e){var t="".concat(this._endpoint,"/v1/devices/").concat(this._deviceId,"/volume");return this._setSequenceNumber(e),this._transport.request(t,{authorize:!0,method:"PUT",headers:{"Content-Type":"application/json"},payload:JSON.stringify(e)})}},{key:"_setAllTrackPositions",value:function(e){this._previousTrackPosition=e,this._currentTrackPosition=e}},{key:"_setCurrentTrackPosition",value:function(e){this._previousTrackPosition=this._currentTrackPosition,this._currentTrackPosition=e}},{key:"_setSequenceNumber",value:function(e){return void 0===e.seq_num&&(e.seq_num=++this._sequenceNumber),e}},{key:"_setSequenceNumbers",value:function(e,t){e.seq_nums=[];for(var n=0;n<t;n++)e.seq_nums.push(++this._sequenceNumber);return e}},{key:"_setVolume",value:function(e){var t,n=e.volume/R;this._listPlayer.setVolume(n,null!==(t=e.command_id)&&void 0!==t?t:"tpcommand-".concat(Date.now()))}},{key:"_shouldSendUpdateForEvent",value:function(e){return!(!e||e===this._lastProcessedStateId)}},{key:"_updateDeviceInfo",value:function(){var e=this;this._registered&&this._deviceInfo&&this._sendDevicesRequest("PUT",this._deviceInfo).then((function(t){204===t.status&&e.emit("registration_updated",null)}))}},{key:"_updateState",value:function(e,t){var n,r,i,a,o=this;if(this._registered)if(t?(i=t.state_ref,a=t):(i=null!==(r=null===(n=this._currentContext)||void 0===n?void 0:n.getStateRef())&&void 0!==r?r:null,a=this._generateStatePayload(i,e)),this._shouldSendPayload(a)){if(this._emitStateChanged(),this._isSendingUpdate&&this._limitStateUpdates)return this._logUnsentStateUpdate(a),void this._queueSendUpdate.push(e);this._isSendingUpdate=!0,this._queueSendUpdate=[],this._setSequenceNumber(a),this._lastSentStateUpdatePayload=a;var s=function(){o._isSendingUpdate=!1,o._queueSendUpdate.length&&o._updateState(o._queueSendUpdate[o._queueSendUpdate.length-1]),ti.info("State update sent.",e,a)},u="".concat(this._endpoint,"/v1/devices/").concat(this._deviceId,"/state");this._lastUpdateStateTime=Date.now(),this._transport.request(u,{authorize:!0,method:"PUT",headers:{"Content-Type":"application/json"},responseType:"json",payload:JSON.stringify(a),retry:si}).then(this._handleStateUpdateResponse.bind(this,i)).then(s,(function(e){o._emitError(e),s()}))}else ti.info("State update ignored (duplicate).",a)}},{key:"_shouldSendPayload",value:function(e){var t=this._lastSentStateUpdatePayload;if(!t||!t.state_ref||!e.state_ref)return!0;var n=e.state_ref,r=t.state_ref;if(n.paused!==r.paused||n.state_id!==r.state_id||n.state_machine_id!==r.state_machine_id)return!0;var i=e.sub_state,a=t.sub_state;if(i.playback_speed!==a.playback_speed||i.position!==a.position)return!0;if(e.previous_position!==t.previous_position)return!0;return Math.abs((i.duration||0)-(a.duration||0))>=26}},{key:"stop",value:function(){return!(!this._registered||!this._currentContext)&&(this._clearContextAndState(),!0)}},{key:"deregister",value:function(){var e=this;return this._registered?(this._isDeregistering=!0,this._registered=!1,this._listPlayer.getPlayerState().then((function(t){return Promise.all([e._deregisterFromService(t),e._waitingForTrackingData.promise,e._listPlayer.stop().catch((function(){}))]).then((function(t){var n=(0,u.Z)(t,1)[0];return e._isDeregistering=!1,n}))}),(function(){return e._isDeregistering=!1,e._registered=!0,!1}))):Promise.resolve(!1)}},{key:"register",value:function(){var e,t=this;if(this._registered)return Promise.resolve(!1);if(!this._deviceInfo)return Promise.reject(new Error("Need DeviceInfo for device registration."));if(!this._connectionId)return Promise.reject(new Error("Need connection-id for device registration"));var n=this._currentContext;return n&&(e=this._generateStatePayload(n.getStateRef(),Qr.REGISTER),this._setSequenceNumber(e)),this._sendDevicesRequest("POST",{device:this._deviceInfo,outro_endcontent_snooping:"true"==={}.OUTRO_SNOOPING,connection_id:this._connectionId,client_version:this._clientVersion,previous_session_state:e,volume:this._currentGaiaVolume}).then(this._handleRegisterResponse).catch((function(e){return e&&!e.maxedSubscriptions&&(e.registration=!0,t._emitError(e)),!1}))}}],[{key:"create",value:function(e){return new n(e)}}]),n}(p.vp);function ci(e){return function(e,t){var n,r,i,a,o,s,l,c,_,d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},f=e.getSDKId(),h=e.getPublicTransport(),v=e.getLogger(),p=e.getDeviceDescriptor(),E=null!==(n=d.initialVolume)&&void 0!==n?n:1;d.audioProcessorOptions=Object.assign(Object.assign({},d.audioProcessorOptions),{disable:null===(i=null===(r=d.audioProcessorOptions)||void 0===r?void 0:r.disable)||void 0===i||i});var y=Mr(Object.assign(Object.assign({},d),{transport:h,sdkId:e.getUntaggedSDKId(),loggerOptions:{disableMux:null===(s=null!==(o=null===(a=null==d?void 0:d.mux)||void 0===a?void 0:a.disable)&&void 0!==o?o:null==d?void 0:d.disableMux)||void 0===s||s,muxEnvKey:null!==(c=null===(l=null==d?void 0:d.mux)||void 0===l?void 0:l.envKey)&&void 0!==c?c:null==d?void 0:d.muxEnvKey,deviceInfo:p.then((function(e){return{platform_name:e.getPlatformName(),platform:e.getPlatformIdentifier(),version:e.getPlatformVersion(),brand:e.getBrand(),model:e.getModel(),type:e.getType()}})),muxCustomDimensions:null===(_=null==d?void 0:d.mux)||void 0===_?void 0:_.customDimensions,platform:e.getPlatformIdentifier(),clientVersion:e.getPlatformVersion()}})).then((function(e){return e.player})),m=y.then((function(e){return e.getMediaConfig()})),g=Promise.all([p,m]).then((function(e){var t=(0,u.Z)(e,2),n=t[0],r=t[1];return n.getCapability("audio_podcasts")&&!d.disableExternalFiles&&n.appendManifestFormat(B.FILE_URLS_EXTERNAL),r.keysystem===le.FAIRPLAY?n.appendManifestFormat(B.FILE_IDS_CBCS):r.keysystem!==le.WIDEVINE||d.preferMultiDRMFormat?n.appendManifestFormat(B.FILE_IDS_MP4_DUAL,B.FILE_IDS_MP4):(-1!==r.formats.audio.indexOf('audio/mp4; codecs="flac"')&&n.getCapability("lossless_playback")&&n.appendManifestFormat(B.FILE_IDS_MP4FLAC),n.appendManifestFormat(B.FILE_IDS_MP4,B.FILE_IDS_MP4_DUAL)),r.supports.protected_video&&n.getCapability("video_playback")&&n.prependManifestFormat(B.MANIFEST_IDS_VIDEO),n})),S=Or.create({trackPlayer:y}),R=Jr.create({descriptor:p,listPlayer:S}),A=t({initialVolume:E,listPlayer:S,logger:v,transport:h,clientVersion:f,descriptor:g,endpoint:d.endpoint,manifestTrackResolver:R}),T=A.playbackServiceClient,P=A.playbackStateObserver;return new Ur({client:e,playbackServiceClient:T,playbackStateObserver:P,initialVolume:E,playerPromise:y,listPlayer:S,stopOnBackground:d.stopOnBackground})}(e,(function(e){var t=li.create(Object.assign(Object.assign({},e),{ListClass:xr}));return{playbackServiceClient:t,playbackStateObserver:jr.create(t)}}),arguments.length>1&&void 0!==arguments[1]?arguments[1]:{})}var _i,di=n(96539);n(26068);function fi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}!function(e){e.LOCAL_PLAYER_DISABLED="local_player_disabled",e.STOPPED="stopped",e.REMOTE_ACTIVATED="remote_activated",e.UNKNOWN="unknown"}(_i||(_i={}));var hi=function(e){(0,f.Z)(n,e);var t=fi(n);function n(e,r){var i;return(0,c.Z)(this,n),(i=t.call(this,r)).status=-1,i.maxedSubscriptions=!1,i.unrecoverable=!1,i.debug={},i.code=e,i.name="PlayerAPIClientError",i}return(0,_.Z)(n,null,[{key:"fatal",value:function(e,t){var r=new n(e,t);return r.unrecoverable=!0,r}}]),n}((0,A.Z)(Error));function vi(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return pi(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return pi(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function pi(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Ei=function(){function e(t){(0,c.Z)(this,e),this._transport=t.transport,this._metadataCache=new ve.z6(t.cacheSize||20)}return(0,_.Z)(e,[{key:"_decorateTrackWindow",value:function(e){var t,n,r,i=this._metadataCache,a={current_track:null,next_tracks:[],previous_tracks:[]};e.current_track&&(n=i&&e.current_track&&"uri"in e.current_track&&i.get(e.current_track.uri),a.current_track=Object.assign({uid:e.current_track.uid},n||e.current_track)),t=e.next_tracks.length;for(;t--;)r=e.next_tracks[t],n=i&&r&&"uri"in r&&i.get(r.uri),a.next_tracks[t]=Object.assign({uid:r.uid},n||r);for(t=e.previous_tracks.length;t--;)r=e.previous_tracks[t],n=i&&r&&"uri"in r&&i.get(r.uri),a.previous_tracks[t]=Object.assign({uid:r.uid},n||r);return a}},{key:"_buildTrackList",value:function(e){var t,n=[],r={},i=vi([e.current_track].concat((0,I.Z)(e.next_tracks),(0,I.Z)(e.previous_tracks)));try{for(i.s();!(t=i.n()).done;){var a=t.value;a&&!r[a.uri]&&n.push(a.uri)}}catch(o){i.e(o)}finally{i.f()}return n}},{key:"_cacheMetadata",value:function(e){var t,n=[],r=[],i=this._metadataCache,a=vi(e);try{for(a.s();!(t=a.n()).done;){var o=t.value;if(!i.get(o)){var s=(0,Zr.EC)(o);s&&(s.type===Zr.JM.TRACK?r.push(s.id):s.type===Zr.JM.EPISODE&&n.push(s.id))}}}catch(l){a.e(l)}finally{a.f()}return n.length||r.length?Promise.all([this._requestMultiData("episodes",n),this._requestMultiData("tracks",r)]).then((function(e){var t=(0,u.Z)(e,2),n=t[0],r=t[1];return!!n||!!r})):Promise.resolve(!0)}},{key:"_requestMultiData",value:function(e,t){var n=this;if(!t.length)return Promise.resolve(!1);var r=this._metadataCache,i=["https://@webapi/v1/",e,"?ids=",t.join(","),"&market=from_token"].join("");return this._transport.request(i,{responseType:"json"}).then((function(t){var i;if(200!==t.status)return!1;var a=null===(i=t.body)||void 0===i?void 0:i[e];if(!a)return!1;for(var o=a.length;o--;){var s=a[o];s&&("episodes"===e?s=n._formatEpisodeData(s):(s.track_type="audio",s.media_type="audio"),r&&r.set(s.uri,s),r&&s.linked_from&&s.linked_from.uri&&r.set(s.linked_from.uri,s))}return!0}))}},{key:"_formatEpisodeData",value:function(e){var t="audio"===e.show.media_type?"audio":"video";return{id:e.id,uri:e.uri,type:"episode",media_type:t,track_type:e.show.media_type,name:e.name,artists:[{uri:e.show.uri,name:e.show.publisher}],album:{uri:e.show.uri,name:e.show.name,images:e.images},duration_ms:e.duration_ms||0,is_playable:!0}}},{key:"formatLocalTrack",value:function(e,t){return e&&e.type===Zr.JM.LOCAL_TRACK?{uri:e.toURI(),type:"local",uid:t,media_type:"audio",track_type:"audio",name:e.track,artists:[{uri:(0,Zr.ak)(e.artist).toURI(),name:e.artist}],album:{uri:(0,Zr.Jf)(e.artist,e.album).toURI(),name:e.album,images:[{url:""}]},duration_ms:e.duration?1e3*e.duration:0,is_playable:!1}:null}},{key:"formatAd",value:function(e,t){if(!e||e.type!==Zr.JM.AD&&e.type!==Zr.JM.INTERRUPTION)return null;if(!t||!t.metadata)return null;var n=t.metadata;return{id:e.id,uri:e.toURI(),type:e.type,uid:t.uid,media_type:"audio",track_type:"audio",name:n.advertiser,artists:[{uri:n.click_url,name:n.buttonMessage||n.advertiser}],album:{uri:n.click_url,name:n.advertiser,images:[{url:n.image_url}]},duration_ms:parseInt(n.duration,10),is_playable:!1}}},{key:"decorateTrackWindow",value:function(e,t){var n=this,r=null!=t?t:this._buildTrackList(e);return this._cacheMetadata(r).then((function(t){return t?n._decorateTrackWindow(e):e}))}}],[{key:"create",value:function(t){return new e(t)}}]),e}();function yi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}function mi(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return gi(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return gi(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function gi(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Si=K.P.forTag("harmony.controller"),Ri=/^disallow_([^]+)_reasons$/,Ai={disallow_pausing_reasons:!0,disallow_peeking_next_reasons:!0,disallow_peeking_prev_reasons:!0,disallow_resuming_reasons:!0,disallow_seeking_reasons:!0,disallow_skipping_next_reasons:!0,disallow_skipping_prev_reasons:!0,disallow_toggling_repeat_context_reasons:!0,disallow_toggling_repeat_track_reasons:!0,disallow_toggling_shuffle_reasons:!0,disallow_transferring_playback_reasons:!0},Ti="premium",Pi="on-demand",Li={unknown:Ar.UNKNOWN,default:Ar.DEFAULT,low:Ar.LOW,normal:Ar.NORMAL,normalized:Ar.NORMAL,high:Ar.HIGH,veryhigh:Ar.VERY_HIGH,hifi:Ar.HIFI},Ii={on:Yr.ON,off:Yr.OFF,none:Yr.NONE};function ki(e,t){if(!e)return[];for(var n=[],r=[Zr.JM.TRACK,Zr.JM.EPISODE],i=0,a=e.length;i<a;i++){var o=e[i];if(!o)throw new TypeError("Null value inside track array.");var s=void 0;if("string"==typeof o?(s=(0,Zr.EC)(o),o={uri:o}):s=(0,Zr.EC)(o.uri),!/^spotify:(meta:|delimiter)/.test(o.uri)){if(!s)throw new TypeError("Invalid uri string: ".concat(s));if(-1===r.indexOf(s.type))throw new TypeError("Invalid track uri: ".concat(o.uri))}o.metadata||(o.metadata={}),t&&t.queued&&(o.metadata.is_queued="true"),n.push(o)}return n}function Di(e){if(e){if(/^.+:\/\//.test(e))return e;throw new TypeError("Invalid page url: ".concat(e))}}var Ci=function(e){(0,f.Z)(n,e);var t=yi(n);function n(e){var r;return(0,c.Z)(this,n),(r=t.call(this))._suppressed=!1,r._lastDeviceInfoData=null,r._state=null,r._lastPlayerState=null,r._isOrphanedState=!1,r._progressPosition=0,r._lastProgressTs=0,r._trackingIntervalId=0,r._queue=null,r._client=e.client,r._serverTime=e.serverTime,r._version=e.version,r._playerClient=e.playerClient,r._disableProgress=!!e.disableProgress,r._transport=r._client.getPublicTransport(),r._decorate=!!e.decorateTrackWindow,r._metadataDecorator=new Ei({transport:r._transport}),r._onClientBeforeDisconnect=r._onClientBeforeDisconnect.bind((0,d.Z)(r)),r._onDeviceStateChanged=r._onDeviceStateChanged.bind((0,d.Z)(r)),r._onPlayerStateChanged=r._onPlayerStateChanged.bind((0,d.Z)(r)),r._onProgressTracking=r._onProgressTracking.bind((0,d.Z)(r)),r._client.on("before_disconnect",r._onClientBeforeDisconnect),r.proxyEmit(r._playerClient,"max_subscriptions_reached","max_subscriptions_reached"),r.proxyEmit(r._playerClient,"devices_changed","devices_changed"),r.proxyEmit(r._playerClient,"registered","registered"),r.proxyEmit(r._playerClient,"deregistered","deregistered"),r._playerClient.on("device_state_changed",r._onDeviceStateChanged),r._playerClient.on("player_state_changed",r._onPlayerStateChanged),r}return(0,_.Z)(n,[{key:"_onClientBeforeDisconnect",value:function(e){e&&e.data.awaitPromise(this._playerClient.deregister().catch((function(){})))}},{key:"_onDeviceStateChanged",value:function(e){var t,n,r=this,i=e.data,a=i.deviceState,o=i.hasOrphanedState,s=!!(null===(n=null===(t=this._lastDeviceInfoData)||void 0===t?void 0:t.deviceInfo)||void 0===n?void 0:n.local);this._lastDeviceInfoData={deviceInfo:a,hasOrphanedState:o},s&&!(null==a?void 0:a.local)&&this._playerClient.getDevices().then((function(e){var t=e.localDevice,n=_i.STOPPED;o?t||(n=_i.LOCAL_PLAYER_DISABLED):n=_i.REMOTE_ACTIVATED,r.emit("device_deactivated",{reason:n})})).catch((function(e){Si.warn("Device deactivation checking failed.",e)})),this._suppressed||this.emit("device_info_changed",this._lastDeviceInfoData)}},{key:"_startProgressTracking",value:function(){this._stopProgressTracking(),this._lastProgressTs=Date.now(),this._onProgressTracking(),this._trackingIntervalId=setInterval(this._onProgressTracking,500)}},{key:"_stopProgressTracking",value:function(){this._trackingIntervalId&&(clearInterval(this._trackingIntervalId),this._trackingIntervalId=0)}},{key:"_onProgressTracking",value:function(){var e,t=Date.now(),n=(null===(e=this._lastPlayerState)||void 0===e?void 0:e.playback_speed)||1;this._progressPosition+=n*(t-this._lastProgressTs),this.emit("progress",{position:this._progressPosition,timestamp:Date.now()}),this._lastProgressTs=t}},{key:"_getLicense",value:function(){return this._client.getProductState().then((function(e){return"premium"===e.product?Ti:Pi})).catch((function(){return Pi}))}},{key:"_generatePlayOptions",value:function(e,t){return this._getLicense().then((function(n){var r={license:n};if(!e)return r;if(("index"in e||"trackUID"in e||"trackURI"in e||"pageIndex"in e)&&(r.skip_to={track_uid:e.trackUID,track_index:e.index,track_uri:e.trackURI,page_index:e.pageIndex}),"initialOffset"in e&&(r.seek_to=e.initialOffset),"paused"in e&&(r.initially_paused=e.paused),"alwaysPlaySomething"in e&&(r.always_play_something=e.alwaysPlaySomething),t)return r;r.player_options_override={};var i=r.player_options_override;if("shuffle"in e&&(i.shuffling_context=e.shuffle),"repeatMode"in e)switch(e.repeatMode){case m.CONTEXT:i.repeating_context=!0,i.repeating_track=!1;break;case m.TRACK:i.repeating_track=!0,i.repeating_context=!1;break;case m.OFF:i.repeating_track=!1,i.repeating_context=!1}return r}))}},{key:"_setFilterAndSort",value:function(e,t){t&&t.filter&&e.metadata&&(e.metadata["filtering.predicate"]=t.filter),t&&t.sort&&e.metadata&&(e.metadata["sorting.criteria"]=t.sort)}},{key:"_setMetadataOptions",value:function(e,t){if(t){var n=e.metadata||{};"autoplayCandidate"in t&&(n.autoplay_candidate=t.autoplayCandidate?"true":"false"),e.metadata=n}}},{key:"_generatePlayOrigin",value:function(e){if(e&&e.featureClasses&&!Array.isArray(e.featureClasses))throw new TypeError("PlayOptions playOrigin.featureClasses must be an array of strings.");return{feature_identifier:e&&e.featureIdentifier||"harmony",feature_version:e&&e.featureVersion||this._version,feature_classes:e&&e.featureClasses,view_uri:e&&e.viewURI,external_referrer:e&&e.externalReferrer,referrer_identifier:e&&e.referrerIdentifier}}},{key:"_generateLoggingParams",value:function(e){if(e){var t=e.pageInstanceId,n=e.interactionId;return{page_instance_ids:t?[t]:[],interaction_ids:n?[n]:[]}}}},{key:"_parseRestrictions",value:function(e){var t={};for(var n in e.restrictions)e.restrictions.hasOwnProperty(n)&&Ai[n]?t[n]=e.restrictions[n]:Ai[n]&&(t[n]=[]);return t}},{key:"_parseDisallows",value:function(e){var t={},n=e.restrictions;for(var r in n)if(n.hasOwnProperty(r)&&Ai[r]){var i=n[r],a=!(!i||!i.length);t[r.replace(Ri,"$1")]=a}return t}},{key:"_onPlayerStateChanged",value:function(e){var t=this;this._isOrphanedState=e.data.orphaned,this._parsePlayerState(e.data.playerState).then((function(n){t._state=n,t._suppressed||t.emit("state_changed",{state:n?Object.assign({},n):null,orphaned:e.data.orphaned}),!t._disableProgress&&n&&(t._progressPosition=n.position,n.paused?t._stopProgressTracking():t._startProgressTracking())}))}},{key:"_parsePlayerState",value:function(e){var t=this;return this._lastPlayerState=e,e?this._getTrackWindow(e).then((function(n){var r,i,a,o,s,u,l,c;return{context:{uri:e.context_uri||null,metadata:e.context_metadata||{}},timestamp:e.timestamp,duration:e.duration||n.current_track&&"uri"in n.current_track&&n.current_track.duration_ms||0,position:e.is_paused?e.position_as_of_timestamp:t._offsetPosition(e.timestamp,e.position_as_of_timestamp,null===(r=t._lastPlayerState)||void 0===r?void 0:r.playback_speed),playback_id:null,playback_quality:null!==(o=Li[null!==(a=null===(i=e.playback_quality)||void 0===i?void 0:i.bitrate_level)&&void 0!==a?a:"unknown"])&&void 0!==o?o:Ar.UNKNOWN,playback_features:{hifi_status:Ii[null!==(u=null===(s=e.playback_quality)||void 0===s?void 0:s.hifi_status)&&void 0!==u?u:"none"]},paused:!!e.is_paused,shuffle:!(!e.options||!e.options.shuffling_context),repeat_mode:t._getStateRepeatMode(e),restrictions:t._parseRestrictions(e),disallows:t._parseDisallows(e),track_window:n,bitrate:null,loading:null!==(c=null===(l=t._state)||void 0===l?void 0:l.loading)&&void 0!==c&&c}})):Promise.resolve(null)}},{key:"_offsetPosition",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=t+(((arguments.length>3?arguments[3]:void 0)||this._serverTime.getApproximate())-e)*n;return r<0?0:r}},{key:"_isRestricted",value:function(e,t){if(!e||!e.restrictions)return!1;var n="disallow_".concat(t,"_reasons");return!!(e.restrictions[n]||[]).length}},{key:"_getTrackWindow",value:function(e){var t={current_track:null,next_tracks:[],previous_tracks:[]},n={},r=[];if(!e.track)return Promise.resolve(t);var i=e.track.uri;if(!i)return Promise.resolve(t);var a=this._metadataDecorator,o=(0,Zr.EC)(i),s=a.formatLocalTrack(o,e.track.uid),u=a.formatAd(o,e.track);return t.current_track=s||u||{uri:i,uid:e.track.uid,type:o&&o.type?o.type:"unknown"},s||u||(n[i]=1,r.push(i)),this._isRestricted(e,"peeking_next")||this._fillWindow(r,t.next_tracks,n,e.next_tracks?e.next_tracks.slice(0,5):[]),this._isRestricted(e,"peeking_prev")||this._fillWindow(r,t.previous_tracks,n,e.prev_tracks?e.prev_tracks.slice(-5):[],!0),this._decorate?this._metadataDecorator.decorateTrackWindow(t,r):Promise.resolve(t)}},{key:"_fillWindow",value:function(e,t,n,r,i){i&&r.reverse();var a,o=mi(r);try{for(o.s();!(a=o.n()).done;){var s=a.value,u=s.uri,l=(0,Zr.EC)(u);if(u&&"spotify:delimiter"!==u&&(!l||l.type!==Zr.JM.AD&&l.type!==Zr.JM.INTERRUPTION)){var c=this._metadataDecorator.formatLocalTrack(l,s.uid),_=c||{uri:u,uid:s.uid,type:"unknown"};if(c||u in n||(n[u]=1,e.push(u)),i?t.unshift(_):t.push(_),2===t.length)break}}}catch(d){o.e(d)}finally{o.f()}}},{key:"_getStateRepeatMode",value:function(e){var t=e.options;return t&&t.repeating_track?m.TRACK:t&&t.repeating_context?m.CONTEXT:m.OFF}},{key:"_play",value:function(e,t,n){var r=this;return this._setFilterAndSort(e,n),this._setMetadataOptions(e,n),this._generatePlayOptions(n).then((function(i){var a={context:e,play_origin:r._generatePlayOrigin(n&&n.playOrigin),options:i,logging_params:r._generateLoggingParams(null==n?void 0:n.loggingParams)};return r._playerClient.play(a,t)}))}},{key:"getActiveDevice",value:function(){return this._playerClient.getActiveDevice()}},{key:"getCurrentState",value:function(e){var t;if(e&&this._isOrphanedState)return Promise.resolve(null);var n=this._state;if(n&&!n.paused){var r=this._serverTime.getApproximate();n.position=this._offsetPosition(n.timestamp,n.position,null===(t=this._lastPlayerState)||void 0===t?void 0:t.playback_speed,r),n.timestamp=r}return Promise.resolve(n?Object.assign({},n):null)}},{key:"getContextPlayerState",value:function(){return Si.warn("The `getContextPlayerState()` method is not well supported. Please avoid using it directly."),this._playerClient.getContextPlayerState()}},{key:"getDevices",value:function(){return this._playerClient.getDevices()}},{key:"playURI",value:function(e,t,n){if(!(0,Zr.EC)(e))return Promise.reject(new TypeError("Invalid Spotify URI"));var r={uri:e,url:"context://".concat(e),metadata:n&&n.contextMetadata||{}};return this._play(r,t,n)}},{key:"playPages",value:function(e,t,n){var r,i;if(!Array.isArray(e))return Promise.reject(new TypeError("Invalid pages array."));try{i=function(e){var t,n,r,i,a=[],o=mi(e);try{for(o.s();!(i=o.n()).done;){var s=i.value;a.push({tracks:Array.isArray(s.tracks)?ki(s.tracks):void 0,page_url:null!==(t=Di(s.pageURL))&&void 0!==t?t:void 0,next_page_url:null!==(n=Di(s.nextPageURL))&&void 0!==n?n:void 0,metadata:null!==(r=s.metadata)&&void 0!==r?r:void 0})}}catch(u){o.e(u)}finally{o.f()}return a}(e)}catch(o){return Promise.reject(o)}var a={uri:null!==(r=null==n?void 0:n.contextURI)&&void 0!==r?r:"spotify:internal:harmony-play-pages",metadata:(null==n?void 0:n.contextMetadata)||{},pages:i};return this._play(a,t,n)}},{key:"playTracks",value:function(e,t,n){var r,i;if(!Array.isArray(e))return Promise.reject(new TypeError("Invalid tracks array."));try{i=ki(e)}catch(o){return Promise.reject(o)}var a={uri:null!==(r=null==n?void 0:n.contextURI)&&void 0!==r?r:"spotify:internal:harmony-play-tracks",metadata:(null==n?void 0:n.contextMetadata)||{},pages:[{tracks:i}]};return this._play(a,t,n)}},{key:"updateCurrentContext",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this._playerClient.updateCurrentContext(e,t)}},{key:"setQueue",value:function(e,t,n){if(!Array.isArray(e))return Promise.reject(new TypeError("Invalid nextTracks array."));if(!Array.isArray(t))return Promise.reject(new TypeError("Invalid previousTracks array."));var r,i;try{r=ki(e),i=ki(t)}catch(o){return Promise.reject(o)}var a={next_tracks:r.length?r:void 0,prev_tracks:i.length?i:void 0};return this._playerClient.setQueue(a,n)}},{key:"transfer",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this._playerClient.transfer(e,t)}},{key:"pause",value:function(e,t){var n={logging_params:this._generateLoggingParams(null==t?void 0:t.loggingParams)};return this._playerClient.pause(e,n)}},{key:"resume",value:function(e,t){var n={logging_params:this._generateLoggingParams(null==t?void 0:t.loggingParams)};return this._playerClient.resume(e,n)}},{key:"togglePlay",value:function(e,t){var n={logging_params:this._generateLoggingParams(null==t?void 0:t.loggingParams)};return this._playerClient.togglePlay(e,n)}},{key:"nextTrack",value:function(e,t){var n={logging_params:this._generateLoggingParams(null==t?void 0:t.loggingParams)};return(null==t?void 0:t.track)&&(n.track=w([t.track])[0]),this._playerClient.nextTrack(e,n)}},{key:"previousTrack",value:function(e,t){var n={logging_params:this._generateLoggingParams(null==t?void 0:t.loggingParams)};return(null==t?void 0:t.track)&&(n.track=w([t.track])[0]),this._playerClient.previousTrack(e,n)}},{key:"seek",value:function(e,t){return this._playerClient.seek(e,t)}},{key:"setShuffle",value:function(e,t,n){var r={logging_params:this._generateLoggingParams(null==n?void 0:n.loggingParams)};return this._playerClient.setShuffle(e,t,r)}},{key:"toggleShuffle",value:function(e,t){var n={logging_params:this._generateLoggingParams(null==t?void 0:t.loggingParams)};return this._playerClient.toggleShuffle(e,n)}},{key:"setVolume",value:function(e,t){return this._playerClient.setVolume(e,t)}},{key:"logout",value:function(e){return this._playerClient.logout(e)}},{key:"setRepeatMode",value:function(e,t){var n=this;return this.getCurrentState().then((function(r){if(!r)return Promise.reject(new hi(i.CONNECTAPI_CLIENT_NO_STATE,"Nothing playing"));var a=n._playerClient,o=r.disallows;switch(e){case m.OFF:return(!o.toggling_repeat_context||!o.toggling_repeat_track)&&a.setOptions({repeating_context:!!o.toggling_repeat_context&&void 0,repeating_track:!!o.toggling_repeat_track&&void 0},t);case m.CONTEXT:return!o.toggling_repeat_context&&a.setOptions({repeating_context:!0,repeating_track:!!o.toggling_repeat_track&&void 0},t);case m.TRACK:return!o.toggling_repeat_track&&a.setOptions({repeating_context:!o.toggling_repeat_context||void 0,repeating_track:!0},t);default:return Promise.reject(new TypeError("Unknown repeat mode."))}}))}},{key:"register",value:function(){return this._playerClient.register()}},{key:"suppressEvents",value:function(){this._suppressed=!0}},{key:"unsuppressEvents",value:function(){this._suppressed=!1,this._lastDeviceInfoData&&this.emit("device_info_changed",this._lastDeviceInfoData),this._state&&this.emit("state_changed",{state:this._state})}},{key:"getQueueManager",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this._queue){var n=t.reportInitial?this._lastPlayerState:null;this._queue=new F(Object.assign({connectClient:this._playerClient,initialContextPlayerState:n,runner:e},t))}return this._queue}}],[{key:"create",value:function(e){return new n(e)}}]),n}(p.vp),bi=n(16221);function Oi(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Ni(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Ni(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function Ni(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Mi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,v.Z)(e);if(t){var i=(0,v.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,h.Z)(this,n)}}var wi=/connect-state\/v1\/cluster$/,Ui=/^([a-zA-Z0-9_%:-]{1,40}).*$/;function Fi(e){var t,n,r;return!!e.track&&0===(null!==(r=null===(n=null===(t=e.restrictions)||void 0===t?void 0:t.disallow_transferring_playback_reasons)||void 0===n?void 0:n.length)&&void 0!==r?r:0)}var Yi="::a_";function Bi(e){if(!e)return{deviceId:null};var t=e.split(Yi),n=(0,u.Z)(t,2),r=n[0],i=n[1];return{deviceId:r,aliasId:i?parseInt(i,10):void 0}}var xi=function(e){(0,f.Z)(n,e);var t=Mi(n);function n(e){var r;return(0,c.Z)(this,n),(r=t.call(this))._autoregister=!0,r._connectionId="",r._localDeviceId="",r._localObserverDeviceId=null,r._lastActiveDevice=null,r._lastKnownPlayerState=null,r._lastKnownDevices=[],r._localDevice=null,r._fetchedInitialState=!1,r._awaitingAcknowledgment={},r._acknowledgementMaps=[],r._lastProcessedTimestamp=0,r._descriptor=e.descriptor,r._transport=e.transport,r._endpoint=e.endpoint||"@webgate/connect-state",r._autoregister=!("autoregister"in e)||!!e.autoregister,r._onConnectionId=r._onConnectionId.bind((0,d.Z)(r)),r._onClusterMessage=r._onClusterMessage.bind((0,d.Z)(r)),r._awaitResponseWithAck=r._awaitResponseWithAck.bind((0,d.Z)(r)),r._transport.on(r._transport.EVENT_CONNECTION_ID,(function(e){r._onConnectionId(e.data.id)})),r._transport.matchMessages(wi,r._onClusterMessage),r._descriptorPromise=Promise.resolve(r._descriptor).then((function(e){return r._localDeviceId=e.id||"",r._localObserverDeviceId=("hobs_"+r._localDeviceId).replace(Ui,"$1"),!0})),r}return(0,_.Z)(n,[{key:"_onConnectionId",value:function(e){this._connectionId=e,this._autoregister&&this.register()}},{key:"_onClusterMessage",value:function(e){var t=e.payloads&&e.payloads[0];if(t){if(t.ack_id){var n=t.ack_id,r=this._awaitingAcknowledgment[n];if(r)r.resolve(!0);else{var i,a=Oi(this._acknowledgementMaps);try{for(a.s();!(i=a.n()).done;){i.value[n]=(0,g.$)()}}catch(o){a.e(o)}finally{a.f()}}}this._parseCluster(t.cluster)}}},{key:"_resolveTargetDevice",value:function(e){var t=this;return this._descriptorPromise.then((function(){var n=t._localDeviceId;return Bi(e?e===S?n:e:t._lastActiveDevice?t._lastActiveDevice.id:n)}))}},{key:"_makeEndpoint",value:function(e,t,n){var r=this;return this._descriptorPromise.then((function(){var i=r._localDeviceId;return"".concat(r._endpoint,"/").concat(e,"/").concat(t,"/from/").concat(i,"/to/").concat(n)}))}},{key:"_sendPlayerCommand",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};r.endpoint=e;var a={command:r};return this._resolveTargetDevice(n).then((function(e){if(!e.deviceId)throw new hi(i.CONNECTAPI_CLIENT_MISSING_DEVICE_ID,"Operation resulted in a null device id");return!a.target_alias_id&&e.aliasId&&(a.target_alias_id=e.aliasId),t._makeEndpoint("v1","player/command",e.deviceId)})).then((function(e){return t._sendRequest(bi.n.POST,e,a)})).then(this._awaitResponseWithAck)}},{key:"_sendConnectCommand",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a="volume"===e?bi.n.PUT:bi.n.POST,o="volume"===e||"logout"===e;return this._resolveTargetDevice(n).then((function(n){if(!n.deviceId)throw new hi(i.CONNECTAPI_CLIENT_MISSING_DEVICE_ID,"Operation resulted in a null device id");return n.aliasId&&(o?r.command_options={target_alias_id:n.aliasId}:r.target_alias_id||(r.target_alias_id=n.aliasId)),t._makeEndpoint("v1","connect/".concat(e),n.deviceId)})).then((function(e){return t._sendRequest(a,e,r)})).then(this._awaitResponseWithAck)}},{key:"_sendRequest",value:function(e,t,n){var r=this._acknowledgementMaps,i={};r.push(i);var a=function(){var e=r.indexOf(i);-1!==e&&r.splice(e,1)};return this._transport.request(t,{method:e,payload:n?JSON.stringify(n):void 0,responseType:"json",retry:{condition:function(e,t){var n=e.getStatusFamily();return n===t.SERVER_ERROR||n===t.CONNECTION_ERROR}}}).then((function(e){return a(),{response:e,map:i}}),(function(e){return a(),Promise.reject(e)}))}},{key:"_awaitResponseWithAck",value:function(e){var t,n;if(404===e.response.status)return Promise.reject(new hi(i.CONNECTAPI_CLIENT_NO_DEVICE,"No such device."));var r=null===(t=e.response.body)||void 0===t?void 0:t.ack_id;if(200===e.response.status&&r){if(null===(n=e.map)||void 0===n?void 0:n[r])return Promise.resolve(!0);var a=(0,g.$)();return this._awaitingAcknowledgment[r]=a,a.promise}return Promise.resolve(202===e.response.status&&!r)}},{key:"_parseCluster",value:function(e){if(e){var t=parseInt(e.timestamp,10);this._lastProcessedTimestamp>t||(this._lastProcessedTimestamp=t,this._parseClusterDevices(e),this._parseClusterPlayerState(e))}}},{key:"_parseClusterDevices",value:function(e){var t=this._lastActiveDevice;this._lastActiveDevice=null,this._lastKnownDevices=[],this._localDevice=null;var n=[];for(var r in e.devices)e.devices.hasOwnProperty(r)&&n.push(r);if(n.sort(),n.length){var i,a=e.active_device_id,o=Oi(n);try{for(o.s();!(i=o.n()).done;){var s,u=i.value,l=e.devices[u],c=this._formatClusterDevice(l,a);(s=this._lastKnownDevices).push.apply(s,(0,I.Z)(c));var _,d=Oi(c);try{for(d.s();!(_=d.n()).done;){var f=_.value;f.is_active&&(this._lastActiveDevice=f),f.local&&(this._localDevice=f)}}catch(p){d.e(p)}finally{d.f()}}}catch(p){o.e(p)}finally{o.f()}}if(!this._fetchedInitialState||!L(this._lastActiveDevice,t)){var h=e.player_state,v=h&&Fi(h);this.emit("device_state_changed",{deviceState:this._lastActiveDevice,hasOrphanedState:!this._lastActiveDevice&&!!v,disappeared:!!t&&!this._lastActiveDevice})}this.emit("devices_changed",{devices:this._lastKnownDevices,localDevice:this._localDevice})}},{key:"_formatClusterDevice",value:function(e,t){var n={};if(e&&Array.isArray(e.metadata))for(var r=0,i=e.metadata.length;r<i;r++){var a=e.metadata[r];n[a.type]=a.metadata}var o=e.capabilities,s={hidden:!1,id:e.device_id,is_active:e.device_id===t,is_controllable:!!o.is_controllable,is_observable:!!o.is_observable,local:e.device_id===this._localDeviceId,metadata:n,name:e.name,type:(e.device_type||x.UNKNOWN).toLowerCase(),version:e.device_software_version,volume:o.disable_volume?-1:e.volume/R||0,capabilities:{supports_lossless_audio:!!o.supports_lossless_audio},is_alias:!1,is_alias_group:!1,playback_features:{hifi_status:o.supports_hifi},is_group:!!e.is_group,is_being_activated:!1};if(!e.device_aliases)return[s];var u=[];for(var l in e.device_aliases)if(e.device_aliases.hasOwnProperty(l)){var c=e.device_aliases[l];if(c){var _=Object.assign(Object.assign({},s),{id:"".concat(s.id).concat(Yi).concat(c.id),name:c.display_name,is_alias:!0,is_alias_group:e.is_group||c.is_group,is_active:s.is_active&&e.selected_alias_id===c.id,is_group:!!c.is_group});u.push(_)}}return u}},{key:"_parseClusterPlayerState",value:function(e){this._lastKnownPlayerState=null;var t=e.active_device_id,n=t&&e.devices[t],r=e.player_state;r&&r.track&&(n&&n.capabilities&&!n.capabilities.is_observable?r=null:(n||(r.is_paused=!0,r.restrictions&&(delete r.restrictions.disallow_resuming_reasons,r.restrictions.disallow_pausing_reasons=["already_paused"])),r.duration=parseInt(r.duration,10),r.position=parseInt(r.position,10),r.position_as_of_timestamp=parseInt(r.position_as_of_timestamp,10),r.timestamp=parseInt(r.timestamp,10),r.next_tracks=r.next_tracks||[],r.prev_tracks=r.prev_tracks||[]),this._lastKnownPlayerState=r);var i=!n&&!!this._lastKnownPlayerState;i&&r&&!Fi(r)&&(this._lastKnownPlayerState=null,i=!1),this.emit("player_state_changed",{playerState:this._lastKnownPlayerState,orphaned:i,isLocal:!!t&&t===this._localDeviceId})}},{key:"_register",value:function(){var e=this;this._fetchedInitialState=!1;var t="".concat(this._endpoint,"/v1/devices/").concat(this._localObserverDeviceId);return this._connectionId||Promise.reject(new hi(i.CONNECTAPI_CLIENT_NO_CONNECTION_ID,"Cannot register: no connection id.")),this._transport.request(t,{method:"PUT",headers:{"X-Spotify-Connection-Id":this._connectionId,Accept:"application/json"},payload:JSON.stringify({member_type:"CONNECT_STATE",device:{device_info:{capabilities:{can_be_player:!1,hidden:!0,needs_full_player_state:!0}}}}),responseType:"json"}).then((function(t){429===t.status?e.emit("max_subscriptions_reached",{error:new hi(i.CONNECTAPI_MAX_SUBSCRIPTIONS_REACHED,"Max connections reached")}):200===t.status&&(e.emit("registered",null),t.body&&(e._parseCluster(t.body),e._fetchedInitialState=!0)),429!==t.status&&408!==t.status||(e._lastKnownDevices=e._lastKnownDevices.map((function(e){return e.is_being_activated=!1,e})),e._localDevice&&(e._localDevice.is_being_activated=!1),e.emit("devices_changed",{devices:e._lastKnownDevices,localDevice:e._localDevice}))}))}},{key:"register",value:function(){return this._connectionId?this._descriptorPromise.then(this._register.bind(this)):Promise.reject(new hi(i.CONNECTAPI_CLIENT_NO_CONNECTION_ID,"Cannot register: no connection id."))}},{key:"deregister",value:function(){var e=this,t="".concat(this._endpoint,"/v1/devices/").concat(this._localObserverDeviceId);return this._transport.request(t,{method:"DELETE",responseType:"json"}).then((function(t){200===t.status&&e.emit("deregistered",null)}))}},{key:"getDevices",value:function(){var e=this;return this._fetchedInitialState?Promise.resolve({devices:this._lastKnownDevices,localDevice:this._localDevice}):new Promise((function(t){e.once("device_state_changed",(function(){t({devices:e._lastKnownDevices,localDevice:e._localDevice})}))}))}},{key:"getActiveDevice",value:function(){var e=this;return this._fetchedInitialState?Promise.resolve(this._lastActiveDevice):new Promise((function(t){e.once("device_state_changed",(function(e){t(e.data.deviceState)}))}))}},{key:"getContextPlayerState",value:function(){var e=this;return this._fetchedInitialState?Promise.resolve(this._lastKnownPlayerState):new Promise((function(t){e.once("player_state_changed",(function(e){t(e.data.playerState)}))}))}},{key:"play",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return e?this._sendPlayerCommand("play",t,e):Promise.reject(new hi(i.CONNECTAPI_CLIENT_INVALID_ARGUMENTS,"Descriptor is required for play commands"))}},{key:"updateCurrentContext",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.getContextPlayerState().then((function(r){return r?r.session_id?r.context_url||n.forceNonUpdateable?e._sendPlayerCommand("update_context",t,{context:{url:r.context_url||"context://".concat(r.context_uri)},session_id:r.session_id}):Promise.resolve(!1):Promise.reject(new hi(i.CONNECTAPI_CLIENT_NO_SESSION_ID,"The current state does not have a session id")):Promise.reject(new hi(i.CONNECTAPI_CLIENT_NO_STATE,"Nothing playing"))}))}},{key:"setQueue",value:function(e,t){return this._sendPlayerCommand("set_queue",t,e)}},{key:"addToQueue",value:function(e,t){return this._sendPlayerCommand("add_to_queue",t,{track:e})}},{key:"transfer",value:function(e){var t,n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this._lastKnownDevices=this._lastKnownDevices.map((function(t){return t.is_being_activated=t.id===e,t})),this._localDevice&&(this._localDevice.is_being_activated=e===S),this.emit("devices_changed",{devices:this._lastKnownDevices,localDevice:this._localDevice});var i={restore_paused:"restore"};return"paused"in r&&(i.restore_paused=r.paused?"pause":"resume"),this._sendConnectCommand("transfer",e||S,{transfer_options:i,page_instance_id:null===(t=r.loggingParams)||void 0===t?void 0:t.pageInstanceId,interaction_id:null===(n=r.loggingParams)||void 0===n?void 0:n.interactionId})}},{key:"pause",value:function(e,t){return this._sendPlayerCommand("pause",e,t)}},{key:"resume",value:function(e,t){return this._sendPlayerCommand("resume",e,t)}},{key:"togglePlay",value:function(e,t){var n=this;return this.getContextPlayerState().then((function(r){return r?r.is_paused?n.resume(e,t):n.pause(e,t):Promise.reject(new hi(i.CONNECTAPI_CLIENT_NO_STATE,"Nothing playing"))}))}},{key:"nextTrack",value:function(e,t){return this._sendPlayerCommand("skip_next",e,t)}},{key:"previousTrack",value:function(e,t){return this._sendPlayerCommand("skip_prev",e,t)}},{key:"seek",value:function(e,t){return isNaN(e)||e<0?Promise.reject(new hi(i.CONNECTAPI_CLIENT_INVALID_POSITION,"Invalid position.")):this._sendPlayerCommand("seek_to",t,{value:e})}},{key:"setShuffle",value:function(e,t,n){return this._sendPlayerCommand("set_shuffling_context",t,Object.assign({value:!!e},n))}},{key:"toggleShuffle",value:function(e,t){var n=this;return this.getContextPlayerState().then((function(r){if(!r)return Promise.reject(new hi(i.CONNECTAPI_CLIENT_NO_STATE,"Nothing playing"));var a=r.options&&r.options.shuffling_context;return n.setShuffle(!a,e,t)}))}},{key:"setRepeatingContext",value:function(e,t){return this._sendPlayerCommand("set_repeating_context",t,{value:e})}},{key:"setRepeatingTrack",value:function(e,t){return this._sendPlayerCommand("set_repeating_track",t,{value:!!e})}},{key:"setOptions",value:function(e,t){return this._sendPlayerCommand("set_options",t,Object.assign({},e))}},{key:"setVolume",value:function(e,t){if(isNaN(e)||e<0)return Promise.reject(new hi(i.CONNECTAPI_CLIENT_INVALID_VOLUME,"Invalid volume."));var n=Math.round(e*R);return this._sendConnectCommand("volume",t,{volume:n})}},{key:"logout",value:function(e){return this._sendConnectCommand("logout",e)}}],[{key:"create",value:function(e){return new n(e)}}]),n}(p.vp);Object.assign(Object.assign(Object.assign({},i),a.J),r);function Zi(e){var t,n=e.transport;if(!n)throw new TypeError("No Transport instance provided");var r=function(e){return se.create(e)}(Object.assign(Object.assign({},e.client),{transport:n,hidden:!!e.hidden,playTokenLostBehavior:e.hidden&&!e.onlyLocalState?"stop":"pause"})),i=e.streamer||{},a=e.controller||{},o=void 0,s=!1;e.streamer&&e.streamer.disabled?(e.hidden=!0,e.onlyLocalState=!1,e.claimInactivePlayerStates=!1,s=!0):(o=ci(r,i),a.autoregister=!1,e.onlyLocalState&&(a.decorateTrackWindow=!1,a.disableProgress=!0));var u=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=e.getPublicTransport(),r=e.getVersionDescriptor().tagged,i=xi.create({autoregister:!("autoregister"in t)||t.autoregister,descriptor:e.getClientDescriptor(),transport:n});return Ci.create({client:e,playerClient:i,version:r,serverTime:di.X.create(n),decorateTrackWindow:"boolean"!=typeof t.decorateTrackWindow||t.decorateTrackWindow,disableProgress:t.disableProgress})}(r,a);return Z.create({transport:n,client:r,streamer:o,controller:u,enableControllerWithoutStreamer:s,hidden:e.hidden,onlyLocalState:e.onlyLocalState,claimInactivePlayerStates:e.claimInactivePlayerStates,autoActivateElement:null!==(t=e.autoActivateElement)&&void 0!==t?t:"undefined"!=typeof WebKitMediaKeys,experimentalDeactivateOnStop:e.experimentalDeactivateOnStop})}}}]);
//# sourceMappingURL=908.2744e127.js.map